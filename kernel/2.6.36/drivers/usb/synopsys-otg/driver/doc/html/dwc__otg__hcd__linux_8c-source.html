<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>DesignWare USB 2.0 OTG Controller (DWC_otg) Device Driver: dwc_otg_hcd_linux.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.7 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>Globals</span></a></li>
  </ul></div>
<h1>dwc_otg_hcd_linux.c</h1><a href="dwc__otg__hcd__linux_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/* ==========================================================================</span>
<a name="l00002"></a>00002 <span class="comment"> * $File: //dwh/usb_iip/dev/software/otg/linux/drivers/dwc_otg_hcd_linux.c $</span>
<a name="l00003"></a>00003 <span class="comment"> * $Revision: #11 $</span>
<a name="l00004"></a>00004 <span class="comment"> * $Date: 2009/04/21 $</span>
<a name="l00005"></a>00005 <span class="comment"> * $Change: 1237476 $</span>
<a name="l00006"></a>00006 <span class="comment"> *</span>
<a name="l00007"></a>00007 <span class="comment"> * Synopsys HS OTG Linux Software Driver and documentation (hereinafter,</span>
<a name="l00008"></a>00008 <span class="comment"> * "Software") is an Unsupported proprietary work of Synopsys, Inc. unless</span>
<a name="l00009"></a>00009 <span class="comment"> * otherwise expressly agreed to in writing between Synopsys and you.</span>
<a name="l00010"></a>00010 <span class="comment"> *</span>
<a name="l00011"></a>00011 <span class="comment"> * The Software IS NOT an item of Licensed Software or Licensed Product under</span>
<a name="l00012"></a>00012 <span class="comment"> * any End User Software License Agreement or Agreement for Licensed Product</span>
<a name="l00013"></a>00013 <span class="comment"> * with Synopsys or any supplement thereto. You are permitted to use and</span>
<a name="l00014"></a>00014 <span class="comment"> * redistribute this Software in source and binary forms, with or without</span>
<a name="l00015"></a>00015 <span class="comment"> * modification, provided that redistributions of source code must retain this</span>
<a name="l00016"></a>00016 <span class="comment"> * notice. You may not view, use, disclose, copy or distribute this file or</span>
<a name="l00017"></a>00017 <span class="comment"> * any information contained herein except pursuant to this license grant from</span>
<a name="l00018"></a>00018 <span class="comment"> * Synopsys. If you do not agree with this notice, including the disclaimer</span>
<a name="l00019"></a>00019 <span class="comment"> * below, then you are not authorized to use the Software.</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * THIS SOFTWARE IS BEING DISTRIBUTED BY SYNOPSYS SOLELY ON AN "AS IS" BASIS</span>
<a name="l00022"></a>00022 <span class="comment"> * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
<a name="l00023"></a>00023 <span class="comment"> * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
<a name="l00024"></a>00024 <span class="comment"> * ARE HEREBY DISCLAIMED. IN NO EVENT SHALL SYNOPSYS BE LIABLE FOR ANY DIRECT,</span>
<a name="l00025"></a>00025 <span class="comment"> * INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES</span>
<a name="l00026"></a>00026 <span class="comment"> * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR</span>
<a name="l00027"></a>00027 <span class="comment"> * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER</span>
<a name="l00028"></a>00028 <span class="comment"> * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</span>
<a name="l00029"></a>00029 <span class="comment"> * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY</span>
<a name="l00030"></a>00030 <span class="comment"> * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH</span>
<a name="l00031"></a>00031 <span class="comment"> * DAMAGE.</span>
<a name="l00032"></a>00032 <span class="comment"> * ========================================================================== */</span>
<a name="l00033"></a>00033 <span class="preprocessor">#ifndef DWC_DEVICE_ONLY</span>
<a name="l00034"></a>00034 <span class="preprocessor"></span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &lt;linux/kernel.h&gt;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &lt;linux/module.h&gt;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &lt;linux/moduleparam.h&gt;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &lt;linux/init.h&gt;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &lt;linux/device.h&gt;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &lt;linux/errno.h&gt;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &lt;linux/list.h&gt;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &lt;linux/interrupt.h&gt;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &lt;linux/string.h&gt;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &lt;linux/dma-mapping.h&gt;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &lt;linux/version.h&gt;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &lt;asm/io.h&gt;</span>
<a name="l00053"></a>00053 
<a name="l00054"></a>00054 <span class="preprocessor">#ifdef LM_INTERFACE</span>
<a name="l00055"></a>00055 <span class="preprocessor"></span><span class="preprocessor">#include &lt;asm/arch/regs-irq.h&gt;</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include &lt;asm/arch/lm.h&gt;</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include &lt;asm/arch/irqs.h&gt;</span>
<a name="l00058"></a>00058 <span class="preprocessor">#endif</span>
<a name="l00059"></a>00059 <span class="preprocessor"></span>
<a name="l00060"></a>00060 <span class="preprocessor">#include &lt;linux/usb.h&gt;</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include &lt;../drivers/usb/core/hcd.h&gt;</span>
<a name="l00062"></a>00062 
<a name="l00063"></a>00063 <span class="preprocessor">#include "<a class="code" href="dwc__otg__hcd__if_8h.html">dwc_otg_hcd_if.h</a>"</span>
<a name="l00064"></a>00064 <span class="preprocessor">#include "<a class="code" href="dwc__otg__dbg_8h.html">dwc_otg_dbg.h</a>"</span>
<a name="l00065"></a>00065 <span class="preprocessor">#include "<a class="code" href="dwc__otg__driver_8h.html">dwc_otg_driver.h</a>"</span>
<a name="l00066"></a>00066 
<a name="l00071"></a><a class="code" href="dwc__otg__hcd__linux_8c.html#4a327046464cd55f8abafc4af8ef74aa">00071</a> <span class="preprocessor">#define dwc_ep_addr_to_endpoint(_bEndpointAddress_) ((_bEndpointAddress_ &amp; USB_ENDPOINT_NUMBER_MASK) | \</span>
<a name="l00072"></a>00072 <span class="preprocessor">                                                     ((_bEndpointAddress_ &amp; USB_DIR_IN) != 0) &lt;&lt; 4)</span>
<a name="l00073"></a>00073 <span class="preprocessor"></span>
<a name="l00074"></a><a class="code" href="dwc__otg__hcd__linux_8c.html#41b49c86957a3835934c2f26fee377df">00074</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="dwc__otg__hcd__linux_8c.html#41b49c86957a3835934c2f26fee377df">dwc_otg_hcd_name</a>[] = <span class="stringliteral">"dwc_otg_hcd"</span>;
<a name="l00075"></a>00075 
<a name="l00078"></a>00078 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__hcd__linux_8c.html#d9e9c76f2bc1c4f662d132c710a95a60">urb_enqueue</a>(<span class="keyword">struct</span> usb_hcd *hcd,
<a name="l00079"></a>00079                        <span class="keyword">struct</span> usb_host_endpoint *ep,
<a name="l00080"></a>00080                        <span class="keyword">struct</span> urb *urb, gfp_t mem_flags);
<a name="l00081"></a>00081 
<a name="l00082"></a>00082 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__hcd__linux_8c.html#afc1f3d92fd7596140c0068bc96034f7">urb_dequeue</a>(<span class="keyword">struct</span> usb_hcd *hcd, <span class="keyword">struct</span> urb *urb);
<a name="l00083"></a>00083 
<a name="l00084"></a>00084 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__hcd__linux_8c.html#0aefc084c4c334dac85c95a43e8942c6">endpoint_disable</a>(<span class="keyword">struct</span> usb_hcd *hcd, <span class="keyword">struct</span> usb_host_endpoint *ep);
<a name="l00085"></a>00085 
<a name="l00086"></a>00086 <span class="keyword">static</span> irqreturn_t <a class="code" href="dwc__otg__hcd__linux_8c.html#1e911926e9d51d6d9d11f11b81da8c3d">dwc_otg_hcd_irq</a>(<span class="keyword">struct</span> usb_hcd *hcd);
<a name="l00087"></a>00087 <span class="keyword">extern</span> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__cil__intr_8c.html#fc2d933cd662b3d060747004c79203a1">hcd_start</a>(<span class="keyword">struct</span> usb_hcd *hcd);
<a name="l00088"></a>00088 <span class="keyword">extern</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__cil__intr_8c.html#b2721d01cc389181470095955b4e0994">hcd_stop</a>(<span class="keyword">struct</span> usb_hcd *hcd);
<a name="l00089"></a>00089 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__hcd__linux_8c.html#c78128edb8902dc96534c5bb253f99a3">get_frame_number</a>(<span class="keyword">struct</span> usb_hcd *hcd);
<a name="l00090"></a>00090 <span class="keyword">extern</span> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__hcd__linux_8c.html#108442f4aa4dc4663d8659241ed04e9c">hub_status_data</a>(<span class="keyword">struct</span> usb_hcd *hcd, <span class="keywordtype">char</span> *buf);
<a name="l00091"></a>00091 <span class="keyword">extern</span> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__hcd__linux_8c.html#55d196cab99083dabdacdee78dc5e339">hub_control</a>(<span class="keyword">struct</span> usb_hcd *hcd,
<a name="l00092"></a>00092                        u16 typeReq,
<a name="l00093"></a>00093                        u16 wValue, u16 wIndex, <span class="keywordtype">char</span> *buf, u16 wLength);
<a name="l00094"></a>00094 
<a name="l00095"></a><a class="code" href="structwrapper__priv__data.html">00095</a> <span class="keyword">struct </span><a class="code" href="structwrapper__priv__data.html">wrapper_priv_data</a> {
<a name="l00096"></a><a class="code" href="structwrapper__priv__data.html#3a5cfdab2772597d857294972bb171c8">00096</a>         <a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> *<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd</a>;
<a name="l00097"></a>00097 };
<a name="l00098"></a>00098 
<a name="l00101"></a><a class="code" href="dwc__otg__hcd__linux_8c.html#ab1d492c360b963d179798f2641c02a5">00101</a> <span class="keyword">static</span> <span class="keyword">struct </span>hc_driver <a class="code" href="dwc__otg__hcd__linux_8c.html#ab1d492c360b963d179798f2641c02a5">dwc_otg_hc_driver</a> = {
<a name="l00102"></a>00102 
<a name="l00103"></a>00103         .description = <a class="code" href="dwc__otg__hcd__linux_8c.html#41b49c86957a3835934c2f26fee377df">dwc_otg_hcd_name</a>,
<a name="l00104"></a>00104         .product_desc = <span class="stringliteral">"DWC OTG Controller"</span>,
<a name="l00105"></a>00105         .hcd_priv_size = <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structwrapper__priv__data.html">wrapper_priv_data</a>),
<a name="l00106"></a>00106 
<a name="l00107"></a>00107         .irq = <a class="code" href="dwc__otg__hcd__linux_8c.html#1e911926e9d51d6d9d11f11b81da8c3d">dwc_otg_hcd_irq</a>,
<a name="l00108"></a>00108 
<a name="l00109"></a>00109         .flags = HCD_MEMORY | HCD_USB2,
<a name="l00110"></a>00110 
<a name="l00111"></a>00111         <span class="comment">//.reset =              </span>
<a name="l00112"></a>00112         .start = <a class="code" href="dwc__otg__cil__intr_8c.html#fc2d933cd662b3d060747004c79203a1">hcd_start</a>,
<a name="l00113"></a>00113         <span class="comment">//.suspend =            </span>
<a name="l00114"></a>00114         <span class="comment">//.resume =             </span>
<a name="l00115"></a>00115         .stop = <a class="code" href="dwc__otg__cil__intr_8c.html#b2721d01cc389181470095955b4e0994">hcd_stop</a>,
<a name="l00116"></a>00116 
<a name="l00117"></a>00117         .urb_enqueue = <a class="code" href="dwc__otg__hcd__linux_8c.html#d9e9c76f2bc1c4f662d132c710a95a60">urb_enqueue</a>,
<a name="l00118"></a>00118         .urb_dequeue = <a class="code" href="dwc__otg__hcd__linux_8c.html#afc1f3d92fd7596140c0068bc96034f7">urb_dequeue</a>,
<a name="l00119"></a>00119         .endpoint_disable = <a class="code" href="dwc__otg__hcd__linux_8c.html#0aefc084c4c334dac85c95a43e8942c6">endpoint_disable</a>,
<a name="l00120"></a>00120 
<a name="l00121"></a>00121         .get_frame_number = <a class="code" href="dwc__otg__hcd__linux_8c.html#c78128edb8902dc96534c5bb253f99a3">get_frame_number</a>,
<a name="l00122"></a>00122 
<a name="l00123"></a>00123         .hub_status_data = <a class="code" href="dwc__otg__hcd__linux_8c.html#108442f4aa4dc4663d8659241ed04e9c">hub_status_data</a>,
<a name="l00124"></a>00124         .hub_control = <a class="code" href="dwc__otg__hcd__linux_8c.html#55d196cab99083dabdacdee78dc5e339">hub_control</a>,
<a name="l00125"></a>00125         <span class="comment">//.bus_suspend =                </span>
<a name="l00126"></a>00126         <span class="comment">//.bus_resume =         </span>
<a name="l00127"></a>00127 };
<a name="l00128"></a>00128 
<a name="l00130"></a><a class="code" href="dwc__otg__hcd__linux_8c.html#bd8c86466ccd8ff8b94867d601e66116">00130</a> <span class="keyword">static</span> <span class="keyword">inline</span> <a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> *<a class="code" href="dwc__otg__hcd__linux_8c.html#bd8c86466ccd8ff8b94867d601e66116">hcd_to_dwc_otg_hcd</a>(<span class="keyword">struct</span> usb_hcd *hcd)
<a name="l00131"></a>00131 {
<a name="l00132"></a>00132         <span class="keyword">struct </span><a class="code" href="structwrapper__priv__data.html">wrapper_priv_data</a> *p;
<a name="l00133"></a>00133         p = (<span class="keyword">struct </span><a class="code" href="structwrapper__priv__data.html">wrapper_priv_data</a> *)(hcd-&gt;hcd_priv);
<a name="l00134"></a>00134         <span class="keywordflow">return</span> p-&gt;<a class="code" href="structwrapper__priv__data.html#3a5cfdab2772597d857294972bb171c8">dwc_otg_hcd</a>;
<a name="l00135"></a>00135 }
<a name="l00136"></a>00136 
<a name="l00138"></a><a class="code" href="dwc__otg__hcd__linux_8c.html#e314b37c9e03857c2cad95724982ad42">00138</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">struct </span>usb_hcd *<a class="code" href="dwc__otg__hcd__linux_8c.html#e314b37c9e03857c2cad95724982ad42">dwc_otg_hcd_to_hcd</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * <a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd</a>)
<a name="l00139"></a>00139 {
<a name="l00140"></a>00140         <span class="keywordflow">return</span> <a class="code" href="dwc__otg__hcd_8c.html#7740268b2d0fd8d25aaaeacfa5aef5cf">dwc_otg_hcd_get_priv_data</a>(dwc_otg_hcd);
<a name="l00141"></a>00141 }
<a name="l00142"></a>00142 
<a name="l00144"></a><a class="code" href="dwc__otg__hcd__linux_8c.html#99c594c1e3af2fa78b09c914cb334611">00144</a> <span class="keyword">inline</span> <span class="keyword">struct </span>usb_host_endpoint *<a class="code" href="dwc__otg__hcd__linux_8c.html#99c594c1e3af2fa78b09c914cb334611">dwc_urb_to_endpoint</a>(<span class="keyword">struct</span> urb *urb)
<a name="l00145"></a>00145 {
<a name="l00146"></a>00146         <span class="keyword">struct </span>usb_device *dev = urb-&gt;dev;
<a name="l00147"></a>00147         <span class="keywordtype">int</span> ep_num = usb_pipeendpoint(urb-&gt;pipe);
<a name="l00148"></a>00148 
<a name="l00149"></a>00149         <span class="keywordflow">if</span> (usb_pipein(urb-&gt;pipe))
<a name="l00150"></a>00150                 <span class="keywordflow">return</span> dev-&gt;ep_in[ep_num];
<a name="l00151"></a>00151         <span class="keywordflow">else</span>
<a name="l00152"></a>00152                 <span class="keywordflow">return</span> dev-&gt;ep_out[ep_num];
<a name="l00153"></a>00153 }
<a name="l00154"></a>00154 
<a name="l00155"></a><a class="code" href="dwc__otg__hcd__linux_8c.html#8011f9b662a7f4182e762de616bbc95e">00155</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__hcd__linux_8c.html#8011f9b662a7f4182e762de616bbc95e">_disconnect</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd)
<a name="l00156"></a>00156 {
<a name="l00157"></a>00157         <span class="keyword">struct </span>usb_hcd *usb_hcd = <a class="code" href="dwc__otg__hcd__linux_8c.html#e314b37c9e03857c2cad95724982ad42">dwc_otg_hcd_to_hcd</a>(hcd);
<a name="l00158"></a>00158 
<a name="l00159"></a>00159         usb_hcd-&gt;self.is_b_host = 0;
<a name="l00160"></a>00160         <span class="keywordflow">return</span> 0;
<a name="l00161"></a>00161 }
<a name="l00162"></a>00162 
<a name="l00163"></a><a class="code" href="dwc__otg__hcd__linux_8c.html#e11ebd665a86e6ec3fd661965acca90e">00163</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__hcd__linux_8c.html#e11ebd665a86e6ec3fd661965acca90e">_start</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd)
<a name="l00164"></a>00164 {
<a name="l00165"></a>00165         <span class="keyword">struct </span>usb_hcd *usb_hcd = <a class="code" href="dwc__otg__hcd__linux_8c.html#e314b37c9e03857c2cad95724982ad42">dwc_otg_hcd_to_hcd</a>(hcd);
<a name="l00166"></a>00166 
<a name="l00167"></a>00167         usb_hcd-&gt;self.is_b_host = <a class="code" href="dwc__otg__hcd_8c.html#ca25b33b440a4ef112ee459c26c14adc">dwc_otg_hcd_is_b_host</a>(hcd);
<a name="l00168"></a>00168         <a class="code" href="dwc__otg__cil__intr_8c.html#fc2d933cd662b3d060747004c79203a1">hcd_start</a>(usb_hcd);
<a name="l00169"></a>00169 
<a name="l00170"></a>00170         <span class="keywordflow">return</span> 0;
<a name="l00171"></a>00171 }
<a name="l00172"></a>00172 
<a name="l00173"></a><a class="code" href="dwc__otg__hcd__linux_8c.html#f4fe5a6082e7cce809f3e2a4cb71a7e4">00173</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__hcd__linux_8c.html#f4fe5a6082e7cce809f3e2a4cb71a7e4">_hub_info</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd, <span class="keywordtype">void</span> *urb_handle, uint32_t * hub_addr,
<a name="l00174"></a>00174                      uint32_t * port_addr)
<a name="l00175"></a>00175 {
<a name="l00176"></a>00176         <span class="keyword">struct </span>urb *urb = (<span class="keyword">struct </span>urb *)urb_handle;
<a name="l00177"></a>00177         <span class="keywordflow">if</span> (urb-&gt;dev-&gt;tt) {
<a name="l00178"></a>00178                 *hub_addr = urb-&gt;dev-&gt;tt-&gt;hub-&gt;devnum;
<a name="l00179"></a>00179         } <span class="keywordflow">else</span> {
<a name="l00180"></a>00180                 *hub_addr = 0;
<a name="l00181"></a>00181         }
<a name="l00182"></a>00182         *port_addr = urb-&gt;dev-&gt;ttport;
<a name="l00183"></a>00183         <span class="keywordflow">return</span> 0;
<a name="l00184"></a>00184 }
<a name="l00185"></a>00185 
<a name="l00186"></a><a class="code" href="dwc__otg__hcd__linux_8c.html#22cff3e20b45ec02e81e54a1adacfa20">00186</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__hcd__linux_8c.html#22cff3e20b45ec02e81e54a1adacfa20">_speed</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd, <span class="keywordtype">void</span> *urb_handle)
<a name="l00187"></a>00187 {
<a name="l00188"></a>00188         <span class="keyword">struct </span>urb *urb = (<span class="keyword">struct </span>urb *)urb_handle;
<a name="l00189"></a>00189         <span class="keywordflow">return</span> urb-&gt;dev-&gt;speed;
<a name="l00190"></a>00190 }
<a name="l00191"></a>00191 
<a name="l00192"></a><a class="code" href="dwc__otg__hcd__linux_8c.html#578b76a201e8e722e31afdcd2c35dac9">00192</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__hcd__linux_8c.html#578b76a201e8e722e31afdcd2c35dac9">_get_b_hnp_enable</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd)
<a name="l00193"></a>00193 {
<a name="l00194"></a>00194         <span class="keyword">struct </span>usb_hcd *usb_hcd = <a class="code" href="dwc__otg__hcd__linux_8c.html#e314b37c9e03857c2cad95724982ad42">dwc_otg_hcd_to_hcd</a>(hcd);
<a name="l00195"></a>00195         <span class="keywordflow">return</span> usb_hcd-&gt;self.b_hnp_enable;
<a name="l00196"></a>00196 }
<a name="l00197"></a>00197 
<a name="l00198"></a><a class="code" href="dwc__otg__hcd__linux_8c.html#e270a6a091a674ccf6f390fdcf746b87">00198</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__hcd__linux_8c.html#e270a6a091a674ccf6f390fdcf746b87">allocate_bus_bandwidth</a>(<span class="keyword">struct</span> usb_hcd *hcd, uint32_t bw,
<a name="l00199"></a>00199                                    <span class="keyword">struct</span> urb *urb)
<a name="l00200"></a>00200 {
<a name="l00201"></a>00201         hcd_to_bus(hcd)-&gt;bandwidth_allocated += bw / urb-&gt;interval;
<a name="l00202"></a>00202         <span class="keywordflow">if</span> (usb_pipetype(urb-&gt;pipe) == PIPE_ISOCHRONOUS) {
<a name="l00203"></a>00203                 hcd_to_bus(hcd)-&gt;bandwidth_isoc_reqs++;
<a name="l00204"></a>00204         } <span class="keywordflow">else</span> {
<a name="l00205"></a>00205                 hcd_to_bus(hcd)-&gt;bandwidth_int_reqs++;
<a name="l00206"></a>00206         }
<a name="l00207"></a>00207 }
<a name="l00208"></a>00208 
<a name="l00209"></a><a class="code" href="dwc__otg__hcd__linux_8c.html#53fcd6fb7b833323112e8856070e88d8">00209</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__hcd__linux_8c.html#53fcd6fb7b833323112e8856070e88d8">free_bus_bandwidth</a>(<span class="keyword">struct</span> usb_hcd *hcd, uint32_t bw,
<a name="l00210"></a>00210                                <span class="keyword">struct</span> urb *urb)
<a name="l00211"></a>00211 {
<a name="l00212"></a>00212         hcd_to_bus(hcd)-&gt;bandwidth_allocated -= bw / urb-&gt;interval;
<a name="l00213"></a>00213         <span class="keywordflow">if</span> (usb_pipetype(urb-&gt;pipe) == PIPE_ISOCHRONOUS) {
<a name="l00214"></a>00214                 hcd_to_bus(hcd)-&gt;bandwidth_isoc_reqs--;
<a name="l00215"></a>00215         } <span class="keywordflow">else</span> {
<a name="l00216"></a>00216                 hcd_to_bus(hcd)-&gt;bandwidth_int_reqs--;
<a name="l00217"></a>00217         }
<a name="l00218"></a>00218 }
<a name="l00219"></a>00219 
<a name="l00224"></a><a class="code" href="dwc__otg__hcd__linux_8c.html#a0d18986574c384e98aa280e0475a9aa">00224</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__hcd__linux_8c.html#a0d18986574c384e98aa280e0475a9aa">_complete</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd, <span class="keywordtype">void</span> *urb_handle,
<a name="l00225"></a>00225                      <a class="code" href="structdwc__otg__hcd__urb.html">dwc_otg_hcd_urb_t</a> * dwc_otg_urb, int32_t status)
<a name="l00226"></a>00226 {
<a name="l00227"></a>00227         <span class="keyword">struct </span>urb *urb = (<span class="keyword">struct </span>urb *)urb_handle;
<a name="l00228"></a>00228 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l00229"></a>00229 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="dwc__otg__dbg_8h.html#7a96217c88a4d786f6cb3d4df09dee04">CHK_DEBUG_LEVEL</a>(<a class="code" href="dwc__otg__dbg_8h.html#39931d908ba215b3d5d590e42d8408b5">DBG_HCDV</a> | <a class="code" href="dwc__otg__dbg_8h.html#737e22e02729647d12db8e3059ad06c9">DBG_HCD_URB</a>)) {
<a name="l00230"></a>00230                 DWC_PRINTF(<span class="stringliteral">"%s: urb %p, device %d, ep %d %s, status=%d\n"</span>,
<a name="l00231"></a>00231                            __func__, urb, usb_pipedevice(urb-&gt;pipe),
<a name="l00232"></a>00232                            usb_pipeendpoint(urb-&gt;pipe),
<a name="l00233"></a>00233                            usb_pipein(urb-&gt;pipe) ? <span class="stringliteral">"IN"</span> : <span class="stringliteral">"OUT"</span>, status);
<a name="l00234"></a>00234                 <span class="keywordflow">if</span> (usb_pipetype(urb-&gt;pipe) == PIPE_ISOCHRONOUS) {
<a name="l00235"></a>00235                         <span class="keywordtype">int</span> i;
<a name="l00236"></a>00236                         <span class="keywordflow">for</span> (i = 0; i &lt; urb-&gt;number_of_packets; i++) {
<a name="l00237"></a>00237                                 DWC_PRINTF(<span class="stringliteral">"  ISO Desc %d status: %d\n"</span>,
<a name="l00238"></a>00238                                            i, urb-&gt;iso_frame_desc[i].status);
<a name="l00239"></a>00239                         }
<a name="l00240"></a>00240                 }
<a name="l00241"></a>00241         }
<a name="l00242"></a>00242 <span class="preprocessor">#endif</span>
<a name="l00243"></a>00243 <span class="preprocessor"></span>
<a name="l00244"></a>00244         urb-&gt;actual_length = <a class="code" href="dwc__otg__hcd_8c.html#3260f5db4ea20074da16b292eb1a686b">dwc_otg_hcd_urb_get_actual_length</a>(dwc_otg_urb);
<a name="l00245"></a>00245         <span class="comment">/* Convert status value. */</span>
<a name="l00246"></a>00246         <span class="keywordflow">switch</span> (status) {
<a name="l00247"></a>00247         <span class="keywordflow">case</span> -DWC_E_PROTOCOL:
<a name="l00248"></a>00248                 status = -EPROTO;
<a name="l00249"></a>00249                 <span class="keywordflow">break</span>;
<a name="l00250"></a>00250         <span class="keywordflow">case</span> -DWC_E_IN_PROGRESS:
<a name="l00251"></a>00251                 status = -EINPROGRESS;
<a name="l00252"></a>00252                 <span class="keywordflow">break</span>;
<a name="l00253"></a>00253         <span class="keywordflow">case</span> -DWC_E_PIPE:
<a name="l00254"></a>00254                 status = -EPIPE;
<a name="l00255"></a>00255                 <span class="keywordflow">break</span>;
<a name="l00256"></a>00256         <span class="keywordflow">case</span> -DWC_E_IO:
<a name="l00257"></a>00257                 status = -EIO;
<a name="l00258"></a>00258                 <span class="keywordflow">break</span>;
<a name="l00259"></a>00259         <span class="keywordflow">case</span> -DWC_E_TIMEOUT:
<a name="l00260"></a>00260                 status = -ETIMEDOUT;
<a name="l00261"></a>00261                 <span class="keywordflow">break</span>;
<a name="l00262"></a>00262         <span class="keywordflow">case</span> -DWC_E_OVERFLOW:
<a name="l00263"></a>00263                 status = -EOVERFLOW;
<a name="l00264"></a>00264                 <span class="keywordflow">break</span>;
<a name="l00265"></a>00265         <span class="keywordflow">default</span>:
<a name="l00266"></a>00266                 <span class="keywordflow">if</span> (status) {
<a name="l00267"></a>00267                         DWC_PRINTF(<span class="stringliteral">"Uknown urb status %d\n"</span>, status);
<a name="l00268"></a>00268 
<a name="l00269"></a>00269                 }
<a name="l00270"></a>00270         }
<a name="l00271"></a>00271 
<a name="l00272"></a>00272         <span class="keywordflow">if</span> (usb_pipetype(urb-&gt;pipe) == PIPE_ISOCHRONOUS) {
<a name="l00273"></a>00273                 <span class="keywordtype">int</span> i;
<a name="l00274"></a>00274 
<a name="l00275"></a>00275                 urb-&gt;error_count = <a class="code" href="dwc__otg__hcd_8c.html#816cc30c3129fc8911a458355d977129">dwc_otg_hcd_urb_get_error_count</a>(dwc_otg_urb);
<a name="l00276"></a>00276                 <span class="keywordflow">for</span> (i = 0; i &lt; urb-&gt;number_of_packets; ++i) {
<a name="l00277"></a>00277                         urb-&gt;iso_frame_desc[i].actual_length =
<a name="l00278"></a>00278                             <a class="code" href="dwc__otg__hcd_8c.html#c6d28fc3e6aedb29d46a793423c4de0a">dwc_otg_hcd_urb_get_iso_desc_actual_length</a>
<a name="l00279"></a>00279                             (dwc_otg_urb, i);
<a name="l00280"></a>00280                         urb-&gt;iso_frame_desc[i].status =
<a name="l00281"></a>00281                             <a class="code" href="dwc__otg__hcd_8c.html#fde27182e452709e10c1100ea57aa46b">dwc_otg_hcd_urb_get_iso_desc_status</a>
<a name="l00282"></a>00282                             (dwc_otg_urb, i);
<a name="l00283"></a>00283                 }
<a name="l00284"></a>00284         }
<a name="l00285"></a>00285 
<a name="l00286"></a>00286         urb-&gt;status = status;
<a name="l00287"></a>00287         urb-&gt;hcpriv = NULL;
<a name="l00288"></a>00288         <span class="keywordflow">if</span> (!status) {
<a name="l00289"></a>00289                 <span class="keywordflow">if</span> ((urb-&gt;transfer_flags &amp; URB_SHORT_NOT_OK) &amp;&amp;
<a name="l00290"></a>00290                     (urb-&gt;actual_length &lt; urb-&gt;transfer_buffer_length)) {
<a name="l00291"></a>00291                         urb-&gt;status = -EREMOTEIO;
<a name="l00292"></a>00292                 }
<a name="l00293"></a>00293         }
<a name="l00294"></a>00294 
<a name="l00295"></a>00295         <span class="keywordflow">if</span> ((usb_pipetype(urb-&gt;pipe) == PIPE_ISOCHRONOUS) ||
<a name="l00296"></a>00296             (usb_pipetype(urb-&gt;pipe) == PIPE_INTERRUPT)) {
<a name="l00297"></a>00297                 <span class="keyword">struct </span>usb_host_endpoint *ep = <a class="code" href="dwc__otg__hcd__linux_8c.html#99c594c1e3af2fa78b09c914cb334611">dwc_urb_to_endpoint</a>(urb);
<a name="l00298"></a>00298                 <span class="keywordflow">if</span> (ep) {
<a name="l00299"></a>00299                         <a class="code" href="dwc__otg__hcd__linux_8c.html#53fcd6fb7b833323112e8856070e88d8">free_bus_bandwidth</a>(<a class="code" href="dwc__otg__hcd__linux_8c.html#e314b37c9e03857c2cad95724982ad42">dwc_otg_hcd_to_hcd</a>(hcd),
<a name="l00300"></a>00300                                            <a class="code" href="dwc__otg__hcd_8c.html#bd160be911ccc8f90141dae9c40276eb">dwc_otg_hcd_get_ep_bandwidth</a>(hcd,
<a name="l00301"></a>00301                                                                         ep-&gt;
<a name="l00302"></a>00302                                                                         hcpriv),
<a name="l00303"></a>00303                                            urb);
<a name="l00304"></a>00304                 }
<a name="l00305"></a>00305         }
<a name="l00306"></a>00306 
<a name="l00307"></a>00307         dwc_free(dwc_otg_urb);
<a name="l00308"></a>00308         usb_hcd_giveback_urb(<a class="code" href="dwc__otg__hcd__linux_8c.html#e314b37c9e03857c2cad95724982ad42">dwc_otg_hcd_to_hcd</a>(hcd), urb);
<a name="l00309"></a>00309         <span class="keywordflow">return</span> 0;
<a name="l00310"></a>00310 }
<a name="l00311"></a>00311 
<a name="l00312"></a><a class="code" href="dwc__otg__hcd__linux_8c.html#430ee3db85940ea34a1702a37fbfb942">00312</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structdwc__otg__hcd__function__ops.html">dwc_otg_hcd_function_ops</a> <a class="code" href="dwc__otg__hcd__linux_8c.html#430ee3db85940ea34a1702a37fbfb942">hcd_fops</a> = {
<a name="l00313"></a>00313         .<a class="code" href="structdwc__otg__hcd__function__ops.html#d74a65269fe5712ac307bfd3230a29b4">start</a> = <a class="code" href="dwc__otg__hcd__linux_8c.html#e11ebd665a86e6ec3fd661965acca90e">_start</a>,
<a name="l00314"></a>00314         .disconnect = <a class="code" href="dwc__otg__hcd__linux_8c.html#8011f9b662a7f4182e762de616bbc95e">_disconnect</a>,
<a name="l00315"></a>00315         .hub_info = <a class="code" href="dwc__otg__hcd__linux_8c.html#f4fe5a6082e7cce809f3e2a4cb71a7e4">_hub_info</a>,
<a name="l00316"></a>00316         .speed = <a class="code" href="dwc__otg__hcd__linux_8c.html#22cff3e20b45ec02e81e54a1adacfa20">_speed</a>,
<a name="l00317"></a>00317         .complete = <a class="code" href="dwc__otg__hcd__linux_8c.html#a0d18986574c384e98aa280e0475a9aa">_complete</a>,
<a name="l00318"></a>00318         .get_b_hnp_enable = <a class="code" href="dwc__otg__hcd__linux_8c.html#578b76a201e8e722e31afdcd2c35dac9">_get_b_hnp_enable</a>,
<a name="l00319"></a>00319 };
<a name="l00320"></a>00320 
<a name="l00327"></a><a class="code" href="dwc__otg__hcd__linux_8c.html#ab12cdf65bf4ed68545a6c17cc31269f">00327</a> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__driver_8c.html#ab12cdf65bf4ed68545a6c17cc31269f">hcd_init</a>(
<a name="l00328"></a>00328 #ifdef LM_INTERFACE
<a name="l00329"></a>00329         <span class="keyword">struct</span> lm_device *_dev
<a name="l00330"></a>00330 #elif  PCI_INTERFACE
<a name="l00331"></a>00331         <span class="keyword">struct</span> pci_dev *_dev
<a name="l00332"></a>00332 #endif
<a name="l00333"></a>00333         )
<a name="l00334"></a>00334 {
<a name="l00335"></a>00335         <span class="keyword">struct </span>usb_hcd *hcd = NULL;
<a name="l00336"></a>00336         <a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> *<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd</a> = NULL;
<a name="l00337"></a>00337 <span class="preprocessor">#ifdef LM_INTERFACE</span>
<a name="l00338"></a>00338 <span class="preprocessor"></span>        <a class="code" href="structdwc__otg__device.html">dwc_otg_device_t</a> *otg_dev = lm_get_drvdata(_dev);
<a name="l00339"></a>00339 <span class="preprocessor">#elif  PCI_INTERFACE</span>
<a name="l00340"></a>00340 <span class="preprocessor"></span>        <a class="code" href="structdwc__otg__device.html">dwc_otg_device_t</a> *otg_dev = pci_get_drvdata(_dev);
<a name="l00341"></a>00341 <span class="preprocessor">#endif</span>
<a name="l00342"></a>00342 <span class="preprocessor"></span>
<a name="l00343"></a>00343         <span class="keywordtype">int</span> retval = 0;
<a name="l00344"></a>00344 
<a name="l00345"></a>00345         <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#e4a050e176c1c4f556da2b276a8c2b37">DBG_HCD</a>, <span class="stringliteral">"DWC OTG HCD INIT\n"</span>);
<a name="l00346"></a>00346 
<a name="l00347"></a>00347         <span class="comment">/* Set device flags indicating whether the HCD supports DMA. */</span>
<a name="l00348"></a>00348         <span class="keywordflow">if</span> (<a class="code" href="dwc__otg__cil_8c.html#f4f060a2decd6434bbd96703a4d1fc66">dwc_otg_is_dma_enable</a>(otg_dev-&gt;<a class="code" href="structdwc__otg__device.html#4cc7c9f6e473072c2ed0a5e6adb25ebe">core_if</a>)) {
<a name="l00349"></a>00349 <span class="preprocessor">#ifdef LM_INTERFACE</span>
<a name="l00350"></a>00350 <span class="preprocessor"></span>                _dev-&gt;dev.dma_mask = (<span class="keywordtype">void</span> *)~0;
<a name="l00351"></a>00351                 _dev-&gt;dev.coherent_dma_mask = ~0;
<a name="l00352"></a>00352 <span class="preprocessor">#elif  PCI_INTERFACE</span>
<a name="l00353"></a>00353 <span class="preprocessor"></span>                pci_set_dma_mask(_dev,DMA_32BIT_MASK);          
<a name="l00354"></a>00354                 pci_set_consistent_dma_mask(_dev,DMA_32BIT_MASK);
<a name="l00355"></a>00355 <span class="preprocessor">#endif</span>
<a name="l00356"></a>00356 <span class="preprocessor"></span>
<a name="l00357"></a>00357         } <span class="keywordflow">else</span> {
<a name="l00358"></a>00358 <span class="preprocessor">#ifdef LM_INTERFACE</span>
<a name="l00359"></a>00359 <span class="preprocessor"></span>                _dev-&gt;dev.dma_mask = (<span class="keywordtype">void</span> *)0;
<a name="l00360"></a>00360                 _dev-&gt;dev.coherent_dma_mask = 0;
<a name="l00361"></a>00361 <span class="preprocessor">#elif  PCI_INTERFACE</span>
<a name="l00362"></a>00362 <span class="preprocessor"></span>                pci_set_dma_mask(_dev,0);               
<a name="l00363"></a>00363                 pci_set_consistent_dma_mask(_dev,0);
<a name="l00364"></a>00364 <span class="preprocessor">#endif</span>
<a name="l00365"></a>00365 <span class="preprocessor"></span>        }
<a name="l00366"></a>00366 
<a name="l00367"></a>00367         <span class="comment">/*</span>
<a name="l00368"></a>00368 <span class="comment">         * Allocate memory for the base HCD plus the DWC OTG HCD.</span>
<a name="l00369"></a>00369 <span class="comment">         * Initialize the base HCD.</span>
<a name="l00370"></a>00370 <span class="comment">         */</span>
<a name="l00371"></a>00371         hcd = usb_create_hcd(&amp;<a class="code" href="dwc__otg__hcd__linux_8c.html#ab1d492c360b963d179798f2641c02a5">dwc_otg_hc_driver</a>, &amp;_dev-&gt;dev, _dev-&gt;dev.bus_id);
<a name="l00372"></a>00372         <span class="keywordflow">if</span> (!hcd) {
<a name="l00373"></a>00373                 retval = -ENOMEM;
<a name="l00374"></a>00374                 <span class="keywordflow">goto</span> error1;
<a name="l00375"></a>00375         }
<a name="l00376"></a>00376 
<a name="l00377"></a>00377         hcd-&gt;regs = otg_dev-&gt;<a class="code" href="structdwc__otg__device.html#ed96ed1109175f87fd83fa32a9c2c6fa">base</a>;
<a name="l00378"></a>00378 
<a name="l00379"></a>00379         <span class="comment">/* Initialize the DWC OTG HCD. */</span>
<a name="l00380"></a>00380         dwc_otg_hcd = <a class="code" href="dwc__otg__hcd_8c.html#5595437c199432efbd3609dc87ef5afa">dwc_otg_hcd_alloc_hcd</a>();
<a name="l00381"></a>00381         <span class="keywordflow">if</span> (!dwc_otg_hcd) {
<a name="l00382"></a>00382                 <span class="keywordflow">goto</span> error2;
<a name="l00383"></a>00383         }
<a name="l00384"></a>00384         ((<span class="keyword">struct </span><a class="code" href="structwrapper__priv__data.html">wrapper_priv_data</a> *)(hcd-&gt;hcd_priv))-&gt;<a class="code" href="structwrapper__priv__data.html#3a5cfdab2772597d857294972bb171c8">dwc_otg_hcd</a> =
<a name="l00385"></a>00385             <a class="code" href="structwrapper__priv__data.html#3a5cfdab2772597d857294972bb171c8">dwc_otg_hcd</a>;
<a name="l00386"></a>00386         otg_dev-&gt;<a class="code" href="structdwc__otg__device.html#834ef28e884f0d7fcac68f3bdf5c4b33">hcd</a> = <a class="code" href="structwrapper__priv__data.html#3a5cfdab2772597d857294972bb171c8">dwc_otg_hcd</a>;
<a name="l00387"></a>00387 
<a name="l00388"></a>00388         <span class="keywordflow">if</span> (<a class="code" href="dwc__otg__hcd_8c.html#2d38590dadee51fd767d63e0dc675f23">dwc_otg_hcd_init</a>(<a class="code" href="structwrapper__priv__data.html#3a5cfdab2772597d857294972bb171c8">dwc_otg_hcd</a>, otg_dev-&gt;<a class="code" href="structdwc__otg__device.html#4cc7c9f6e473072c2ed0a5e6adb25ebe">core_if</a>)) {
<a name="l00389"></a>00389                 <span class="keywordflow">goto</span> error2;
<a name="l00390"></a>00390         }
<a name="l00391"></a>00391 
<a name="l00392"></a>00392         hcd-&gt;self.<a class="code" href="structdwc__otg__hcd.html#9231b4c3dce89a1506a5e501ec5c7a39">otg_port</a> = <a class="code" href="dwc__otg__hcd_8c.html#e7d3657931984a1ce1cee5cf47cb08f3">dwc_otg_hcd_otg_port</a>(<a class="code" href="structwrapper__priv__data.html#3a5cfdab2772597d857294972bb171c8">dwc_otg_hcd</a>);
<a name="l00393"></a>00393 
<a name="l00394"></a>00394         <span class="comment">/*</span>
<a name="l00395"></a>00395 <span class="comment">         * Finish generic HCD initialization and start the HCD. This function</span>
<a name="l00396"></a>00396 <span class="comment">         * allocates the DMA buffer pool, registers the USB bus, requests the</span>
<a name="l00397"></a>00397 <span class="comment">         * IRQ line, and calls hcd_start method.</span>
<a name="l00398"></a>00398 <span class="comment">         */</span>
<a name="l00399"></a>00399         retval = usb_add_hcd(hcd, _dev-&gt;irq, SA_SHIRQ);
<a name="l00400"></a>00400         <span class="keywordflow">if</span> (retval &lt; 0) {
<a name="l00401"></a>00401                 <span class="keywordflow">goto</span> error2;
<a name="l00402"></a>00402         }
<a name="l00403"></a>00403 
<a name="l00404"></a>00404         <a class="code" href="dwc__otg__hcd_8c.html#c73ca7d4284c8f0de7338a66607e4eb1">dwc_otg_hcd_set_priv_data</a>(<a class="code" href="structwrapper__priv__data.html#3a5cfdab2772597d857294972bb171c8">dwc_otg_hcd</a>, hcd);
<a name="l00405"></a>00405         <span class="keywordflow">return</span> 0;
<a name="l00406"></a>00406 
<a name="l00407"></a>00407       error2:
<a name="l00408"></a>00408         usb_put_hcd(hcd);
<a name="l00409"></a>00409       error1:
<a name="l00410"></a>00410         <span class="keywordflow">return</span> retval;
<a name="l00411"></a>00411 }
<a name="l00412"></a>00412 
<a name="l00417"></a><a class="code" href="dwc__otg__hcd__linux_8c.html#f36193b3ff33c0473956c8a15eee4f5b">00417</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__driver_8c.html#f36193b3ff33c0473956c8a15eee4f5b">hcd_remove</a>(
<a name="l00418"></a>00418 #ifdef LM_INTERFACE
<a name="l00419"></a>00419         <span class="keyword">struct</span> lm_device *_dev
<a name="l00420"></a>00420 #elif  PCI_INTERFACE
<a name="l00421"></a>00421         <span class="keyword">struct</span> pci_dev *_dev
<a name="l00422"></a>00422 #endif
<a name="l00423"></a>00423         )
<a name="l00424"></a>00424 {
<a name="l00425"></a>00425 <span class="preprocessor">#ifdef LM_INTERFACE</span>
<a name="l00426"></a>00426 <span class="preprocessor"></span>        <a class="code" href="structdwc__otg__device.html">dwc_otg_device_t</a> *otg_dev = lm_get_drvdata(_dev);
<a name="l00427"></a>00427 <span class="preprocessor">#elif  PCI_INTERFACE</span>
<a name="l00428"></a>00428 <span class="preprocessor"></span>        <a class="code" href="structdwc__otg__device.html">dwc_otg_device_t</a> *otg_dev = pci_get_drvdata(_dev);
<a name="l00429"></a>00429 <span class="preprocessor">#endif</span>
<a name="l00430"></a>00430 <span class="preprocessor"></span>
<a name="l00431"></a>00431         <a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> *<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd</a>;
<a name="l00432"></a>00432         <span class="keyword">struct </span>usb_hcd *hcd;
<a name="l00433"></a>00433 
<a name="l00434"></a>00434         <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#e4a050e176c1c4f556da2b276a8c2b37">DBG_HCD</a>, <span class="stringliteral">"DWC OTG HCD REMOVE\n"</span>);
<a name="l00435"></a>00435 
<a name="l00436"></a>00436         <span class="keywordflow">if</span> (!otg_dev) {
<a name="l00437"></a>00437                 <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#2bf62a567355d1ea38814714bd7b57ec">DBG_ANY</a>, <span class="stringliteral">"%s: otg_dev NULL!\n"</span>, __func__);
<a name="l00438"></a>00438                 <span class="keywordflow">return</span>;
<a name="l00439"></a>00439         }
<a name="l00440"></a>00440 
<a name="l00441"></a>00441         dwc_otg_hcd = otg_dev-&gt;<a class="code" href="structdwc__otg__device.html#834ef28e884f0d7fcac68f3bdf5c4b33">hcd</a>;
<a name="l00442"></a>00442 
<a name="l00443"></a>00443         <span class="keywordflow">if</span> (!dwc_otg_hcd) {
<a name="l00444"></a>00444                 <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#2bf62a567355d1ea38814714bd7b57ec">DBG_ANY</a>, <span class="stringliteral">"%s: otg_dev-&gt;hcd NULL!\n"</span>, __func__);
<a name="l00445"></a>00445                 <span class="keywordflow">return</span>;
<a name="l00446"></a>00446         }
<a name="l00447"></a>00447 
<a name="l00448"></a>00448         hcd = <a class="code" href="dwc__otg__hcd__linux_8c.html#e314b37c9e03857c2cad95724982ad42">dwc_otg_hcd_to_hcd</a>(dwc_otg_hcd);
<a name="l00449"></a>00449 
<a name="l00450"></a>00450         <span class="keywordflow">if</span> (!hcd) {
<a name="l00451"></a>00451                 <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#2bf62a567355d1ea38814714bd7b57ec">DBG_ANY</a>,
<a name="l00452"></a>00452                             <span class="stringliteral">"%s: dwc_otg_hcd_to_hcd(dwc_otg_hcd) NULL!\n"</span>,
<a name="l00453"></a>00453                             __func__);
<a name="l00454"></a>00454                 <span class="keywordflow">return</span>;
<a name="l00455"></a>00455         }
<a name="l00456"></a>00456         usb_remove_hcd(hcd);
<a name="l00457"></a>00457         <a class="code" href="dwc__otg__hcd_8c.html#c73ca7d4284c8f0de7338a66607e4eb1">dwc_otg_hcd_set_priv_data</a>(dwc_otg_hcd, NULL);
<a name="l00458"></a>00458         <a class="code" href="dwc__otg__hcd_8c.html#f347bcb363a622ced29161878d38830b">dwc_otg_hcd_remove</a>(dwc_otg_hcd);
<a name="l00459"></a>00459         usb_put_hcd(hcd);
<a name="l00460"></a>00460 }
<a name="l00461"></a>00461 
<a name="l00462"></a>00462 <span class="comment">/* =========================================================================</span>
<a name="l00463"></a>00463 <span class="comment"> *  Linux HC Driver Functions</span>
<a name="l00464"></a>00464 <span class="comment"> * ========================================================================= */</span>
<a name="l00465"></a>00465 
<a name="l00469"></a><a class="code" href="dwc__otg__hcd__linux_8c.html#5d7f9da64cfeb32895d6c3d1366d45cf">00469</a> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__cil__intr_8c.html#fc2d933cd662b3d060747004c79203a1">hcd_start</a>(<span class="keyword">struct</span> usb_hcd *hcd)
<a name="l00470"></a>00470 {
<a name="l00471"></a>00471         <a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> *<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd</a> = <a class="code" href="dwc__otg__hcd__linux_8c.html#bd8c86466ccd8ff8b94867d601e66116">hcd_to_dwc_otg_hcd</a>(hcd);
<a name="l00472"></a>00472         <span class="keyword">struct </span>usb_bus *bus;
<a name="l00473"></a>00473 
<a name="l00474"></a>00474         <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#e4a050e176c1c4f556da2b276a8c2b37">DBG_HCD</a>, <span class="stringliteral">"DWC OTG HCD START\n"</span>);
<a name="l00475"></a>00475         bus = hcd_to_bus(hcd);
<a name="l00476"></a>00476 
<a name="l00477"></a>00477         hcd-&gt;state = HC_STATE_RUNNING;
<a name="l00478"></a>00478         <span class="keywordflow">if</span> (<a class="code" href="dwc__otg__hcd_8c.html#7242be8ebc7f7516292cbe2344ab03be">dwc_otg_hcd_start</a>(dwc_otg_hcd, &amp;<a class="code" href="dwc__otg__hcd__linux_8c.html#430ee3db85940ea34a1702a37fbfb942">hcd_fops</a>)) {
<a name="l00479"></a>00479                 <span class="keywordflow">return</span> 0;
<a name="l00480"></a>00480         }
<a name="l00481"></a>00481 
<a name="l00482"></a>00482         <span class="comment">/* Initialize and connect root hub if one is not already attached */</span>
<a name="l00483"></a>00483         <span class="keywordflow">if</span> (bus-&gt;root_hub) {
<a name="l00484"></a>00484                 <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#e4a050e176c1c4f556da2b276a8c2b37">DBG_HCD</a>, <span class="stringliteral">"DWC OTG HCD Has Root Hub\n"</span>);
<a name="l00485"></a>00485                 <span class="comment">/* Inform the HUB driver to resume. */</span>
<a name="l00486"></a>00486                 usb_hcd_resume_root_hub(hcd);
<a name="l00487"></a>00487         }
<a name="l00488"></a>00488 
<a name="l00489"></a>00489         <span class="keywordflow">return</span> 0;
<a name="l00490"></a>00490 }
<a name="l00491"></a>00491 
<a name="l00496"></a><a class="code" href="dwc__otg__hcd__linux_8c.html#cbb6a9e932a0baf80d1fdb013ac5d679">00496</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__cil__intr_8c.html#b2721d01cc389181470095955b4e0994">hcd_stop</a>(<span class="keyword">struct</span> usb_hcd *hcd)
<a name="l00497"></a>00497 {
<a name="l00498"></a>00498         <a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> *<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd</a> = <a class="code" href="dwc__otg__hcd__linux_8c.html#bd8c86466ccd8ff8b94867d601e66116">hcd_to_dwc_otg_hcd</a>(hcd);
<a name="l00499"></a>00499 
<a name="l00500"></a>00500         <a class="code" href="dwc__otg__hcd_8c.html#70c58e8a45eb7ad8ee2f2c74ba3a77f0">dwc_otg_hcd_stop</a>(dwc_otg_hcd);
<a name="l00501"></a>00501 }
<a name="l00502"></a>00502 
<a name="l00504"></a><a class="code" href="dwc__otg__hcd__linux_8c.html#c78128edb8902dc96534c5bb253f99a3">00504</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__hcd__linux_8c.html#c78128edb8902dc96534c5bb253f99a3">get_frame_number</a>(<span class="keyword">struct</span> usb_hcd *hcd)
<a name="l00505"></a>00505 {
<a name="l00506"></a>00506         <a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> *<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd</a> = <a class="code" href="dwc__otg__hcd__linux_8c.html#bd8c86466ccd8ff8b94867d601e66116">hcd_to_dwc_otg_hcd</a>(hcd);
<a name="l00507"></a>00507 
<a name="l00508"></a>00508         <span class="keywordflow">return</span> <a class="code" href="dwc__otg__hcd_8c.html#f06514bd6f8c219cc72d1f467a82c056">dwc_otg_hcd_get_frame_number</a>(dwc_otg_hcd);
<a name="l00509"></a>00509 }
<a name="l00510"></a>00510 
<a name="l00511"></a>00511 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l00512"></a>00512 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">void</span> dump_urb_info(<span class="keyword">struct</span> urb *urb, <span class="keywordtype">char</span> *fn_name)
<a name="l00513"></a>00513 {
<a name="l00514"></a>00514         DWC_PRINTF(<span class="stringliteral">"%s, urb %p\n"</span>, fn_name, urb);
<a name="l00515"></a>00515         DWC_PRINTF(<span class="stringliteral">"  Device address: %d\n"</span>, usb_pipedevice(urb-&gt;pipe));
<a name="l00516"></a>00516         DWC_PRINTF(<span class="stringliteral">"  Endpoint: %d, %s\n"</span>, usb_pipeendpoint(urb-&gt;pipe),
<a name="l00517"></a>00517                    (usb_pipein(urb-&gt;pipe) ? <span class="stringliteral">"IN"</span> : <span class="stringliteral">"OUT"</span>));
<a name="l00518"></a>00518         DWC_PRINTF(<span class="stringliteral">"  Endpoint type: %s\n"</span>, ( {
<a name="l00519"></a>00519                                              <span class="keywordtype">char</span> *pipetype;
<a name="l00520"></a>00520                                              <span class="keywordflow">switch</span> (usb_pipetype(urb-&gt;pipe)) {
<a name="l00521"></a>00521 <span class="keywordflow">case</span> PIPE_CONTROL:
<a name="l00522"></a>00522 pipetype = <span class="stringliteral">"CONTROL"</span>; <span class="keywordflow">break</span>; <span class="keywordflow">case</span> PIPE_BULK:
<a name="l00523"></a>00523 pipetype = <span class="stringliteral">"BULK"</span>; <span class="keywordflow">break</span>; <span class="keywordflow">case</span> PIPE_INTERRUPT:
<a name="l00524"></a>00524 pipetype = <span class="stringliteral">"INTERRUPT"</span>; <span class="keywordflow">break</span>; <span class="keywordflow">case</span> PIPE_ISOCHRONOUS:
<a name="l00525"></a>00525 pipetype = <span class="stringliteral">"ISOCHRONOUS"</span>; <span class="keywordflow">break</span>; <span class="keywordflow">default</span>:
<a name="l00526"></a>00526                                              pipetype = <span class="stringliteral">"UNKNOWN"</span>; <span class="keywordflow">break</span>;};
<a name="l00527"></a>00527                                              pipetype;}
<a name="l00528"></a>00528                    )) ;
<a name="l00529"></a>00529         DWC_PRINTF(<span class="stringliteral">"  Speed: %s\n"</span>, ( {
<a name="l00530"></a>00530                                      <span class="keywordtype">char</span> *speed; <span class="keywordflow">switch</span> (urb-&gt;dev-&gt;speed) {
<a name="l00531"></a>00531 <span class="keywordflow">case</span> USB_SPEED_HIGH:
<a name="l00532"></a>00532 speed = <span class="stringliteral">"HIGH"</span>; <span class="keywordflow">break</span>; <span class="keywordflow">case</span> USB_SPEED_FULL:
<a name="l00533"></a>00533 speed = <span class="stringliteral">"FULL"</span>; <span class="keywordflow">break</span>; <span class="keywordflow">case</span> USB_SPEED_LOW:
<a name="l00534"></a>00534 speed = <span class="stringliteral">"LOW"</span>; <span class="keywordflow">break</span>; <span class="keywordflow">default</span>:
<a name="l00535"></a>00535                                      speed = <span class="stringliteral">"UNKNOWN"</span>; <span class="keywordflow">break</span>;};
<a name="l00536"></a>00536                                      speed;}
<a name="l00537"></a>00537                    )) ;
<a name="l00538"></a>00538         DWC_PRINTF(<span class="stringliteral">"  Max packet size: %d\n"</span>,
<a name="l00539"></a>00539                    usb_maxpacket(urb-&gt;dev, urb-&gt;pipe, usb_pipeout(urb-&gt;pipe)));
<a name="l00540"></a>00540         DWC_PRINTF(<span class="stringliteral">"  Data buffer length: %d\n"</span>, urb-&gt;transfer_buffer_length);
<a name="l00541"></a>00541         DWC_PRINTF(<span class="stringliteral">"  Transfer buffer: %p, Transfer DMA: %p\n"</span>,
<a name="l00542"></a>00542                    urb-&gt;transfer_buffer, (<span class="keywordtype">void</span> *)urb-&gt;transfer_dma);
<a name="l00543"></a>00543         DWC_PRINTF(<span class="stringliteral">"  Setup buffer: %p, Setup DMA: %p\n"</span>,
<a name="l00544"></a>00544                    urb-&gt;setup_packet, (<span class="keywordtype">void</span> *)urb-&gt;setup_dma);
<a name="l00545"></a>00545         DWC_PRINTF(<span class="stringliteral">"  Interval: %d\n"</span>, urb-&gt;interval);
<a name="l00546"></a>00546         <span class="keywordflow">if</span> (usb_pipetype(urb-&gt;pipe) == PIPE_ISOCHRONOUS) {
<a name="l00547"></a>00547                 <span class="keywordtype">int</span> i;
<a name="l00548"></a>00548                 <span class="keywordflow">for</span> (i = 0; i &lt; urb-&gt;number_of_packets; i++) {
<a name="l00549"></a>00549                         DWC_PRINTF(<span class="stringliteral">"  ISO Desc %d:\n"</span>, i);
<a name="l00550"></a>00550                         DWC_PRINTF(<span class="stringliteral">"    offset: %d, length %d\n"</span>,
<a name="l00551"></a>00551                                    urb-&gt;iso_frame_desc[i].offset,
<a name="l00552"></a>00552                                    urb-&gt;iso_frame_desc[i].length);
<a name="l00553"></a>00553                 }
<a name="l00554"></a>00554         }
<a name="l00555"></a>00555 }
<a name="l00556"></a>00556 
<a name="l00557"></a>00557 <span class="preprocessor">#endif</span>
<a name="l00558"></a>00558 <span class="preprocessor"></span>
<a name="l00562"></a><a class="code" href="dwc__otg__hcd__linux_8c.html#d9e9c76f2bc1c4f662d132c710a95a60">00562</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__hcd__linux_8c.html#d9e9c76f2bc1c4f662d132c710a95a60">urb_enqueue</a>(<span class="keyword">struct</span> usb_hcd *hcd,
<a name="l00563"></a>00563                        <span class="keyword">struct</span> usb_host_endpoint *ep,
<a name="l00564"></a>00564                        <span class="keyword">struct</span> urb *urb, gfp_t mem_flags)
<a name="l00565"></a>00565 {
<a name="l00566"></a>00566         <span class="keywordtype">int</span> retval = 0;
<a name="l00567"></a>00567         <a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> *<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd</a> = <a class="code" href="dwc__otg__hcd__linux_8c.html#bd8c86466ccd8ff8b94867d601e66116">hcd_to_dwc_otg_hcd</a>(hcd);
<a name="l00568"></a>00568         <a class="code" href="structdwc__otg__hcd__urb.html">dwc_otg_hcd_urb_t</a> *dwc_otg_urb;
<a name="l00569"></a>00569         <span class="keywordtype">int</span> i;
<a name="l00570"></a>00570         <span class="keywordtype">int</span> alloc_bandwidth = 0;
<a name="l00571"></a>00571         uint8_t ep_type = 0;
<a name="l00572"></a>00572         uint32_t flags = 0;
<a name="l00573"></a>00573         <span class="keywordtype">void</span> *buf;
<a name="l00574"></a>00574 
<a name="l00575"></a>00575 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l00576"></a>00576 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="dwc__otg__dbg_8h.html#7a96217c88a4d786f6cb3d4df09dee04">CHK_DEBUG_LEVEL</a>(<a class="code" href="dwc__otg__dbg_8h.html#39931d908ba215b3d5d590e42d8408b5">DBG_HCDV</a> | <a class="code" href="dwc__otg__dbg_8h.html#737e22e02729647d12db8e3059ad06c9">DBG_HCD_URB</a>)) {
<a name="l00577"></a>00577                 dump_urb_info(urb, <span class="stringliteral">"urb_enqueue"</span>);
<a name="l00578"></a>00578         }
<a name="l00579"></a>00579 <span class="preprocessor">#endif</span>
<a name="l00580"></a>00580 <span class="preprocessor"></span>
<a name="l00581"></a>00581         <span class="keywordflow">if</span> ((usb_pipetype(urb-&gt;pipe) == PIPE_ISOCHRONOUS)
<a name="l00582"></a>00582             || (usb_pipetype(urb-&gt;pipe) == PIPE_INTERRUPT)) {
<a name="l00583"></a>00583                 <span class="keywordflow">if</span> (!<a class="code" href="dwc__otg__hcd_8c.html#5deb69c332ba937b959c9dccadd87568">dwc_otg_hcd_is_bandwidth_allocated</a>
<a name="l00584"></a>00584                     (dwc_otg_hcd, &amp;ep-&gt;hcpriv)) {
<a name="l00585"></a>00585                         alloc_bandwidth = 1;
<a name="l00586"></a>00586                 }
<a name="l00587"></a>00587         }
<a name="l00588"></a>00588 
<a name="l00589"></a>00589         <span class="keywordflow">switch</span> (usb_pipetype(urb-&gt;pipe)) {
<a name="l00590"></a>00590         <span class="keywordflow">case</span> PIPE_CONTROL:
<a name="l00591"></a>00591                 ep_type = USB_ENDPOINT_XFER_CONTROL;
<a name="l00592"></a>00592                 <span class="keywordflow">break</span>;
<a name="l00593"></a>00593         <span class="keywordflow">case</span> PIPE_ISOCHRONOUS:
<a name="l00594"></a>00594                 ep_type = USB_ENDPOINT_XFER_ISOC;
<a name="l00595"></a>00595                 <span class="keywordflow">break</span>;
<a name="l00596"></a>00596         <span class="keywordflow">case</span> PIPE_BULK:
<a name="l00597"></a>00597                 ep_type = USB_ENDPOINT_XFER_BULK;
<a name="l00598"></a>00598                 <span class="keywordflow">break</span>;
<a name="l00599"></a>00599         <span class="keywordflow">case</span> PIPE_INTERRUPT:
<a name="l00600"></a>00600                 ep_type = USB_ENDPOINT_XFER_INT;
<a name="l00601"></a>00601                 <span class="keywordflow">break</span>;
<a name="l00602"></a>00602         <span class="keywordflow">default</span>:
<a name="l00603"></a>00603                 DWC_WARN(<span class="stringliteral">"Wrong ep type\n"</span>);
<a name="l00604"></a>00604         }
<a name="l00605"></a>00605 
<a name="l00606"></a>00606         dwc_otg_urb = <a class="code" href="dwc__otg__hcd_8c.html#264fc9d293c76e42dded9dee2cf44283">dwc_otg_hcd_urb_alloc</a>(dwc_otg_hcd,
<a name="l00607"></a>00607                                             urb-&gt;number_of_packets,
<a name="l00608"></a>00608                                             mem_flags == GFP_ATOMIC ? 1 : 0);
<a name="l00609"></a>00609 
<a name="l00610"></a>00610         <a class="code" href="dwc__otg__hcd_8c.html#4aca8781f512198149388799a8ae9aba">dwc_otg_hcd_urb_set_pipeinfo</a>(dwc_otg_urb, usb_pipedevice(urb-&gt;pipe),
<a name="l00611"></a>00611                                      usb_pipeendpoint(urb-&gt;pipe), ep_type,
<a name="l00612"></a>00612                                      usb_pipein(urb-&gt;pipe),
<a name="l00613"></a>00613                                      usb_maxpacket(urb-&gt;dev, urb-&gt;pipe,
<a name="l00614"></a>00614                                                    !(usb_pipein(urb-&gt;pipe))));
<a name="l00615"></a>00615 
<a name="l00616"></a>00616         buf = urb-&gt;transfer_buffer;
<a name="l00617"></a>00617         <span class="keywordflow">if</span> (hcd-&gt;self.uses_dma) {
<a name="l00618"></a>00618                 <span class="comment">/*</span>
<a name="l00619"></a>00619 <span class="comment">                 * Calculate virtual address from physical address,</span>
<a name="l00620"></a>00620 <span class="comment">                 * because some class driver may not fill transfer_buffer.</span>
<a name="l00621"></a>00621 <span class="comment">                 * In Buffer DMA mode virual address is used,</span>
<a name="l00622"></a>00622 <span class="comment">                 * when handling non DWORD aligned buffers.</span>
<a name="l00623"></a>00623 <span class="comment">                 */</span>
<a name="l00624"></a>00624                 buf = phys_to_virt(urb-&gt;transfer_dma);
<a name="l00625"></a>00625         }
<a name="l00626"></a>00626         
<a name="l00627"></a>00627         <span class="keywordflow">if</span> (!(urb-&gt;transfer_flags &amp; URB_NO_INTERRUPT))
<a name="l00628"></a>00628                 flags |= <a class="code" href="dwc__otg__hcd__if_8h.html#973a9deb7ee08e99abf7cb7adf6a5c72">URB_GIVEBACK_ASAP</a>;
<a name="l00629"></a>00629         <span class="keywordflow">if</span> (urb-&gt;transfer_flags &amp; URB_ZERO_PACKET)
<a name="l00630"></a>00630                 flags |= <a class="code" href="dwc__otg__hcd__if_8h.html#14e576ea3b30c038f925e3e6c80c64fe">URB_SEND_ZERO_PACKET</a>;
<a name="l00631"></a>00631 
<a name="l00632"></a>00632         <a class="code" href="dwc__otg__hcd_8c.html#d141b0ed3f2eac3f8aab2d8cefe34345">dwc_otg_hcd_urb_set_params</a>(dwc_otg_urb, urb, buf,
<a name="l00633"></a>00633                                    urb-&gt;transfer_dma,
<a name="l00634"></a>00634                                    urb-&gt;transfer_buffer_length,
<a name="l00635"></a>00635                                    urb-&gt;<a class="code" href="structdwc__otg__hcd__urb.html#254afd954f3e24bb92841384183a317c">setup_packet</a>, 
<a name="l00636"></a>00636                                    urb-&gt;setup_dma,
<a name="l00637"></a>00637                                    flags,
<a name="l00638"></a>00638                                    urb-&gt;interval);
<a name="l00639"></a>00639 
<a name="l00640"></a>00640         <span class="keywordflow">for</span> (i = 0; i &lt; urb-&gt;number_of_packets; ++i) {
<a name="l00641"></a>00641                 <a class="code" href="dwc__otg__hcd_8c.html#8617e93eba1bfd6466a9af1e6d2f731b">dwc_otg_hcd_urb_set_iso_desc_params</a>(dwc_otg_urb, i,
<a name="l00642"></a>00642                                                     urb-&gt;iso_frame_desc[i].
<a name="l00643"></a>00643                                                     offset,
<a name="l00644"></a>00644                                                     urb-&gt;iso_frame_desc[i].
<a name="l00645"></a>00645                                                     length);
<a name="l00646"></a>00646         }
<a name="l00647"></a>00647 
<a name="l00648"></a>00648         urb-&gt;hcpriv = dwc_otg_urb;
<a name="l00649"></a>00649         retval = <a class="code" href="dwc__otg__hcd_8c.html#e8129fbc0a4073f0a5f64fa3b0f5127b">dwc_otg_hcd_urb_enqueue</a>(dwc_otg_hcd, dwc_otg_urb, &amp;ep-&gt;hcpriv);
<a name="l00650"></a>00650         <span class="keywordflow">if</span> (!retval) {
<a name="l00651"></a>00651                 <span class="keywordflow">if</span> (alloc_bandwidth) {
<a name="l00652"></a>00652                         <a class="code" href="dwc__otg__hcd__linux_8c.html#e270a6a091a674ccf6f390fdcf746b87">allocate_bus_bandwidth</a>(hcd,
<a name="l00653"></a>00653                                                <a class="code" href="dwc__otg__hcd_8c.html#bd160be911ccc8f90141dae9c40276eb">dwc_otg_hcd_get_ep_bandwidth</a>
<a name="l00654"></a>00654                                                (dwc_otg_hcd, ep-&gt;hcpriv), urb);
<a name="l00655"></a>00655                 }
<a name="l00656"></a>00656         } <span class="keywordflow">else</span> {
<a name="l00657"></a>00657                 <span class="keywordflow">if</span> (retval == -DWC_E_NO_DEVICE) {
<a name="l00658"></a>00658                         retval = -ENODEV;
<a name="l00659"></a>00659                 }
<a name="l00660"></a>00660         }
<a name="l00661"></a>00661 
<a name="l00662"></a>00662         <span class="keywordflow">return</span> retval;
<a name="l00663"></a>00663 }
<a name="l00664"></a>00664 
<a name="l00667"></a><a class="code" href="dwc__otg__hcd__linux_8c.html#afc1f3d92fd7596140c0068bc96034f7">00667</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__hcd__linux_8c.html#afc1f3d92fd7596140c0068bc96034f7">urb_dequeue</a>(<span class="keyword">struct</span> usb_hcd *hcd, <span class="keyword">struct</span> urb *urb)
<a name="l00668"></a>00668 {
<a name="l00669"></a>00669         <a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> *<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd</a>;
<a name="l00670"></a>00670         <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#e4a050e176c1c4f556da2b276a8c2b37">DBG_HCD</a>, <span class="stringliteral">"DWC OTG HCD URB Dequeue\n"</span>);
<a name="l00671"></a>00671 
<a name="l00672"></a>00672         dwc_otg_hcd = <a class="code" href="dwc__otg__hcd__linux_8c.html#bd8c86466ccd8ff8b94867d601e66116">hcd_to_dwc_otg_hcd</a>(hcd);
<a name="l00673"></a>00673 
<a name="l00674"></a>00674 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l00675"></a>00675 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="dwc__otg__dbg_8h.html#7a96217c88a4d786f6cb3d4df09dee04">CHK_DEBUG_LEVEL</a>(<a class="code" href="dwc__otg__dbg_8h.html#39931d908ba215b3d5d590e42d8408b5">DBG_HCDV</a> | <a class="code" href="dwc__otg__dbg_8h.html#737e22e02729647d12db8e3059ad06c9">DBG_HCD_URB</a>)) {
<a name="l00676"></a>00676                 dump_urb_info(urb, <span class="stringliteral">"urb_dequeue"</span>);
<a name="l00677"></a>00677         }
<a name="l00678"></a>00678 <span class="preprocessor">#endif</span>
<a name="l00679"></a>00679 <span class="preprocessor"></span>        <a class="code" href="dwc__otg__hcd_8c.html#8844d0e14480b7f0dcf5c8120cc20a4f">dwc_otg_hcd_urb_dequeue</a>(dwc_otg_hcd, urb-&gt;hcpriv);
<a name="l00680"></a>00680 
<a name="l00681"></a>00681         dwc_free(urb-&gt;hcpriv);
<a name="l00682"></a>00682         urb-&gt;hcpriv = NULL;
<a name="l00683"></a>00683 
<a name="l00684"></a>00684         <span class="comment">/* Higher layer software sets URB status. */</span>
<a name="l00685"></a>00685         usb_hcd_giveback_urb(hcd, urb);
<a name="l00686"></a>00686         <span class="keywordflow">if</span> (<a class="code" href="dwc__otg__dbg_8h.html#7a96217c88a4d786f6cb3d4df09dee04">CHK_DEBUG_LEVEL</a>(<a class="code" href="dwc__otg__dbg_8h.html#39931d908ba215b3d5d590e42d8408b5">DBG_HCDV</a> | <a class="code" href="dwc__otg__dbg_8h.html#737e22e02729647d12db8e3059ad06c9">DBG_HCD_URB</a>)) {
<a name="l00687"></a>00687                 DWC_PRINTF(<span class="stringliteral">"Called usb_hcd_giveback_urb()\n"</span>);
<a name="l00688"></a>00688                 DWC_PRINTF(<span class="stringliteral">"  urb-&gt;status = %d\n"</span>, urb-&gt;status);
<a name="l00689"></a>00689         }
<a name="l00690"></a>00690 
<a name="l00691"></a>00691         <span class="keywordflow">return</span> 0;
<a name="l00692"></a>00692 }
<a name="l00693"></a>00693 
<a name="l00694"></a>00694 <span class="comment">/* Frees resources in the DWC_otg controller related to a given endpoint. Also</span>
<a name="l00695"></a>00695 <span class="comment"> * clears state in the HCD related to the endpoint. Any URBs for the endpoint</span>
<a name="l00696"></a>00696 <span class="comment"> * must already be dequeued. */</span>
<a name="l00697"></a><a class="code" href="dwc__otg__hcd__linux_8c.html#0aefc084c4c334dac85c95a43e8942c6">00697</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__hcd__linux_8c.html#0aefc084c4c334dac85c95a43e8942c6">endpoint_disable</a>(<span class="keyword">struct</span> usb_hcd *hcd, <span class="keyword">struct</span> usb_host_endpoint *ep)
<a name="l00698"></a>00698 {
<a name="l00699"></a>00699         <a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> *<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd</a> = <a class="code" href="dwc__otg__hcd__linux_8c.html#bd8c86466ccd8ff8b94867d601e66116">hcd_to_dwc_otg_hcd</a>(hcd);
<a name="l00700"></a>00700 
<a name="l00701"></a>00701         <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#e4a050e176c1c4f556da2b276a8c2b37">DBG_HCD</a>,
<a name="l00702"></a>00702                     <span class="stringliteral">"DWC OTG HCD EP DISABLE: _bEndpointAddress=0x%02x, "</span>
<a name="l00703"></a>00703                     <span class="stringliteral">"endpoint=%d\n"</span>, ep-&gt;desc.bEndpointAddress,
<a name="l00704"></a>00704                     <a class="code" href="dwc__otg__hcd__linux_8c.html#4a327046464cd55f8abafc4af8ef74aa">dwc_ep_addr_to_endpoint</a>(ep-&gt;desc.bEndpointAddress));
<a name="l00705"></a>00705         <a class="code" href="dwc__otg__hcd_8c.html#f80e9550161e354c865e3c411d661dbe">dwc_otg_hcd_endpoint_disable</a>(dwc_otg_hcd, ep-&gt;hcpriv, 250);
<a name="l00706"></a>00706         ep-&gt;hcpriv = NULL;
<a name="l00707"></a>00707 }
<a name="l00708"></a>00708 
<a name="l00714"></a><a class="code" href="dwc__otg__hcd__linux_8c.html#1e911926e9d51d6d9d11f11b81da8c3d">00714</a> <span class="keyword">static</span> irqreturn_t <a class="code" href="dwc__otg__hcd__linux_8c.html#1e911926e9d51d6d9d11f11b81da8c3d">dwc_otg_hcd_irq</a>(<span class="keyword">struct</span> usb_hcd *hcd)
<a name="l00715"></a>00715 {
<a name="l00716"></a>00716         <a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> *<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd</a> = <a class="code" href="dwc__otg__hcd__linux_8c.html#bd8c86466ccd8ff8b94867d601e66116">hcd_to_dwc_otg_hcd</a>(hcd);
<a name="l00717"></a>00717         int32_t retval = <a class="code" href="dwc__otg__hcd_8h.html#b9dde24773f2741b9ff67e2d46760dc0">dwc_otg_hcd_handle_intr</a>(dwc_otg_hcd);
<a name="l00718"></a>00718         <span class="keywordflow">if</span> (retval != 0) {
<a name="l00719"></a>00719                 <a class="code" href="dwc__otg__driver_8h.html#3af7bafbb69f04a0fd36a27fae7e8497">S3C2410X_CLEAR_EINTPEND</a>();
<a name="l00720"></a>00720         }
<a name="l00721"></a>00721         <span class="keywordflow">return</span> IRQ_RETVAL(retval);
<a name="l00722"></a>00722 }
<a name="l00723"></a>00723 
<a name="l00728"></a><a class="code" href="dwc__otg__hcd__linux_8c.html#108442f4aa4dc4663d8659241ed04e9c">00728</a> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__hcd__linux_8c.html#108442f4aa4dc4663d8659241ed04e9c">hub_status_data</a>(<span class="keyword">struct</span> usb_hcd *hcd, <span class="keywordtype">char</span> *buf)
<a name="l00729"></a>00729 {
<a name="l00730"></a>00730         <a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> *<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd</a> = <a class="code" href="dwc__otg__hcd__linux_8c.html#bd8c86466ccd8ff8b94867d601e66116">hcd_to_dwc_otg_hcd</a>(hcd);
<a name="l00731"></a>00731 
<a name="l00732"></a>00732         buf[0] = 0;
<a name="l00733"></a>00733         buf[0] |= (<a class="code" href="dwc__otg__hcd_8c.html#0d324c8dbb0c7cbadec8cebf943fc84b">dwc_otg_hcd_is_status_changed</a>(dwc_otg_hcd, 1)) &lt;&lt; 1;
<a name="l00734"></a>00734 
<a name="l00735"></a>00735         <span class="keywordflow">return</span> (buf[0] != 0);
<a name="l00736"></a>00736 }
<a name="l00737"></a>00737 
<a name="l00739"></a><a class="code" href="dwc__otg__hcd__linux_8c.html#55d196cab99083dabdacdee78dc5e339">00739</a> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__hcd__linux_8c.html#55d196cab99083dabdacdee78dc5e339">hub_control</a>(<span class="keyword">struct</span> usb_hcd *hcd,
<a name="l00740"></a>00740                 u16 typeReq, u16 wValue, u16 wIndex, <span class="keywordtype">char</span> *buf, u16 wLength)
<a name="l00741"></a>00741 {
<a name="l00742"></a>00742         <span class="keywordtype">int</span> retval;
<a name="l00743"></a>00743 
<a name="l00744"></a>00744         retval = <a class="code" href="dwc__otg__hcd_8c.html#e3bd4e9d1f641cdd29df6633bfb1ebd2">dwc_otg_hcd_hub_control</a>(<a class="code" href="dwc__otg__hcd__linux_8c.html#bd8c86466ccd8ff8b94867d601e66116">hcd_to_dwc_otg_hcd</a>(hcd),
<a name="l00745"></a>00745                                          typeReq, wValue, wIndex, buf, wLength);
<a name="l00746"></a>00746 
<a name="l00747"></a>00747         <span class="keywordflow">switch</span> (retval) {
<a name="l00748"></a>00748         <span class="keywordflow">case</span> -DWC_E_INVALID:
<a name="l00749"></a>00749                 retval = -EINVAL;
<a name="l00750"></a>00750                 <span class="keywordflow">break</span>;
<a name="l00751"></a>00751         }
<a name="l00752"></a>00752 
<a name="l00753"></a>00753         <span class="keywordflow">return</span> retval;
<a name="l00754"></a>00754 }
<a name="l00755"></a>00755 
<a name="l00756"></a>00756 <span class="preprocessor">#endif                          </span><span class="comment">/* DWC_DEVICE_ONLY */</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Tue May 5 02:22:48 2009 for DesignWare USB 2.0 OTG Controller (DWC_otg) Device Driver by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.7 </small></address>
</body>
</html>
