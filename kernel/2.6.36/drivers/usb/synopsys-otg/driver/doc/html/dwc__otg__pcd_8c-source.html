<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>DesignWare USB 2.0 OTG Controller (DWC_otg) Device Driver: dwc_otg_pcd.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.7 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>Globals</span></a></li>
  </ul></div>
<h1>dwc_otg_pcd.c</h1><a href="dwc__otg__pcd_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/* ==========================================================================</span>
<a name="l00002"></a>00002 <span class="comment"> * $File: //dwh/usb_iip/dev/software/otg/linux/drivers/dwc_otg_pcd.c $</span>
<a name="l00003"></a>00003 <span class="comment"> * $Revision: #79 $</span>
<a name="l00004"></a>00004 <span class="comment"> * $Date: 2009/04/10 $</span>
<a name="l00005"></a>00005 <span class="comment"> * $Change: 1230501 $</span>
<a name="l00006"></a>00006 <span class="comment"> *</span>
<a name="l00007"></a>00007 <span class="comment"> * Synopsys HS OTG Linux Software Driver and documentation (hereinafter,</span>
<a name="l00008"></a>00008 <span class="comment"> * "Software") is an Unsupported proprietary work of Synopsys, Inc. unless</span>
<a name="l00009"></a>00009 <span class="comment"> * otherwise expressly agreed to in writing between Synopsys and you.</span>
<a name="l00010"></a>00010 <span class="comment"> *</span>
<a name="l00011"></a>00011 <span class="comment"> * The Software IS NOT an item of Licensed Software or Licensed Product under</span>
<a name="l00012"></a>00012 <span class="comment"> * any End User Software License Agreement or Agreement for Licensed Product</span>
<a name="l00013"></a>00013 <span class="comment"> * with Synopsys or any supplement thereto. You are permitted to use and</span>
<a name="l00014"></a>00014 <span class="comment"> * redistribute this Software in source and binary forms, with or without</span>
<a name="l00015"></a>00015 <span class="comment"> * modification, provided that redistributions of source code must retain this</span>
<a name="l00016"></a>00016 <span class="comment"> * notice. You may not view, use, disclose, copy or distribute this file or</span>
<a name="l00017"></a>00017 <span class="comment"> * any information contained herein except pursuant to this license grant from</span>
<a name="l00018"></a>00018 <span class="comment"> * Synopsys. If you do not agree with this notice, including the disclaimer</span>
<a name="l00019"></a>00019 <span class="comment"> * below, then you are not authorized to use the Software.</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * THIS SOFTWARE IS BEING DISTRIBUTED BY SYNOPSYS SOLELY ON AN "AS IS" BASIS</span>
<a name="l00022"></a>00022 <span class="comment"> * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
<a name="l00023"></a>00023 <span class="comment"> * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
<a name="l00024"></a>00024 <span class="comment"> * ARE HEREBY DISCLAIMED. IN NO EVENT SHALL SYNOPSYS BE LIABLE FOR ANY DIRECT,</span>
<a name="l00025"></a>00025 <span class="comment"> * INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES</span>
<a name="l00026"></a>00026 <span class="comment"> * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR</span>
<a name="l00027"></a>00027 <span class="comment"> * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER</span>
<a name="l00028"></a>00028 <span class="comment"> * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</span>
<a name="l00029"></a>00029 <span class="comment"> * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY</span>
<a name="l00030"></a>00030 <span class="comment"> * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH</span>
<a name="l00031"></a>00031 <span class="comment"> * DAMAGE.</span>
<a name="l00032"></a>00032 <span class="comment"> * ========================================================================== */</span>
<a name="l00033"></a>00033 <span class="preprocessor">#ifndef DWC_HOST_ONLY</span>
<a name="l00034"></a>00034 <span class="preprocessor"></span>
<a name="l00051"></a>00051 <span class="preprocessor">#include "<a class="code" href="dwc__otg__pcd_8h.html">dwc_otg_pcd.h</a>"</span>
<a name="l00052"></a>00052 
<a name="l00053"></a>00053 <span class="preprocessor">#ifdef DWC_UTE_CFI</span>
<a name="l00054"></a>00054 <span class="preprocessor"></span><span class="preprocessor">#include "<a class="code" href="dwc__otg__cfi_8h.html">dwc_otg_cfi.h</a>"</span>
<a name="l00055"></a>00055 
<a name="l00056"></a>00056 <span class="keyword">extern</span> <span class="keywordtype">int</span> init_cfi(<a class="code" href="structcfiobject.html">cfiobject_t</a> * cfiobj);
<a name="l00057"></a>00057 <span class="preprocessor">#endif</span>
<a name="l00058"></a>00058 <span class="preprocessor"></span>
<a name="l00059"></a><a class="code" href="dwc__otg__pcd_8c.html#4b46c226fa34cd7fc4ceec2c5e7f8ebe">00059</a> <span class="keyword">static</span> <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> *<a class="code" href="dwc__otg__pcd_8c.html#4b46c226fa34cd7fc4ceec2c5e7f8ebe">get_ep_from_handle</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd, <span class="keywordtype">void</span> *handle)
<a name="l00060"></a>00060 {
<a name="l00061"></a>00061         <span class="keywordtype">int</span> i;
<a name="l00062"></a>00062         <span class="keywordflow">if</span> (pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#14f4f2a41d1305fdc0ec1806d119da89">ep0</a>.<a class="code" href="structdwc__otg__pcd__ep.html#8c8fad971c6c3b1c54d334c7f9b2d03e">priv</a> == handle) {
<a name="l00063"></a>00063                 <span class="keywordflow">return</span> &amp;pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#14f4f2a41d1305fdc0ec1806d119da89">ep0</a>;
<a name="l00064"></a>00064         }
<a name="l00065"></a>00065         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="dwc__otg__core__if_8h.html#bfb88b45545f7685f668ac2f545674ec">MAX_EPS_CHANNELS</a> - 1; i++) {
<a name="l00066"></a>00066                 <span class="keywordflow">if</span> (pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#dbfc8c424ea3add38db96fa87219caa8">in_ep</a>[i].<a class="code" href="structdwc__otg__pcd__ep.html#8c8fad971c6c3b1c54d334c7f9b2d03e">priv</a> == handle)
<a name="l00067"></a>00067                         <span class="keywordflow">return</span> &amp;pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#dbfc8c424ea3add38db96fa87219caa8">in_ep</a>[i];
<a name="l00068"></a>00068                 if (pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#b9e49a1d1fbca5ba9523e27c7108df30">out_ep</a>[i].<a class="code" href="structdwc__otg__pcd__ep.html#8c8fad971c6c3b1c54d334c7f9b2d03e">priv</a> == handle)
<a name="l00069"></a>00069                         <span class="keywordflow">return</span> &amp;pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#b9e49a1d1fbca5ba9523e27c7108df30">out_ep</a>[i];
<a name="l00070"></a>00070         }
<a name="l00071"></a>00071 
<a name="l00072"></a>00072         <span class="keywordflow">return</span> NULL;
<a name="l00073"></a>00073 }
<a name="l00074"></a>00074 
<a name="l00078"></a><a class="code" href="dwc__otg__pcd_8h.html#5c9b20abc81e0f860a8f23c90b10b59e">00078</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd_8c.html#5c9b20abc81e0f860a8f23c90b10b59e">dwc_otg_request_done</a>(<a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> * ep, <a class="code" href="structdwc__otg__pcd__request.html">dwc_otg_pcd_request_t</a> * req,
<a name="l00079"></a>00079                           int32_t status)
<a name="l00080"></a>00080 {
<a name="l00081"></a>00081         <span class="keywordtype">unsigned</span> stopped = ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#cce0e089118d8bf7c6278c21ded70d5a">stopped</a>;
<a name="l00082"></a>00082 
<a name="l00083"></a>00083         <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#fe60e047aac272899de8f63b43df80e7">DBG_PCDV</a>, <span class="stringliteral">"%s(%p)\n"</span>, __func__, ep);
<a name="l00084"></a>00084         DWC_CIRCLEQ_REMOVE_INIT(&amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#71f4fa571dfdc96f62fa4869e6add300">queue</a>, req, queue_entry);
<a name="l00085"></a>00085 
<a name="l00086"></a>00086         <span class="comment">/* don't modify queue heads during completion callback */</span>
<a name="l00087"></a>00087         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#cce0e089118d8bf7c6278c21ded70d5a">stopped</a> = 1;
<a name="l00088"></a>00088         DWC_SPINUNLOCK(ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#234391334e48cbd72710d08655c9ed16">pcd</a>-&gt;<a class="code" href="structdwc__otg__pcd.html#5d450e4d06659ab2f3b18e5c816776e4">lock</a>);
<a name="l00089"></a>00089         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#234391334e48cbd72710d08655c9ed16">pcd</a>-&gt;<a class="code" href="structdwc__otg__pcd.html#b7001dde5db2706707a860da0030d9e6">fops</a>-&gt;<a class="code" href="structdwc__otg__pcd__function__ops.html#126db5e83cd3cc03f303eb3da668816f">complete</a>(ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#234391334e48cbd72710d08655c9ed16">pcd</a>, ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#8c8fad971c6c3b1c54d334c7f9b2d03e">priv</a>, req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#e0d93b64365968aa0dcf58535aecf40c">priv</a>, status,
<a name="l00090"></a>00090                                 req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#0fd7d659f353273d8b2b22027306a2a2">actual</a>);
<a name="l00091"></a>00091         DWC_SPINLOCK(ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#234391334e48cbd72710d08655c9ed16">pcd</a>-&gt;<a class="code" href="structdwc__otg__pcd.html#5d450e4d06659ab2f3b18e5c816776e4">lock</a>);
<a name="l00092"></a>00092 
<a name="l00093"></a>00093         <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#234391334e48cbd72710d08655c9ed16">pcd</a>-&gt;<a class="code" href="structdwc__otg__pcd.html#3a0464b4ac677a7742e9b7c0c820414c">request_pending</a> &gt; 0) {
<a name="l00094"></a>00094                 --ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#234391334e48cbd72710d08655c9ed16">pcd</a>-&gt;<a class="code" href="structdwc__otg__pcd.html#3a0464b4ac677a7742e9b7c0c820414c">request_pending</a>;
<a name="l00095"></a>00095         }
<a name="l00096"></a>00096 
<a name="l00097"></a>00097         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#cce0e089118d8bf7c6278c21ded70d5a">stopped</a> = stopped;
<a name="l00098"></a>00098         dwc_free(req);
<a name="l00099"></a>00099 }
<a name="l00100"></a>00100 
<a name="l00104"></a><a class="code" href="dwc__otg__pcd_8h.html#e8ef6f3d831b89a753d93489827949d3">00104</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd_8c.html#e8ef6f3d831b89a753d93489827949d3">dwc_otg_request_nuke</a>(<a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> * ep)
<a name="l00105"></a>00105 {
<a name="l00106"></a>00106         <a class="code" href="structdwc__otg__pcd__request.html">dwc_otg_pcd_request_t</a> *req;
<a name="l00107"></a>00107 
<a name="l00108"></a>00108         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#cce0e089118d8bf7c6278c21ded70d5a">stopped</a> = 1;
<a name="l00109"></a>00109 
<a name="l00110"></a>00110         <span class="comment">/* called with irqs blocked?? */</span>
<a name="l00111"></a>00111         <span class="keywordflow">while</span> (!DWC_CIRCLEQ_EMPTY(&amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#71f4fa571dfdc96f62fa4869e6add300">queue</a>)) {
<a name="l00112"></a>00112                 req = DWC_CIRCLEQ_FIRST(&amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#71f4fa571dfdc96f62fa4869e6add300">queue</a>);
<a name="l00113"></a>00113                 <a class="code" href="dwc__otg__pcd_8c.html#5c9b20abc81e0f860a8f23c90b10b59e">dwc_otg_request_done</a>(ep, req, -DWC_E_SHUTDOWN);
<a name="l00114"></a>00114         }
<a name="l00115"></a>00115 }
<a name="l00116"></a>00116 
<a name="l00117"></a><a class="code" href="dwc__otg__pcd__if_8h.html#187209231d66bc200444c0d52331d276">00117</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd_8c.html#187209231d66bc200444c0d52331d276">dwc_otg_pcd_start</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd,
<a name="l00118"></a>00118                        <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structdwc__otg__pcd__function__ops.html">dwc_otg_pcd_function_ops</a> *<a class="code" href="dwc__otg__pcd__linux_8c.html#9ce9b5e49c60906c189bee157dd68acd">fops</a>)
<a name="l00119"></a>00119 {
<a name="l00120"></a>00120         pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#b7001dde5db2706707a860da0030d9e6">fops</a> = <a class="code" href="dwc__otg__pcd__linux_8c.html#9ce9b5e49c60906c189bee157dd68acd">fops</a>;
<a name="l00121"></a>00121 }
<a name="l00122"></a>00122 
<a name="l00129"></a><a class="code" href="dwc__otg__pcd_8c.html#81693a91f25fb36b1443d3e597f9e59d">00129</a> <span class="keyword">static</span> int32_t <a class="code" href="dwc__otg__pcd_8c.html#81693a91f25fb36b1443d3e597f9e59d">dwc_otg_pcd_start_cb</a>(<span class="keywordtype">void</span> *p)
<a name="l00130"></a>00130 {
<a name="l00131"></a>00131         <a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> *pcd = (<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> *) p;
<a name="l00132"></a>00132 
<a name="l00133"></a>00133         <span class="comment">/*</span>
<a name="l00134"></a>00134 <span class="comment">         * Initialized the Core for Device mode.</span>
<a name="l00135"></a>00135 <span class="comment">         */</span>
<a name="l00136"></a>00136         <span class="keywordflow">if</span> (<a class="code" href="dwc__otg__cil_8c.html#e83fb22890bc54c6b06cedb751430e77">dwc_otg_is_device_mode</a>(<a class="code" href="dwc__otg__pcd_8h.html#464549f9f4484651efe25b1a03692d72">GET_CORE_IF</a>(pcd))) {
<a name="l00137"></a>00137                 <a class="code" href="dwc__otg__cil_8c.html#f79b0f3b5b96b0535e33627ee3a66eba">dwc_otg_core_dev_init</a>(<a class="code" href="dwc__otg__pcd_8h.html#464549f9f4484651efe25b1a03692d72">GET_CORE_IF</a>(pcd));
<a name="l00138"></a>00138         }
<a name="l00139"></a>00139         <span class="keywordflow">return</span> 1;
<a name="l00140"></a>00140 }
<a name="l00141"></a>00141 
<a name="l00143"></a>00143 <span class="preprocessor">#ifdef DWC_UTE_CFI</span>
<a name="l00144"></a>00144 <span class="preprocessor"></span>uint8_t *<a class="code" href="dwc__otg__pcd_8c.html#3951259aaef3df35d1955076a907f095">cfiw_ep_alloc_buffer</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd, <span class="keywordtype">void</span> *pep, dwc_dma_t * addr,
<a name="l00145"></a>00145                               size_t buflen, <span class="keywordtype">int</span> flags)
<a name="l00146"></a>00146 {
<a name="l00147"></a>00147         <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> *ep;
<a name="l00148"></a>00148         ep = <a class="code" href="dwc__otg__pcd_8c.html#4b46c226fa34cd7fc4ceec2c5e7f8ebe">get_ep_from_handle</a>(pcd, pep);
<a name="l00149"></a>00149         <span class="keywordflow">return</span> pcd-&gt;cfi-&gt;ops.ep_alloc_buf(pcd-&gt;cfi, pcd, ep, addr, buflen,
<a name="l00150"></a>00150                                           flags);
<a name="l00151"></a>00151 }
<a name="l00152"></a>00152 <span class="preprocessor">#else</span>
<a name="l00153"></a>00153 <span class="preprocessor"></span>uint8_t *<a class="code" href="dwc__otg__pcd_8c.html#3951259aaef3df35d1955076a907f095">cfiw_ep_alloc_buffer</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd, <span class="keywordtype">void</span> *pep, dwc_dma_t * addr,
<a name="l00154"></a>00154                               size_t buflen, <span class="keywordtype">int</span> flags);
<a name="l00155"></a>00155 <span class="preprocessor">#endif</span>
<a name="l00156"></a>00156 <span class="preprocessor"></span>
<a name="l00163"></a><a class="code" href="dwc__otg__pcd_8c.html#7bc757d00f936e5e308e950a17281675">00163</a> <span class="keyword">static</span> int32_t <a class="code" href="dwc__otg__pcd_8c.html#7bc757d00f936e5e308e950a17281675">dwc_otg_pcd_resume_cb</a>(<span class="keywordtype">void</span> *p)
<a name="l00164"></a>00164 {
<a name="l00165"></a>00165         <a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> *pcd = (<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> *) p;
<a name="l00166"></a>00166 
<a name="l00167"></a>00167         <span class="keywordflow">if</span> (pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#b7001dde5db2706707a860da0030d9e6">fops</a>-&gt;<a class="code" href="structdwc__otg__pcd__function__ops.html#654870eb85c5356b6a97a514645e5d8c">resume</a>) {
<a name="l00168"></a>00168                 pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#b7001dde5db2706707a860da0030d9e6">fops</a>-&gt;<a class="code" href="structdwc__otg__pcd__function__ops.html#654870eb85c5356b6a97a514645e5d8c">resume</a>(pcd);
<a name="l00169"></a>00169         }
<a name="l00170"></a>00170 
<a name="l00171"></a>00171         <span class="comment">/* Stop the SRP timeout timer. */</span>
<a name="l00172"></a>00172         <span class="keywordflow">if</span> ((<a class="code" href="dwc__otg__pcd_8h.html#464549f9f4484651efe25b1a03692d72">GET_CORE_IF</a>(pcd)-&gt;core_params-&gt;phy_type != <a class="code" href="dwc__otg__core__if_8h.html#f7395410ea596c4c660f61ff41cb38b8">DWC_PHY_TYPE_PARAM_FS</a>)
<a name="l00173"></a>00173             || (!<a class="code" href="dwc__otg__pcd_8h.html#464549f9f4484651efe25b1a03692d72">GET_CORE_IF</a>(pcd)-&gt;core_params-&gt;i2c_enable)) {
<a name="l00174"></a>00174                 <span class="keywordflow">if</span> (<a class="code" href="dwc__otg__pcd_8h.html#464549f9f4484651efe25b1a03692d72">GET_CORE_IF</a>(pcd)-&gt;srp_timer_started) {
<a name="l00175"></a>00175                         <a class="code" href="dwc__otg__pcd_8h.html#464549f9f4484651efe25b1a03692d72">GET_CORE_IF</a>(pcd)-&gt;srp_timer_started = 0;
<a name="l00176"></a>00176                         DWC_TIMER_CANCEL(pcd-&gt;srp_timer);
<a name="l00177"></a>00177                 }
<a name="l00178"></a>00178         }
<a name="l00179"></a>00179         <span class="keywordflow">return</span> 1;
<a name="l00180"></a>00180 }
<a name="l00181"></a>00181 
<a name="l00187"></a><a class="code" href="dwc__otg__pcd_8c.html#41a824bd34aa279d07ba3a17da35cf11">00187</a> <span class="keyword">static</span> int32_t <a class="code" href="dwc__otg__pcd_8c.html#41a824bd34aa279d07ba3a17da35cf11">dwc_otg_pcd_suspend_cb</a>(<span class="keywordtype">void</span> *p)
<a name="l00188"></a>00188 {
<a name="l00189"></a>00189         <a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> *pcd = (<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> *) p;
<a name="l00190"></a>00190 
<a name="l00191"></a>00191         <span class="keywordflow">if</span> (pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#b7001dde5db2706707a860da0030d9e6">fops</a>-&gt;<a class="code" href="structdwc__otg__pcd__function__ops.html#fef8ed359353cb84b7c5ac641d54d296">suspend</a>) {
<a name="l00192"></a>00192                 pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#b7001dde5db2706707a860da0030d9e6">fops</a>-&gt;<a class="code" href="structdwc__otg__pcd__function__ops.html#fef8ed359353cb84b7c5ac641d54d296">suspend</a>(pcd);
<a name="l00193"></a>00193         }
<a name="l00194"></a>00194 
<a name="l00195"></a>00195         <span class="keywordflow">return</span> 1;
<a name="l00196"></a>00196 }
<a name="l00197"></a>00197 
<a name="l00204"></a><a class="code" href="dwc__otg__pcd_8c.html#00e06d719bfc4fa4c40c8a06a88eb052">00204</a> <span class="keyword">static</span> int32_t <a class="code" href="dwc__otg__pcd_8c.html#00e06d719bfc4fa4c40c8a06a88eb052">dwc_otg_pcd_stop_cb</a>(<span class="keywordtype">void</span> *p)
<a name="l00205"></a>00205 {
<a name="l00206"></a>00206         <a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> *pcd = (<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> *) p;
<a name="l00207"></a>00207         <span class="keyword">extern</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd__intr_8c.html#19e17d6a73d8a3ebf00a1d11999a5ff9">dwc_otg_pcd_stop</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * _pcd);
<a name="l00208"></a>00208 
<a name="l00209"></a>00209         <a class="code" href="dwc__otg__pcd__intr_8c.html#19e17d6a73d8a3ebf00a1d11999a5ff9">dwc_otg_pcd_stop</a>(pcd);
<a name="l00210"></a>00210         <span class="keywordflow">return</span> 1;
<a name="l00211"></a>00211 }
<a name="l00212"></a>00212 
<a name="l00216"></a><a class="code" href="dwc__otg__pcd_8c.html#c360aaa36ba28b977284fd482e7bc5ca">00216</a> <span class="keyword">static</span> <a class="code" href="structdwc__otg__cil__callbacks.html">dwc_otg_cil_callbacks_t</a> <a class="code" href="dwc__otg__pcd_8c.html#c360aaa36ba28b977284fd482e7bc5ca">pcd_callbacks</a> = {
<a name="l00217"></a>00217         .<a class="code" href="structdwc__otg__cil__callbacks.html#ebb662b2e0b4d187648b7f91b9d00713">start</a> = <a class="code" href="dwc__otg__pcd_8c.html#81693a91f25fb36b1443d3e597f9e59d">dwc_otg_pcd_start_cb</a>,
<a name="l00218"></a>00218         .stop = <a class="code" href="dwc__otg__pcd_8c.html#00e06d719bfc4fa4c40c8a06a88eb052">dwc_otg_pcd_stop_cb</a>,
<a name="l00219"></a>00219         .suspend = <a class="code" href="dwc__otg__pcd_8c.html#41a824bd34aa279d07ba3a17da35cf11">dwc_otg_pcd_suspend_cb</a>,
<a name="l00220"></a>00220         .resume_wakeup = <a class="code" href="dwc__otg__pcd_8c.html#7bc757d00f936e5e308e950a17281675">dwc_otg_pcd_resume_cb</a>,
<a name="l00221"></a>00221         .p = 0,                 <span class="comment">/* Set at registration */</span>
<a name="l00222"></a>00222 };
<a name="l00223"></a>00223 
<a name="l00228"></a><a class="code" href="dwc__otg__pcd_8c.html#18b4a856523673f3bf97b676c8d9717e">00228</a> <a class="code" href="structdwc__otg__dev__dma__desc.html">dwc_otg_dev_dma_desc_t</a> *<a class="code" href="dwc__otg__pcd_8c.html#18b4a856523673f3bf97b676c8d9717e">dwc_otg_ep_alloc_desc_chain</a>(uint32_t * dma_desc_addr,
<a name="l00229"></a>00229                                                 uint32_t count)
<a name="l00230"></a>00230 {
<a name="l00231"></a>00231 
<a name="l00232"></a>00232         <span class="keywordflow">return</span> dwc_dma_alloc(count * <span class="keyword">sizeof</span>(<a class="code" href="structdwc__otg__dev__dma__desc.html">dwc_otg_dev_dma_desc_t</a>), dma_desc_addr);
<a name="l00233"></a>00233 }
<a name="l00234"></a>00234 
<a name="l00238"></a><a class="code" href="dwc__otg__pcd_8c.html#1926b61a7438bd9a14bd6d6a26c6a63d">00238</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd_8c.html#1926b61a7438bd9a14bd6d6a26c6a63d">dwc_otg_ep_free_desc_chain</a>(<a class="code" href="structdwc__otg__dev__dma__desc.html">dwc_otg_dev_dma_desc_t</a> * desc_addr,
<a name="l00239"></a>00239                                 uint32_t dma_desc_addr, uint32_t count)
<a name="l00240"></a>00240 {
<a name="l00241"></a>00241         dwc_dma_free(count * <span class="keyword">sizeof</span>(<a class="code" href="structdwc__otg__dev__dma__desc.html">dwc_otg_dev_dma_desc_t</a>), desc_addr,
<a name="l00242"></a>00242                      dma_desc_addr);
<a name="l00243"></a>00243 }
<a name="l00244"></a>00244 
<a name="l00245"></a>00245 <span class="preprocessor">#ifdef DWC_EN_ISOC</span>
<a name="l00246"></a>00246 <span class="preprocessor"></span>
<a name="l00254"></a><a class="code" href="dwc__otg__pcd_8c.html#456f7e798e18c0b169fc196fb305e2ea">00254</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd_8c.html#456f7e798e18c0b169fc196fb305e2ea">dwc_otg_iso_ep_start_ddma_transfer</a>(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if,
<a name="l00255"></a>00255                                         <a class="code" href="structdwc__ep.html">dwc_ep_t</a> * <a class="code" href="structdwc__ep.html">dwc_ep</a>)
<a name="l00256"></a>00256 {
<a name="l00257"></a>00257 
<a name="l00258"></a>00258         <a class="code" href="uniondsts__data.html">dsts_data_t</a> dsts = {.d32 = 0 };
<a name="l00259"></a>00259         <a class="code" href="uniondepctl__data.html">depctl_data_t</a> depctl = {.d32 = 0 };
<a name="l00260"></a>00260         <span class="keyword">volatile</span> uint32_t *addr;
<a name="l00261"></a>00261         <span class="keywordtype">int</span> i, j;
<a name="l00262"></a>00262 
<a name="l00263"></a>00263         <span class="keywordflow">if</span> (dwc_ep-&gt;<a class="code" href="structdwc__ep.html#b882b6b7c857100ed20600e94ea37760">is_in</a>)
<a name="l00264"></a>00264                 dwc_ep-&gt;<a class="code" href="structdwc__ep.html#5e5bfcc93d41670bc0d29ad5f0f35871">desc_cnt</a> = dwc_ep-&gt;<a class="code" href="structdwc__ep.html#4638b25387e59a5a4721a503b5279dfc">buf_proc_intrvl</a> / dwc_ep-&gt;<a class="code" href="structdwc__ep.html#d9e9ffe348764ababc3165ed04f9ec6c">bInterval</a>;
<a name="l00265"></a>00265         <span class="keywordflow">else</span>
<a name="l00266"></a>00266                 dwc_ep-&gt;<a class="code" href="structdwc__ep.html#5e5bfcc93d41670bc0d29ad5f0f35871">desc_cnt</a> =
<a name="l00267"></a>00267                     dwc_ep-&gt;<a class="code" href="structdwc__ep.html#4638b25387e59a5a4721a503b5279dfc">buf_proc_intrvl</a> * dwc_ep-&gt;<a class="code" href="structdwc__ep.html#fe51420474de8a9d74fc9c4adc811c4b">pkt_per_frm</a> /
<a name="l00268"></a>00268                     dwc_ep-&gt;<a class="code" href="structdwc__ep.html#d9e9ffe348764ababc3165ed04f9ec6c">bInterval</a>;
<a name="l00269"></a>00269 
<a name="l00271"></a>00271         dwc_ep-&gt;<a class="code" href="structdwc__ep.html#a4e11d12099ad64dd5048a3a210fc9f6">iso_desc_addr</a> =
<a name="l00272"></a>00272             <a class="code" href="dwc__otg__pcd_8c.html#18b4a856523673f3bf97b676c8d9717e">dwc_otg_ep_alloc_desc_chain</a>(&amp;dwc_ep-&gt;<a class="code" href="structdwc__ep.html#d571f49545171ea167193edac7984173">iso_dma_desc_addr</a>,
<a name="l00273"></a>00273                                         dwc_ep-&gt;<a class="code" href="structdwc__ep.html#5e5bfcc93d41670bc0d29ad5f0f35871">desc_cnt</a> * 2);
<a name="l00274"></a>00274         <span class="keywordflow">if</span> (dwc_ep-&gt;<a class="code" href="structdwc__ep.html#57e934b26e76939912eaa76321075a0d">desc_addr</a>) {
<a name="l00275"></a>00275                 DWC_WARN(<span class="stringliteral">"%s, can't allocate DMA descriptor chain\n"</span>, __func__);
<a name="l00276"></a>00276                 <span class="keywordflow">return</span>;
<a name="l00277"></a>00277         }
<a name="l00278"></a>00278 
<a name="l00279"></a>00279         dsts.<a class="code" href="uniondsts__data.html#0f126daef735b142b06dbc4cdbe13814">d32</a> = dwc_read_reg32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#a0ed84d057445e2acd4c793f10f91078">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#e261921bab2e67ccc69007fc485d7f82">dev_global_regs</a>-&gt;<a class="code" href="structdwc__otg__dev__global__regs.html#1ed00edd20ce5db7d07666804101ec05">dsts</a>);
<a name="l00280"></a>00280 
<a name="l00282"></a>00282         <span class="keywordflow">if</span> (dwc_ep-&gt;<a class="code" href="structdwc__ep.html#b882b6b7c857100ed20600e94ea37760">is_in</a> == 0) {
<a name="l00283"></a>00283                 <a class="code" href="uniondev__dma__desc__sts.html">dev_dma_desc_sts_t</a> sts = {.d32 = 0 };
<a name="l00284"></a>00284                 <a class="code" href="structdwc__otg__dev__dma__desc.html">dwc_otg_dev_dma_desc_t</a> *dma_desc = dwc_ep-&gt;<a class="code" href="structdwc__ep.html#a4e11d12099ad64dd5048a3a210fc9f6">iso_desc_addr</a>;
<a name="l00285"></a>00285                 dma_addr_t dma_ad;
<a name="l00286"></a>00286                 uint32_t data_per_desc;
<a name="l00287"></a>00287                 <a class="code" href="structdwc__otg__dev__out__ep__regs.html">dwc_otg_dev_out_ep_regs_t</a> *out_regs =
<a name="l00288"></a>00288                     core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#a0ed84d057445e2acd4c793f10f91078">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#9cc0e6b18b00e44c5d4b46a8ff460384">out_ep_regs</a>[dwc_ep-&gt;<a class="code" href="structdwc__ep.html#1dd76dafde9ac2a466d64a5acbc35214">num</a>];
<a name="l00289"></a>00289                 <span class="keywordtype">int</span> offset;
<a name="l00290"></a>00290 
<a name="l00291"></a>00291                 addr = &amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#a0ed84d057445e2acd4c793f10f91078">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#9cc0e6b18b00e44c5d4b46a8ff460384">out_ep_regs</a>[dwc_ep-&gt;<a class="code" href="structdwc__ep.html#1dd76dafde9ac2a466d64a5acbc35214">num</a>]-&gt;<a class="code" href="structdwc__otg__dev__out__ep__regs.html#2a522b71fc97658c07debf3521f7d3e5">doepctl</a>;
<a name="l00292"></a>00292                 dma_ad = (dma_addr_t) dwc_read_reg32(&amp;(out_regs-&gt;<a class="code" href="structdwc__otg__dev__out__ep__regs.html#006071bf54bfa1c1f5e25cf4c9f65cb1">doepdma</a>));
<a name="l00293"></a>00293 
<a name="l00295"></a>00295                 dma_ad = dwc_ep-&gt;<a class="code" href="structdwc__ep.html#553936d1d003413d00a24330274887f9">dma_addr0</a>;
<a name="l00296"></a>00296 
<a name="l00297"></a>00297                 sts.<a class="code" href="uniondev__dma__desc__sts.html#214ba099b6077c3393b179cf9a7909f7">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#05d1c1d8f6c5a1967c51c5d0e2e04261">bs</a> = <a class="code" href="dwc__otg__regs_8h.html#c2cfc53da94087a90d21d3528b005bcf">BS_HOST_READY</a>;
<a name="l00298"></a>00298                 sts.<a class="code" href="uniondev__dma__desc__sts.html#214ba099b6077c3393b179cf9a7909f7">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#a80809cda5b19b3e36f512effef795f0">rxsts</a> = 0;
<a name="l00299"></a>00299                 sts.<a class="code" href="uniondev__dma__desc__sts.html#214ba099b6077c3393b179cf9a7909f7">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#b728a79d6a86a0d1b6426a1b2627f2c2">l</a> = 0;
<a name="l00300"></a>00300                 sts.<a class="code" href="uniondev__dma__desc__sts.html#214ba099b6077c3393b179cf9a7909f7">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#a850ddfa13601227c05e0ae43a538a9d">sp</a> = 0;
<a name="l00301"></a>00301                 sts.<a class="code" href="uniondev__dma__desc__sts.html#214ba099b6077c3393b179cf9a7909f7">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#02c8be72ef6258c25094478c7cac0b12">ioc</a> = 0;
<a name="l00302"></a>00302                 sts.<a class="code" href="uniondev__dma__desc__sts.html#214ba099b6077c3393b179cf9a7909f7">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#79bf5fe6d9949ddb671daa14b5ee298e">pid</a> = 0;
<a name="l00303"></a>00303                 sts.<a class="code" href="uniondev__dma__desc__sts.html#214ba099b6077c3393b179cf9a7909f7">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#d9da3eccc6d247e2b5eccd4dfba7874e">framenum</a> = 0;
<a name="l00304"></a>00304 
<a name="l00305"></a>00305                 offset = 0;
<a name="l00306"></a>00306                 <span class="keywordflow">for</span> (i = 0; i &lt; dwc_ep-&gt;<a class="code" href="structdwc__ep.html#5e5bfcc93d41670bc0d29ad5f0f35871">desc_cnt</a> - dwc_ep-&gt;<a class="code" href="structdwc__ep.html#fe51420474de8a9d74fc9c4adc811c4b">pkt_per_frm</a>;
<a name="l00307"></a>00307                      i += dwc_ep-&gt;<a class="code" href="structdwc__ep.html#fe51420474de8a9d74fc9c4adc811c4b">pkt_per_frm</a>) {
<a name="l00308"></a>00308 
<a name="l00309"></a>00309                         <span class="keywordflow">for</span> (j = 0; j &lt; dwc_ep-&gt;<a class="code" href="structdwc__ep.html#fe51420474de8a9d74fc9c4adc811c4b">pkt_per_frm</a>; ++j) {
<a name="l00310"></a>00310                                 data_per_desc =
<a name="l00311"></a>00311                                     ((j + 1) * dwc_ep-&gt;<a class="code" href="structdwc__ep.html#d17473ece3c9a34f5e7a230d3315de94">maxpacket</a> &gt;
<a name="l00312"></a>00312                                      dwc_ep-&gt;<a class="code" href="structdwc__ep.html#4672369f4724db642856d72d5048213e">data_per_frame</a>) ? dwc_ep-&gt;
<a name="l00313"></a>00313                                     data_per_frame -
<a name="l00314"></a>00314                                     j * dwc_ep-&gt;<a class="code" href="structdwc__ep.html#d17473ece3c9a34f5e7a230d3315de94">maxpacket</a> : dwc_ep-&gt;<a class="code" href="structdwc__ep.html#d17473ece3c9a34f5e7a230d3315de94">maxpacket</a>;
<a name="l00315"></a>00315 
<a name="l00316"></a>00316                                 data_per_desc +=
<a name="l00317"></a>00317                                     (data_per_desc % 4) ? (4 -
<a name="l00318"></a>00318                                                            data_per_desc %
<a name="l00319"></a>00319                                                            4) : 0;
<a name="l00320"></a>00320                                 sts.<a class="code" href="uniondev__dma__desc__sts.html#214ba099b6077c3393b179cf9a7909f7">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#ede78801cd7bc514474fcbe1ef154e5a">rxbytes</a> = data_per_desc;
<a name="l00321"></a>00321                                 dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#0454dad420ef536fe5eb7c38ef764430">buf</a> = dma_ad;
<a name="l00322"></a>00322                                 dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#ab81bc9b2bca330e2dda8941b17c85ba">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#fb77b9c4ab63304073542ed2b118a64b">d32</a> = sts.<a class="code" href="uniondev__dma__desc__sts.html#fb77b9c4ab63304073542ed2b118a64b">d32</a>;
<a name="l00323"></a>00323 
<a name="l00324"></a>00324                                 offset += data_per_desc;
<a name="l00325"></a>00325                                 dma_desc++;
<a name="l00326"></a>00326                                 dma_ad += data_per_desc;
<a name="l00327"></a>00327                         }
<a name="l00328"></a>00328                 }
<a name="l00329"></a>00329 
<a name="l00330"></a>00330                 <span class="keywordflow">for</span> (j = 0; j &lt; dwc_ep-&gt;<a class="code" href="structdwc__ep.html#fe51420474de8a9d74fc9c4adc811c4b">pkt_per_frm</a> - 1; ++j) {
<a name="l00331"></a>00331                         data_per_desc =
<a name="l00332"></a>00332                             ((j + 1) * dwc_ep-&gt;<a class="code" href="structdwc__ep.html#d17473ece3c9a34f5e7a230d3315de94">maxpacket</a> &gt;
<a name="l00333"></a>00333                              dwc_ep-&gt;<a class="code" href="structdwc__ep.html#4672369f4724db642856d72d5048213e">data_per_frame</a>) ? dwc_ep-&gt;<a class="code" href="structdwc__ep.html#4672369f4724db642856d72d5048213e">data_per_frame</a> -
<a name="l00334"></a>00334                             j * dwc_ep-&gt;<a class="code" href="structdwc__ep.html#d17473ece3c9a34f5e7a230d3315de94">maxpacket</a> : dwc_ep-&gt;<a class="code" href="structdwc__ep.html#d17473ece3c9a34f5e7a230d3315de94">maxpacket</a>;
<a name="l00335"></a>00335                         data_per_desc +=
<a name="l00336"></a>00336                             (data_per_desc % 4) ? (4 - data_per_desc % 4) : 0;
<a name="l00337"></a>00337                         sts.<a class="code" href="uniondev__dma__desc__sts.html#214ba099b6077c3393b179cf9a7909f7">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#ede78801cd7bc514474fcbe1ef154e5a">rxbytes</a> = data_per_desc;
<a name="l00338"></a>00338                         dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#0454dad420ef536fe5eb7c38ef764430">buf</a> = dma_ad;
<a name="l00339"></a>00339                         dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#ab81bc9b2bca330e2dda8941b17c85ba">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#fb77b9c4ab63304073542ed2b118a64b">d32</a> = sts.<a class="code" href="uniondev__dma__desc__sts.html#fb77b9c4ab63304073542ed2b118a64b">d32</a>;
<a name="l00340"></a>00340 
<a name="l00341"></a>00341                         offset += data_per_desc;
<a name="l00342"></a>00342                         dma_desc++;
<a name="l00343"></a>00343                         dma_ad += data_per_desc;
<a name="l00344"></a>00344                 }
<a name="l00345"></a>00345 
<a name="l00346"></a>00346                 sts.<a class="code" href="uniondev__dma__desc__sts.html#214ba099b6077c3393b179cf9a7909f7">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#02c8be72ef6258c25094478c7cac0b12">ioc</a> = 1;
<a name="l00347"></a>00347                 data_per_desc =
<a name="l00348"></a>00348                     ((j + 1) * dwc_ep-&gt;<a class="code" href="structdwc__ep.html#d17473ece3c9a34f5e7a230d3315de94">maxpacket</a> &gt;
<a name="l00349"></a>00349                      dwc_ep-&gt;<a class="code" href="structdwc__ep.html#4672369f4724db642856d72d5048213e">data_per_frame</a>) ? dwc_ep-&gt;<a class="code" href="structdwc__ep.html#4672369f4724db642856d72d5048213e">data_per_frame</a> -
<a name="l00350"></a>00350                     j * dwc_ep-&gt;<a class="code" href="structdwc__ep.html#d17473ece3c9a34f5e7a230d3315de94">maxpacket</a> : dwc_ep-&gt;<a class="code" href="structdwc__ep.html#d17473ece3c9a34f5e7a230d3315de94">maxpacket</a>;
<a name="l00351"></a>00351                 data_per_desc +=
<a name="l00352"></a>00352                     (data_per_desc % 4) ? (4 - data_per_desc % 4) : 0;
<a name="l00353"></a>00353                 sts.<a class="code" href="uniondev__dma__desc__sts.html#214ba099b6077c3393b179cf9a7909f7">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#ede78801cd7bc514474fcbe1ef154e5a">rxbytes</a> = data_per_desc;
<a name="l00354"></a>00354 
<a name="l00355"></a>00355                 dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#0454dad420ef536fe5eb7c38ef764430">buf</a> = dma_ad;
<a name="l00356"></a>00356                 dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#ab81bc9b2bca330e2dda8941b17c85ba">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#fb77b9c4ab63304073542ed2b118a64b">d32</a> = sts.<a class="code" href="uniondev__dma__desc__sts.html#fb77b9c4ab63304073542ed2b118a64b">d32</a>;
<a name="l00357"></a>00357                 dma_desc++;
<a name="l00358"></a>00358 
<a name="l00360"></a>00360                 sts.<a class="code" href="uniondev__dma__desc__sts.html#214ba099b6077c3393b179cf9a7909f7">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#02c8be72ef6258c25094478c7cac0b12">ioc</a> = 0;
<a name="l00361"></a>00361                 dma_ad = dwc_ep-&gt;<a class="code" href="structdwc__ep.html#02dc1be77d505b19f14651fe9805c97f">dma_addr1</a>;
<a name="l00362"></a>00362 
<a name="l00363"></a>00363                 offset = 0;
<a name="l00364"></a>00364                 for (i = 0; i &lt; dwc_ep-&gt;<a class="code" href="structdwc__ep.html#5e5bfcc93d41670bc0d29ad5f0f35871">desc_cnt</a> - dwc_ep-&gt;<a class="code" href="structdwc__ep.html#fe51420474de8a9d74fc9c4adc811c4b">pkt_per_frm</a>;
<a name="l00365"></a>00365                      i += dwc_ep-&gt;<a class="code" href="structdwc__ep.html#fe51420474de8a9d74fc9c4adc811c4b">pkt_per_frm</a>) {
<a name="l00366"></a>00366                         <span class="keywordflow">for</span> (j = 0; j &lt; dwc_ep-&gt;<a class="code" href="structdwc__ep.html#fe51420474de8a9d74fc9c4adc811c4b">pkt_per_frm</a>; ++j) {
<a name="l00367"></a>00367                                 data_per_desc =
<a name="l00368"></a>00368                                     ((j + 1) * dwc_ep-&gt;<a class="code" href="structdwc__ep.html#d17473ece3c9a34f5e7a230d3315de94">maxpacket</a> &gt;
<a name="l00369"></a>00369                                      dwc_ep-&gt;<a class="code" href="structdwc__ep.html#4672369f4724db642856d72d5048213e">data_per_frame</a>) ? dwc_ep-&gt;
<a name="l00370"></a>00370                                     data_per_frame -
<a name="l00371"></a>00371                                     j * dwc_ep-&gt;<a class="code" href="structdwc__ep.html#d17473ece3c9a34f5e7a230d3315de94">maxpacket</a> : dwc_ep-&gt;<a class="code" href="structdwc__ep.html#d17473ece3c9a34f5e7a230d3315de94">maxpacket</a>;
<a name="l00372"></a>00372                                 data_per_desc +=
<a name="l00373"></a>00373                                     (data_per_desc % 4) ? (4 -
<a name="l00374"></a>00374                                                            data_per_desc %
<a name="l00375"></a>00375                                                            4) : 0;
<a name="l00376"></a>00376                                 sts.<a class="code" href="uniondev__dma__desc__sts.html#214ba099b6077c3393b179cf9a7909f7">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#ede78801cd7bc514474fcbe1ef154e5a">rxbytes</a> = data_per_desc;
<a name="l00377"></a>00377                                 dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#0454dad420ef536fe5eb7c38ef764430">buf</a> = dma_ad;
<a name="l00378"></a>00378                                 dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#ab81bc9b2bca330e2dda8941b17c85ba">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#fb77b9c4ab63304073542ed2b118a64b">d32</a> = sts.<a class="code" href="uniondev__dma__desc__sts.html#fb77b9c4ab63304073542ed2b118a64b">d32</a>;
<a name="l00379"></a>00379 
<a name="l00380"></a>00380                                 offset += data_per_desc;
<a name="l00381"></a>00381                                 dma_desc++;
<a name="l00382"></a>00382                                 dma_ad += data_per_desc;
<a name="l00383"></a>00383                         }
<a name="l00384"></a>00384                 }
<a name="l00385"></a>00385                 <span class="keywordflow">for</span> (j = 0; j &lt; dwc_ep-&gt;<a class="code" href="structdwc__ep.html#fe51420474de8a9d74fc9c4adc811c4b">pkt_per_frm</a> - 1; ++j) {
<a name="l00386"></a>00386                         data_per_desc =
<a name="l00387"></a>00387                             ((j + 1) * dwc_ep-&gt;<a class="code" href="structdwc__ep.html#d17473ece3c9a34f5e7a230d3315de94">maxpacket</a> &gt;
<a name="l00388"></a>00388                              dwc_ep-&gt;<a class="code" href="structdwc__ep.html#4672369f4724db642856d72d5048213e">data_per_frame</a>) ? dwc_ep-&gt;<a class="code" href="structdwc__ep.html#4672369f4724db642856d72d5048213e">data_per_frame</a> -
<a name="l00389"></a>00389                             j * dwc_ep-&gt;<a class="code" href="structdwc__ep.html#d17473ece3c9a34f5e7a230d3315de94">maxpacket</a> : dwc_ep-&gt;<a class="code" href="structdwc__ep.html#d17473ece3c9a34f5e7a230d3315de94">maxpacket</a>;
<a name="l00390"></a>00390                         data_per_desc +=
<a name="l00391"></a>00391                             (data_per_desc % 4) ? (4 - data_per_desc % 4) : 0;
<a name="l00392"></a>00392                         sts.<a class="code" href="uniondev__dma__desc__sts.html#214ba099b6077c3393b179cf9a7909f7">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#ede78801cd7bc514474fcbe1ef154e5a">rxbytes</a> = data_per_desc;
<a name="l00393"></a>00393                         dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#0454dad420ef536fe5eb7c38ef764430">buf</a> = dma_ad;
<a name="l00394"></a>00394                         dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#ab81bc9b2bca330e2dda8941b17c85ba">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#fb77b9c4ab63304073542ed2b118a64b">d32</a> = sts.<a class="code" href="uniondev__dma__desc__sts.html#fb77b9c4ab63304073542ed2b118a64b">d32</a>;
<a name="l00395"></a>00395 
<a name="l00396"></a>00396                         offset += data_per_desc;
<a name="l00397"></a>00397                         dma_desc++;
<a name="l00398"></a>00398                         dma_ad += data_per_desc;
<a name="l00399"></a>00399                 }
<a name="l00400"></a>00400 
<a name="l00401"></a>00401                 sts.<a class="code" href="uniondev__dma__desc__sts.html#214ba099b6077c3393b179cf9a7909f7">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#02c8be72ef6258c25094478c7cac0b12">ioc</a> = 1;
<a name="l00402"></a>00402                 sts.<a class="code" href="uniondev__dma__desc__sts.html#214ba099b6077c3393b179cf9a7909f7">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#b728a79d6a86a0d1b6426a1b2627f2c2">l</a> = 1;
<a name="l00403"></a>00403                 data_per_desc =
<a name="l00404"></a>00404                     ((j + 1) * dwc_ep-&gt;<a class="code" href="structdwc__ep.html#d17473ece3c9a34f5e7a230d3315de94">maxpacket</a> &gt;
<a name="l00405"></a>00405                      dwc_ep-&gt;<a class="code" href="structdwc__ep.html#4672369f4724db642856d72d5048213e">data_per_frame</a>) ? dwc_ep-&gt;<a class="code" href="structdwc__ep.html#4672369f4724db642856d72d5048213e">data_per_frame</a> -
<a name="l00406"></a>00406                     j * dwc_ep-&gt;<a class="code" href="structdwc__ep.html#d17473ece3c9a34f5e7a230d3315de94">maxpacket</a> : dwc_ep-&gt;<a class="code" href="structdwc__ep.html#d17473ece3c9a34f5e7a230d3315de94">maxpacket</a>;
<a name="l00407"></a>00407                 data_per_desc +=
<a name="l00408"></a>00408                     (data_per_desc % 4) ? (4 - data_per_desc % 4) : 0;
<a name="l00409"></a>00409                 sts.<a class="code" href="uniondev__dma__desc__sts.html#214ba099b6077c3393b179cf9a7909f7">b_iso_out</a>.<a class="code" href="uniondev__dma__desc__sts.html#ede78801cd7bc514474fcbe1ef154e5a">rxbytes</a> = data_per_desc;
<a name="l00410"></a>00410 
<a name="l00411"></a>00411                 dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#0454dad420ef536fe5eb7c38ef764430">buf</a> = dma_ad;
<a name="l00412"></a>00412                 dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#ab81bc9b2bca330e2dda8941b17c85ba">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#fb77b9c4ab63304073542ed2b118a64b">d32</a> = sts.<a class="code" href="uniondev__dma__desc__sts.html#fb77b9c4ab63304073542ed2b118a64b">d32</a>;
<a name="l00413"></a>00413 
<a name="l00414"></a>00414                 dwc_ep-&gt;<a class="code" href="structdwc__ep.html#1e9f4d08454c973c17acb3e52a2c3689">next_frame</a> = 0;
<a name="l00415"></a>00415 
<a name="l00417"></a>00417                 dwc_write_reg32(&amp;(out_regs-&gt;<a class="code" href="structdwc__otg__dev__out__ep__regs.html#006071bf54bfa1c1f5e25cf4c9f65cb1">doepdma</a>),
<a name="l00418"></a>00418                                 (uint32_t) dwc_ep-&gt;<a class="code" href="structdwc__ep.html#d571f49545171ea167193edac7984173">iso_dma_desc_addr</a>);
<a name="l00419"></a>00419 
<a name="l00420"></a>00420         }
<a name="l00422"></a>00422         <span class="keywordflow">else</span> {
<a name="l00423"></a>00423                 <a class="code" href="uniondev__dma__desc__sts.html">dev_dma_desc_sts_t</a> sts = {.d32 = 0 };
<a name="l00424"></a>00424                 <a class="code" href="structdwc__otg__dev__dma__desc.html">dwc_otg_dev_dma_desc_t</a> *dma_desc = dwc_ep-&gt;<a class="code" href="structdwc__ep.html#a4e11d12099ad64dd5048a3a210fc9f6">iso_desc_addr</a>;
<a name="l00425"></a>00425                 dma_addr_t dma_ad;
<a name="l00426"></a>00426                 <a class="code" href="structdwc__otg__dev__in__ep__regs.html">dwc_otg_dev_in_ep_regs_t</a> *in_regs =
<a name="l00427"></a>00427                     core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#a0ed84d057445e2acd4c793f10f91078">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#7329ead96344810d718f63738b54a4ca">in_ep_regs</a>[dwc_ep-&gt;<a class="code" href="structdwc__ep.html#1dd76dafde9ac2a466d64a5acbc35214">num</a>];
<a name="l00428"></a>00428                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> frmnumber;
<a name="l00429"></a>00429                 <a class="code" href="unionfifosize__data.html">fifosize_data_t</a> txfifosize, rxfifosize;
<a name="l00430"></a>00430 
<a name="l00431"></a>00431                 txfifosize.<a class="code" href="unionfifosize__data.html#937e01b91f0a60a5aa9f6a4eaf6ce661">d32</a> =
<a name="l00432"></a>00432                     dwc_read_reg32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#a0ed84d057445e2acd4c793f10f91078">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#7329ead96344810d718f63738b54a4ca">in_ep_regs</a>[dwc_ep-&gt;<a class="code" href="structdwc__ep.html#1dd76dafde9ac2a466d64a5acbc35214">num</a>]-&gt;
<a name="l00433"></a>00433                                    dtxfsts);
<a name="l00434"></a>00434                 rxfifosize.<a class="code" href="unionfifosize__data.html#937e01b91f0a60a5aa9f6a4eaf6ce661">d32</a> =
<a name="l00435"></a>00435                     dwc_read_reg32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#909eae7e3b9432ca1e278b99f7811f52">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#b1a8cc07a9541c9a73e864579602b79b">grxfsiz</a>);
<a name="l00436"></a>00436 
<a name="l00437"></a>00437                 addr = &amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#a0ed84d057445e2acd4c793f10f91078">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#7329ead96344810d718f63738b54a4ca">in_ep_regs</a>[dwc_ep-&gt;<a class="code" href="structdwc__ep.html#1dd76dafde9ac2a466d64a5acbc35214">num</a>]-&gt;<a class="code" href="structdwc__otg__dev__in__ep__regs.html#53a5adb977e2aec66d4902c6ba293216">diepctl</a>;
<a name="l00438"></a>00438 
<a name="l00439"></a>00439                 dma_ad = dwc_ep-&gt;<a class="code" href="structdwc__ep.html#553936d1d003413d00a24330274887f9">dma_addr0</a>;
<a name="l00440"></a>00440 
<a name="l00441"></a>00441                 dsts.<a class="code" href="uniondsts__data.html#0f126daef735b142b06dbc4cdbe13814">d32</a> =
<a name="l00442"></a>00442                     dwc_read_reg32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#a0ed84d057445e2acd4c793f10f91078">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#e261921bab2e67ccc69007fc485d7f82">dev_global_regs</a>-&gt;<a class="code" href="structdwc__otg__dev__global__regs.html#1ed00edd20ce5db7d07666804101ec05">dsts</a>);
<a name="l00443"></a>00443 
<a name="l00444"></a>00444                 sts.<a class="code" href="uniondev__dma__desc__sts.html#324fdd57830243334b74e0579b4e9f96">b_iso_in</a>.<a class="code" href="uniondev__dma__desc__sts.html#05d1c1d8f6c5a1967c51c5d0e2e04261">bs</a> = <a class="code" href="dwc__otg__regs_8h.html#c2cfc53da94087a90d21d3528b005bcf">BS_HOST_READY</a>;
<a name="l00445"></a>00445                 sts.<a class="code" href="uniondev__dma__desc__sts.html#324fdd57830243334b74e0579b4e9f96">b_iso_in</a>.<a class="code" href="uniondev__dma__desc__sts.html#30ebc024572822f0803d28c95914a44c">txsts</a> = 0;
<a name="l00446"></a>00446                 sts.<a class="code" href="uniondev__dma__desc__sts.html#324fdd57830243334b74e0579b4e9f96">b_iso_in</a>.<a class="code" href="uniondev__dma__desc__sts.html#a850ddfa13601227c05e0ae43a538a9d">sp</a> =
<a name="l00447"></a>00447                     (dwc_ep-&gt;<a class="code" href="structdwc__ep.html#4672369f4724db642856d72d5048213e">data_per_frame</a> % dwc_ep-&gt;<a class="code" href="structdwc__ep.html#d17473ece3c9a34f5e7a230d3315de94">maxpacket</a>) ? 1 : 0;
<a name="l00448"></a>00448                 sts.<a class="code" href="uniondev__dma__desc__sts.html#324fdd57830243334b74e0579b4e9f96">b_iso_in</a>.<a class="code" href="uniondev__dma__desc__sts.html#02c8be72ef6258c25094478c7cac0b12">ioc</a> = 0;
<a name="l00449"></a>00449                 sts.<a class="code" href="uniondev__dma__desc__sts.html#324fdd57830243334b74e0579b4e9f96">b_iso_in</a>.<a class="code" href="uniondev__dma__desc__sts.html#79bf5fe6d9949ddb671daa14b5ee298e">pid</a> = dwc_ep-&gt;<a class="code" href="structdwc__ep.html#fe51420474de8a9d74fc9c4adc811c4b">pkt_per_frm</a>;
<a name="l00450"></a>00450 
<a name="l00451"></a>00451                 frmnumber = dwc_ep-&gt;<a class="code" href="structdwc__ep.html#1e9f4d08454c973c17acb3e52a2c3689">next_frame</a>;
<a name="l00452"></a>00452 
<a name="l00453"></a>00453                 sts.<a class="code" href="uniondev__dma__desc__sts.html#324fdd57830243334b74e0579b4e9f96">b_iso_in</a>.<a class="code" href="uniondev__dma__desc__sts.html#d9da3eccc6d247e2b5eccd4dfba7874e">framenum</a> = frmnumber;
<a name="l00454"></a>00454                 sts.<a class="code" href="uniondev__dma__desc__sts.html#324fdd57830243334b74e0579b4e9f96">b_iso_in</a>.<a class="code" href="uniondev__dma__desc__sts.html#56cc3ad6b0e5704c6eb394f58f660eef">txbytes</a> = dwc_ep-&gt;<a class="code" href="structdwc__ep.html#4672369f4724db642856d72d5048213e">data_per_frame</a>;
<a name="l00455"></a>00455                 sts.<a class="code" href="uniondev__dma__desc__sts.html#324fdd57830243334b74e0579b4e9f96">b_iso_in</a>.<a class="code" href="uniondev__dma__desc__sts.html#b728a79d6a86a0d1b6426a1b2627f2c2">l</a> = 0;
<a name="l00456"></a>00456 
<a name="l00458"></a>00458                 <span class="keywordflow">for</span> (i = 0; i &lt; dwc_ep-&gt;<a class="code" href="structdwc__ep.html#5e5bfcc93d41670bc0d29ad5f0f35871">desc_cnt</a> - 1; i++) {
<a name="l00459"></a>00459                         dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#0454dad420ef536fe5eb7c38ef764430">buf</a> = dma_ad;
<a name="l00460"></a>00460                         dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#ab81bc9b2bca330e2dda8941b17c85ba">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#fb77b9c4ab63304073542ed2b118a64b">d32</a> = sts.<a class="code" href="uniondev__dma__desc__sts.html#fb77b9c4ab63304073542ed2b118a64b">d32</a>;
<a name="l00461"></a>00461                         dma_desc++;
<a name="l00462"></a>00462 
<a name="l00463"></a>00463                         dma_ad += dwc_ep-&gt;<a class="code" href="structdwc__ep.html#4672369f4724db642856d72d5048213e">data_per_frame</a>;
<a name="l00464"></a>00464                         sts.<a class="code" href="uniondev__dma__desc__sts.html#324fdd57830243334b74e0579b4e9f96">b_iso_in</a>.<a class="code" href="uniondev__dma__desc__sts.html#d9da3eccc6d247e2b5eccd4dfba7874e">framenum</a> += dwc_ep-&gt;<a class="code" href="structdwc__ep.html#d9e9ffe348764ababc3165ed04f9ec6c">bInterval</a>;
<a name="l00465"></a>00465                 }
<a name="l00466"></a>00466 
<a name="l00467"></a>00467                 sts.<a class="code" href="uniondev__dma__desc__sts.html#324fdd57830243334b74e0579b4e9f96">b_iso_in</a>.<a class="code" href="uniondev__dma__desc__sts.html#02c8be72ef6258c25094478c7cac0b12">ioc</a> = 1;
<a name="l00468"></a>00468                 dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#0454dad420ef536fe5eb7c38ef764430">buf</a> = dma_ad;
<a name="l00469"></a>00469                 dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#ab81bc9b2bca330e2dda8941b17c85ba">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#fb77b9c4ab63304073542ed2b118a64b">d32</a> = sts.<a class="code" href="uniondev__dma__desc__sts.html#fb77b9c4ab63304073542ed2b118a64b">d32</a>;
<a name="l00470"></a>00470                 ++dma_desc;
<a name="l00471"></a>00471 
<a name="l00473"></a>00473                 sts.<a class="code" href="uniondev__dma__desc__sts.html#324fdd57830243334b74e0579b4e9f96">b_iso_in</a>.<a class="code" href="uniondev__dma__desc__sts.html#02c8be72ef6258c25094478c7cac0b12">ioc</a> = 0;
<a name="l00474"></a>00474                 dma_ad = dwc_ep-&gt;<a class="code" href="structdwc__ep.html#02dc1be77d505b19f14651fe9805c97f">dma_addr1</a>;
<a name="l00475"></a>00475 
<a name="l00476"></a>00476                 <span class="keywordflow">for</span> (i = 0; i &lt; dwc_ep-&gt;<a class="code" href="structdwc__ep.html#5e5bfcc93d41670bc0d29ad5f0f35871">desc_cnt</a> - dwc_ep-&gt;<a class="code" href="structdwc__ep.html#fe51420474de8a9d74fc9c4adc811c4b">pkt_per_frm</a>;
<a name="l00477"></a>00477                      i += dwc_ep-&gt;<a class="code" href="structdwc__ep.html#fe51420474de8a9d74fc9c4adc811c4b">pkt_per_frm</a>) {
<a name="l00478"></a>00478                         dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#0454dad420ef536fe5eb7c38ef764430">buf</a> = dma_ad;
<a name="l00479"></a>00479                         dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#ab81bc9b2bca330e2dda8941b17c85ba">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#fb77b9c4ab63304073542ed2b118a64b">d32</a> = sts.<a class="code" href="uniondev__dma__desc__sts.html#fb77b9c4ab63304073542ed2b118a64b">d32</a>;
<a name="l00480"></a>00480                         dma_desc++;
<a name="l00481"></a>00481 
<a name="l00482"></a>00482                         dma_ad += dwc_ep-&gt;<a class="code" href="structdwc__ep.html#4672369f4724db642856d72d5048213e">data_per_frame</a>;
<a name="l00483"></a>00483                         sts.<a class="code" href="uniondev__dma__desc__sts.html#324fdd57830243334b74e0579b4e9f96">b_iso_in</a>.<a class="code" href="uniondev__dma__desc__sts.html#d9da3eccc6d247e2b5eccd4dfba7874e">framenum</a> += dwc_ep-&gt;<a class="code" href="structdwc__ep.html#d9e9ffe348764ababc3165ed04f9ec6c">bInterval</a>;
<a name="l00484"></a>00484 
<a name="l00485"></a>00485                         sts.<a class="code" href="uniondev__dma__desc__sts.html#324fdd57830243334b74e0579b4e9f96">b_iso_in</a>.<a class="code" href="uniondev__dma__desc__sts.html#02c8be72ef6258c25094478c7cac0b12">ioc</a> = 0;
<a name="l00486"></a>00486                 }
<a name="l00487"></a>00487                 sts.<a class="code" href="uniondev__dma__desc__sts.html#324fdd57830243334b74e0579b4e9f96">b_iso_in</a>.<a class="code" href="uniondev__dma__desc__sts.html#02c8be72ef6258c25094478c7cac0b12">ioc</a> = 1;
<a name="l00488"></a>00488                 sts.<a class="code" href="uniondev__dma__desc__sts.html#324fdd57830243334b74e0579b4e9f96">b_iso_in</a>.<a class="code" href="uniondev__dma__desc__sts.html#b728a79d6a86a0d1b6426a1b2627f2c2">l</a> = 1;
<a name="l00489"></a>00489 
<a name="l00490"></a>00490                 dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#0454dad420ef536fe5eb7c38ef764430">buf</a> = dma_ad;
<a name="l00491"></a>00491                 dma_desc-&gt;<a class="code" href="structdwc__otg__dev__dma__desc.html#ab81bc9b2bca330e2dda8941b17c85ba">status</a>.<a class="code" href="uniondev__dma__desc__sts.html#fb77b9c4ab63304073542ed2b118a64b">d32</a> = sts.<a class="code" href="uniondev__dma__desc__sts.html#fb77b9c4ab63304073542ed2b118a64b">d32</a>;
<a name="l00492"></a>00492 
<a name="l00493"></a>00493                 dwc_ep-&gt;<a class="code" href="structdwc__ep.html#1e9f4d08454c973c17acb3e52a2c3689">next_frame</a> = sts.<a class="code" href="uniondev__dma__desc__sts.html#324fdd57830243334b74e0579b4e9f96">b_iso_in</a>.<a class="code" href="uniondev__dma__desc__sts.html#d9da3eccc6d247e2b5eccd4dfba7874e">framenum</a> + dwc_ep-&gt;<a class="code" href="structdwc__ep.html#d9e9ffe348764ababc3165ed04f9ec6c">bInterval</a>;
<a name="l00494"></a>00494 
<a name="l00496"></a>00496                 dwc_write_reg32(&amp;(in_regs-&gt;<a class="code" href="structdwc__otg__dev__in__ep__regs.html#5f013840a15e0a310b8722646880a420">diepdma</a>),
<a name="l00497"></a>00497                                 (uint32_t) dwc_ep-&gt;<a class="code" href="structdwc__ep.html#d571f49545171ea167193edac7984173">iso_dma_desc_addr</a>);
<a name="l00498"></a>00498         }
<a name="l00500"></a>00500         depctl.<a class="code" href="uniondepctl__data.html#c3d4448663382417e50e23c05ff11a09">d32</a> = 0;
<a name="l00501"></a>00501         depctl.<a class="code" href="uniondepctl__data.html#92b47fc74de50f45d781d16e33176766">b</a>.<a class="code" href="uniondepctl__data.html#337ceb41a9e0735e144e684b1f9e5368">epena</a> = 1;
<a name="l00502"></a>00502         depctl.<a class="code" href="uniondepctl__data.html#92b47fc74de50f45d781d16e33176766">b</a>.<a class="code" href="uniondepctl__data.html#2ddb1e68ac29dfc383dacd94f76b4710">usbactep</a> = 1;
<a name="l00503"></a>00503         depctl.<a class="code" href="uniondepctl__data.html#92b47fc74de50f45d781d16e33176766">b</a>.<a class="code" href="uniondepctl__data.html#0b87d0914ceee7a20ffd2d7510b6a72e">cnak</a> = 1;
<a name="l00504"></a>00504 
<a name="l00505"></a>00505         dwc_modify_reg32(addr, depctl.<a class="code" href="uniondepctl__data.html#c3d4448663382417e50e23c05ff11a09">d32</a>, depctl.<a class="code" href="uniondepctl__data.html#c3d4448663382417e50e23c05ff11a09">d32</a>);
<a name="l00506"></a>00506         depctl.<a class="code" href="uniondepctl__data.html#c3d4448663382417e50e23c05ff11a09">d32</a> = dwc_read_reg32(addr);
<a name="l00507"></a>00507 }
<a name="l00508"></a>00508 
<a name="l00517"></a><a class="code" href="dwc__otg__pcd_8c.html#0b13a31a7ddc82b53862cd06cfed6393">00517</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__cil_8h.html#0b13a31a7ddc82b53862cd06cfed6393">dwc_otg_iso_ep_start_buf_transfer</a>(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if,
<a name="l00518"></a>00518                                        <a class="code" href="structdwc__ep.html">dwc_ep_t</a> * ep)
<a name="l00519"></a>00519 {
<a name="l00520"></a>00520         <a class="code" href="uniondepctl__data.html">depctl_data_t</a> depctl = {.d32 = 0 };
<a name="l00521"></a>00521         <span class="keyword">volatile</span> uint32_t *addr;
<a name="l00522"></a>00522 
<a name="l00523"></a>00523         <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__ep.html#b882b6b7c857100ed20600e94ea37760">is_in</a>) {
<a name="l00524"></a>00524                 addr = &amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#a0ed84d057445e2acd4c793f10f91078">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#7329ead96344810d718f63738b54a4ca">in_ep_regs</a>[ep-&gt;<a class="code" href="structdwc__ep.html#1dd76dafde9ac2a466d64a5acbc35214">num</a>]-&gt;<a class="code" href="structdwc__otg__dev__in__ep__regs.html#53a5adb977e2aec66d4902c6ba293216">diepctl</a>;
<a name="l00525"></a>00525         } <span class="keywordflow">else</span> {
<a name="l00526"></a>00526                 addr = &amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#a0ed84d057445e2acd4c793f10f91078">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#9cc0e6b18b00e44c5d4b46a8ff460384">out_ep_regs</a>[ep-&gt;<a class="code" href="structdwc__ep.html#1dd76dafde9ac2a466d64a5acbc35214">num</a>]-&gt;<a class="code" href="structdwc__otg__dev__out__ep__regs.html#2a522b71fc97658c07debf3521f7d3e5">doepctl</a>;
<a name="l00527"></a>00527         }
<a name="l00528"></a>00528 
<a name="l00529"></a>00529         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#5ade18c62c5101c603247691d3047a19">dma_enable</a> == 0 || core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#7e3b96c6167eceeeb1090798f8297f1f">dma_desc_enable</a> != 0) {
<a name="l00530"></a>00530                 <span class="keywordflow">return</span>;
<a name="l00531"></a>00531         } <span class="keywordflow">else</span> {
<a name="l00532"></a>00532                 <a class="code" href="uniondeptsiz__data.html">deptsiz_data_t</a> deptsiz = {.d32 = 0 };
<a name="l00533"></a>00533 
<a name="l00534"></a>00534                 ep-&gt;<a class="code" href="structdwc__ep.html#36d4010478ceb27479c0b12b376a7924">xfer_len</a> =
<a name="l00535"></a>00535                     ep-&gt;<a class="code" href="structdwc__ep.html#4672369f4724db642856d72d5048213e">data_per_frame</a> * ep-&gt;<a class="code" href="structdwc__ep.html#4638b25387e59a5a4721a503b5279dfc">buf_proc_intrvl</a> / ep-&gt;<a class="code" href="structdwc__ep.html#d9e9ffe348764ababc3165ed04f9ec6c">bInterval</a>;
<a name="l00536"></a>00536                 ep-&gt;<a class="code" href="structdwc__ep.html#46349fb0608d8c6849ced211b0628c15">pkt_cnt</a> =
<a name="l00537"></a>00537                     (ep-&gt;<a class="code" href="structdwc__ep.html#36d4010478ceb27479c0b12b376a7924">xfer_len</a> - 1 + ep-&gt;<a class="code" href="structdwc__ep.html#d17473ece3c9a34f5e7a230d3315de94">maxpacket</a>) / ep-&gt;<a class="code" href="structdwc__ep.html#d17473ece3c9a34f5e7a230d3315de94">maxpacket</a>;
<a name="l00538"></a>00538                 ep-&gt;<a class="code" href="structdwc__ep.html#23d4871510b5bcb54fbf0674d8f122bd">xfer_count</a> = 0;
<a name="l00539"></a>00539                 ep-&gt;<a class="code" href="structdwc__ep.html#97fa9bf5c31ba734d54f70e6fe6ae8eb">xfer_buff</a> =
<a name="l00540"></a>00540                     (ep-&gt;<a class="code" href="structdwc__ep.html#53033f174854701986545f05502e1cad">proc_buf_num</a>) ? ep-&gt;<a class="code" href="structdwc__ep.html#36ff87362a0da5bce95eaf85522d49ff">xfer_buff1</a> : ep-&gt;<a class="code" href="structdwc__ep.html#b6d727e366ac589d304256c758d2d44a">xfer_buff0</a>;
<a name="l00541"></a>00541                 ep-&gt;<a class="code" href="structdwc__ep.html#b40ce70422b6d105a855a8df4b33d45d">dma_addr</a> =
<a name="l00542"></a>00542                     (ep-&gt;<a class="code" href="structdwc__ep.html#53033f174854701986545f05502e1cad">proc_buf_num</a>) ? ep-&gt;<a class="code" href="structdwc__ep.html#02dc1be77d505b19f14651fe9805c97f">dma_addr1</a> : ep-&gt;<a class="code" href="structdwc__ep.html#553936d1d003413d00a24330274887f9">dma_addr0</a>;
<a name="l00543"></a>00543 
<a name="l00544"></a>00544                 if (ep-&gt;<a class="code" href="structdwc__ep.html#b882b6b7c857100ed20600e94ea37760">is_in</a>) {
<a name="l00545"></a>00545                         <span class="comment">/* Program the transfer size and packet count</span>
<a name="l00546"></a>00546 <span class="comment">                         *      as follows: xfersize = N * maxpacket +</span>
<a name="l00547"></a>00547 <span class="comment">                         *      short_packet pktcnt = N + (short_packet</span>
<a name="l00548"></a>00548 <span class="comment">                         *      exist ? 1 : 0)  </span>
<a name="l00549"></a>00549 <span class="comment">                         */</span>
<a name="l00550"></a>00550                         deptsiz.<a class="code" href="uniondeptsiz__data.html#4ef5a09d8918c8ec2769c5b67f8b6d32">b</a>.<a class="code" href="uniondeptsiz__data.html#45a97381fba9a7d9c3bde425334a60a5">mc</a> = ep-&gt;<a class="code" href="structdwc__ep.html#fe51420474de8a9d74fc9c4adc811c4b">pkt_per_frm</a>;
<a name="l00551"></a>00551                         deptsiz.<a class="code" href="uniondeptsiz__data.html#4ef5a09d8918c8ec2769c5b67f8b6d32">b</a>.<a class="code" href="uniondeptsiz__data.html#cf06327d851e7cfe5c442b29bf2d6fa4">xfersize</a> = ep-&gt;<a class="code" href="structdwc__ep.html#36d4010478ceb27479c0b12b376a7924">xfer_len</a>;
<a name="l00552"></a>00552                         deptsiz.<a class="code" href="uniondeptsiz__data.html#4ef5a09d8918c8ec2769c5b67f8b6d32">b</a>.<a class="code" href="uniondeptsiz__data.html#bbd89e812371e5b555bb82373f3643d9">pktcnt</a> =
<a name="l00553"></a>00553                             (ep-&gt;<a class="code" href="structdwc__ep.html#36d4010478ceb27479c0b12b376a7924">xfer_len</a> - 1 + ep-&gt;<a class="code" href="structdwc__ep.html#d17473ece3c9a34f5e7a230d3315de94">maxpacket</a>) / ep-&gt;<a class="code" href="structdwc__ep.html#d17473ece3c9a34f5e7a230d3315de94">maxpacket</a>;
<a name="l00554"></a>00554                         dwc_write_reg32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#a0ed84d057445e2acd4c793f10f91078">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#7329ead96344810d718f63738b54a4ca">in_ep_regs</a>[ep-&gt;<a class="code" href="structdwc__ep.html#1dd76dafde9ac2a466d64a5acbc35214">num</a>]-&gt;
<a name="l00555"></a>00555                                         dieptsiz, deptsiz.<a class="code" href="uniondeptsiz__data.html#10c2b2ba8b419b0a766430a59befbbe0">d32</a>);
<a name="l00556"></a>00556 
<a name="l00557"></a>00557                         <span class="comment">/* Write the DMA register */</span>
<a name="l00558"></a>00558                         dwc_write_reg32(&amp;
<a name="l00559"></a>00559                                         (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#a0ed84d057445e2acd4c793f10f91078">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#7329ead96344810d718f63738b54a4ca">in_ep_regs</a>[ep-&gt;<a class="code" href="structdwc__ep.html#1dd76dafde9ac2a466d64a5acbc35214">num</a>]-&gt;
<a name="l00560"></a>00560                                          diepdma), (uint32_t) ep-&gt;<a class="code" href="structdwc__ep.html#b40ce70422b6d105a855a8df4b33d45d">dma_addr</a>);
<a name="l00561"></a>00561 
<a name="l00562"></a>00562                 } <span class="keywordflow">else</span> {
<a name="l00563"></a>00563                         deptsiz.<a class="code" href="uniondeptsiz__data.html#4ef5a09d8918c8ec2769c5b67f8b6d32">b</a>.<a class="code" href="uniondeptsiz__data.html#bbd89e812371e5b555bb82373f3643d9">pktcnt</a> =
<a name="l00564"></a>00564                             (ep-&gt;<a class="code" href="structdwc__ep.html#36d4010478ceb27479c0b12b376a7924">xfer_len</a> + (ep-&gt;<a class="code" href="structdwc__ep.html#d17473ece3c9a34f5e7a230d3315de94">maxpacket</a> - 1)) /
<a name="l00565"></a>00565                             ep-&gt;<a class="code" href="structdwc__ep.html#d17473ece3c9a34f5e7a230d3315de94">maxpacket</a>;
<a name="l00566"></a>00566                         deptsiz.<a class="code" href="uniondeptsiz__data.html#4ef5a09d8918c8ec2769c5b67f8b6d32">b</a>.<a class="code" href="uniondeptsiz__data.html#cf06327d851e7cfe5c442b29bf2d6fa4">xfersize</a> = deptsiz.<a class="code" href="uniondeptsiz__data.html#4ef5a09d8918c8ec2769c5b67f8b6d32">b</a>.<a class="code" href="uniondeptsiz__data.html#bbd89e812371e5b555bb82373f3643d9">pktcnt</a> * ep-&gt;<a class="code" href="structdwc__ep.html#d17473ece3c9a34f5e7a230d3315de94">maxpacket</a>;
<a name="l00567"></a>00567 
<a name="l00568"></a>00568                         dwc_write_reg32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#a0ed84d057445e2acd4c793f10f91078">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#9cc0e6b18b00e44c5d4b46a8ff460384">out_ep_regs</a>[ep-&gt;<a class="code" href="structdwc__ep.html#1dd76dafde9ac2a466d64a5acbc35214">num</a>]-&gt;
<a name="l00569"></a>00569                                         doeptsiz, deptsiz.<a class="code" href="uniondeptsiz__data.html#10c2b2ba8b419b0a766430a59befbbe0">d32</a>);
<a name="l00570"></a>00570 
<a name="l00571"></a>00571                         <span class="comment">/* Write the DMA register */</span>
<a name="l00572"></a>00572                         dwc_write_reg32(&amp;
<a name="l00573"></a>00573                                         (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#a0ed84d057445e2acd4c793f10f91078">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#9cc0e6b18b00e44c5d4b46a8ff460384">out_ep_regs</a>[ep-&gt;<a class="code" href="structdwc__ep.html#1dd76dafde9ac2a466d64a5acbc35214">num</a>]-&gt;
<a name="l00574"></a>00574                                          doepdma), (uint32_t) ep-&gt;<a class="code" href="structdwc__ep.html#b40ce70422b6d105a855a8df4b33d45d">dma_addr</a>);
<a name="l00575"></a>00575 
<a name="l00576"></a>00576                 }
<a name="l00578"></a>00578                 depctl.<a class="code" href="uniondepctl__data.html#c3d4448663382417e50e23c05ff11a09">d32</a> = 0;
<a name="l00579"></a>00579                 dwc_modify_reg32(addr, depctl.<a class="code" href="uniondepctl__data.html#c3d4448663382417e50e23c05ff11a09">d32</a>, depctl.<a class="code" href="uniondepctl__data.html#c3d4448663382417e50e23c05ff11a09">d32</a>);
<a name="l00580"></a>00580 
<a name="l00581"></a>00581                 depctl.<a class="code" href="uniondepctl__data.html#92b47fc74de50f45d781d16e33176766">b</a>.<a class="code" href="uniondepctl__data.html#337ceb41a9e0735e144e684b1f9e5368">epena</a> = 1;
<a name="l00582"></a>00582                 depctl.<a class="code" href="uniondepctl__data.html#92b47fc74de50f45d781d16e33176766">b</a>.<a class="code" href="uniondepctl__data.html#0b87d0914ceee7a20ffd2d7510b6a72e">cnak</a> = 1;
<a name="l00583"></a>00583 
<a name="l00584"></a>00584                 dwc_modify_reg32(addr, depctl.<a class="code" href="uniondepctl__data.html#c3d4448663382417e50e23c05ff11a09">d32</a>, depctl.<a class="code" href="uniondepctl__data.html#c3d4448663382417e50e23c05ff11a09">d32</a>);
<a name="l00585"></a>00585         }
<a name="l00586"></a>00586 }
<a name="l00587"></a>00587 
<a name="l00598"></a><a class="code" href="dwc__otg__pcd_8c.html#3f39ccc23c6f9bd4fd4ab7a5cecc67a3">00598</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd_8c.html#3f39ccc23c6f9bd4fd4ab7a5cecc67a3">dwc_otg_iso_ep_start_transfer</a>(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if,
<a name="l00599"></a>00599                                           <a class="code" href="structdwc__ep.html">dwc_ep_t</a> * ep)
<a name="l00600"></a>00600 {
<a name="l00601"></a>00601         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#5ade18c62c5101c603247691d3047a19">dma_enable</a>) {
<a name="l00602"></a>00602                 <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#7e3b96c6167eceeeb1090798f8297f1f">dma_desc_enable</a>) {
<a name="l00603"></a>00603                         <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__ep.html#b882b6b7c857100ed20600e94ea37760">is_in</a>) {
<a name="l00604"></a>00604                                 ep-&gt;<a class="code" href="structdwc__ep.html#5e5bfcc93d41670bc0d29ad5f0f35871">desc_cnt</a> = ep-&gt;<a class="code" href="structdwc__ep.html#46349fb0608d8c6849ced211b0628c15">pkt_cnt</a> / ep-&gt;<a class="code" href="structdwc__ep.html#fe51420474de8a9d74fc9c4adc811c4b">pkt_per_frm</a>;
<a name="l00605"></a>00605                         } <span class="keywordflow">else</span> {
<a name="l00606"></a>00606                                 ep-&gt;<a class="code" href="structdwc__ep.html#5e5bfcc93d41670bc0d29ad5f0f35871">desc_cnt</a> = ep-&gt;<a class="code" href="structdwc__ep.html#46349fb0608d8c6849ced211b0628c15">pkt_cnt</a>;
<a name="l00607"></a>00607                         }
<a name="l00608"></a>00608                         <a class="code" href="dwc__otg__pcd_8c.html#456f7e798e18c0b169fc196fb305e2ea">dwc_otg_iso_ep_start_ddma_transfer</a>(core_if, ep);
<a name="l00609"></a>00609                 } <span class="keywordflow">else</span> {
<a name="l00610"></a>00610                         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#34540b79e9a14bfa234a52ac132c5cd1">pti_enh_enable</a>) {
<a name="l00611"></a>00611                                 <a class="code" href="dwc__otg__cil_8h.html#0b13a31a7ddc82b53862cd06cfed6393">dwc_otg_iso_ep_start_buf_transfer</a>(core_if, ep);
<a name="l00612"></a>00612                         } <span class="keywordflow">else</span> {
<a name="l00613"></a>00613                                 ep-&gt;<a class="code" href="structdwc__ep.html#d3bc23598a77d3cca52c70a28afc6b5e">cur_pkt_addr</a> =
<a name="l00614"></a>00614                                     (ep-&gt;<a class="code" href="structdwc__ep.html#53033f174854701986545f05502e1cad">proc_buf_num</a>) ? ep-&gt;<a class="code" href="structdwc__ep.html#36ff87362a0da5bce95eaf85522d49ff">xfer_buff1</a> : ep-&gt;
<a name="l00615"></a>00615                                     xfer_buff0;
<a name="l00616"></a>00616                                 ep-&gt;<a class="code" href="structdwc__ep.html#ed4594c9f6c2bcbcf6f1bbe9e9c64061">cur_pkt_dma_addr</a> =
<a name="l00617"></a>00617                                     (ep-&gt;<a class="code" href="structdwc__ep.html#53033f174854701986545f05502e1cad">proc_buf_num</a>) ? ep-&gt;<a class="code" href="structdwc__ep.html#02dc1be77d505b19f14651fe9805c97f">dma_addr1</a> : ep-&gt;
<a name="l00618"></a>00618                                     dma_addr0;
<a name="l00619"></a>00619                                 <a class="code" href="dwc__otg__cil_8c.html#0f0894ae9890260e1da839aa10af35cc">dwc_otg_iso_ep_start_frm_transfer</a>(core_if, ep);
<a name="l00620"></a>00620                         }
<a name="l00621"></a>00621                 }
<a name="l00622"></a>00622         } <span class="keywordflow">else</span> {
<a name="l00623"></a>00623                 ep-&gt;<a class="code" href="structdwc__ep.html#d3bc23598a77d3cca52c70a28afc6b5e">cur_pkt_addr</a> =
<a name="l00624"></a>00624                     (ep-&gt;<a class="code" href="structdwc__ep.html#53033f174854701986545f05502e1cad">proc_buf_num</a>) ? ep-&gt;<a class="code" href="structdwc__ep.html#36ff87362a0da5bce95eaf85522d49ff">xfer_buff1</a> : ep-&gt;<a class="code" href="structdwc__ep.html#b6d727e366ac589d304256c758d2d44a">xfer_buff0</a>;
<a name="l00625"></a>00625                 ep-&gt;<a class="code" href="structdwc__ep.html#ed4594c9f6c2bcbcf6f1bbe9e9c64061">cur_pkt_dma_addr</a> =
<a name="l00626"></a>00626                     (ep-&gt;<a class="code" href="structdwc__ep.html#53033f174854701986545f05502e1cad">proc_buf_num</a>) ? ep-&gt;<a class="code" href="structdwc__ep.html#02dc1be77d505b19f14651fe9805c97f">dma_addr1</a> : ep-&gt;<a class="code" href="structdwc__ep.html#553936d1d003413d00a24330274887f9">dma_addr0</a>;
<a name="l00627"></a>00627                 <a class="code" href="dwc__otg__cil_8c.html#0f0894ae9890260e1da839aa10af35cc">dwc_otg_iso_ep_start_frm_transfer</a>(core_if, ep);
<a name="l00628"></a>00628         }
<a name="l00629"></a>00629 }
<a name="l00630"></a>00630 
<a name="l00641"></a><a class="code" href="dwc__otg__pcd_8c.html#2898810e04a9dd19798f59cfdb56c670">00641</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd_8c.html#2898810e04a9dd19798f59cfdb56c670">dwc_otg_iso_ep_stop_transfer</a>(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if, <a class="code" href="structdwc__ep.html">dwc_ep_t</a> * ep)
<a name="l00642"></a>00642 {
<a name="l00643"></a>00643         <a class="code" href="uniondepctl__data.html">depctl_data_t</a> depctl = {.d32 = 0 };
<a name="l00644"></a>00644         <span class="keyword">volatile</span> uint32_t *addr;
<a name="l00645"></a>00645 
<a name="l00646"></a>00646         <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__ep.html#b882b6b7c857100ed20600e94ea37760">is_in</a> == 1) {
<a name="l00647"></a>00647                 addr = &amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#a0ed84d057445e2acd4c793f10f91078">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#7329ead96344810d718f63738b54a4ca">in_ep_regs</a>[ep-&gt;<a class="code" href="structdwc__ep.html#1dd76dafde9ac2a466d64a5acbc35214">num</a>]-&gt;<a class="code" href="structdwc__otg__dev__in__ep__regs.html#53a5adb977e2aec66d4902c6ba293216">diepctl</a>;
<a name="l00648"></a>00648         } <span class="keywordflow">else</span> {
<a name="l00649"></a>00649                 addr = &amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#a0ed84d057445e2acd4c793f10f91078">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#9cc0e6b18b00e44c5d4b46a8ff460384">out_ep_regs</a>[ep-&gt;<a class="code" href="structdwc__ep.html#1dd76dafde9ac2a466d64a5acbc35214">num</a>]-&gt;<a class="code" href="structdwc__otg__dev__out__ep__regs.html#2a522b71fc97658c07debf3521f7d3e5">doepctl</a>;
<a name="l00650"></a>00650         }
<a name="l00651"></a>00651 
<a name="l00652"></a>00652         <span class="comment">/* disable the ep */</span>
<a name="l00653"></a>00653         depctl.<a class="code" href="uniondepctl__data.html#c3d4448663382417e50e23c05ff11a09">d32</a> = dwc_read_reg32(addr);
<a name="l00654"></a>00654 
<a name="l00655"></a>00655         depctl.<a class="code" href="uniondepctl__data.html#92b47fc74de50f45d781d16e33176766">b</a>.<a class="code" href="uniondepctl__data.html#4d76ba4ebd506d3175ec5cdc0d811654">epdis</a> = 1;
<a name="l00656"></a>00656         depctl.<a class="code" href="uniondepctl__data.html#92b47fc74de50f45d781d16e33176766">b</a>.<a class="code" href="uniondepctl__data.html#ccf6e60ac8cabde8da36edb19504ba2b">snak</a> = 1;
<a name="l00657"></a>00657 
<a name="l00658"></a>00658         dwc_write_reg32(addr, depctl.<a class="code" href="uniondepctl__data.html#c3d4448663382417e50e23c05ff11a09">d32</a>);
<a name="l00659"></a>00659 
<a name="l00660"></a>00660         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#7e3b96c6167eceeeb1090798f8297f1f">dma_desc_enable</a> &amp;&amp;
<a name="l00661"></a>00661             ep-&gt;<a class="code" href="structdwc__ep.html#a4e11d12099ad64dd5048a3a210fc9f6">iso_desc_addr</a> &amp;&amp; ep-&gt;<a class="code" href="structdwc__ep.html#d571f49545171ea167193edac7984173">iso_dma_desc_addr</a>) {
<a name="l00662"></a>00662                 <a class="code" href="dwc__otg__pcd_8c.html#1926b61a7438bd9a14bd6d6a26c6a63d">dwc_otg_ep_free_desc_chain</a>(ep-&gt;<a class="code" href="structdwc__ep.html#a4e11d12099ad64dd5048a3a210fc9f6">iso_desc_addr</a>,
<a name="l00663"></a>00663                                            ep-&gt;<a class="code" href="structdwc__ep.html#d571f49545171ea167193edac7984173">iso_dma_desc_addr</a>,
<a name="l00664"></a>00664                                            ep-&gt;<a class="code" href="structdwc__ep.html#5e5bfcc93d41670bc0d29ad5f0f35871">desc_cnt</a> * 2);
<a name="l00665"></a>00665         }
<a name="l00666"></a>00666 
<a name="l00667"></a>00667         <span class="comment">/* reset varibales */</span>
<a name="l00668"></a>00668         ep-&gt;<a class="code" href="structdwc__ep.html#553936d1d003413d00a24330274887f9">dma_addr0</a> = 0;
<a name="l00669"></a>00669         ep-&gt;<a class="code" href="structdwc__ep.html#02dc1be77d505b19f14651fe9805c97f">dma_addr1</a> = 0;
<a name="l00670"></a>00670         ep-&gt;<a class="code" href="structdwc__ep.html#b6d727e366ac589d304256c758d2d44a">xfer_buff0</a> = 0;
<a name="l00671"></a>00671         ep-&gt;<a class="code" href="structdwc__ep.html#36ff87362a0da5bce95eaf85522d49ff">xfer_buff1</a> = 0;
<a name="l00672"></a>00672         ep-&gt;<a class="code" href="structdwc__ep.html#4672369f4724db642856d72d5048213e">data_per_frame</a> = 0;
<a name="l00673"></a>00673         ep-&gt;<a class="code" href="structdwc__ep.html#c505483882bd67a7b0076851f693f2cc">data_pattern_frame</a> = 0;
<a name="l00674"></a>00674         ep-&gt;<a class="code" href="structdwc__ep.html#1b9094ddfba3cddf397fd308cdbf4c81">sync_frame</a> = 0;
<a name="l00675"></a>00675         ep-&gt;<a class="code" href="structdwc__ep.html#4638b25387e59a5a4721a503b5279dfc">buf_proc_intrvl</a> = 0;
<a name="l00676"></a>00676         ep-&gt;<a class="code" href="structdwc__ep.html#d9e9ffe348764ababc3165ed04f9ec6c">bInterval</a> = 0;
<a name="l00677"></a>00677         ep-&gt;<a class="code" href="structdwc__ep.html#53033f174854701986545f05502e1cad">proc_buf_num</a> = 0;
<a name="l00678"></a>00678         ep-&gt;<a class="code" href="structdwc__ep.html#fe51420474de8a9d74fc9c4adc811c4b">pkt_per_frm</a> = 0;
<a name="l00679"></a>00679         ep-&gt;<a class="code" href="structdwc__ep.html#fe51420474de8a9d74fc9c4adc811c4b">pkt_per_frm</a> = 0;
<a name="l00680"></a>00680         ep-&gt;<a class="code" href="structdwc__ep.html#5e5bfcc93d41670bc0d29ad5f0f35871">desc_cnt</a> = 0;
<a name="l00681"></a>00681         ep-&gt;<a class="code" href="structdwc__ep.html#a4e11d12099ad64dd5048a3a210fc9f6">iso_desc_addr</a> = 0;
<a name="l00682"></a>00682         ep-&gt;<a class="code" href="structdwc__ep.html#d571f49545171ea167193edac7984173">iso_dma_desc_addr</a> = 0;
<a name="l00683"></a>00683 }
<a name="l00684"></a>00684 
<a name="l00685"></a><a class="code" href="dwc__otg__pcd__if_8h.html#e0a690ac031f8f06c2e7fb10b4633b05">00685</a> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__pcd_8c.html#e0a690ac031f8f06c2e7fb10b4633b05">dwc_otg_pcd_iso_ep_start</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd, <span class="keywordtype">void</span> *ep_handle,
<a name="l00686"></a>00686                              uint8_t * buf0, uint8_t * buf1, dwc_dma_t dma0,
<a name="l00687"></a>00687                              dwc_dma_t dma1, <span class="keywordtype">int</span> sync_frame, <span class="keywordtype">int</span> dp_frame,
<a name="l00688"></a>00688                              <span class="keywordtype">int</span> data_per_frame, <span class="keywordtype">int</span> start_frame,
<a name="l00689"></a>00689                              <span class="keywordtype">int</span> buf_proc_intrvl, <span class="keywordtype">void</span> *req_handle,
<a name="l00690"></a>00690                              <span class="keywordtype">int</span> atomic_alloc)
<a name="l00691"></a>00691 {
<a name="l00692"></a>00692         <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> *ep;
<a name="l00693"></a>00693         uint64_t flags = 0;
<a name="l00694"></a>00694         <a class="code" href="structdwc__ep.html">dwc_ep_t</a> *<a class="code" href="structdwc__ep.html">dwc_ep</a>;
<a name="l00695"></a>00695         int32_t frm_data;
<a name="l00696"></a>00696         <a class="code" href="uniondsts__data.html">dsts_data_t</a> dsts;
<a name="l00697"></a>00697         <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *core_if;
<a name="l00698"></a>00698 
<a name="l00699"></a>00699         ep = <a class="code" href="dwc__otg__pcd_8c.html#4b46c226fa34cd7fc4ceec2c5e7f8ebe">get_ep_from_handle</a>(pcd, ep_handle);
<a name="l00700"></a>00700 
<a name="l00701"></a>00701         <span class="keywordflow">if</span> (!ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#86e27843c439dd0b1d12d9bf2dc6516f">desc</a> || ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#1dd76dafde9ac2a466d64a5acbc35214">num</a> == 0) {
<a name="l00702"></a>00702                 DWC_WARN(<span class="stringliteral">"bad ep\n"</span>);
<a name="l00703"></a>00703                 <span class="keywordflow">return</span> -DWC_E_INVALID;
<a name="l00704"></a>00704         }
<a name="l00705"></a>00705 
<a name="l00706"></a>00706         DWC_SPINLOCK_IRQSAVE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#5d450e4d06659ab2f3b18e5c816776e4">lock</a>, &amp;flags);
<a name="l00707"></a>00707         core_if = <a class="code" href="dwc__otg__pcd_8h.html#464549f9f4484651efe25b1a03692d72">GET_CORE_IF</a>(pcd);
<a name="l00708"></a>00708         dwc_ep = &amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>;
<a name="l00709"></a>00709 
<a name="l00710"></a>00710         <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#716d3c29adc54c6822935fc2ae9bef51">iso_req_handle</a>) {
<a name="l00711"></a>00711                 DWC_WARN(<span class="stringliteral">"ISO request in progress\n"</span>);
<a name="l00712"></a>00712         }
<a name="l00713"></a>00713 
<a name="l00714"></a>00714         dwc_ep-&gt;<a class="code" href="structdwc__ep.html#553936d1d003413d00a24330274887f9">dma_addr0</a> = dma0;
<a name="l00715"></a>00715         dwc_ep-&gt;<a class="code" href="structdwc__ep.html#02dc1be77d505b19f14651fe9805c97f">dma_addr1</a> = dma1;
<a name="l00716"></a>00716 
<a name="l00717"></a>00717         dwc_ep-&gt;<a class="code" href="structdwc__ep.html#b6d727e366ac589d304256c758d2d44a">xfer_buff0</a> = buf0;
<a name="l00718"></a>00718         dwc_ep-&gt;<a class="code" href="structdwc__ep.html#36ff87362a0da5bce95eaf85522d49ff">xfer_buff1</a> = buf1;
<a name="l00719"></a>00719 
<a name="l00720"></a>00720         dwc_ep-&gt;<a class="code" href="structdwc__ep.html#4672369f4724db642856d72d5048213e">data_per_frame</a> = data_per_frame;
<a name="l00721"></a>00721 
<a name="l00723"></a>00723         dwc_ep-&gt;<a class="code" href="structdwc__ep.html#c505483882bd67a7b0076851f693f2cc">data_pattern_frame</a> = dp_frame;
<a name="l00724"></a>00724         dwc_ep-&gt;<a class="code" href="structdwc__ep.html#1b9094ddfba3cddf397fd308cdbf4c81">sync_frame</a> = sync_frame;
<a name="l00725"></a>00725 
<a name="l00726"></a>00726         dwc_ep-&gt;<a class="code" href="structdwc__ep.html#4638b25387e59a5a4721a503b5279dfc">buf_proc_intrvl</a> = buf_proc_intrvl;
<a name="l00727"></a>00727 
<a name="l00728"></a>00728         dwc_ep-&gt;<a class="code" href="structdwc__ep.html#d9e9ffe348764ababc3165ed04f9ec6c">bInterval</a> = 1 &lt;&lt; (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#86e27843c439dd0b1d12d9bf2dc6516f">desc</a>-&gt;bInterval - 1);
<a name="l00729"></a>00729 
<a name="l00730"></a>00730         dwc_ep-&gt;<a class="code" href="structdwc__ep.html#53033f174854701986545f05502e1cad">proc_buf_num</a> = 0;
<a name="l00731"></a>00731 
<a name="l00732"></a>00732         dwc_ep-&gt;<a class="code" href="structdwc__ep.html#fe51420474de8a9d74fc9c4adc811c4b">pkt_per_frm</a> = 0;
<a name="l00733"></a>00733         frm_data = ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#4672369f4724db642856d72d5048213e">data_per_frame</a>;
<a name="l00734"></a>00734         <span class="keywordflow">while</span> (frm_data &gt; 0) {
<a name="l00735"></a>00735                 dwc_ep-&gt;<a class="code" href="structdwc__ep.html#fe51420474de8a9d74fc9c4adc811c4b">pkt_per_frm</a>++;
<a name="l00736"></a>00736                 frm_data -= ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#d17473ece3c9a34f5e7a230d3315de94">maxpacket</a>;
<a name="l00737"></a>00737         }
<a name="l00738"></a>00738 
<a name="l00739"></a>00739         dsts.<a class="code" href="uniondsts__data.html#0f126daef735b142b06dbc4cdbe13814">d32</a> = dwc_read_reg32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#a0ed84d057445e2acd4c793f10f91078">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#e261921bab2e67ccc69007fc485d7f82">dev_global_regs</a>-&gt;<a class="code" href="structdwc__otg__dev__global__regs.html#1ed00edd20ce5db7d07666804101ec05">dsts</a>);
<a name="l00740"></a>00740 
<a name="l00741"></a>00741         <span class="keywordflow">if</span> (start_frame == -1) {
<a name="l00742"></a>00742                 dwc_ep-&gt;<a class="code" href="structdwc__ep.html#1e9f4d08454c973c17acb3e52a2c3689">next_frame</a> = dsts.<a class="code" href="uniondsts__data.html#4066fcedb7ac9a88e47aa1b2df0e89ee">b</a>.<a class="code" href="uniondsts__data.html#5a81ac4848c859cbf7d494dc345a0ce8">soffn</a> + 1;
<a name="l00743"></a>00743                 <span class="keywordflow">if</span> (dwc_ep-&gt;<a class="code" href="structdwc__ep.html#d9e9ffe348764ababc3165ed04f9ec6c">bInterval</a> != 1) {
<a name="l00744"></a>00744                         dwc_ep-&gt;<a class="code" href="structdwc__ep.html#1e9f4d08454c973c17acb3e52a2c3689">next_frame</a> =
<a name="l00745"></a>00745                             dwc_ep-&gt;<a class="code" href="structdwc__ep.html#1e9f4d08454c973c17acb3e52a2c3689">next_frame</a> + (dwc_ep-&gt;<a class="code" href="structdwc__ep.html#d9e9ffe348764ababc3165ed04f9ec6c">bInterval</a> - 1 -
<a name="l00746"></a>00746                                                   dwc_ep-&gt;<a class="code" href="structdwc__ep.html#1e9f4d08454c973c17acb3e52a2c3689">next_frame</a> %
<a name="l00747"></a>00747                                                   dwc_ep-&gt;<a class="code" href="structdwc__ep.html#d9e9ffe348764ababc3165ed04f9ec6c">bInterval</a>);
<a name="l00748"></a>00748                 }
<a name="l00749"></a>00749         } <span class="keywordflow">else</span> {
<a name="l00750"></a>00750                 dwc_ep-&gt;<a class="code" href="structdwc__ep.html#1e9f4d08454c973c17acb3e52a2c3689">next_frame</a> = start_frame;
<a name="l00751"></a>00751         }
<a name="l00752"></a>00752 
<a name="l00753"></a>00753         <span class="keywordflow">if</span> (!core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#34540b79e9a14bfa234a52ac132c5cd1">pti_enh_enable</a>) {
<a name="l00754"></a>00754                 dwc_ep-&gt;<a class="code" href="structdwc__ep.html#46349fb0608d8c6849ced211b0628c15">pkt_cnt</a> =
<a name="l00755"></a>00755                     dwc_ep-&gt;<a class="code" href="structdwc__ep.html#4638b25387e59a5a4721a503b5279dfc">buf_proc_intrvl</a> * dwc_ep-&gt;<a class="code" href="structdwc__ep.html#fe51420474de8a9d74fc9c4adc811c4b">pkt_per_frm</a> /
<a name="l00756"></a>00756                     dwc_ep-&gt;<a class="code" href="structdwc__ep.html#d9e9ffe348764ababc3165ed04f9ec6c">bInterval</a>;
<a name="l00757"></a>00757         } <span class="keywordflow">else</span> {
<a name="l00758"></a>00758                 dwc_ep-&gt;<a class="code" href="structdwc__ep.html#46349fb0608d8c6849ced211b0628c15">pkt_cnt</a> =
<a name="l00759"></a>00759                     (dwc_ep-&gt;<a class="code" href="structdwc__ep.html#4672369f4724db642856d72d5048213e">data_per_frame</a> *
<a name="l00760"></a>00760                      (dwc_ep-&gt;<a class="code" href="structdwc__ep.html#4638b25387e59a5a4721a503b5279dfc">buf_proc_intrvl</a> / dwc_ep-&gt;<a class="code" href="structdwc__ep.html#d9e9ffe348764ababc3165ed04f9ec6c">bInterval</a>)
<a name="l00761"></a>00761                      - 1 + dwc_ep-&gt;<a class="code" href="structdwc__ep.html#d17473ece3c9a34f5e7a230d3315de94">maxpacket</a>) / dwc_ep-&gt;<a class="code" href="structdwc__ep.html#d17473ece3c9a34f5e7a230d3315de94">maxpacket</a>;
<a name="l00762"></a>00762         }
<a name="l00763"></a>00763 
<a name="l00764"></a>00764         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#7e3b96c6167eceeeb1090798f8297f1f">dma_desc_enable</a>) {
<a name="l00765"></a>00765                 dwc_ep-&gt;<a class="code" href="structdwc__ep.html#5e5bfcc93d41670bc0d29ad5f0f35871">desc_cnt</a> =
<a name="l00766"></a>00766                     dwc_ep-&gt;<a class="code" href="structdwc__ep.html#4638b25387e59a5a4721a503b5279dfc">buf_proc_intrvl</a> * dwc_ep-&gt;<a class="code" href="structdwc__ep.html#fe51420474de8a9d74fc9c4adc811c4b">pkt_per_frm</a> /
<a name="l00767"></a>00767                     dwc_ep-&gt;<a class="code" href="structdwc__ep.html#d9e9ffe348764ababc3165ed04f9ec6c">bInterval</a>;
<a name="l00768"></a>00768         }
<a name="l00769"></a>00769 
<a name="l00770"></a>00770         <span class="keywordflow">if</span> (atomic_alloc) {
<a name="l00771"></a>00771                 dwc_ep-&gt;<a class="code" href="structdwc__ep.html#a8ed15a24123a2dad6861da7d61dfb48">pkt_info</a> =
<a name="l00772"></a>00772                     dwc_alloc_atomic(<span class="keyword">sizeof</span>(<a class="code" href="structiso__pkt__info.html">iso_pkt_info_t</a>) * dwc_ep-&gt;<a class="code" href="structdwc__ep.html#46349fb0608d8c6849ced211b0628c15">pkt_cnt</a>);
<a name="l00773"></a>00773         } <span class="keywordflow">else</span> {
<a name="l00774"></a>00774                 dwc_ep-&gt;<a class="code" href="structdwc__ep.html#a8ed15a24123a2dad6861da7d61dfb48">pkt_info</a> =
<a name="l00775"></a>00775                     dwc_alloc(<span class="keyword">sizeof</span>(<a class="code" href="structiso__pkt__info.html">iso_pkt_info_t</a>) * dwc_ep-&gt;<a class="code" href="structdwc__ep.html#46349fb0608d8c6849ced211b0628c15">pkt_cnt</a>);
<a name="l00776"></a>00776         }
<a name="l00777"></a>00777         <span class="keywordflow">if</span> (!dwc_ep-&gt;<a class="code" href="structdwc__ep.html#a8ed15a24123a2dad6861da7d61dfb48">pkt_info</a>) {
<a name="l00778"></a>00778                 DWC_SPINUNLOCK_IRQRESTORE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#5d450e4d06659ab2f3b18e5c816776e4">lock</a>, flags);
<a name="l00779"></a>00779                 <span class="keywordflow">return</span> -DWC_E_NO_MEMORY;
<a name="l00780"></a>00780         }
<a name="l00781"></a>00781         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#34540b79e9a14bfa234a52ac132c5cd1">pti_enh_enable</a>) {
<a name="l00782"></a>00782                 dwc_memset(dwc_ep-&gt;<a class="code" href="structdwc__ep.html#a8ed15a24123a2dad6861da7d61dfb48">pkt_info</a>, 0,
<a name="l00783"></a>00783                            <span class="keyword">sizeof</span>(<a class="code" href="structiso__pkt__info.html">iso_pkt_info_t</a>) * dwc_ep-&gt;<a class="code" href="structdwc__ep.html#46349fb0608d8c6849ced211b0628c15">pkt_cnt</a>);
<a name="l00784"></a>00784         }
<a name="l00785"></a>00785 
<a name="l00786"></a>00786         dwc_ep-&gt;<a class="code" href="structdwc__ep.html#d4e63c7d944c2b48260b4a75c2b58925">cur_pkt</a> = 0;
<a name="l00787"></a>00787         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#716d3c29adc54c6822935fc2ae9bef51">iso_req_handle</a> = req_handle;
<a name="l00788"></a>00788 
<a name="l00789"></a>00789         DWC_SPINUNLOCK_IRQRESTORE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#5d450e4d06659ab2f3b18e5c816776e4">lock</a>, flags);
<a name="l00790"></a>00790         <a class="code" href="dwc__otg__pcd_8c.html#3f39ccc23c6f9bd4fd4ab7a5cecc67a3">dwc_otg_iso_ep_start_transfer</a>(core_if, dwc_ep);
<a name="l00791"></a>00791         <span class="keywordflow">return</span> 0;
<a name="l00792"></a>00792 }
<a name="l00793"></a>00793 
<a name="l00794"></a><a class="code" href="dwc__otg__pcd__if_8h.html#5098f89da28c6b450e7e10b31441b945">00794</a> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__pcd_8c.html#5098f89da28c6b450e7e10b31441b945">dwc_otg_pcd_iso_ep_stop</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd, <span class="keywordtype">void</span> *ep_handle,
<a name="l00795"></a>00795                             <span class="keywordtype">void</span> *req_handle)
<a name="l00796"></a>00796 {
<a name="l00797"></a>00797         uint64_t flags = 0;
<a name="l00798"></a>00798         <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> *ep;
<a name="l00799"></a>00799         <a class="code" href="structdwc__ep.html">dwc_ep_t</a> *<a class="code" href="structdwc__ep.html">dwc_ep</a>;
<a name="l00800"></a>00800 
<a name="l00801"></a>00801         ep = <a class="code" href="dwc__otg__pcd_8c.html#4b46c226fa34cd7fc4ceec2c5e7f8ebe">get_ep_from_handle</a>(pcd, ep_handle);
<a name="l00802"></a>00802         <span class="keywordflow">if</span> (!ep || !ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#86e27843c439dd0b1d12d9bf2dc6516f">desc</a> || ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#1dd76dafde9ac2a466d64a5acbc35214">num</a> == 0) {
<a name="l00803"></a>00803                 DWC_WARN(<span class="stringliteral">"bad ep\n"</span>);
<a name="l00804"></a>00804                 <span class="keywordflow">return</span> -DWC_E_INVALID;
<a name="l00805"></a>00805         }
<a name="l00806"></a>00806         dwc_ep = &amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>;
<a name="l00807"></a>00807 
<a name="l00808"></a>00808         <a class="code" href="dwc__otg__pcd_8c.html#2898810e04a9dd19798f59cfdb56c670">dwc_otg_iso_ep_stop_transfer</a>(<a class="code" href="dwc__otg__pcd_8h.html#464549f9f4484651efe25b1a03692d72">GET_CORE_IF</a>(pcd), dwc_ep);
<a name="l00809"></a>00809 
<a name="l00810"></a>00810         dwc_free(dwc_ep-&gt;<a class="code" href="structdwc__ep.html#a8ed15a24123a2dad6861da7d61dfb48">pkt_info</a>);
<a name="l00811"></a>00811         DWC_SPINLOCK_IRQSAVE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#5d450e4d06659ab2f3b18e5c816776e4">lock</a>, &amp;flags);
<a name="l00812"></a>00812         <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#716d3c29adc54c6822935fc2ae9bef51">iso_req_handle</a> != req_handle) {
<a name="l00813"></a>00813                 DWC_SPINUNLOCK_IRQRESTORE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#5d450e4d06659ab2f3b18e5c816776e4">lock</a>, flags);
<a name="l00814"></a>00814                 <span class="keywordflow">return</span> -DWC_E_INVALID;
<a name="l00815"></a>00815         }
<a name="l00816"></a>00816 
<a name="l00817"></a>00817         DWC_SPINUNLOCK_IRQRESTORE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#5d450e4d06659ab2f3b18e5c816776e4">lock</a>, flags);
<a name="l00818"></a>00818 
<a name="l00819"></a>00819         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#716d3c29adc54c6822935fc2ae9bef51">iso_req_handle</a> = 0;
<a name="l00820"></a>00820         <span class="keywordflow">return</span> 0;
<a name="l00821"></a>00821 }
<a name="l00822"></a>00822 
<a name="l00830"></a><a class="code" href="dwc__otg__pcd_8h.html#b4e2c352426923d4bd519cf18b68206d">00830</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd_8c.html#b4e2c352426923d4bd519cf18b68206d">dwc_otg_iso_buffer_done</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd, <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> * ep,
<a name="l00831"></a>00831                              <span class="keywordtype">void</span> *req_handle)
<a name="l00832"></a>00832 {
<a name="l00833"></a>00833         <span class="keywordtype">int</span> i;
<a name="l00834"></a>00834         <a class="code" href="structdwc__ep.html">dwc_ep_t</a> *<a class="code" href="structdwc__ep.html">dwc_ep</a>;
<a name="l00835"></a>00835 
<a name="l00836"></a>00836         dwc_ep = &amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>;
<a name="l00837"></a>00837 
<a name="l00838"></a>00838         DWC_SPINUNLOCK(ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#234391334e48cbd72710d08655c9ed16">pcd</a>-&gt;<a class="code" href="structdwc__otg__pcd.html#5d450e4d06659ab2f3b18e5c816776e4">lock</a>);
<a name="l00839"></a>00839         pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#b7001dde5db2706707a860da0030d9e6">fops</a>-&gt;<a class="code" href="structdwc__otg__pcd__function__ops.html#9714dfa4909221c0b937a9bcadf97339">isoc_complete</a>(pcd, ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#8c8fad971c6c3b1c54d334c7f9b2d03e">priv</a>, ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#716d3c29adc54c6822935fc2ae9bef51">iso_req_handle</a>,
<a name="l00840"></a>00840                                  dwc_ep-&gt;<a class="code" href="structdwc__ep.html#53033f174854701986545f05502e1cad">proc_buf_num</a> ^ 0x1);
<a name="l00841"></a>00841         DWC_SPINLOCK(ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#234391334e48cbd72710d08655c9ed16">pcd</a>-&gt;<a class="code" href="structdwc__otg__pcd.html#5d450e4d06659ab2f3b18e5c816776e4">lock</a>);
<a name="l00842"></a>00842 
<a name="l00843"></a>00843         <span class="keywordflow">for</span> (i = 0; i &lt; dwc_ep-&gt;<a class="code" href="structdwc__ep.html#46349fb0608d8c6849ced211b0628c15">pkt_cnt</a>; ++i) {
<a name="l00844"></a>00844                 dwc_ep-&gt;<a class="code" href="structdwc__ep.html#a8ed15a24123a2dad6861da7d61dfb48">pkt_info</a>[i].<a class="code" href="structiso__pkt__info.html#1317c3b425c0ef55dbde153b04c28dd4">status</a> = 0;
<a name="l00845"></a>00845                 dwc_ep-&gt;<a class="code" href="structdwc__ep.html#a8ed15a24123a2dad6861da7d61dfb48">pkt_info</a>[i].<a class="code" href="structiso__pkt__info.html#0c72a0585ccc93555da4db7e168f75f8">offset</a> = 0;
<a name="l00846"></a>00846                 dwc_ep-&gt;<a class="code" href="structdwc__ep.html#a8ed15a24123a2dad6861da7d61dfb48">pkt_info</a>[i].<a class="code" href="structiso__pkt__info.html#ced82142e81778345016841e15020eb8">length</a> = 0;
<a name="l00847"></a>00847         }
<a name="l00848"></a>00848 }
<a name="l00849"></a>00849 
<a name="l00850"></a><a class="code" href="dwc__otg__pcd__if_8h.html#2f04b14612c2b58909b3a54ed71ab12e">00850</a> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__pcd_8c.html#2f04b14612c2b58909b3a54ed71ab12e">dwc_otg_pcd_get_iso_packet_count</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd, <span class="keywordtype">void</span> *ep_handle,
<a name="l00851"></a>00851                                      <span class="keywordtype">void</span> *iso_req_handle)
<a name="l00852"></a>00852 {
<a name="l00853"></a>00853         <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> *ep;
<a name="l00854"></a>00854         <a class="code" href="structdwc__ep.html">dwc_ep_t</a> *<a class="code" href="structdwc__ep.html">dwc_ep</a>;
<a name="l00855"></a>00855 
<a name="l00856"></a>00856         ep = <a class="code" href="dwc__otg__pcd_8c.html#4b46c226fa34cd7fc4ceec2c5e7f8ebe">get_ep_from_handle</a>(pcd, ep_handle);
<a name="l00857"></a>00857         dwc_ep = &amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>;
<a name="l00858"></a>00858 
<a name="l00859"></a>00859         <span class="keywordflow">return</span> dwc_ep-&gt;<a class="code" href="structdwc__ep.html#46349fb0608d8c6849ced211b0628c15">pkt_cnt</a>;
<a name="l00860"></a>00860 }
<a name="l00861"></a>00861 
<a name="l00862"></a><a class="code" href="dwc__otg__pcd__if_8h.html#21149047aa9abddac5654e4496175ac5">00862</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd_8c.html#21149047aa9abddac5654e4496175ac5">dwc_otg_pcd_get_iso_packet_params</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd, <span class="keywordtype">void</span> *ep_handle,
<a name="l00863"></a>00863                                        <span class="keywordtype">void</span> *iso_req_handle, <span class="keywordtype">int</span> packet,
<a name="l00864"></a>00864                                        <span class="keywordtype">int</span> *status, <span class="keywordtype">int</span> *actual, <span class="keywordtype">int</span> *offset)
<a name="l00865"></a>00865 {
<a name="l00866"></a>00866         <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> *ep;
<a name="l00867"></a>00867         <a class="code" href="structdwc__ep.html">dwc_ep_t</a> *<a class="code" href="structdwc__ep.html">dwc_ep</a>;
<a name="l00868"></a>00868 
<a name="l00869"></a>00869         ep = <a class="code" href="dwc__otg__pcd_8c.html#4b46c226fa34cd7fc4ceec2c5e7f8ebe">get_ep_from_handle</a>(pcd, ep_handle);
<a name="l00870"></a>00870         dwc_ep = &amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>;
<a name="l00871"></a>00871 
<a name="l00872"></a>00872         *status = dwc_ep-&gt;<a class="code" href="structdwc__ep.html#a8ed15a24123a2dad6861da7d61dfb48">pkt_info</a>[packet].<a class="code" href="structiso__pkt__info.html#1317c3b425c0ef55dbde153b04c28dd4">status</a>;
<a name="l00873"></a>00873         *actual = dwc_ep-&gt;<a class="code" href="structdwc__ep.html#a8ed15a24123a2dad6861da7d61dfb48">pkt_info</a>[packet].<a class="code" href="structiso__pkt__info.html#ced82142e81778345016841e15020eb8">length</a>;
<a name="l00874"></a>00874         *offset = dwc_ep-&gt;<a class="code" href="structdwc__ep.html#a8ed15a24123a2dad6861da7d61dfb48">pkt_info</a>[packet].<a class="code" href="structiso__pkt__info.html#0c72a0585ccc93555da4db7e168f75f8">offset</a>;
<a name="l00875"></a>00875 }
<a name="l00876"></a>00876 
<a name="l00877"></a>00877 <span class="preprocessor">#endif                          </span><span class="comment">/* DWC_EN_ISOC */</span>
<a name="l00878"></a>00878 
<a name="l00879"></a><a class="code" href="dwc__otg__pcd_8c.html#dbfe9af71d4c36cbf7eb544a1df9364e">00879</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd_8c.html#dbfe9af71d4c36cbf7eb544a1df9364e">dwc_otg_pcd_init_ep</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd, <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> * pcd_ep,
<a name="l00880"></a>00880                                 uint32_t is_in, uint32_t ep_num)
<a name="l00881"></a>00881 {
<a name="l00882"></a>00882         <span class="comment">/* Init EP structure */</span>
<a name="l00883"></a>00883         pcd_ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#86e27843c439dd0b1d12d9bf2dc6516f">desc</a> = 0;
<a name="l00884"></a>00884         pcd_ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#234391334e48cbd72710d08655c9ed16">pcd</a> = pcd;
<a name="l00885"></a>00885         pcd_ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#cce0e089118d8bf7c6278c21ded70d5a">stopped</a> = 1;
<a name="l00886"></a>00886         pcd_ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#bbec681b68f2f745d1cfecfedd4e64be">queue_sof</a> = 0;
<a name="l00887"></a>00887 
<a name="l00888"></a>00888         <span class="comment">/* Init DWC ep structure */</span>
<a name="l00889"></a>00889         pcd_ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#b882b6b7c857100ed20600e94ea37760">is_in</a> = is_in;
<a name="l00890"></a>00890         pcd_ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#1dd76dafde9ac2a466d64a5acbc35214">num</a> = ep_num;
<a name="l00891"></a>00891         pcd_ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#63b7a1a3ee32df393ff10d8bfc5c8648">active</a> = 0;
<a name="l00892"></a>00892         pcd_ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#ffa14f48094778143353b845b5d238cd">tx_fifo_num</a> = 0;
<a name="l00893"></a>00893         <span class="comment">/* Control until ep is actvated */</span>
<a name="l00894"></a>00894         pcd_ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#17b10677bd9b0a1d612dd4ce2fb0eb0f">type</a> = <a class="code" href="dwc__otg__cil_8h.html#64e5cd756330f5adab79b25cc8067bdc">DWC_OTG_EP_TYPE_CONTROL</a>;
<a name="l00895"></a>00895         pcd_ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#d17473ece3c9a34f5e7a230d3315de94">maxpacket</a> = <a class="code" href="dwc__otg__pcd__if_8h.html#cf2c48a3393f5ae43e8d88d01c2d204a">MAX_PACKET_SIZE</a>;
<a name="l00896"></a>00896         pcd_ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#b40ce70422b6d105a855a8df4b33d45d">dma_addr</a> = 0;
<a name="l00897"></a>00897         pcd_ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#d0cda8ded2e5142d9a1c9c17efc5812f">start_xfer_buff</a> = 0;
<a name="l00898"></a>00898         pcd_ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#97fa9bf5c31ba734d54f70e6fe6ae8eb">xfer_buff</a> = 0;
<a name="l00899"></a>00899         pcd_ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#36d4010478ceb27479c0b12b376a7924">xfer_len</a> = 0;
<a name="l00900"></a>00900         pcd_ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#23d4871510b5bcb54fbf0674d8f122bd">xfer_count</a> = 0;
<a name="l00901"></a>00901         pcd_ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#8c6340435beba0b8c025a4677602acab">sent_zlp</a> = 0;
<a name="l00902"></a>00902         pcd_ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#5a218f200cff0491b735f43fed5176bf">total_len</a> = 0;
<a name="l00903"></a>00903         pcd_ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#57e934b26e76939912eaa76321075a0d">desc_addr</a> = 0;
<a name="l00904"></a>00904         pcd_ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#1a43e464429530e874472092e0e1af09">dma_desc_addr</a> = 0;
<a name="l00905"></a>00905         DWC_CIRCLEQ_INIT(&amp;pcd_ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#71f4fa571dfdc96f62fa4869e6add300">queue</a>);
<a name="l00906"></a>00906 }
<a name="l00907"></a>00907 
<a name="l00911"></a><a class="code" href="dwc__otg__pcd_8c.html#b6506996bd4b93ef4f80092a64384fae">00911</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd_8c.html#b6506996bd4b93ef4f80092a64384fae">dwc_otg_pcd_reinit</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd)
<a name="l00912"></a>00912 {
<a name="l00913"></a>00913         <span class="keywordtype">int</span> i;
<a name="l00914"></a>00914         uint32_t hwcfg1;
<a name="l00915"></a>00915         <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> *ep;
<a name="l00916"></a>00916         <span class="keywordtype">int</span> in_ep_cntr, out_ep_cntr;
<a name="l00917"></a>00917         uint32_t num_in_eps = (<a class="code" href="dwc__otg__pcd_8h.html#464549f9f4484651efe25b1a03692d72">GET_CORE_IF</a>(pcd))-&gt;dev_if-&gt;num_in_eps;
<a name="l00918"></a>00918         uint32_t num_out_eps = (<a class="code" href="dwc__otg__pcd_8h.html#464549f9f4484651efe25b1a03692d72">GET_CORE_IF</a>(pcd))-&gt;dev_if-&gt;num_out_eps;
<a name="l00919"></a>00919 
<a name="l00923"></a>00923         ep = &amp;pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#14f4f2a41d1305fdc0ec1806d119da89">ep0</a>;
<a name="l00924"></a>00924         <a class="code" href="dwc__otg__pcd_8c.html#dbfe9af71d4c36cbf7eb544a1df9364e">dwc_otg_pcd_init_ep</a>(pcd, ep, 0, 0);
<a name="l00925"></a>00925 
<a name="l00926"></a>00926         in_ep_cntr = 0;
<a name="l00927"></a>00927         hwcfg1 = (<a class="code" href="dwc__otg__pcd_8h.html#464549f9f4484651efe25b1a03692d72">GET_CORE_IF</a>(pcd))-&gt;hwcfg1.d32 &gt;&gt; 3;
<a name="l00928"></a>00928         for (i = 1; in_ep_cntr &lt; num_in_eps; i++) {
<a name="l00929"></a>00929                 <span class="keywordflow">if</span> ((hwcfg1 &amp; 0x1) == 0) {
<a name="l00930"></a>00930                         <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> *ep = &amp;pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#dbfc8c424ea3add38db96fa87219caa8">in_ep</a>[in_ep_cntr];
<a name="l00931"></a>00931                         in_ep_cntr++;
<a name="l00937"></a>00937                         <a class="code" href="dwc__otg__pcd_8c.html#dbfe9af71d4c36cbf7eb544a1df9364e">dwc_otg_pcd_init_ep</a>(pcd, ep, 1 <span class="comment">/* IN */</span> , i);
<a name="l00938"></a>00938 
<a name="l00939"></a>00939                         DWC_CIRCLEQ_INIT(&amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#71f4fa571dfdc96f62fa4869e6add300">queue</a>);
<a name="l00940"></a>00940                 }
<a name="l00941"></a>00941                 hwcfg1 &gt;&gt;= 2;
<a name="l00942"></a>00942         }
<a name="l00943"></a>00943 
<a name="l00944"></a>00944         out_ep_cntr = 0;
<a name="l00945"></a>00945         hwcfg1 = (<a class="code" href="dwc__otg__pcd_8h.html#464549f9f4484651efe25b1a03692d72">GET_CORE_IF</a>(pcd))-&gt;hwcfg1.d32 &gt;&gt; 2;
<a name="l00946"></a>00946         for (i = 1; out_ep_cntr &lt; num_out_eps; i++) {
<a name="l00947"></a>00947                 <span class="keywordflow">if</span> ((hwcfg1 &amp; 0x1) == 0) {
<a name="l00948"></a>00948                         <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> *ep = &amp;pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#b9e49a1d1fbca5ba9523e27c7108df30">out_ep</a>[out_ep_cntr];
<a name="l00949"></a>00949                         out_ep_cntr++;
<a name="l00955"></a>00955                         <a class="code" href="dwc__otg__pcd_8c.html#dbfe9af71d4c36cbf7eb544a1df9364e">dwc_otg_pcd_init_ep</a>(pcd, ep, 0 <span class="comment">/* OUT */</span> , i);
<a name="l00956"></a>00956                         DWC_CIRCLEQ_INIT(&amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#71f4fa571dfdc96f62fa4869e6add300">queue</a>);
<a name="l00957"></a>00957                 }
<a name="l00958"></a>00958                 hwcfg1 &gt;&gt;= 2;
<a name="l00959"></a>00959         }
<a name="l00960"></a>00960 
<a name="l00961"></a>00961         pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#8f6963b3fb9ab83048c4c0697c90382a">ep0state</a> = EP0_DISCONNECT;
<a name="l00962"></a>00962         pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#14f4f2a41d1305fdc0ec1806d119da89">ep0</a>.<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#d17473ece3c9a34f5e7a230d3315de94">maxpacket</a> = <a class="code" href="dwc__otg__pcd__if_8h.html#8fbbba66f80923843e99def6064a570f">MAX_EP0_SIZE</a>;
<a name="l00963"></a>00963         pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#14f4f2a41d1305fdc0ec1806d119da89">ep0</a>.<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#17b10677bd9b0a1d612dd4ce2fb0eb0f">type</a> = <a class="code" href="dwc__otg__cil_8h.html#64e5cd756330f5adab79b25cc8067bdc">DWC_OTG_EP_TYPE_CONTROL</a>;
<a name="l00964"></a>00964 }
<a name="l00965"></a>00965 
<a name="l00970"></a><a class="code" href="dwc__otg__pcd_8c.html#e1e5a9264c2ad212d697d6be1110874f">00970</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd_8c.html#e1e5a9264c2ad212d697d6be1110874f">srp_timeout</a>(<span class="keywordtype">void</span> *ptr)
<a name="l00971"></a>00971 {
<a name="l00972"></a>00972         <a class="code" href="uniongotgctl__data.html">gotgctl_data_t</a> gotgctl;
<a name="l00973"></a>00973         <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *core_if = (<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *) ptr;
<a name="l00974"></a>00974         <span class="keyword">volatile</span> uint32_t *addr = &amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#909eae7e3b9432ca1e278b99f7811f52">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#54034d00bb6b47ada4e0c0baa87cbd8a">gotgctl</a>;
<a name="l00975"></a>00975 
<a name="l00976"></a>00976         gotgctl.<a class="code" href="uniongotgctl__data.html#ebb591ab40ff41f0e06f03a795647d33">d32</a> = dwc_read_reg32(addr);
<a name="l00977"></a>00977 
<a name="l00978"></a>00978         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#749cdeef193b7590b036a9b1d1442b73">srp_timer_started</a> = 0;
<a name="l00979"></a>00979 
<a name="l00980"></a>00980         <span class="keywordflow">if</span> ((core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#63ffc9b8e36340bd59bf1fab9ca490ad">core_params</a>-&gt;<a class="code" href="structdwc__otg__core__params.html#8b5d4e0c98c46d0d4e80b6faf66daf72">phy_type</a> == <a class="code" href="dwc__otg__core__if_8h.html#f7395410ea596c4c660f61ff41cb38b8">DWC_PHY_TYPE_PARAM_FS</a>) &amp;&amp;
<a name="l00981"></a>00981             (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#63ffc9b8e36340bd59bf1fab9ca490ad">core_params</a>-&gt;<a class="code" href="structdwc__otg__core__params.html#6b0a0ab15284a541ae079beecaf3e617">i2c_enable</a>)) {
<a name="l00982"></a>00982                 DWC_PRINTF(<span class="stringliteral">"SRP Timeout\n"</span>);
<a name="l00983"></a>00983 
<a name="l00984"></a>00984                 <span class="keywordflow">if</span> ((core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#c2bb1913ed3fcc082a06d70242e9768a">srp_success</a>) &amp;&amp; (gotgctl.<a class="code" href="uniongotgctl__data.html#212c81366266e906a188f4dbfadb6dd3">b</a>.<a class="code" href="uniongotgctl__data.html#69931c3759421d5eb6f91d4c9da4dddd">bsesvld</a>)) {
<a name="l00985"></a>00985                         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#83bca1e02fafc4bbfa9c1f2eeb19b245">pcd_cb</a> &amp;&amp; core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#83bca1e02fafc4bbfa9c1f2eeb19b245">pcd_cb</a>-&gt;<a class="code" href="structdwc__otg__cil__callbacks.html#ad1895ddf4ad83622a514a725b4129d6">resume_wakeup</a>) {
<a name="l00986"></a>00986                                 core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#83bca1e02fafc4bbfa9c1f2eeb19b245">pcd_cb</a>-&gt;<a class="code" href="structdwc__otg__cil__callbacks.html#ad1895ddf4ad83622a514a725b4129d6">resume_wakeup</a>(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#83bca1e02fafc4bbfa9c1f2eeb19b245">pcd_cb</a>-&gt;
<a name="l00987"></a>00987                                                                p);
<a name="l00988"></a>00988                         }
<a name="l00989"></a>00989 
<a name="l00990"></a>00990                         <span class="comment">/* Clear Session Request */</span>
<a name="l00991"></a>00991                         gotgctl.<a class="code" href="uniongotgctl__data.html#ebb591ab40ff41f0e06f03a795647d33">d32</a> = 0;
<a name="l00992"></a>00992                         gotgctl.<a class="code" href="uniongotgctl__data.html#212c81366266e906a188f4dbfadb6dd3">b</a>.<a class="code" href="uniongotgctl__data.html#c6b0b35d4366f74cf6fe268eda781f06">sesreq</a> = 1;
<a name="l00993"></a>00993                         dwc_modify_reg32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#909eae7e3b9432ca1e278b99f7811f52">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#54034d00bb6b47ada4e0c0baa87cbd8a">gotgctl</a>,
<a name="l00994"></a>00994                                          gotgctl.<a class="code" href="uniongotgctl__data.html#ebb591ab40ff41f0e06f03a795647d33">d32</a>, 0);
<a name="l00995"></a>00995 
<a name="l00996"></a>00996                         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#c2bb1913ed3fcc082a06d70242e9768a">srp_success</a> = 0;
<a name="l00997"></a>00997                 } <span class="keywordflow">else</span> {
<a name="l00998"></a>00998                         __DWC_ERROR(<span class="stringliteral">"Device not connected/responding\n"</span>);
<a name="l00999"></a>00999                         gotgctl.<a class="code" href="uniongotgctl__data.html#212c81366266e906a188f4dbfadb6dd3">b</a>.<a class="code" href="uniongotgctl__data.html#c6b0b35d4366f74cf6fe268eda781f06">sesreq</a> = 0;
<a name="l01000"></a>01000                         dwc_write_reg32(addr, gotgctl.<a class="code" href="uniongotgctl__data.html#ebb591ab40ff41f0e06f03a795647d33">d32</a>);
<a name="l01001"></a>01001                 }
<a name="l01002"></a>01002         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (gotgctl.<a class="code" href="uniongotgctl__data.html#212c81366266e906a188f4dbfadb6dd3">b</a>.<a class="code" href="uniongotgctl__data.html#c6b0b35d4366f74cf6fe268eda781f06">sesreq</a>) {
<a name="l01003"></a>01003                 DWC_PRINTF(<span class="stringliteral">"SRP Timeout\n"</span>);
<a name="l01004"></a>01004 
<a name="l01005"></a>01005                 __DWC_ERROR(<span class="stringliteral">"Device not connected/responding\n"</span>);
<a name="l01006"></a>01006                 gotgctl.<a class="code" href="uniongotgctl__data.html#212c81366266e906a188f4dbfadb6dd3">b</a>.<a class="code" href="uniongotgctl__data.html#c6b0b35d4366f74cf6fe268eda781f06">sesreq</a> = 0;
<a name="l01007"></a>01007                 dwc_write_reg32(addr, gotgctl.<a class="code" href="uniongotgctl__data.html#ebb591ab40ff41f0e06f03a795647d33">d32</a>);
<a name="l01008"></a>01008         } <span class="keywordflow">else</span> {
<a name="l01009"></a>01009                 DWC_PRINTF(<span class="stringliteral">" SRP GOTGCTL=%0x\n"</span>, gotgctl.<a class="code" href="uniongotgctl__data.html#ebb591ab40ff41f0e06f03a795647d33">d32</a>);
<a name="l01010"></a>01010         }
<a name="l01011"></a>01011 }
<a name="l01012"></a>01012 
<a name="l01017"></a>01017 <span class="keyword">extern</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd_8c.html#de7160b7e7b8fd622ba95392513e197c">start_next_request</a>(<a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> * ep);
<a name="l01018"></a>01018 
<a name="l01019"></a><a class="code" href="dwc__otg__pcd_8c.html#4d9d8f7fb8f74eb64176fba91b38cb35">01019</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd_8c.html#4d9d8f7fb8f74eb64176fba91b38cb35">start_xfer_tasklet_func</a>(<span class="keywordtype">void</span> *data)
<a name="l01020"></a>01020 {
<a name="l01021"></a>01021         <a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> *pcd = (<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> *) data;
<a name="l01022"></a>01022         <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *core_if = <a class="code" href="dwc__otg__pcd_8h.html#464549f9f4484651efe25b1a03692d72">GET_CORE_IF</a>(pcd);
<a name="l01023"></a>01023 
<a name="l01024"></a>01024         <span class="keywordtype">int</span> i;
<a name="l01025"></a>01025         <a class="code" href="uniondepctl__data.html">depctl_data_t</a> diepctl;
<a name="l01026"></a>01026 
<a name="l01027"></a>01027         <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#fe60e047aac272899de8f63b43df80e7">DBG_PCDV</a>, <span class="stringliteral">"Start xfer tasklet\n"</span>);
<a name="l01028"></a>01028 
<a name="l01029"></a>01029         diepctl.<a class="code" href="uniondepctl__data.html#c3d4448663382417e50e23c05ff11a09">d32</a> = dwc_read_reg32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#a0ed84d057445e2acd4c793f10f91078">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#7329ead96344810d718f63738b54a4ca">in_ep_regs</a>[0]-&gt;<a class="code" href="structdwc__otg__dev__in__ep__regs.html#53a5adb977e2aec66d4902c6ba293216">diepctl</a>);
<a name="l01030"></a>01030 
<a name="l01031"></a>01031         <span class="keywordflow">if</span> (pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#14f4f2a41d1305fdc0ec1806d119da89">ep0</a>.<a class="code" href="structdwc__otg__pcd__ep.html#bbec681b68f2f745d1cfecfedd4e64be">queue_sof</a>) {
<a name="l01032"></a>01032                 pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#14f4f2a41d1305fdc0ec1806d119da89">ep0</a>.<a class="code" href="structdwc__otg__pcd__ep.html#bbec681b68f2f745d1cfecfedd4e64be">queue_sof</a> = 0;
<a name="l01033"></a>01033                 <a class="code" href="dwc__otg__pcd_8c.html#de7160b7e7b8fd622ba95392513e197c">start_next_request</a>(&amp;pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#14f4f2a41d1305fdc0ec1806d119da89">ep0</a>);
<a name="l01034"></a>01034                 <span class="comment">// break;</span>
<a name="l01035"></a>01035         }
<a name="l01036"></a>01036 
<a name="l01037"></a>01037         <span class="keywordflow">for</span> (i = 0; i &lt; core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#a0ed84d057445e2acd4c793f10f91078">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#4fae9bc1293bf2e58966c38fa5b98822">num_in_eps</a>; i++) {
<a name="l01038"></a>01038                 <a class="code" href="uniondepctl__data.html">depctl_data_t</a> diepctl;
<a name="l01039"></a>01039                 diepctl.<a class="code" href="uniondepctl__data.html#c3d4448663382417e50e23c05ff11a09">d32</a> =
<a name="l01040"></a>01040                     dwc_read_reg32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#a0ed84d057445e2acd4c793f10f91078">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#7329ead96344810d718f63738b54a4ca">in_ep_regs</a>[i]-&gt;<a class="code" href="structdwc__otg__dev__in__ep__regs.html#53a5adb977e2aec66d4902c6ba293216">diepctl</a>);
<a name="l01041"></a>01041 
<a name="l01042"></a>01042                 <span class="keywordflow">if</span> (pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#dbfc8c424ea3add38db96fa87219caa8">in_ep</a>[i].<a class="code" href="structdwc__otg__pcd__ep.html#bbec681b68f2f745d1cfecfedd4e64be">queue_sof</a>) {
<a name="l01043"></a>01043                         pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#dbfc8c424ea3add38db96fa87219caa8">in_ep</a>[i].<a class="code" href="structdwc__otg__pcd__ep.html#bbec681b68f2f745d1cfecfedd4e64be">queue_sof</a> = 0;
<a name="l01044"></a>01044                         <a class="code" href="dwc__otg__pcd_8c.html#de7160b7e7b8fd622ba95392513e197c">start_next_request</a>(&amp;pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#dbfc8c424ea3add38db96fa87219caa8">in_ep</a>[i]);
<a name="l01045"></a>01045                         <span class="comment">// break;</span>
<a name="l01046"></a>01046                 }
<a name="l01047"></a>01047         }
<a name="l01048"></a>01048 
<a name="l01049"></a>01049         <span class="keywordflow">return</span>;
<a name="l01050"></a>01050 }
<a name="l01051"></a>01051 
<a name="l01056"></a><a class="code" href="dwc__otg__pcd__if_8h.html#fc3d8c56afa93b474180cc1eb8624ab8">01056</a> <a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> *<a class="code" href="dwc__otg__pcd_8c.html#fc3d8c56afa93b474180cc1eb8624ab8">dwc_otg_pcd_init</a>(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if)
<a name="l01057"></a>01057 {
<a name="l01058"></a>01058         <a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> *pcd = 0;
<a name="l01059"></a>01059         <a class="code" href="structdwc__otg__dev__if.html">dwc_otg_dev_if_t</a> *dev_if;
<a name="l01060"></a>01060 
<a name="l01061"></a>01061         <span class="comment">/*</span>
<a name="l01062"></a>01062 <span class="comment">         * Allocate PCD structure</span>
<a name="l01063"></a>01063 <span class="comment">         */</span>
<a name="l01064"></a>01064         pcd = dwc_alloc(<span class="keyword">sizeof</span>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a>));
<a name="l01065"></a>01065 
<a name="l01066"></a>01066         <span class="keywordflow">if</span> (pcd == 0) {
<a name="l01067"></a>01067                 <span class="keywordflow">return</span> NULL;
<a name="l01068"></a>01068         }
<a name="l01069"></a>01069 
<a name="l01070"></a>01070         pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#5d450e4d06659ab2f3b18e5c816776e4">lock</a> = DWC_SPINLOCK_ALLOC();
<a name="l01071"></a>01071         pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#995be0b313ab6aefc095c598528bbd4c">core_if</a> = core_if;
<a name="l01072"></a>01072         <span class="keywordflow">if</span> (!pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#5d450e4d06659ab2f3b18e5c816776e4">lock</a>) {
<a name="l01073"></a>01073                 DWC_ERROR(<span class="stringliteral">"Could not allocate lock for pcd"</span>);
<a name="l01074"></a>01074                 dwc_free(pcd);
<a name="l01075"></a>01075                 <span class="keywordflow">return</span> NULL;
<a name="l01076"></a>01076         }
<a name="l01077"></a>01077         dev_if = core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#a0ed84d057445e2acd4c793f10f91078">dev_if</a>;
<a name="l01078"></a>01078 
<a name="l01079"></a>01079         <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#9c1394f3c46adde2fa7be79bf0237f9b">hwcfg4</a>.<a class="code" href="unionhwcfg4__data.html#9fb9175668e2381c568c5adbf6e5225d">b</a>.<a class="code" href="unionhwcfg4__data.html#175e8897d6e3c8ef4026413943de503b">ded_fifo_en</a>) {
<a name="l01080"></a>01080                 DWC_PRINTF(<span class="stringliteral">"Dedicated Tx FIFOs mode\n"</span>);
<a name="l01081"></a>01081         } <span class="keywordflow">else</span> {
<a name="l01082"></a>01082                 DWC_PRINTF(<span class="stringliteral">"Shared Tx FIFO mode\n"</span>);
<a name="l01083"></a>01083         }
<a name="l01084"></a>01084 
<a name="l01085"></a>01085         <span class="comment">/*</span>
<a name="l01086"></a>01086 <span class="comment">         * Initialized the Core for Device mode.</span>
<a name="l01087"></a>01087 <span class="comment">         */</span>
<a name="l01088"></a>01088         <span class="keywordflow">if</span> (<a class="code" href="dwc__otg__cil_8c.html#e83fb22890bc54c6b06cedb751430e77">dwc_otg_is_device_mode</a>(core_if)) {
<a name="l01089"></a>01089                 <a class="code" href="dwc__otg__cil_8c.html#f79b0f3b5b96b0535e33627ee3a66eba">dwc_otg_core_dev_init</a>(core_if);
<a name="l01090"></a>01090         }
<a name="l01091"></a>01091 
<a name="l01092"></a>01092         <span class="comment">/*</span>
<a name="l01093"></a>01093 <span class="comment">         * Register the PCD Callbacks.</span>
<a name="l01094"></a>01094 <span class="comment">         */</span>
<a name="l01095"></a>01095         <a class="code" href="dwc__otg__cil_8c.html#d2a92003214f444d7ec35dd0c4bb4bc0">dwc_otg_cil_register_pcd_callbacks</a>(core_if, &amp;<a class="code" href="dwc__otg__pcd_8c.html#c360aaa36ba28b977284fd482e7bc5ca">pcd_callbacks</a>, pcd);
<a name="l01096"></a>01096 
<a name="l01097"></a>01097         <span class="comment">/*</span>
<a name="l01098"></a>01098 <span class="comment">         * Initialize the DMA buffer for SETUP packets</span>
<a name="l01099"></a>01099 <span class="comment">         */</span>
<a name="l01100"></a>01100         <span class="keywordflow">if</span> (<a class="code" href="dwc__otg__pcd_8h.html#464549f9f4484651efe25b1a03692d72">GET_CORE_IF</a>(pcd)-&gt;dma_enable) {
<a name="l01101"></a>01101                 pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#5ea5c519e678fbb382c2ea7d128562c1">setup_pkt</a> =
<a name="l01102"></a>01102                     dwc_dma_alloc(<span class="keyword">sizeof</span>(*pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#5ea5c519e678fbb382c2ea7d128562c1">setup_pkt</a>) * 5,
<a name="l01103"></a>01103                                   &amp;pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#606d94ec61cca4c21e4dc9cb2e3b7064">setup_pkt_dma_handle</a>);
<a name="l01104"></a>01104                 <span class="keywordflow">if</span> (pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#5ea5c519e678fbb382c2ea7d128562c1">setup_pkt</a> == 0) {
<a name="l01105"></a>01105                         dwc_free(pcd);
<a name="l01106"></a>01106                         <span class="keywordflow">return</span> NULL;
<a name="l01107"></a>01107                 }
<a name="l01108"></a>01108 
<a name="l01109"></a>01109                 pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#ca247241f78970f27e5c964fc04d47c8">status_buf</a> =
<a name="l01110"></a>01110                     dwc_dma_alloc(<span class="keyword">sizeof</span>(uint16_t),
<a name="l01111"></a>01111                                   &amp;pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#c3880dd4ce15c515ba37b90b6e7fd293">status_buf_dma_handle</a>);
<a name="l01112"></a>01112                 <span class="keywordflow">if</span> (pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#ca247241f78970f27e5c964fc04d47c8">status_buf</a> == 0) {
<a name="l01113"></a>01113                         dwc_dma_free(<span class="keyword">sizeof</span>(*pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#5ea5c519e678fbb382c2ea7d128562c1">setup_pkt</a>) * 5,
<a name="l01114"></a>01114                                      pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#5ea5c519e678fbb382c2ea7d128562c1">setup_pkt</a>, pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#606d94ec61cca4c21e4dc9cb2e3b7064">setup_pkt_dma_handle</a>);
<a name="l01115"></a>01115                         dwc_free(pcd);
<a name="l01116"></a>01116                         <span class="keywordflow">return</span> NULL;
<a name="l01117"></a>01117                 }
<a name="l01118"></a>01118 
<a name="l01119"></a>01119                 <span class="keywordflow">if</span> (<a class="code" href="dwc__otg__pcd_8h.html#464549f9f4484651efe25b1a03692d72">GET_CORE_IF</a>(pcd)-&gt;dma_desc_enable) {
<a name="l01120"></a>01120                         dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#f149a6cbedd5f180ff033caeee6f527e">setup_desc_addr</a>[0] =
<a name="l01121"></a>01121                             <a class="code" href="dwc__otg__pcd_8c.html#18b4a856523673f3bf97b676c8d9717e">dwc_otg_ep_alloc_desc_chain</a>(&amp;dev_if-&gt;
<a name="l01122"></a>01122                                                         dma_setup_desc_addr[0],
<a name="l01123"></a>01123                                                         1);
<a name="l01124"></a>01124                         dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#f149a6cbedd5f180ff033caeee6f527e">setup_desc_addr</a>[1] =
<a name="l01125"></a>01125                             <a class="code" href="dwc__otg__pcd_8c.html#18b4a856523673f3bf97b676c8d9717e">dwc_otg_ep_alloc_desc_chain</a>(&amp;dev_if-&gt;
<a name="l01126"></a>01126                                                         dma_setup_desc_addr[1],
<a name="l01127"></a>01127                                                         1);
<a name="l01128"></a>01128                         dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#99f44e328bbb4401aabd8e2708853238">in_desc_addr</a> =
<a name="l01129"></a>01129                             <a class="code" href="dwc__otg__pcd_8c.html#18b4a856523673f3bf97b676c8d9717e">dwc_otg_ep_alloc_desc_chain</a>(&amp;dev_if-&gt;
<a name="l01130"></a>01130                                                         dma_in_desc_addr, 1);
<a name="l01131"></a>01131                         dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#8cc9be8ccaba2ef93b02b34ba7b26bad">out_desc_addr</a> =
<a name="l01132"></a>01132                             <a class="code" href="dwc__otg__pcd_8c.html#18b4a856523673f3bf97b676c8d9717e">dwc_otg_ep_alloc_desc_chain</a>(&amp;dev_if-&gt;
<a name="l01133"></a>01133                                                         dma_out_desc_addr, 1);
<a name="l01134"></a>01134 
<a name="l01135"></a>01135                         <span class="keywordflow">if</span> (dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#f149a6cbedd5f180ff033caeee6f527e">setup_desc_addr</a>[0] == 0
<a name="l01136"></a>01136                             || dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#f149a6cbedd5f180ff033caeee6f527e">setup_desc_addr</a>[1] == 0
<a name="l01137"></a>01137                             || dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#99f44e328bbb4401aabd8e2708853238">in_desc_addr</a> == 0
<a name="l01138"></a>01138                             || dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#8cc9be8ccaba2ef93b02b34ba7b26bad">out_desc_addr</a> == 0) {
<a name="l01139"></a>01139 
<a name="l01140"></a>01140                                 <span class="keywordflow">if</span> (dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#8cc9be8ccaba2ef93b02b34ba7b26bad">out_desc_addr</a>)
<a name="l01141"></a>01141                                         <a class="code" href="dwc__otg__pcd_8c.html#1926b61a7438bd9a14bd6d6a26c6a63d">dwc_otg_ep_free_desc_chain</a>(dev_if-&gt;
<a name="l01142"></a>01142                                                                    out_desc_addr,
<a name="l01143"></a>01143                                                                    dev_if-&gt;
<a name="l01144"></a>01144                                                                    dma_out_desc_addr,
<a name="l01145"></a>01145                                                                    1);
<a name="l01146"></a>01146                                 <span class="keywordflow">if</span> (dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#99f44e328bbb4401aabd8e2708853238">in_desc_addr</a>)
<a name="l01147"></a>01147                                         <a class="code" href="dwc__otg__pcd_8c.html#1926b61a7438bd9a14bd6d6a26c6a63d">dwc_otg_ep_free_desc_chain</a>(dev_if-&gt;
<a name="l01148"></a>01148                                                                    in_desc_addr,
<a name="l01149"></a>01149                                                                    dev_if-&gt;
<a name="l01150"></a>01150                                                                    dma_in_desc_addr,
<a name="l01151"></a>01151                                                                    1);
<a name="l01152"></a>01152                                 <span class="keywordflow">if</span> (dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#f149a6cbedd5f180ff033caeee6f527e">setup_desc_addr</a>[1])
<a name="l01153"></a>01153                                         <a class="code" href="dwc__otg__pcd_8c.html#1926b61a7438bd9a14bd6d6a26c6a63d">dwc_otg_ep_free_desc_chain</a>(dev_if-&gt;
<a name="l01154"></a>01154                                                                    setup_desc_addr
<a name="l01155"></a>01155                                                                    [1],
<a name="l01156"></a>01156                                                                    dev_if-&gt;
<a name="l01157"></a>01157                                                                    dma_setup_desc_addr
<a name="l01158"></a>01158                                                                    [1], 1);
<a name="l01159"></a>01159                                 <span class="keywordflow">if</span> (dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#f149a6cbedd5f180ff033caeee6f527e">setup_desc_addr</a>[0])
<a name="l01160"></a>01160                                         <a class="code" href="dwc__otg__pcd_8c.html#1926b61a7438bd9a14bd6d6a26c6a63d">dwc_otg_ep_free_desc_chain</a>(dev_if-&gt;
<a name="l01161"></a>01161                                                                    setup_desc_addr
<a name="l01162"></a>01162                                                                    [0],
<a name="l01163"></a>01163                                                                    dev_if-&gt;
<a name="l01164"></a>01164                                                                    dma_setup_desc_addr
<a name="l01165"></a>01165                                                                    [0], 1);
<a name="l01166"></a>01166 
<a name="l01167"></a>01167                                 dwc_dma_free(<span class="keyword">sizeof</span>(*pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#5ea5c519e678fbb382c2ea7d128562c1">setup_pkt</a>) * 5,
<a name="l01168"></a>01168                                              pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#5ea5c519e678fbb382c2ea7d128562c1">setup_pkt</a>,
<a name="l01169"></a>01169                                              pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#606d94ec61cca4c21e4dc9cb2e3b7064">setup_pkt_dma_handle</a>);
<a name="l01170"></a>01170                                 dwc_dma_free(<span class="keyword">sizeof</span>(*pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#ca247241f78970f27e5c964fc04d47c8">status_buf</a>),
<a name="l01171"></a>01171                                              pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#ca247241f78970f27e5c964fc04d47c8">status_buf</a>,
<a name="l01172"></a>01172                                              pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#c3880dd4ce15c515ba37b90b6e7fd293">status_buf_dma_handle</a>);
<a name="l01173"></a>01173 
<a name="l01174"></a>01174                                 dwc_free(pcd);
<a name="l01175"></a>01175 
<a name="l01176"></a>01176                                 <span class="keywordflow">return</span> NULL;
<a name="l01177"></a>01177                         }
<a name="l01178"></a>01178                 }
<a name="l01179"></a>01179         } <span class="keywordflow">else</span> {
<a name="l01180"></a>01180                 pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#5ea5c519e678fbb382c2ea7d128562c1">setup_pkt</a> = dwc_alloc(<span class="keyword">sizeof</span>(*pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#5ea5c519e678fbb382c2ea7d128562c1">setup_pkt</a>) * 5);
<a name="l01181"></a>01181                 <span class="keywordflow">if</span> (pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#5ea5c519e678fbb382c2ea7d128562c1">setup_pkt</a> == 0) {
<a name="l01182"></a>01182                         dwc_free(pcd);
<a name="l01183"></a>01183                         <span class="keywordflow">return</span> NULL;
<a name="l01184"></a>01184                 }
<a name="l01185"></a>01185 
<a name="l01186"></a>01186                 pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#ca247241f78970f27e5c964fc04d47c8">status_buf</a> = dwc_alloc(<span class="keyword">sizeof</span>(uint16_t));
<a name="l01187"></a>01187                 <span class="keywordflow">if</span> (pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#ca247241f78970f27e5c964fc04d47c8">status_buf</a> == 0) {
<a name="l01188"></a>01188                         dwc_free(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#5ea5c519e678fbb382c2ea7d128562c1">setup_pkt</a>);
<a name="l01189"></a>01189                         dwc_free(pcd);
<a name="l01190"></a>01190                         <span class="keywordflow">return</span> NULL;
<a name="l01191"></a>01191                 }
<a name="l01192"></a>01192         }
<a name="l01193"></a>01193 
<a name="l01194"></a>01194         <a class="code" href="dwc__otg__pcd_8c.html#b6506996bd4b93ef4f80092a64384fae">dwc_otg_pcd_reinit</a>(pcd);
<a name="l01195"></a>01195 
<a name="l01196"></a>01196         <span class="comment">/* Allocate the cfi object for the PCD */</span>
<a name="l01197"></a>01197 <span class="preprocessor">#ifdef DWC_UTE_CFI</span>
<a name="l01198"></a>01198 <span class="preprocessor"></span>        pcd-&gt;cfi = dwc_alloc(<span class="keyword">sizeof</span>(<a class="code" href="structcfiobject.html">cfiobject_t</a>));
<a name="l01199"></a>01199         <span class="keywordflow">if</span> (NULL == pcd-&gt;cfi)
<a name="l01200"></a>01200                 <span class="keywordflow">return</span> NULL;
<a name="l01201"></a>01201         <span class="keywordflow">if</span> (init_cfi(pcd-&gt;cfi)) {
<a name="l01202"></a>01202                 <a class="code" href="dwc__otg__cfi_8h.html#f121e7b686ae7277b695f7209c41135f">CFI_INFO</a>(<span class="stringliteral">"%s: Failed to init the CFI object\n"</span>, __func__);
<a name="l01203"></a>01203                 <span class="keywordflow">return</span> NULL;
<a name="l01204"></a>01204         }
<a name="l01205"></a>01205 <span class="preprocessor">#endif</span>
<a name="l01206"></a>01206 <span class="preprocessor"></span>
<a name="l01207"></a>01207         <span class="comment">/* Initialize tasklets */</span>
<a name="l01208"></a>01208         pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#9b45cd00cd5835aba4236529a04b28f1">start_xfer_tasklet</a> = DWC_TASK_ALLOC(<a class="code" href="dwc__otg__pcd_8c.html#4d9d8f7fb8f74eb64176fba91b38cb35">start_xfer_tasklet_func</a>, pcd);
<a name="l01209"></a>01209         pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#d1aed2eb03a93032a1ce80e3145bb81e">test_mode_tasklet</a> = DWC_TASK_ALLOC(<a class="code" href="dwc__otg__pcd_8h.html#9d6d6e24faab6478aef9e2217c9b5ab9">do_test_mode</a>, pcd);
<a name="l01210"></a>01210         <span class="comment">/* Initialize timer */</span>
<a name="l01211"></a>01211         pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#466fb6ae524fc970f164701db2e70246">srp_timer</a> = DWC_TIMER_ALLOC(<span class="stringliteral">"SRP TIMER"</span>, <a class="code" href="dwc__otg__pcd_8c.html#e1e5a9264c2ad212d697d6be1110874f">srp_timeout</a>, core_if);
<a name="l01212"></a>01212         <span class="keywordflow">return</span> pcd;
<a name="l01213"></a>01213 }
<a name="l01214"></a>01214 
<a name="l01215"></a><a class="code" href="dwc__otg__pcd__if_8h.html#aaab1535dacd5e947c1f9343d9b3ddf5">01215</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd_8c.html#aaab1535dacd5e947c1f9343d9b3ddf5">dwc_otg_pcd_remove</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd)
<a name="l01216"></a>01216 {
<a name="l01217"></a>01217         <a class="code" href="structdwc__otg__dev__if.html">dwc_otg_dev_if_t</a> *dev_if = <a class="code" href="dwc__otg__pcd_8h.html#464549f9f4484651efe25b1a03692d72">GET_CORE_IF</a>(pcd)-&gt;dev_if;
<a name="l01218"></a>01218 
<a name="l01219"></a>01219         <span class="keywordflow">if</span> (<a class="code" href="dwc__otg__pcd_8h.html#464549f9f4484651efe25b1a03692d72">GET_CORE_IF</a>(pcd)-&gt;dma_enable) {
<a name="l01220"></a>01220                 dwc_dma_free(<span class="keyword">sizeof</span>(*pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#5ea5c519e678fbb382c2ea7d128562c1">setup_pkt</a>) * 5, pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#5ea5c519e678fbb382c2ea7d128562c1">setup_pkt</a>,
<a name="l01221"></a>01221                              pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#606d94ec61cca4c21e4dc9cb2e3b7064">setup_pkt_dma_handle</a>);
<a name="l01222"></a>01222                 dwc_dma_free(<span class="keyword">sizeof</span>(uint16_t), pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#ca247241f78970f27e5c964fc04d47c8">status_buf</a>,
<a name="l01223"></a>01223                              pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#c3880dd4ce15c515ba37b90b6e7fd293">status_buf_dma_handle</a>);
<a name="l01224"></a>01224                 <span class="keywordflow">if</span> (<a class="code" href="dwc__otg__pcd_8h.html#464549f9f4484651efe25b1a03692d72">GET_CORE_IF</a>(pcd)-&gt;dma_desc_enable) {
<a name="l01225"></a>01225                         <a class="code" href="dwc__otg__pcd_8c.html#1926b61a7438bd9a14bd6d6a26c6a63d">dwc_otg_ep_free_desc_chain</a>(dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#f149a6cbedd5f180ff033caeee6f527e">setup_desc_addr</a>[0],
<a name="l01226"></a>01226                                                    dev_if-&gt;
<a name="l01227"></a>01227                                                    dma_setup_desc_addr[0], 1);
<a name="l01228"></a>01228                         <a class="code" href="dwc__otg__pcd_8c.html#1926b61a7438bd9a14bd6d6a26c6a63d">dwc_otg_ep_free_desc_chain</a>(dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#f149a6cbedd5f180ff033caeee6f527e">setup_desc_addr</a>[1],
<a name="l01229"></a>01229                                                    dev_if-&gt;
<a name="l01230"></a>01230                                                    dma_setup_desc_addr[1], 1);
<a name="l01231"></a>01231                         <a class="code" href="dwc__otg__pcd_8c.html#1926b61a7438bd9a14bd6d6a26c6a63d">dwc_otg_ep_free_desc_chain</a>(dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#99f44e328bbb4401aabd8e2708853238">in_desc_addr</a>,
<a name="l01232"></a>01232                                                    dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#ba2f5eede8b3deaaec8882baeea6a35b">dma_in_desc_addr</a>, 1);
<a name="l01233"></a>01233                         <a class="code" href="dwc__otg__pcd_8c.html#1926b61a7438bd9a14bd6d6a26c6a63d">dwc_otg_ep_free_desc_chain</a>(dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#8cc9be8ccaba2ef93b02b34ba7b26bad">out_desc_addr</a>,
<a name="l01234"></a>01234                                                    dev_if-&gt;<a class="code" href="structdwc__otg__dev__if.html#3829a415bbaf0f5c3e29b1a9f3cf546b">dma_out_desc_addr</a>,
<a name="l01235"></a>01235                                                    1);
<a name="l01236"></a>01236                 }
<a name="l01237"></a>01237         } <span class="keywordflow">else</span> {
<a name="l01238"></a>01238                 dwc_free(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#5ea5c519e678fbb382c2ea7d128562c1">setup_pkt</a>);
<a name="l01239"></a>01239                 dwc_free(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#ca247241f78970f27e5c964fc04d47c8">status_buf</a>);
<a name="l01240"></a>01240         }
<a name="l01241"></a>01241         DWC_SPINLOCK_FREE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#5d450e4d06659ab2f3b18e5c816776e4">lock</a>);
<a name="l01242"></a>01242         DWC_TASK_FREE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#9b45cd00cd5835aba4236529a04b28f1">start_xfer_tasklet</a>);
<a name="l01243"></a>01243         DWC_TASK_FREE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#d1aed2eb03a93032a1ce80e3145bb81e">test_mode_tasklet</a>);
<a name="l01244"></a>01244         DWC_TIMER_FREE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#466fb6ae524fc970f164701db2e70246">srp_timer</a>);
<a name="l01245"></a>01245 
<a name="l01246"></a>01246 <span class="comment">/* Release the CFI object's dynamic memory */</span>
<a name="l01247"></a>01247 <span class="preprocessor">#ifdef DWC_UTE_CFI</span>
<a name="l01248"></a>01248 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (pcd-&gt;cfi-&gt;ops.release) {
<a name="l01249"></a>01249                 pcd-&gt;cfi-&gt;ops.release(pcd-&gt;cfi);
<a name="l01250"></a>01250         }
<a name="l01251"></a>01251 <span class="preprocessor">#endif</span>
<a name="l01252"></a>01252 <span class="preprocessor"></span>
<a name="l01253"></a>01253         dwc_free(pcd);
<a name="l01254"></a>01254 }
<a name="l01255"></a>01255 
<a name="l01256"></a><a class="code" href="dwc__otg__pcd__if_8h.html#ae9b15825812485a06be318858e0316a">01256</a> uint32_t <a class="code" href="dwc__otg__pcd_8c.html#ae9b15825812485a06be318858e0316a">dwc_otg_pcd_is_dualspeed</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd)
<a name="l01257"></a>01257 {
<a name="l01258"></a>01258         <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *core_if = <a class="code" href="dwc__otg__pcd_8h.html#464549f9f4484651efe25b1a03692d72">GET_CORE_IF</a>(pcd);
<a name="l01259"></a>01259 
<a name="l01260"></a>01260         <span class="keywordflow">if</span> ((core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#63ffc9b8e36340bd59bf1fab9ca490ad">core_params</a>-&gt;<a class="code" href="structdwc__otg__core__params.html#d2c4f622f1c14f68c6e60e2603acd09d">speed</a> == <a class="code" href="dwc__otg__core__if_8h.html#353c64bfe6bbc9da8406528ad8220166">DWC_SPEED_PARAM_FULL</a>) ||
<a name="l01261"></a>01261             ((core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#e5782c3dc6b5b7a25dfebd4b9bf258c5">hwcfg2</a>.<a class="code" href="unionhwcfg2__data.html#9dcc70e2dba617cbc6c12189be5c1d6a">b</a>.<a class="code" href="unionhwcfg2__data.html#a248a2502e3c440d7b6e4ad61d396f4e">hs_phy_type</a> == 2) &amp;&amp;
<a name="l01262"></a>01262              (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#e5782c3dc6b5b7a25dfebd4b9bf258c5">hwcfg2</a>.<a class="code" href="unionhwcfg2__data.html#9dcc70e2dba617cbc6c12189be5c1d6a">b</a>.<a class="code" href="unionhwcfg2__data.html#e75417d7e2d1843abf6e48f67851326e">fs_phy_type</a> == 1) &amp;&amp;
<a name="l01263"></a>01263              (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#63ffc9b8e36340bd59bf1fab9ca490ad">core_params</a>-&gt;<a class="code" href="structdwc__otg__core__params.html#3d7cfc3c416010102b2c671dfaa828d5">ulpi_fs_ls</a>))) {
<a name="l01264"></a>01264                 <span class="keywordflow">return</span> 0;
<a name="l01265"></a>01265         }
<a name="l01266"></a>01266 
<a name="l01267"></a>01267         <span class="keywordflow">return</span> 1;
<a name="l01268"></a>01268 }
<a name="l01269"></a>01269 
<a name="l01270"></a><a class="code" href="dwc__otg__pcd__if_8h.html#07169d2569c7e071fc99045fd435f2c6">01270</a> uint32_t <a class="code" href="dwc__otg__pcd_8c.html#07169d2569c7e071fc99045fd435f2c6">dwc_otg_pcd_is_otg</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd)
<a name="l01271"></a>01271 {
<a name="l01272"></a>01272         <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *core_if = <a class="code" href="dwc__otg__pcd_8h.html#464549f9f4484651efe25b1a03692d72">GET_CORE_IF</a>(pcd);
<a name="l01273"></a>01273         <a class="code" href="uniongusbcfg__data.html">gusbcfg_data_t</a> usbcfg = {.d32 = 0 };
<a name="l01274"></a>01274 
<a name="l01275"></a>01275         usbcfg.<a class="code" href="uniongusbcfg__data.html#c3d8f2d95fd61a172eb108cb72a85b47">d32</a> = dwc_read_reg32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#909eae7e3b9432ca1e278b99f7811f52">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#ef39e181e246447df47c56aa4e37cc42">gusbcfg</a>);
<a name="l01276"></a>01276         <span class="keywordflow">if</span> (!usbcfg.<a class="code" href="uniongusbcfg__data.html#1dab81bf7260b1e23f97298c34abea06">b</a>.<a class="code" href="uniongusbcfg__data.html#44485a787b8a386fadae801869ce7810">srpcap</a> || !usbcfg.<a class="code" href="uniongusbcfg__data.html#1dab81bf7260b1e23f97298c34abea06">b</a>.<a class="code" href="uniongusbcfg__data.html#71b6330c5ccf1d21ebf79a0a829612b5">hnpcap</a>) {
<a name="l01277"></a>01277                 <span class="keywordflow">return</span> 0;
<a name="l01278"></a>01278         }
<a name="l01279"></a>01279 
<a name="l01280"></a>01280         <span class="keywordflow">return</span> 1;
<a name="l01281"></a>01281 }
<a name="l01282"></a>01282 
<a name="l01287"></a><a class="code" href="dwc__otg__pcd_8c.html#5b3f2d055af51e556be50f3ada673e4a">01287</a> <span class="keyword">static</span> uint32_t <a class="code" href="dwc__otg__pcd_8c.html#5b3f2d055af51e556be50f3ada673e4a">assign_tx_fifo</a>(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if)
<a name="l01288"></a>01288 {
<a name="l01289"></a>01289         uint32_t TxMsk = 1;
<a name="l01290"></a>01290         <span class="keywordtype">int</span> i;
<a name="l01291"></a>01291 
<a name="l01292"></a>01292         <span class="keywordflow">for</span> (i = 0; i &lt; core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#9c1394f3c46adde2fa7be79bf0237f9b">hwcfg4</a>.<a class="code" href="unionhwcfg4__data.html#9fb9175668e2381c568c5adbf6e5225d">b</a>.<a class="code" href="unionhwcfg4__data.html#753b321350388c5e1307802ff968f9a8">num_in_eps</a>; ++i) {
<a name="l01293"></a>01293                 <span class="keywordflow">if</span> ((TxMsk &amp; core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#b558bae74403677f08e45c692a88d4e2">tx_msk</a>) == 0) {
<a name="l01294"></a>01294                         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#b558bae74403677f08e45c692a88d4e2">tx_msk</a> |= TxMsk;
<a name="l01295"></a>01295                         <span class="keywordflow">return</span> i + 1;
<a name="l01296"></a>01296                 }
<a name="l01297"></a>01297                 TxMsk &lt;&lt;= 1;
<a name="l01298"></a>01298         }
<a name="l01299"></a>01299         <span class="keywordflow">return</span> 0;
<a name="l01300"></a>01300 }
<a name="l01301"></a>01301 
<a name="l01306"></a><a class="code" href="dwc__otg__pcd_8c.html#1df421d3a1449ec3a927d0a006c57c38">01306</a> <span class="keyword">static</span> uint32_t <a class="code" href="dwc__otg__pcd_8c.html#1df421d3a1449ec3a927d0a006c57c38">assign_perio_tx_fifo</a>(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if)
<a name="l01307"></a>01307 {
<a name="l01308"></a>01308         uint32_t PerTxMsk = 1;
<a name="l01309"></a>01309         <span class="keywordtype">int</span> i;
<a name="l01310"></a>01310         <span class="keywordflow">for</span> (i = 0; i &lt; core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#9c1394f3c46adde2fa7be79bf0237f9b">hwcfg4</a>.<a class="code" href="unionhwcfg4__data.html#9fb9175668e2381c568c5adbf6e5225d">b</a>.<a class="code" href="unionhwcfg4__data.html#aee60fb196cf53b610df556744e4d317">num_dev_perio_in_ep</a>; ++i) {
<a name="l01311"></a>01311                 <span class="keywordflow">if</span> ((PerTxMsk &amp; core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#0683b28ebf5247a60247d27a1a714d27">p_tx_msk</a>) == 0) {
<a name="l01312"></a>01312                         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#0683b28ebf5247a60247d27a1a714d27">p_tx_msk</a> |= PerTxMsk;
<a name="l01313"></a>01313                         <span class="keywordflow">return</span> i + 1;
<a name="l01314"></a>01314                 }
<a name="l01315"></a>01315                 PerTxMsk &lt;&lt;= 1;
<a name="l01316"></a>01316         }
<a name="l01317"></a>01317         <span class="keywordflow">return</span> 0;
<a name="l01318"></a>01318 }
<a name="l01319"></a>01319 
<a name="l01324"></a><a class="code" href="dwc__otg__pcd_8c.html#1bd1933ef625beee77eb026c4b1acb15">01324</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd_8c.html#1bd1933ef625beee77eb026c4b1acb15">release_perio_tx_fifo</a>(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if,
<a name="l01325"></a>01325                                   uint32_t fifo_num)
<a name="l01326"></a>01326 {
<a name="l01327"></a>01327         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#0683b28ebf5247a60247d27a1a714d27">p_tx_msk</a> =
<a name="l01328"></a>01328             (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#0683b28ebf5247a60247d27a1a714d27">p_tx_msk</a> &amp; (1 &lt;&lt; (fifo_num - 1))) ^ core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#0683b28ebf5247a60247d27a1a714d27">p_tx_msk</a>;
<a name="l01329"></a>01329 }
<a name="l01330"></a>01330 
<a name="l01335"></a><a class="code" href="dwc__otg__pcd_8c.html#bde782d98282535dc0c29a468da11f02">01335</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd_8c.html#bde782d98282535dc0c29a468da11f02">release_tx_fifo</a>(<a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * core_if, uint32_t fifo_num)
<a name="l01336"></a>01336 {
<a name="l01337"></a>01337         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#b558bae74403677f08e45c692a88d4e2">tx_msk</a> =
<a name="l01338"></a>01338             (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#b558bae74403677f08e45c692a88d4e2">tx_msk</a> &amp; (1 &lt;&lt; (fifo_num - 1))) ^ core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#b558bae74403677f08e45c692a88d4e2">tx_msk</a>;
<a name="l01339"></a>01339 }
<a name="l01340"></a>01340 
<a name="l01341"></a><a class="code" href="dwc__otg__pcd__if_8h.html#109bb0fec2e7ef5b5cac3763f8371551">01341</a> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__pcd_8c.html#b9168f11717bdc672d9a29226779e523">dwc_otg_pcd_ep_enable</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd,
<a name="l01342"></a>01342                           <span class="keyword">const</span> uint8_t * ep_desc, <span class="keywordtype">void</span> *usb_ep)
<a name="l01343"></a>01343 {
<a name="l01344"></a>01344         <span class="keywordtype">int</span> num, dir;
<a name="l01345"></a>01345         <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> *ep = 0;
<a name="l01346"></a>01346         <span class="keyword">const</span> usb_endpoint_descriptor_t *desc;
<a name="l01347"></a>01347         uint64_t flags;
<a name="l01348"></a>01348         <span class="keywordtype">int</span> retval = 0;
<a name="l01349"></a>01349 
<a name="l01350"></a>01350         desc = (<span class="keyword">const</span> usb_endpoint_descriptor_t *)ep_desc;
<a name="l01351"></a>01351 
<a name="l01352"></a>01352         <span class="keywordflow">if</span> (!desc) {
<a name="l01353"></a>01353                 pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#14f4f2a41d1305fdc0ec1806d119da89">ep0</a>.<a class="code" href="structdwc__otg__pcd__ep.html#8c8fad971c6c3b1c54d334c7f9b2d03e">priv</a> = usb_ep;
<a name="l01354"></a>01354                 ep = &amp;pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#14f4f2a41d1305fdc0ec1806d119da89">ep0</a>;
<a name="l01355"></a>01355                 retval = -DWC_E_INVALID;
<a name="l01356"></a>01356                 <span class="keywordflow">goto</span> out;
<a name="l01357"></a>01357         }
<a name="l01358"></a>01358 
<a name="l01359"></a>01359         num = UE_GET_ADDR(desc-&gt;bEndpointAddress);
<a name="l01360"></a>01360         dir = UE_GET_DIR(desc-&gt;bEndpointAddress);
<a name="l01361"></a>01361 
<a name="l01362"></a>01362         <span class="keywordflow">if</span> (!desc-&gt;wMaxPacketSize) {
<a name="l01363"></a>01363                 DWC_WARN(<span class="stringliteral">"bad maxpacketsize\n"</span>);
<a name="l01364"></a>01364                 retval = -DWC_E_INVALID;
<a name="l01365"></a>01365                 <span class="keywordflow">goto</span> out;
<a name="l01366"></a>01366         }
<a name="l01367"></a>01367 
<a name="l01368"></a>01368         <span class="keywordflow">if</span> (dir == UE_DIR_IN) {
<a name="l01369"></a>01369                 ep = &amp;pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#dbfc8c424ea3add38db96fa87219caa8">in_ep</a>[num - 1];
<a name="l01370"></a>01370         } <span class="keywordflow">else</span> {
<a name="l01371"></a>01371                 ep = &amp;pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#b9e49a1d1fbca5ba9523e27c7108df30">out_ep</a>[num - 1];
<a name="l01372"></a>01372         }
<a name="l01373"></a>01373 
<a name="l01374"></a>01374         DWC_SPINLOCK_IRQSAVE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#5d450e4d06659ab2f3b18e5c816776e4">lock</a>, &amp;flags);
<a name="l01375"></a>01375 
<a name="l01376"></a>01376         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#86e27843c439dd0b1d12d9bf2dc6516f">desc</a> = desc;
<a name="l01377"></a>01377         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#8c8fad971c6c3b1c54d334c7f9b2d03e">priv</a> = usb_ep;
<a name="l01378"></a>01378 
<a name="l01379"></a>01379         <span class="comment">/*</span>
<a name="l01380"></a>01380 <span class="comment">         * Activate the EP</span>
<a name="l01381"></a>01381 <span class="comment">         */</span>
<a name="l01382"></a>01382         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#cce0e089118d8bf7c6278c21ded70d5a">stopped</a> = 0;
<a name="l01383"></a>01383 
<a name="l01384"></a>01384         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#b882b6b7c857100ed20600e94ea37760">is_in</a> = (dir == UE_DIR_IN);
<a name="l01385"></a>01385         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#d17473ece3c9a34f5e7a230d3315de94">maxpacket</a> = UGETW(desc-&gt;wMaxPacketSize);
<a name="l01386"></a>01386 
<a name="l01387"></a>01387         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#17b10677bd9b0a1d612dd4ce2fb0eb0f">type</a> = desc-&gt;bmAttributes &amp; UE_XFERTYPE;
<a name="l01388"></a>01388 
<a name="l01389"></a>01389         <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#b882b6b7c857100ed20600e94ea37760">is_in</a>) {
<a name="l01390"></a>01390                 <span class="keywordflow">if</span> (!<a class="code" href="dwc__otg__pcd_8h.html#464549f9f4484651efe25b1a03692d72">GET_CORE_IF</a>(pcd)-&gt;en_multiple_tx_fifo) {
<a name="l01391"></a>01391                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#ffa14f48094778143353b845b5d238cd">tx_fifo_num</a> = 0;
<a name="l01392"></a>01392 
<a name="l01393"></a>01393                         <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#17b10677bd9b0a1d612dd4ce2fb0eb0f">type</a> == UE_ISOCHRONOUS) {
<a name="l01394"></a>01394                                 <span class="comment">/*</span>
<a name="l01395"></a>01395 <span class="comment">                                 * if ISOC EP then assign a Periodic Tx FIFO.</span>
<a name="l01396"></a>01396 <span class="comment">                                 */</span>
<a name="l01397"></a>01397                                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#ffa14f48094778143353b845b5d238cd">tx_fifo_num</a> =
<a name="l01398"></a>01398                                     <a class="code" href="dwc__otg__pcd_8c.html#1df421d3a1449ec3a927d0a006c57c38">assign_perio_tx_fifo</a>(<a class="code" href="dwc__otg__pcd_8h.html#464549f9f4484651efe25b1a03692d72">GET_CORE_IF</a>(pcd));
<a name="l01399"></a>01399                         }
<a name="l01400"></a>01400                 } <span class="keywordflow">else</span> {
<a name="l01401"></a>01401                         <span class="comment">/*</span>
<a name="l01402"></a>01402 <span class="comment">                         * if Dedicated FIFOs mode is on then assign a Tx FIFO.</span>
<a name="l01403"></a>01403 <span class="comment">                         */</span>
<a name="l01404"></a>01404                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#ffa14f48094778143353b845b5d238cd">tx_fifo_num</a> =
<a name="l01405"></a>01405                             <a class="code" href="dwc__otg__pcd_8c.html#5b3f2d055af51e556be50f3ada673e4a">assign_tx_fifo</a>(<a class="code" href="dwc__otg__pcd_8h.html#464549f9f4484651efe25b1a03692d72">GET_CORE_IF</a>(pcd));
<a name="l01406"></a>01406 
<a name="l01407"></a>01407                 }
<a name="l01408"></a>01408         }
<a name="l01409"></a>01409         <span class="comment">/* Set initial data PID. */</span>
<a name="l01410"></a>01410         <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#17b10677bd9b0a1d612dd4ce2fb0eb0f">type</a> == UE_BULK) {
<a name="l01411"></a>01411                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#4ceafa9e067ba462ab38c20ffcf8d597">data_pid_start</a> = 0;
<a name="l01412"></a>01412         }
<a name="l01413"></a>01413 
<a name="l01414"></a>01414         <span class="comment">/* Alloc DMA Descriptors */</span>
<a name="l01415"></a>01415         <span class="keywordflow">if</span> (<a class="code" href="dwc__otg__pcd_8h.html#464549f9f4484651efe25b1a03692d72">GET_CORE_IF</a>(pcd)-&gt;dma_desc_enable) {
<a name="l01416"></a>01416                 <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#17b10677bd9b0a1d612dd4ce2fb0eb0f">type</a> != UE_ISOCHRONOUS) {
<a name="l01417"></a>01417                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#57e934b26e76939912eaa76321075a0d">desc_addr</a> =
<a name="l01418"></a>01418                             <a class="code" href="dwc__otg__pcd_8c.html#18b4a856523673f3bf97b676c8d9717e">dwc_otg_ep_alloc_desc_chain</a>(&amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.
<a name="l01419"></a>01419                                                         dma_desc_addr,
<a name="l01420"></a>01420                                                         <a class="code" href="dwc__otg__pcd_8h.html#a1c5dc8973b5c039fd77b1e250ce29e2">MAX_DMA_DESC_CNT</a>);
<a name="l01421"></a>01421                         <span class="keywordflow">if</span> (!ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#57e934b26e76939912eaa76321075a0d">desc_addr</a>) {
<a name="l01422"></a>01422                                 DWC_WARN(<span class="stringliteral">"%s, can't allocate DMA descriptor\n"</span>,
<a name="l01423"></a>01423                                          __func__);
<a name="l01424"></a>01424                                 retval = -DWC_E_SHUTDOWN;
<a name="l01425"></a>01425                                 DWC_SPINUNLOCK_IRQRESTORE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#5d450e4d06659ab2f3b18e5c816776e4">lock</a>, flags);
<a name="l01426"></a>01426                                 <span class="keywordflow">goto</span> out;
<a name="l01427"></a>01427                         }
<a name="l01428"></a>01428                 }
<a name="l01429"></a>01429         }
<a name="l01430"></a>01430 
<a name="l01431"></a>01431         <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#b39e7fe4805812e8f65962134b45f48a">DBG_PCD</a>, <span class="stringliteral">"Activate %s: type=%d, mps=%d desc=%p\n"</span>,
<a name="l01432"></a>01432                     (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#b882b6b7c857100ed20600e94ea37760">is_in</a> ? <span class="stringliteral">"IN"</span> : <span class="stringliteral">"OUT"</span>),
<a name="l01433"></a>01433                     ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#17b10677bd9b0a1d612dd4ce2fb0eb0f">type</a>, ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#d17473ece3c9a34f5e7a230d3315de94">maxpacket</a>, ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#86e27843c439dd0b1d12d9bf2dc6516f">desc</a>);
<a name="l01434"></a>01434 
<a name="l01435"></a>01435         <a class="code" href="dwc__otg__cil_8c.html#5e5a1fb1ff70d5c42d8cf4a1c5d12b7f">dwc_otg_ep_activate</a>(<a class="code" href="dwc__otg__pcd_8h.html#464549f9f4484651efe25b1a03692d72">GET_CORE_IF</a>(pcd), &amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>);
<a name="l01436"></a>01436 
<a name="l01437"></a>01437 <span class="preprocessor">#ifdef DWC_UTE_CFI</span>
<a name="l01438"></a>01438 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (pcd-&gt;cfi-&gt;ops.ep_enable) {
<a name="l01439"></a>01439                 pcd-&gt;cfi-&gt;ops.ep_enable(pcd-&gt;cfi, pcd, ep);
<a name="l01440"></a>01440         }
<a name="l01441"></a>01441 <span class="preprocessor">#endif</span>
<a name="l01442"></a>01442 <span class="preprocessor"></span>
<a name="l01443"></a>01443         DWC_SPINUNLOCK_IRQRESTORE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#5d450e4d06659ab2f3b18e5c816776e4">lock</a>, flags);
<a name="l01444"></a>01444 
<a name="l01445"></a>01445       out:
<a name="l01446"></a>01446         <span class="keywordflow">return</span> retval;
<a name="l01447"></a>01447 }
<a name="l01448"></a>01448 
<a name="l01449"></a><a class="code" href="dwc__otg__pcd__if_8h.html#8a2f791c79320c8c4657715a672822a4">01449</a> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__pcd_8c.html#8a2f791c79320c8c4657715a672822a4">dwc_otg_pcd_ep_disable</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd, <span class="keywordtype">void</span> *ep_handle)
<a name="l01450"></a>01450 {
<a name="l01451"></a>01451         <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> *ep;
<a name="l01452"></a>01452         uint64_t flags;
<a name="l01453"></a>01453         <a class="code" href="structdwc__otg__dev__dma__desc.html">dwc_otg_dev_dma_desc_t</a> *desc_addr;
<a name="l01454"></a>01454         dwc_dma_t dma_desc_addr;
<a name="l01455"></a>01455 
<a name="l01456"></a>01456         ep = <a class="code" href="dwc__otg__pcd_8c.html#4b46c226fa34cd7fc4ceec2c5e7f8ebe">get_ep_from_handle</a>(pcd, ep_handle);
<a name="l01457"></a>01457 
<a name="l01458"></a>01458         <span class="keywordflow">if</span> (!ep || !ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#86e27843c439dd0b1d12d9bf2dc6516f">desc</a>) {
<a name="l01459"></a>01459                 <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#b39e7fe4805812e8f65962134b45f48a">DBG_PCD</a>, <span class="stringliteral">"%s, %d %s not enabled\n"</span>, __func__,
<a name="l01460"></a>01460                             ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#1dd76dafde9ac2a466d64a5acbc35214">num</a>, ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#b882b6b7c857100ed20600e94ea37760">is_in</a> ? <span class="stringliteral">"IN"</span> : <span class="stringliteral">"OUT"</span>);
<a name="l01461"></a>01461                 <span class="keywordflow">return</span> -DWC_E_INVALID;
<a name="l01462"></a>01462         }
<a name="l01463"></a>01463 
<a name="l01464"></a>01464         DWC_SPINLOCK_IRQSAVE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#5d450e4d06659ab2f3b18e5c816776e4">lock</a>, &amp;flags);
<a name="l01465"></a>01465 
<a name="l01466"></a>01466         <a class="code" href="dwc__otg__pcd_8c.html#e8ef6f3d831b89a753d93489827949d3">dwc_otg_request_nuke</a>(ep);
<a name="l01467"></a>01467 
<a name="l01468"></a>01468         <a class="code" href="dwc__otg__cil_8c.html#94789f2d72adb5daf65c99eadced66b3">dwc_otg_ep_deactivate</a>(<a class="code" href="dwc__otg__pcd_8h.html#464549f9f4484651efe25b1a03692d72">GET_CORE_IF</a>(pcd), &amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>);
<a name="l01469"></a>01469         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#86e27843c439dd0b1d12d9bf2dc6516f">desc</a> = 0;
<a name="l01470"></a>01470         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#cce0e089118d8bf7c6278c21ded70d5a">stopped</a> = 1;
<a name="l01471"></a>01471 
<a name="l01472"></a>01472         <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#b882b6b7c857100ed20600e94ea37760">is_in</a>) {
<a name="l01473"></a>01473                 <a class="code" href="dwc__otg__cil_8c.html#039e387cd0e0282727da3c5a36f4cdda">dwc_otg_flush_tx_fifo</a>(<a class="code" href="dwc__otg__pcd_8h.html#464549f9f4484651efe25b1a03692d72">GET_CORE_IF</a>(pcd), ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#ffa14f48094778143353b845b5d238cd">tx_fifo_num</a>);
<a name="l01474"></a>01474                 <a class="code" href="dwc__otg__pcd_8c.html#1bd1933ef625beee77eb026c4b1acb15">release_perio_tx_fifo</a>(<a class="code" href="dwc__otg__pcd_8h.html#464549f9f4484651efe25b1a03692d72">GET_CORE_IF</a>(pcd), ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#ffa14f48094778143353b845b5d238cd">tx_fifo_num</a>);
<a name="l01475"></a>01475                 <a class="code" href="dwc__otg__pcd_8c.html#bde782d98282535dc0c29a468da11f02">release_tx_fifo</a>(<a class="code" href="dwc__otg__pcd_8h.html#464549f9f4484651efe25b1a03692d72">GET_CORE_IF</a>(pcd), ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#ffa14f48094778143353b845b5d238cd">tx_fifo_num</a>);
<a name="l01476"></a>01476         }
<a name="l01477"></a>01477 
<a name="l01478"></a>01478         <span class="comment">/* Free DMA Descriptors */</span>
<a name="l01479"></a>01479         <span class="keywordflow">if</span> (<a class="code" href="dwc__otg__pcd_8h.html#464549f9f4484651efe25b1a03692d72">GET_CORE_IF</a>(pcd)-&gt;dma_desc_enable) {
<a name="l01480"></a>01480                 <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#17b10677bd9b0a1d612dd4ce2fb0eb0f">type</a> != UE_ISOCHRONOUS) {
<a name="l01481"></a>01481                         desc_addr = ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#57e934b26e76939912eaa76321075a0d">desc_addr</a>;
<a name="l01482"></a>01482                         dma_desc_addr = ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#1a43e464429530e874472092e0e1af09">dma_desc_addr</a>;
<a name="l01483"></a>01483 
<a name="l01484"></a>01484                         <span class="comment">/* Cannot call dma_free_coherent() with IRQs disabled */</span>
<a name="l01485"></a>01485                         DWC_SPINUNLOCK_IRQRESTORE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#5d450e4d06659ab2f3b18e5c816776e4">lock</a>, flags);
<a name="l01486"></a>01486                         <a class="code" href="dwc__otg__pcd_8c.html#1926b61a7438bd9a14bd6d6a26c6a63d">dwc_otg_ep_free_desc_chain</a>(desc_addr, dma_desc_addr,
<a name="l01487"></a>01487                                                    <a class="code" href="dwc__otg__pcd_8h.html#a1c5dc8973b5c039fd77b1e250ce29e2">MAX_DMA_DESC_CNT</a>);
<a name="l01488"></a>01488 
<a name="l01489"></a>01489                         <span class="keywordflow">goto</span> out_unlocked;
<a name="l01490"></a>01490                 }
<a name="l01491"></a>01491         }
<a name="l01492"></a>01492 
<a name="l01493"></a>01493         DWC_SPINUNLOCK_IRQRESTORE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#5d450e4d06659ab2f3b18e5c816776e4">lock</a>, flags);
<a name="l01494"></a>01494 
<a name="l01495"></a>01495       out_unlocked:
<a name="l01496"></a>01496         <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#b39e7fe4805812e8f65962134b45f48a">DBG_PCD</a>, <span class="stringliteral">"%d %s disabled\n"</span>, ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#1dd76dafde9ac2a466d64a5acbc35214">num</a>,
<a name="l01497"></a>01497                     ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#b882b6b7c857100ed20600e94ea37760">is_in</a> ? <span class="stringliteral">"IN"</span> : <span class="stringliteral">"OUT"</span>);
<a name="l01498"></a>01498         <span class="keywordflow">return</span> 0;
<a name="l01499"></a>01499 
<a name="l01500"></a>01500 }
<a name="l01501"></a>01501 
<a name="l01502"></a><a class="code" href="dwc__otg__pcd__if_8h.html#09f3d77397aa7d22a1ca32e26c8aedea">01502</a> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__pcd_8c.html#09f3d77397aa7d22a1ca32e26c8aedea">dwc_otg_pcd_ep_queue</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd, <span class="keywordtype">void</span> *ep_handle,
<a name="l01503"></a>01503                          uint8_t * buf, dwc_dma_t dma_buf, uint32_t buflen,
<a name="l01504"></a>01504                          <span class="keywordtype">int</span> zero, <span class="keywordtype">void</span> *req_handle, <span class="keywordtype">int</span> atomic_alloc)
<a name="l01505"></a>01505 {
<a name="l01506"></a>01506         <span class="keywordtype">int</span> prevented = 0;
<a name="l01507"></a>01507         uint64_t flags;
<a name="l01508"></a>01508         <a class="code" href="structdwc__otg__pcd__request.html">dwc_otg_pcd_request_t</a> *req;
<a name="l01509"></a>01509         <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> *ep;
<a name="l01510"></a>01510         uint32_t max_transfer;
<a name="l01511"></a>01511 
<a name="l01512"></a>01512         ep = <a class="code" href="dwc__otg__pcd_8c.html#4b46c226fa34cd7fc4ceec2c5e7f8ebe">get_ep_from_handle</a>(pcd, ep_handle);
<a name="l01513"></a>01513         <span class="keywordflow">if</span> ((!ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#86e27843c439dd0b1d12d9bf2dc6516f">desc</a> &amp;&amp; ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#1dd76dafde9ac2a466d64a5acbc35214">num</a> != 0)) {
<a name="l01514"></a>01514                 DWC_WARN(<span class="stringliteral">"bad ep\n"</span>);
<a name="l01515"></a>01515                 <span class="keywordflow">return</span> -DWC_E_INVALID;
<a name="l01516"></a>01516         }
<a name="l01517"></a>01517 
<a name="l01518"></a>01518         <span class="keywordflow">if</span> (atomic_alloc) {
<a name="l01519"></a>01519                 req = dwc_alloc_atomic(<span class="keyword">sizeof</span>(*req));
<a name="l01520"></a>01520         } <span class="keywordflow">else</span> {
<a name="l01521"></a>01521                 req = dwc_alloc(<span class="keyword">sizeof</span>(*req));
<a name="l01522"></a>01522         }
<a name="l01523"></a>01523 
<a name="l01524"></a>01524         <span class="keywordflow">if</span> (!req) {
<a name="l01525"></a>01525                 <span class="keywordflow">return</span> -DWC_E_NO_MEMORY;
<a name="l01526"></a>01526         }
<a name="l01527"></a>01527         DWC_CIRCLEQ_INIT_ENTRY(req, queue_entry);
<a name="l01528"></a>01528         <span class="keywordflow">if</span> (!<a class="code" href="dwc__otg__pcd_8h.html#464549f9f4484651efe25b1a03692d72">GET_CORE_IF</a>(pcd)-&gt;core_params-&gt;opt) {
<a name="l01529"></a>01529                 <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#1dd76dafde9ac2a466d64a5acbc35214">num</a> != 0) {
<a name="l01530"></a>01530                         DWC_ERROR(<span class="stringliteral">"queue req %p, len %d buf %p\n"</span>,
<a name="l01531"></a>01531                                   req_handle, buflen, buf);
<a name="l01532"></a>01532                 }
<a name="l01533"></a>01533         }
<a name="l01534"></a>01534 
<a name="l01535"></a>01535         req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#c46438f3d95146654a25cd219d7a1d5a">buf</a> = buf;
<a name="l01536"></a>01536         req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#df93c8905495816eb0327b192938a4a1">dma</a> = dma_buf;
<a name="l01537"></a>01537         req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#3dd3fcc889bf220b048023e8b05fab61">length</a> = buflen;
<a name="l01538"></a>01538         req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#c2c1832d46f417b63e41b5e23def6fc6">sent_zlp</a> = zero;
<a name="l01539"></a>01539         req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#e0d93b64365968aa0dcf58535aecf40c">priv</a> = req_handle;
<a name="l01540"></a>01540 
<a name="l01541"></a>01541         DWC_SPINLOCK_IRQSAVE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#5d450e4d06659ab2f3b18e5c816776e4">lock</a>, &amp;flags);
<a name="l01542"></a>01542 
<a name="l01543"></a>01543         <span class="comment">/*</span>
<a name="l01544"></a>01544 <span class="comment">         * For EP0 IN without premature status, zlp is required?</span>
<a name="l01545"></a>01545 <span class="comment">         */</span>
<a name="l01546"></a>01546         <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#1dd76dafde9ac2a466d64a5acbc35214">num</a> == 0 &amp;&amp; ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#b882b6b7c857100ed20600e94ea37760">is_in</a>) {
<a name="l01547"></a>01547                 <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#fe60e047aac272899de8f63b43df80e7">DBG_PCDV</a>, <span class="stringliteral">"%d-OUT ZLP\n"</span>, ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#1dd76dafde9ac2a466d64a5acbc35214">num</a>);
<a name="l01548"></a>01548                 <span class="comment">//_req-&gt;zero = 1;</span>
<a name="l01549"></a>01549         }
<a name="l01550"></a>01550 
<a name="l01551"></a>01551         <span class="comment">/* Start the transfer */</span>
<a name="l01552"></a>01552         <span class="keywordflow">if</span> (DWC_CIRCLEQ_EMPTY(&amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#71f4fa571dfdc96f62fa4869e6add300">queue</a>) &amp;&amp; !ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#cce0e089118d8bf7c6278c21ded70d5a">stopped</a>) {
<a name="l01553"></a>01553                 <span class="comment">/* EP0 Transfer? */</span>
<a name="l01554"></a>01554                 <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#1dd76dafde9ac2a466d64a5acbc35214">num</a> == 0) {
<a name="l01555"></a>01555                         <span class="keywordflow">switch</span> (pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#8f6963b3fb9ab83048c4c0697c90382a">ep0state</a>) {
<a name="l01556"></a>01556                         <span class="keywordflow">case</span> EP0_IN_DATA_PHASE:
<a name="l01557"></a>01557                                 <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#b39e7fe4805812e8f65962134b45f48a">DBG_PCD</a>,
<a name="l01558"></a>01558                                             <span class="stringliteral">"%s ep0: EP0_IN_DATA_PHASE\n"</span>,
<a name="l01559"></a>01559                                             __func__);
<a name="l01560"></a>01560                                 <span class="keywordflow">break</span>;
<a name="l01561"></a>01561 
<a name="l01562"></a>01562                         <span class="keywordflow">case</span> EP0_OUT_DATA_PHASE:
<a name="l01563"></a>01563                                 <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#b39e7fe4805812e8f65962134b45f48a">DBG_PCD</a>,
<a name="l01564"></a>01564                                             <span class="stringliteral">"%s ep0: EP0_OUT_DATA_PHASE\n"</span>,
<a name="l01565"></a>01565                                             __func__);
<a name="l01566"></a>01566                                 <span class="keywordflow">if</span> (pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#cbe5c4062e140ee88f51ee916c0db0ad">request_config</a>) {
<a name="l01567"></a>01567                                         <span class="comment">/* Complete STATUS PHASE */</span>
<a name="l01568"></a>01568                                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#b882b6b7c857100ed20600e94ea37760">is_in</a> = 1;
<a name="l01569"></a>01569                                         pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#8f6963b3fb9ab83048c4c0697c90382a">ep0state</a> = EP0_IN_STATUS_PHASE;
<a name="l01570"></a>01570                                 }
<a name="l01571"></a>01571                                 <span class="keywordflow">break</span>;
<a name="l01572"></a>01572 
<a name="l01573"></a>01573                         <span class="keywordflow">case</span> EP0_IN_STATUS_PHASE:
<a name="l01574"></a>01574                                 <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#b39e7fe4805812e8f65962134b45f48a">DBG_PCD</a>,
<a name="l01575"></a>01575                                             <span class="stringliteral">"%s ep0: EP0_IN_STATUS_PHASE\n"</span>,
<a name="l01576"></a>01576                                             __func__);
<a name="l01577"></a>01577                                 <span class="keywordflow">break</span>;
<a name="l01578"></a>01578 
<a name="l01579"></a>01579                         <span class="keywordflow">default</span>:
<a name="l01580"></a>01580                                 <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#2bf62a567355d1ea38814714bd7b57ec">DBG_ANY</a>, <span class="stringliteral">"ep0: odd state %d\n"</span>,
<a name="l01581"></a>01581                                             pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#8f6963b3fb9ab83048c4c0697c90382a">ep0state</a>);
<a name="l01582"></a>01582                                 DWC_SPINUNLOCK_IRQRESTORE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#5d450e4d06659ab2f3b18e5c816776e4">lock</a>, flags);
<a name="l01583"></a>01583                                 <span class="keywordflow">return</span> -DWC_E_SHUTDOWN;
<a name="l01584"></a>01584                         }
<a name="l01585"></a>01585 
<a name="l01586"></a>01586                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#b40ce70422b6d105a855a8df4b33d45d">dma_addr</a> = dma_buf;
<a name="l01587"></a>01587                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#d0cda8ded2e5142d9a1c9c17efc5812f">start_xfer_buff</a> = buf;
<a name="l01588"></a>01588                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#97fa9bf5c31ba734d54f70e6fe6ae8eb">xfer_buff</a> = buf;
<a name="l01589"></a>01589                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#36d4010478ceb27479c0b12b376a7924">xfer_len</a> = buflen;
<a name="l01590"></a>01590                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#23d4871510b5bcb54fbf0674d8f122bd">xfer_count</a> = 0;
<a name="l01591"></a>01591                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#8c6340435beba0b8c025a4677602acab">sent_zlp</a> = 0;
<a name="l01592"></a>01592                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#5a218f200cff0491b735f43fed5176bf">total_len</a> = ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#36d4010478ceb27479c0b12b376a7924">xfer_len</a>;
<a name="l01593"></a>01593 
<a name="l01594"></a>01594                         <span class="keywordflow">if</span> (zero) {
<a name="l01595"></a>01595                                 <span class="keywordflow">if</span> ((ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#36d4010478ceb27479c0b12b376a7924">xfer_len</a> %
<a name="l01596"></a>01596                                      ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#d17473ece3c9a34f5e7a230d3315de94">maxpacket</a> == 0)
<a name="l01597"></a>01597                                     &amp;&amp; (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#36d4010478ceb27479c0b12b376a7924">xfer_len</a> != 0)) {
<a name="l01598"></a>01598                                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#8c6340435beba0b8c025a4677602acab">sent_zlp</a> = 1;
<a name="l01599"></a>01599                                 }
<a name="l01600"></a>01600 
<a name="l01601"></a>01601                         }
<a name="l01602"></a>01602 
<a name="l01603"></a>01603                         <a class="code" href="dwc__otg__cil_8c.html#ee4989b24826b2a6592535282853e556">dwc_otg_ep0_start_transfer</a>(<a class="code" href="dwc__otg__pcd_8h.html#464549f9f4484651efe25b1a03692d72">GET_CORE_IF</a>(pcd),
<a name="l01604"></a>01604                                                    &amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>);
<a name="l01605"></a>01605                 }               <span class="comment">// non-ep0 endpoints</span>
<a name="l01606"></a>01606                 <span class="keywordflow">else</span> {
<a name="l01607"></a>01607 <span class="preprocessor">#ifdef DWC_UTE_CFI</span>
<a name="l01608"></a>01608 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.buff_mode != BM_STANDARD) {
<a name="l01609"></a>01609                                 <span class="comment">/* store the request length */</span>
<a name="l01610"></a>01610                                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.cfi_req_len = buflen;
<a name="l01611"></a>01611                                 pcd-&gt;cfi-&gt;ops.build_descriptors(pcd-&gt;cfi, pcd,
<a name="l01612"></a>01612                                                                 ep, req);
<a name="l01613"></a>01613                 } <span class="keywordflow">else</span> {
<a name="l01614"></a>01614 <span class="preprocessor">#endif</span>
<a name="l01615"></a>01615 <span class="preprocessor"></span>                                max_transfer =
<a name="l01616"></a>01616                                     <a class="code" href="dwc__otg__pcd_8h.html#464549f9f4484651efe25b1a03692d72">GET_CORE_IF</a>(ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#234391334e48cbd72710d08655c9ed16">pcd</a>)-&gt;core_params-&gt;
<a name="l01617"></a>01617                                     max_transfer_size;
<a name="l01618"></a>01618 
<a name="l01619"></a>01619                         <span class="comment">/* Setup and start the Transfer */</span>
<a name="l01620"></a>01620                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#b40ce70422b6d105a855a8df4b33d45d">dma_addr</a> = dma_buf;
<a name="l01621"></a>01621                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#d0cda8ded2e5142d9a1c9c17efc5812f">start_xfer_buff</a> = buf;
<a name="l01622"></a>01622                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#97fa9bf5c31ba734d54f70e6fe6ae8eb">xfer_buff</a> = buf;
<a name="l01623"></a>01623                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#36d4010478ceb27479c0b12b376a7924">xfer_len</a> = 0;
<a name="l01624"></a>01624                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#23d4871510b5bcb54fbf0674d8f122bd">xfer_count</a> = 0;
<a name="l01625"></a>01625                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#8c6340435beba0b8c025a4677602acab">sent_zlp</a> = 0;
<a name="l01626"></a>01626                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#5a218f200cff0491b735f43fed5176bf">total_len</a> = buflen;
<a name="l01627"></a>01627 
<a name="l01628"></a>01628                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#f60095e5ebedf7f98f3bfea77ce9a755">maxxfer</a> = max_transfer;
<a name="l01629"></a>01629                         <span class="keywordflow">if</span> (<a class="code" href="dwc__otg__pcd_8h.html#464549f9f4484651efe25b1a03692d72">GET_CORE_IF</a>(pcd)-&gt;dma_desc_enable) {
<a name="l01630"></a>01630                                         uint32_t out_max_xfer =
<a name="l01631"></a>01631                                             <a class="code" href="dwc__otg__pcd_8h.html#6dad4d4462e9819753acfc601889faec">DDMA_MAX_TRANSFER_SIZE</a> -
<a name="l01632"></a>01632                                             (<a class="code" href="dwc__otg__pcd_8h.html#6dad4d4462e9819753acfc601889faec">DDMA_MAX_TRANSFER_SIZE</a> % 4);
<a name="l01633"></a>01633                                 <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#b882b6b7c857100ed20600e94ea37760">is_in</a>) {
<a name="l01634"></a>01634                                         <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#f60095e5ebedf7f98f3bfea77ce9a755">maxxfer</a> &gt;
<a name="l01635"></a>01635                                             <a class="code" href="dwc__otg__pcd_8h.html#6dad4d4462e9819753acfc601889faec">DDMA_MAX_TRANSFER_SIZE</a>) {
<a name="l01636"></a>01636                                                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#f60095e5ebedf7f98f3bfea77ce9a755">maxxfer</a> =
<a name="l01637"></a>01637                                                     <a class="code" href="dwc__otg__pcd_8h.html#6dad4d4462e9819753acfc601889faec">DDMA_MAX_TRANSFER_SIZE</a>;
<a name="l01638"></a>01638                                         }
<a name="l01639"></a>01639                                 } <span class="keywordflow">else</span> {
<a name="l01640"></a>01640                                                 <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#f60095e5ebedf7f98f3bfea77ce9a755">maxxfer</a> &gt;
<a name="l01641"></a>01641                                                     out_max_xfer) {
<a name="l01642"></a>01642                                                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#f60095e5ebedf7f98f3bfea77ce9a755">maxxfer</a> =
<a name="l01643"></a>01643                                                     out_max_xfer;
<a name="l01644"></a>01644                                         }
<a name="l01645"></a>01645                                 }
<a name="l01646"></a>01646                         }
<a name="l01647"></a>01647                         <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#f60095e5ebedf7f98f3bfea77ce9a755">maxxfer</a> &lt; ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#5a218f200cff0491b735f43fed5176bf">total_len</a>) {
<a name="l01648"></a>01648                                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#f60095e5ebedf7f98f3bfea77ce9a755">maxxfer</a> -=
<a name="l01649"></a>01649                                             (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#f60095e5ebedf7f98f3bfea77ce9a755">maxxfer</a> %
<a name="l01650"></a>01650                                              ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#d17473ece3c9a34f5e7a230d3315de94">maxpacket</a>);
<a name="l01651"></a>01651                         }
<a name="l01652"></a>01652 
<a name="l01653"></a>01653                         <span class="keywordflow">if</span> (zero) {
<a name="l01654"></a>01654                                 <span class="keywordflow">if</span> ((ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#5a218f200cff0491b735f43fed5176bf">total_len</a> %
<a name="l01655"></a>01655                                              ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#d17473ece3c9a34f5e7a230d3315de94">maxpacket</a> == 0)
<a name="l01656"></a>01656                                             &amp;&amp; (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#5a218f200cff0491b735f43fed5176bf">total_len</a> != 0)) {
<a name="l01657"></a>01657                                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#8c6340435beba0b8c025a4677602acab">sent_zlp</a> = 1;
<a name="l01658"></a>01658                                 }
<a name="l01659"></a>01659                         }
<a name="l01660"></a>01660 <span class="preprocessor">#ifdef DWC_UTE_CFI</span>
<a name="l01661"></a>01661 <span class="preprocessor"></span>                        }
<a name="l01662"></a>01662 <span class="preprocessor">#endif</span>
<a name="l01663"></a>01663 <span class="preprocessor"></span>                        <a class="code" href="dwc__otg__cil_8c.html#1278f6d58a4a2bc780e90e0b6c9b9a68">dwc_otg_ep_start_transfer</a>(<a class="code" href="dwc__otg__pcd_8h.html#464549f9f4484651efe25b1a03692d72">GET_CORE_IF</a>(pcd),
<a name="l01664"></a>01664                                                   &amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>);
<a name="l01665"></a>01665                 }
<a name="l01666"></a>01666         }
<a name="l01667"></a>01667 
<a name="l01668"></a>01668         <span class="keywordflow">if</span> ((req != 0) || prevented) {
<a name="l01669"></a>01669                 ++pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#3a0464b4ac677a7742e9b7c0c820414c">request_pending</a>;
<a name="l01670"></a>01670                 DWC_CIRCLEQ_INSERT_TAIL(&amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#71f4fa571dfdc96f62fa4869e6add300">queue</a>, req, queue_entry);
<a name="l01671"></a>01671                 <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#b882b6b7c857100ed20600e94ea37760">is_in</a> &amp;&amp; ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#cce0e089118d8bf7c6278c21ded70d5a">stopped</a>
<a name="l01672"></a>01672                     &amp;&amp; !(<a class="code" href="dwc__otg__pcd_8h.html#464549f9f4484651efe25b1a03692d72">GET_CORE_IF</a>(pcd)-&gt;dma_enable)) {
<a name="l01674"></a>01674                         <a class="code" href="uniondiepint__data.html">diepmsk_data_t</a> diepmsk = {.d32 = 0 };
<a name="l01675"></a>01675                         diepmsk.<a class="code" href="uniondiepint__data.html#48d2a745e0ec983a47b35b0428b0437d">b</a>.<a class="code" href="uniondiepint__data.html#7c9961f17328bbc25ca39e7ec1891e16">intktxfemp</a> = 1;
<a name="l01676"></a>01676                         <span class="keywordflow">if</span> (<a class="code" href="dwc__otg__pcd_8h.html#464549f9f4484651efe25b1a03692d72">GET_CORE_IF</a>(pcd)-&gt;multiproc_int_enable) {
<a name="l01677"></a>01677                                 dwc_modify_reg32(&amp;<a class="code" href="dwc__otg__pcd_8h.html#464549f9f4484651efe25b1a03692d72">GET_CORE_IF</a>(pcd)-&gt;dev_if-&gt;
<a name="l01678"></a>01678                                                  dev_global_regs-&gt;
<a name="l01679"></a>01679                                                  diepeachintmsk[ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#1dd76dafde9ac2a466d64a5acbc35214">num</a>],
<a name="l01680"></a>01680                                                  0, diepmsk.<a class="code" href="uniondiepint__data.html#7d2c24507663bf96c280c57fbf544ef7">d32</a>);
<a name="l01681"></a>01681                         } <span class="keywordflow">else</span> {
<a name="l01682"></a>01682                                 dwc_modify_reg32(&amp;<a class="code" href="dwc__otg__pcd_8h.html#464549f9f4484651efe25b1a03692d72">GET_CORE_IF</a>(pcd)-&gt;dev_if-&gt;
<a name="l01683"></a>01683                                                  dev_global_regs-&gt;diepmsk, 0,
<a name="l01684"></a>01684                                                  diepmsk.<a class="code" href="uniondiepint__data.html#7d2c24507663bf96c280c57fbf544ef7">d32</a>);
<a name="l01685"></a>01685                         }
<a name="l01686"></a>01686 
<a name="l01687"></a>01687                 }
<a name="l01688"></a>01688         }
<a name="l01689"></a>01689 
<a name="l01690"></a>01690         DWC_SPINUNLOCK_IRQRESTORE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#5d450e4d06659ab2f3b18e5c816776e4">lock</a>, flags);
<a name="l01691"></a>01691 
<a name="l01692"></a>01692         <span class="keywordflow">return</span> 0;
<a name="l01693"></a>01693 }
<a name="l01694"></a><a class="code" href="dwc__otg__pcd__if_8h.html#aa7546ce68d6fda67bb4cda0f69eedf3">01694</a> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__pcd_8c.html#aa7546ce68d6fda67bb4cda0f69eedf3">dwc_otg_pcd_ep_dequeue</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd, <span class="keywordtype">void</span> *ep_handle,
<a name="l01695"></a>01695                            <span class="keywordtype">void</span> *req_handle)
<a name="l01696"></a>01696 {
<a name="l01697"></a>01697         uint64_t flags;
<a name="l01698"></a>01698         <a class="code" href="structdwc__otg__pcd__request.html">dwc_otg_pcd_request_t</a> *req;
<a name="l01699"></a>01699         <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> *ep;
<a name="l01700"></a>01700 
<a name="l01701"></a>01701         ep = <a class="code" href="dwc__otg__pcd_8c.html#4b46c226fa34cd7fc4ceec2c5e7f8ebe">get_ep_from_handle</a>(pcd, ep_handle);
<a name="l01702"></a>01702         <span class="keywordflow">if</span> (!ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#86e27843c439dd0b1d12d9bf2dc6516f">desc</a> &amp;&amp; ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#1dd76dafde9ac2a466d64a5acbc35214">num</a> != 0) {
<a name="l01703"></a>01703                 DWC_WARN(<span class="stringliteral">"bad argument\n"</span>);
<a name="l01704"></a>01704                 <span class="keywordflow">return</span> -DWC_E_INVALID;
<a name="l01705"></a>01705         }
<a name="l01706"></a>01706 
<a name="l01707"></a>01707         DWC_SPINLOCK_IRQSAVE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#5d450e4d06659ab2f3b18e5c816776e4">lock</a>, &amp;flags);
<a name="l01708"></a>01708 
<a name="l01709"></a>01709         <span class="comment">/* make sure it's actually queued on this endpoint */</span>
<a name="l01710"></a>01710         DWC_CIRCLEQ_FOREACH(req, &amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#71f4fa571dfdc96f62fa4869e6add300">queue</a>, queue_entry) {
<a name="l01711"></a>01711                 <span class="keywordflow">if</span> (req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#e0d93b64365968aa0dcf58535aecf40c">priv</a> == (<span class="keywordtype">void</span> *)req_handle) {
<a name="l01712"></a>01712                         <span class="keywordflow">break</span>;
<a name="l01713"></a>01713                 }
<a name="l01714"></a>01714         }
<a name="l01715"></a>01715 
<a name="l01716"></a>01716         <span class="keywordflow">if</span> (req-&gt;<a class="code" href="structdwc__otg__pcd__request.html#e0d93b64365968aa0dcf58535aecf40c">priv</a> != (<span class="keywordtype">void</span> *)req_handle) {
<a name="l01717"></a>01717                 DWC_SPINUNLOCK_IRQRESTORE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#5d450e4d06659ab2f3b18e5c816776e4">lock</a>, flags);
<a name="l01718"></a>01718                 <span class="keywordflow">return</span> -DWC_E_INVALID;
<a name="l01719"></a>01719         }
<a name="l01720"></a>01720 
<a name="l01721"></a>01721         <span class="keywordflow">if</span> (!DWC_CIRCLEQ_EMPTY_ENTRY(req, queue_entry)) {
<a name="l01722"></a>01722                 <a class="code" href="dwc__otg__pcd_8c.html#5c9b20abc81e0f860a8f23c90b10b59e">dwc_otg_request_done</a>(ep, req, -DWC_E_RESTART);
<a name="l01723"></a>01723         } <span class="keywordflow">else</span> {
<a name="l01724"></a>01724                 req = 0;
<a name="l01725"></a>01725         }
<a name="l01726"></a>01726 
<a name="l01727"></a>01727         DWC_SPINUNLOCK_IRQRESTORE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#5d450e4d06659ab2f3b18e5c816776e4">lock</a>, flags);
<a name="l01728"></a>01728 
<a name="l01729"></a>01729         <span class="keywordflow">return</span> req ? 0 : -DWC_E_SHUTDOWN;
<a name="l01730"></a>01730 
<a name="l01731"></a>01731 }
<a name="l01732"></a>01732 
<a name="l01733"></a><a class="code" href="dwc__otg__pcd__if_8h.html#f7d01b4772f08c6a08f4a22300a7b43b">01733</a> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__pcd_8c.html#f7d01b4772f08c6a08f4a22300a7b43b">dwc_otg_pcd_ep_halt</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd, <span class="keywordtype">void</span> *ep_handle, <span class="keywordtype">int</span> value)
<a name="l01734"></a>01734 {
<a name="l01735"></a>01735         <a class="code" href="structdwc__otg__pcd__ep.html">dwc_otg_pcd_ep_t</a> *ep;
<a name="l01736"></a>01736         uint64_t flags;
<a name="l01737"></a>01737         <span class="keywordtype">int</span> retval = 0;
<a name="l01738"></a>01738 
<a name="l01739"></a>01739         ep = <a class="code" href="dwc__otg__pcd_8c.html#4b46c226fa34cd7fc4ceec2c5e7f8ebe">get_ep_from_handle</a>(pcd, ep_handle);
<a name="l01740"></a>01740 
<a name="l01741"></a>01741         <span class="keywordflow">if</span> ((!ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#86e27843c439dd0b1d12d9bf2dc6516f">desc</a> &amp;&amp; ep != &amp;pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#14f4f2a41d1305fdc0ec1806d119da89">ep0</a>) ||
<a name="l01742"></a>01742             (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#86e27843c439dd0b1d12d9bf2dc6516f">desc</a> &amp;&amp; (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#86e27843c439dd0b1d12d9bf2dc6516f">desc</a>-&gt;bmAttributes == UE_ISOCHRONOUS))) {
<a name="l01743"></a>01743                 DWC_WARN(<span class="stringliteral">"%s, bad ep\n"</span>, __func__);
<a name="l01744"></a>01744                 <span class="keywordflow">return</span> -DWC_E_INVALID;
<a name="l01745"></a>01745         }
<a name="l01746"></a>01746 
<a name="l01747"></a>01747         DWC_SPINLOCK_IRQSAVE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#5d450e4d06659ab2f3b18e5c816776e4">lock</a>, &amp;flags);
<a name="l01748"></a>01748         <span class="keywordflow">if</span> (!DWC_CIRCLEQ_EMPTY(&amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#71f4fa571dfdc96f62fa4869e6add300">queue</a>)) {
<a name="l01749"></a>01749                 DWC_WARN(<span class="stringliteral">"%d %s XFer In process\n"</span>, ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#1dd76dafde9ac2a466d64a5acbc35214">num</a>,
<a name="l01750"></a>01750                          ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#b882b6b7c857100ed20600e94ea37760">is_in</a> ? <span class="stringliteral">"IN"</span> : <span class="stringliteral">"OUT"</span>);
<a name="l01751"></a>01751                 retval = -DWC_E_AGAIN;
<a name="l01752"></a>01752         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (value == 0) {
<a name="l01753"></a>01753                 <a class="code" href="dwc__otg__cil_8c.html#a5f77318fb1c589406927a606844007f">dwc_otg_ep_clear_stall</a>(<a class="code" href="dwc__otg__pcd_8h.html#464549f9f4484651efe25b1a03692d72">GET_CORE_IF</a>(pcd), &amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>);
<a name="l01754"></a>01754         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (value == 1) {
<a name="l01755"></a>01755                 <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#b882b6b7c857100ed20600e94ea37760">is_in</a> == 1 &amp;&amp; <a class="code" href="dwc__otg__pcd_8h.html#464549f9f4484651efe25b1a03692d72">GET_CORE_IF</a>(pcd)-&gt;dma_desc_enable) {
<a name="l01756"></a>01756                         <a class="code" href="uniondtxfsts__data.html">dtxfsts_data_t</a> txstatus;
<a name="l01757"></a>01757                         <a class="code" href="unionfifosize__data.html">fifosize_data_t</a> txfifosize;
<a name="l01758"></a>01758 
<a name="l01759"></a>01759                         txfifosize.<a class="code" href="unionfifosize__data.html#937e01b91f0a60a5aa9f6a4eaf6ce661">d32</a> =
<a name="l01760"></a>01760                             dwc_read_reg32(&amp;<a class="code" href="dwc__otg__pcd_8h.html#464549f9f4484651efe25b1a03692d72">GET_CORE_IF</a>(pcd)-&gt;core_global_regs-&gt;
<a name="l01761"></a>01761                                            dptxfsiz_dieptxf[ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.
<a name="l01762"></a>01762                                                             tx_fifo_num]);
<a name="l01763"></a>01763                         txstatus.<a class="code" href="uniondtxfsts__data.html#684b8a9ccf83a5807e9bb3491c662c39">d32</a> =
<a name="l01764"></a>01764                             dwc_read_reg32(&amp;<a class="code" href="dwc__otg__pcd_8h.html#464549f9f4484651efe25b1a03692d72">GET_CORE_IF</a>(pcd)-&gt;dev_if-&gt;
<a name="l01765"></a>01765                                            in_ep_regs[ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#1dd76dafde9ac2a466d64a5acbc35214">num</a>]-&gt;dtxfsts);
<a name="l01766"></a>01766 
<a name="l01767"></a>01767                         <span class="keywordflow">if</span> (txstatus.<a class="code" href="uniondtxfsts__data.html#168f673549aad11d0d9fdc06ee6c5480">b</a>.<a class="code" href="uniondtxfsts__data.html#83db0e2dbe071694f549a383b7037b3b">txfspcavail</a> &lt; txfifosize.<a class="code" href="unionfifosize__data.html#4f0c71e88cc54c4efa4cd4ff43334c51">b</a>.<a class="code" href="unionfifosize__data.html#48c08d73da4d2d16d4320b93beb5ba8b">depth</a>) {
<a name="l01768"></a>01768                                 DWC_WARN(<span class="stringliteral">"%s() Data In Tx Fifo\n"</span>, __func__);
<a name="l01769"></a>01769                                 retval = -DWC_E_AGAIN;
<a name="l01770"></a>01770                         } <span class="keywordflow">else</span> {
<a name="l01771"></a>01771                                 <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#1dd76dafde9ac2a466d64a5acbc35214">num</a> == 0) {
<a name="l01772"></a>01772                                         pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#8f6963b3fb9ab83048c4c0697c90382a">ep0state</a> = EP0_STALL;
<a name="l01773"></a>01773                                 }
<a name="l01774"></a>01774 
<a name="l01775"></a>01775                                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#cce0e089118d8bf7c6278c21ded70d5a">stopped</a> = 1;
<a name="l01776"></a>01776                                 <a class="code" href="dwc__otg__cil_8c.html#5edca13178261136209ed51360c850b4">dwc_otg_ep_set_stall</a>(<a class="code" href="dwc__otg__pcd_8h.html#464549f9f4484651efe25b1a03692d72">GET_CORE_IF</a>(pcd),
<a name="l01777"></a>01777                                                      &amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>);
<a name="l01778"></a>01778                         }
<a name="l01779"></a>01779                 } <span class="keywordflow">else</span> {
<a name="l01780"></a>01780                         <span class="keywordflow">if</span> (ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#1dd76dafde9ac2a466d64a5acbc35214">num</a> == 0) {
<a name="l01781"></a>01781                                 pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#8f6963b3fb9ab83048c4c0697c90382a">ep0state</a> = EP0_STALL;
<a name="l01782"></a>01782                         }
<a name="l01783"></a>01783 
<a name="l01784"></a>01784                         ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#cce0e089118d8bf7c6278c21ded70d5a">stopped</a> = 1;
<a name="l01785"></a>01785                         <a class="code" href="dwc__otg__cil_8c.html#5edca13178261136209ed51360c850b4">dwc_otg_ep_set_stall</a>(<a class="code" href="dwc__otg__pcd_8h.html#464549f9f4484651efe25b1a03692d72">GET_CORE_IF</a>(pcd), &amp;ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>);
<a name="l01786"></a>01786                 }
<a name="l01787"></a>01787         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (value == 2) {
<a name="l01788"></a>01788                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#0d30d306e370810fc819f6ef735c7e67">stall_clear_flag</a> = 0;
<a name="l01789"></a>01789         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (value == 3) {
<a name="l01790"></a>01790                 ep-&gt;<a class="code" href="structdwc__otg__pcd__ep.html#6e43754ce0f3a4fe29e4d70fd58d4f8f">dwc_ep</a>.<a class="code" href="structdwc__ep.html#0d30d306e370810fc819f6ef735c7e67">stall_clear_flag</a> = 1;
<a name="l01791"></a>01791         }
<a name="l01792"></a>01792 
<a name="l01793"></a>01793         DWC_SPINUNLOCK_IRQRESTORE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#5d450e4d06659ab2f3b18e5c816776e4">lock</a>, flags);
<a name="l01794"></a>01794 
<a name="l01795"></a>01795         <span class="keywordflow">return</span> retval;
<a name="l01796"></a>01796 }
<a name="l01797"></a>01797 
<a name="l01801"></a><a class="code" href="dwc__otg__pcd_8c.html#89fb8b7a8276390becc3370903af55e2">01801</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd_8c.html#89fb8b7a8276390becc3370903af55e2">dwc_otg_pcd_rem_wkup_from_suspend</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd, <span class="keywordtype">int</span> set)
<a name="l01802"></a>01802 {
<a name="l01803"></a>01803         <a class="code" href="uniondctl__data.html">dctl_data_t</a> dctl = { 0 };
<a name="l01804"></a>01804         <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *core_if = <a class="code" href="dwc__otg__pcd_8h.html#464549f9f4484651efe25b1a03692d72">GET_CORE_IF</a>(pcd);
<a name="l01805"></a>01805         <a class="code" href="uniondsts__data.html">dsts_data_t</a> dsts;
<a name="l01806"></a>01806 
<a name="l01807"></a>01807         dsts.<a class="code" href="uniondsts__data.html#0f126daef735b142b06dbc4cdbe13814">d32</a> = dwc_read_reg32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#a0ed84d057445e2acd4c793f10f91078">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#e261921bab2e67ccc69007fc485d7f82">dev_global_regs</a>-&gt;<a class="code" href="structdwc__otg__dev__global__regs.html#1ed00edd20ce5db7d07666804101ec05">dsts</a>);
<a name="l01808"></a>01808         <span class="keywordflow">if</span> (!dsts.<a class="code" href="uniondsts__data.html#4066fcedb7ac9a88e47aa1b2df0e89ee">b</a>.<a class="code" href="uniondsts__data.html#4c7cd8ee3877701268846b0b02ac3d97">suspsts</a>) {
<a name="l01809"></a>01809                 DWC_WARN(<span class="stringliteral">"Remote wakeup while is not in suspend state\n"</span>);
<a name="l01810"></a>01810         }
<a name="l01811"></a>01811         <span class="comment">/* Check if DEVICE_REMOTE_WAKEUP feature enabled */</span>
<a name="l01812"></a>01812         <span class="keywordflow">if</span> (pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#9d8e6d7f0ad10d580d467024e258f6f5">remote_wakeup_enable</a>) {
<a name="l01813"></a>01813                 <span class="keywordflow">if</span> (set) {
<a name="l01814"></a>01814                         dctl.<a class="code" href="uniondctl__data.html#a3abfa6d609d9864f1f65712b409d4d3">b</a>.<a class="code" href="uniondctl__data.html#dcae5af28dc159cd7ba85a9a2b8be51a">rmtwkupsig</a> = 1;
<a name="l01815"></a>01815                         dwc_modify_reg32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#a0ed84d057445e2acd4c793f10f91078">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#e261921bab2e67ccc69007fc485d7f82">dev_global_regs</a>-&gt;
<a name="l01816"></a>01816                                          dctl, 0, dctl.<a class="code" href="uniondctl__data.html#f49aadfd7ad95b570115b3c245b1729e">d32</a>);
<a name="l01817"></a>01817                         <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#b39e7fe4805812e8f65962134b45f48a">DBG_PCD</a>, <span class="stringliteral">"Set Remote Wakeup\n"</span>);
<a name="l01818"></a>01818                         dwc_mdelay(2);
<a name="l01819"></a>01819                         dwc_modify_reg32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#a0ed84d057445e2acd4c793f10f91078">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#e261921bab2e67ccc69007fc485d7f82">dev_global_regs</a>-&gt;
<a name="l01820"></a>01820                                          dctl, dctl.<a class="code" href="uniondctl__data.html#f49aadfd7ad95b570115b3c245b1729e">d32</a>, 0);
<a name="l01821"></a>01821                         <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#b39e7fe4805812e8f65962134b45f48a">DBG_PCD</a>, <span class="stringliteral">"Clear Remote Wakeup\n"</span>);
<a name="l01822"></a>01822                 }
<a name="l01823"></a>01823         } <span class="keywordflow">else</span> {
<a name="l01824"></a>01824                 <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#b39e7fe4805812e8f65962134b45f48a">DBG_PCD</a>, <span class="stringliteral">"Remote Wakeup is disabled\n"</span>);
<a name="l01825"></a>01825         }
<a name="l01826"></a>01826 }
<a name="l01827"></a>01827 
<a name="l01828"></a>01828 <span class="preprocessor">#ifdef CONFIG_USB_DWC_OTG_LPM</span>
<a name="l01829"></a>01829 <span class="preprocessor"></span>
<a name="l01832"></a>01832 <span class="keywordtype">void</span> dwc_otg_pcd_rem_wkup_from_sleep(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd, <span class="keywordtype">int</span> set)
<a name="l01833"></a>01833 {
<a name="l01834"></a>01834         <a class="code" href="unionglpmctl__data.html">glpmcfg_data_t</a> lpmcfg;
<a name="l01835"></a>01835         <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *core_if = <a class="code" href="dwc__otg__pcd_8h.html#464549f9f4484651efe25b1a03692d72">GET_CORE_IF</a>(pcd);
<a name="l01836"></a>01836 
<a name="l01837"></a>01837         lpmcfg.<a class="code" href="unionglpmctl__data.html#cd41461734ff898209bfb64057ef2eb8">d32</a> = dwc_read_reg32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#909eae7e3b9432ca1e278b99f7811f52">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#843cfb38ba366a9a46ad07ed11eb8396">glpmcfg</a>);
<a name="l01838"></a>01838 
<a name="l01839"></a>01839         <span class="comment">/* Check if we are in L1 state */</span>
<a name="l01840"></a>01840         <span class="keywordflow">if</span> (!lpmcfg.<a class="code" href="unionglpmctl__data.html#bd3cc34c338226ff1cd89448f7590ff1">b</a>.<a class="code" href="unionglpmctl__data.html#241ff25a215f16ac29b3bb6d9f4943ed">prt_sleep_sts</a>) {
<a name="l01841"></a>01841                 <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#b39e7fe4805812e8f65962134b45f48a">DBG_PCD</a>, <span class="stringliteral">"Device is not in sleep state\n"</span>);
<a name="l01842"></a>01842                 <span class="keywordflow">return</span>;
<a name="l01843"></a>01843         }
<a name="l01844"></a>01844 
<a name="l01845"></a>01845         <span class="comment">/* Check if host allows remote wakeup */</span>
<a name="l01846"></a>01846         <span class="keywordflow">if</span> (!lpmcfg.<a class="code" href="unionglpmctl__data.html#bd3cc34c338226ff1cd89448f7590ff1">b</a>.<a class="code" href="unionglpmctl__data.html#60a9c2e233e3ee15a80ae80b27d09f8b">rem_wkup_en</a>) {
<a name="l01847"></a>01847                 <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#b39e7fe4805812e8f65962134b45f48a">DBG_PCD</a>, <span class="stringliteral">"Host does not allow remote wakeup\n"</span>);
<a name="l01848"></a>01848                 <span class="keywordflow">return</span>;
<a name="l01849"></a>01849         }
<a name="l01850"></a>01850 
<a name="l01851"></a>01851         <span class="comment">/* Check if Resume OK */</span>
<a name="l01852"></a>01852         <span class="keywordflow">if</span> (!lpmcfg.<a class="code" href="unionglpmctl__data.html#bd3cc34c338226ff1cd89448f7590ff1">b</a>.<a class="code" href="unionglpmctl__data.html#3b87473445c87d173f350828a60cacd8">sleep_state_resumeok</a>) {
<a name="l01853"></a>01853                 <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#b39e7fe4805812e8f65962134b45f48a">DBG_PCD</a>, <span class="stringliteral">"Sleep state resume is not OK\n"</span>);
<a name="l01854"></a>01854                 <span class="keywordflow">return</span>;
<a name="l01855"></a>01855         }
<a name="l01856"></a>01856 
<a name="l01857"></a>01857         lpmcfg.<a class="code" href="unionglpmctl__data.html#cd41461734ff898209bfb64057ef2eb8">d32</a> = dwc_read_reg32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#909eae7e3b9432ca1e278b99f7811f52">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#843cfb38ba366a9a46ad07ed11eb8396">glpmcfg</a>);
<a name="l01858"></a>01858         lpmcfg.<a class="code" href="unionglpmctl__data.html#bd3cc34c338226ff1cd89448f7590ff1">b</a>.<a class="code" href="unionglpmctl__data.html#63e912a05b8d29872b92263ca616fec8">en_utmi_sleep</a> = 0;
<a name="l01859"></a>01859         lpmcfg.<a class="code" href="unionglpmctl__data.html#bd3cc34c338226ff1cd89448f7590ff1">b</a>.<a class="code" href="unionglpmctl__data.html#e2ceea4bfe468c7b3c800235d7ffd5d2">hird_thres</a> &amp;= (~(1 &lt;&lt; 4));
<a name="l01860"></a>01860         dwc_write_reg32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#909eae7e3b9432ca1e278b99f7811f52">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#843cfb38ba366a9a46ad07ed11eb8396">glpmcfg</a>, lpmcfg.<a class="code" href="unionglpmctl__data.html#cd41461734ff898209bfb64057ef2eb8">d32</a>);
<a name="l01861"></a>01861 
<a name="l01862"></a>01862         <span class="keywordflow">if</span> (set) {
<a name="l01863"></a>01863                 <a class="code" href="uniondctl__data.html">dctl_data_t</a> dctl = {.d32 = 0 };
<a name="l01864"></a>01864                 dctl.<a class="code" href="uniondctl__data.html#a3abfa6d609d9864f1f65712b409d4d3">b</a>.<a class="code" href="uniondctl__data.html#dcae5af28dc159cd7ba85a9a2b8be51a">rmtwkupsig</a> = 1;
<a name="l01865"></a>01865                 <span class="comment">/* Set RmtWkUpSig bit to start remote wakup signaling.</span>
<a name="l01866"></a>01866 <span class="comment">                 * Hardware will automatically clear this bit.</span>
<a name="l01867"></a>01867 <span class="comment">                 */</span>
<a name="l01868"></a>01868                 dwc_modify_reg32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#a0ed84d057445e2acd4c793f10f91078">dev_if</a>-&gt;<a class="code" href="structdwc__otg__dev__if.html#e261921bab2e67ccc69007fc485d7f82">dev_global_regs</a>-&gt;<a class="code" href="structdwc__otg__dev__global__regs.html#3779c2fc508920a831a59e696a8fa785">dctl</a>,
<a name="l01869"></a>01869                                  0, dctl.<a class="code" href="uniondctl__data.html#f49aadfd7ad95b570115b3c245b1729e">d32</a>);
<a name="l01870"></a>01870                 <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#b39e7fe4805812e8f65962134b45f48a">DBG_PCD</a>, <span class="stringliteral">"Set Remote Wakeup\n"</span>);
<a name="l01871"></a>01871         }
<a name="l01872"></a>01872 
<a name="l01873"></a>01873 }
<a name="l01874"></a>01874 <span class="preprocessor">#endif</span>
<a name="l01875"></a>01875 <span class="preprocessor"></span>
<a name="l01879"></a><a class="code" href="dwc__otg__pcd__if_8h.html#24cbdd57c573d864a09a30ae3ecda89a">01879</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd_8c.html#24cbdd57c573d864a09a30ae3ecda89a">dwc_otg_pcd_remote_wakeup</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd, <span class="keywordtype">int</span> set)
<a name="l01880"></a>01880 {
<a name="l01881"></a>01881         <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *core_if = <a class="code" href="dwc__otg__pcd_8h.html#464549f9f4484651efe25b1a03692d72">GET_CORE_IF</a>(pcd);
<a name="l01882"></a>01882         <span class="keywordflow">if</span> (<a class="code" href="dwc__otg__cil_8c.html#e83fb22890bc54c6b06cedb751430e77">dwc_otg_is_device_mode</a>(core_if)) {
<a name="l01883"></a>01883 <span class="preprocessor">#ifdef CONFIG_USB_DWC_OTG_LPM</span>
<a name="l01884"></a>01884 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#2b0701d814069ec69897e08374366c7b">lx_state</a> == <a class="code" href="dwc__otg__cil_8h.html#8442e49b7c783099ac17bda4f8b3bc3cf5b112742a8103f3489107ad26c0ff58">DWC_OTG_L1</a>) {
<a name="l01885"></a>01885                         dwc_otg_pcd_rem_wkup_from_sleep(pcd, set);
<a name="l01886"></a>01886                 } <span class="keywordflow">else</span> {
<a name="l01887"></a>01887 <span class="preprocessor">#endif</span>
<a name="l01888"></a>01888 <span class="preprocessor"></span>                        <a class="code" href="dwc__otg__pcd_8c.html#89fb8b7a8276390becc3370903af55e2">dwc_otg_pcd_rem_wkup_from_suspend</a>(pcd, set);
<a name="l01889"></a>01889 <span class="preprocessor">#ifdef CONFIG_USB_DWC_OTG_LPM</span>
<a name="l01890"></a>01890 <span class="preprocessor"></span>                }
<a name="l01891"></a>01891 <span class="preprocessor">#endif</span>
<a name="l01892"></a>01892 <span class="preprocessor"></span>        }
<a name="l01893"></a>01893         <span class="keywordflow">return</span>;
<a name="l01894"></a>01894 }
<a name="l01895"></a>01895 
<a name="l01896"></a><a class="code" href="dwc__otg__pcd__if_8h.html#7e0d7b09dc6528626f4643deb296d68d">01896</a> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__pcd_8c.html#7e0d7b09dc6528626f4643deb296d68d">dwc_otg_pcd_wakeup</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd)
<a name="l01897"></a>01897 {
<a name="l01898"></a>01898         <a class="code" href="uniondsts__data.html">dsts_data_t</a> dsts;
<a name="l01899"></a>01899         <a class="code" href="uniongotgctl__data.html">gotgctl_data_t</a> gotgctl;
<a name="l01900"></a>01900         uint64_t flags;
<a name="l01901"></a>01901 
<a name="l01902"></a>01902         DWC_SPINLOCK_IRQSAVE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#5d450e4d06659ab2f3b18e5c816776e4">lock</a>, &amp;flags);
<a name="l01903"></a>01903 
<a name="l01904"></a>01904         <span class="comment">/*</span>
<a name="l01905"></a>01905 <span class="comment">         * This function starts the Protocol if no session is in progress. If</span>
<a name="l01906"></a>01906 <span class="comment">         * a session is already in progress, but the device is suspended,</span>
<a name="l01907"></a>01907 <span class="comment">         * remote wakeup signaling is started.</span>
<a name="l01908"></a>01908 <span class="comment">         */</span>
<a name="l01909"></a>01909 
<a name="l01910"></a>01910         <span class="comment">/* Check if valid session */</span>
<a name="l01911"></a>01911         gotgctl.<a class="code" href="uniongotgctl__data.html#ebb591ab40ff41f0e06f03a795647d33">d32</a> =
<a name="l01912"></a>01912             dwc_read_reg32(&amp;(<a class="code" href="dwc__otg__pcd_8h.html#464549f9f4484651efe25b1a03692d72">GET_CORE_IF</a>(pcd)-&gt;core_global_regs-&gt;gotgctl));
<a name="l01913"></a>01913         <span class="keywordflow">if</span> (gotgctl.<a class="code" href="uniongotgctl__data.html#212c81366266e906a188f4dbfadb6dd3">b</a>.<a class="code" href="uniongotgctl__data.html#69931c3759421d5eb6f91d4c9da4dddd">bsesvld</a>) {
<a name="l01914"></a>01914                 <span class="comment">/* Check if suspend state */</span>
<a name="l01915"></a>01915                 dsts.<a class="code" href="uniondsts__data.html#0f126daef735b142b06dbc4cdbe13814">d32</a> =
<a name="l01916"></a>01916                     dwc_read_reg32(&amp;
<a name="l01917"></a>01917                                    (<a class="code" href="dwc__otg__pcd_8h.html#464549f9f4484651efe25b1a03692d72">GET_CORE_IF</a>(pcd)-&gt;dev_if-&gt;dev_global_regs-&gt;
<a name="l01918"></a>01918                                     dsts));
<a name="l01919"></a>01919                 <span class="keywordflow">if</span> (dsts.<a class="code" href="uniondsts__data.html#4066fcedb7ac9a88e47aa1b2df0e89ee">b</a>.<a class="code" href="uniondsts__data.html#4c7cd8ee3877701268846b0b02ac3d97">suspsts</a>) {
<a name="l01920"></a>01920                         <a class="code" href="dwc__otg__pcd_8c.html#24cbdd57c573d864a09a30ae3ecda89a">dwc_otg_pcd_remote_wakeup</a>(pcd, 1);
<a name="l01921"></a>01921                 }
<a name="l01922"></a>01922         } <span class="keywordflow">else</span> {
<a name="l01923"></a>01923                 <a class="code" href="dwc__otg__pcd_8c.html#4be3e59162a42a79705e3ea8dc5008fa">dwc_otg_pcd_initiate_srp</a>(pcd);
<a name="l01924"></a>01924         }
<a name="l01925"></a>01925 
<a name="l01926"></a>01926         DWC_SPINUNLOCK_IRQRESTORE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#5d450e4d06659ab2f3b18e5c816776e4">lock</a>, flags);
<a name="l01927"></a>01927         <span class="keywordflow">return</span> 0;
<a name="l01928"></a>01928 
<a name="l01929"></a>01929 }
<a name="l01930"></a>01930 
<a name="l01937"></a><a class="code" href="dwc__otg__pcd_8c.html#517f9cf3e74ebb0b9e00ea1defc56697">01937</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd_8c.html#517f9cf3e74ebb0b9e00ea1defc56697">dwc_otg_pcd_start_srp_timer</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd)
<a name="l01938"></a>01938 {
<a name="l01939"></a>01939         <a class="code" href="dwc__otg__pcd_8h.html#464549f9f4484651efe25b1a03692d72">GET_CORE_IF</a>(pcd)-&gt;srp_timer_started = 1;
<a name="l01940"></a>01940         DWC_TIMER_SCHEDULE(pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#466fb6ae524fc970f164701db2e70246">srp_timer</a>, 6000 <span class="comment">/* 6 secs */</span> );
<a name="l01941"></a>01941 }
<a name="l01942"></a>01942 
<a name="l01943"></a><a class="code" href="dwc__otg__pcd__if_8h.html#4be3e59162a42a79705e3ea8dc5008fa">01943</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__pcd_8c.html#4be3e59162a42a79705e3ea8dc5008fa">dwc_otg_pcd_initiate_srp</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd)
<a name="l01944"></a>01944 {
<a name="l01945"></a>01945         uint32_t *addr =
<a name="l01946"></a>01946             (uint32_t *) &amp; (<a class="code" href="dwc__otg__pcd_8h.html#464549f9f4484651efe25b1a03692d72">GET_CORE_IF</a>(pcd)-&gt;core_global_regs-&gt;gotgctl);
<a name="l01947"></a>01947         <a class="code" href="uniongotgctl__data.html">gotgctl_data_t</a> mem;
<a name="l01948"></a>01948         <a class="code" href="uniongotgctl__data.html">gotgctl_data_t</a> val;
<a name="l01949"></a>01949 
<a name="l01950"></a>01950         val.<a class="code" href="uniongotgctl__data.html#ebb591ab40ff41f0e06f03a795647d33">d32</a> = dwc_read_reg32(addr);
<a name="l01951"></a>01951         <span class="keywordflow">if</span> (val.<a class="code" href="uniongotgctl__data.html#212c81366266e906a188f4dbfadb6dd3">b</a>.<a class="code" href="uniongotgctl__data.html#c6b0b35d4366f74cf6fe268eda781f06">sesreq</a>) {
<a name="l01952"></a>01952                 DWC_ERROR(<span class="stringliteral">"Session Request Already active!\n"</span>);
<a name="l01953"></a>01953                 <span class="keywordflow">return</span>;
<a name="l01954"></a>01954         }
<a name="l01955"></a>01955 
<a name="l01956"></a>01956         DWC_INFO(<span class="stringliteral">"Session Request Initated\n"</span>); <span class="comment">//NOTICE</span>
<a name="l01957"></a>01957         mem.<a class="code" href="uniongotgctl__data.html#ebb591ab40ff41f0e06f03a795647d33">d32</a> = dwc_read_reg32(addr);
<a name="l01958"></a>01958         mem.<a class="code" href="uniongotgctl__data.html#212c81366266e906a188f4dbfadb6dd3">b</a>.<a class="code" href="uniongotgctl__data.html#c6b0b35d4366f74cf6fe268eda781f06">sesreq</a> = 1;
<a name="l01959"></a>01959         dwc_write_reg32(addr, mem.<a class="code" href="uniongotgctl__data.html#ebb591ab40ff41f0e06f03a795647d33">d32</a>);
<a name="l01960"></a>01960 
<a name="l01961"></a>01961         <span class="comment">/* Start the SRP timer */</span>
<a name="l01962"></a>01962         <a class="code" href="dwc__otg__pcd_8c.html#517f9cf3e74ebb0b9e00ea1defc56697">dwc_otg_pcd_start_srp_timer</a>(pcd);
<a name="l01963"></a>01963         <span class="keywordflow">return</span>;
<a name="l01964"></a>01964 }
<a name="l01965"></a>01965 
<a name="l01966"></a><a class="code" href="dwc__otg__pcd__if_8h.html#04876b716043a853b379d72ff3a215e5">01966</a> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__pcd_8c.html#04876b716043a853b379d72ff3a215e5">dwc_otg_pcd_get_frame_number</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd)
<a name="l01967"></a>01967 {
<a name="l01968"></a>01968         <span class="keywordflow">return</span> <a class="code" href="dwc__otg__cil_8c.html#78f20f3acf6245b189abde83d9ce78f2">dwc_otg_get_frame_number</a>(<a class="code" href="dwc__otg__pcd_8h.html#464549f9f4484651efe25b1a03692d72">GET_CORE_IF</a>(pcd));
<a name="l01969"></a>01969 }
<a name="l01970"></a>01970 
<a name="l01971"></a><a class="code" href="dwc__otg__pcd__if_8h.html#676021c9b801674669cdf2d1e68d5b8c">01971</a> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__pcd_8c.html#676021c9b801674669cdf2d1e68d5b8c">dwc_otg_pcd_is_lpm_enabled</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd)
<a name="l01972"></a>01972 {
<a name="l01973"></a>01973         <span class="keywordflow">return</span> <a class="code" href="dwc__otg__pcd_8h.html#464549f9f4484651efe25b1a03692d72">GET_CORE_IF</a>(pcd)-&gt;core_params-&gt;lpm_enable;
<a name="l01974"></a>01974 }
<a name="l01975"></a>01975 
<a name="l01976"></a><a class="code" href="dwc__otg__pcd__if_8h.html#777a6a4e250add9ba5f5f5d63d854031">01976</a> uint32_t <a class="code" href="dwc__otg__pcd_8c.html#777a6a4e250add9ba5f5f5d63d854031">get_b_hnp_enable</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd)
<a name="l01977"></a>01977 {
<a name="l01978"></a>01978         <span class="keywordflow">return</span> pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#e09fc5322ac0d7deec2772984c10ae90">b_hnp_enable</a>;
<a name="l01979"></a>01979 }
<a name="l01980"></a>01980 
<a name="l01981"></a><a class="code" href="dwc__otg__pcd__if_8h.html#69d0bb469e15cb46f00c17398f76df99">01981</a> uint32_t <a class="code" href="dwc__otg__pcd_8c.html#69d0bb469e15cb46f00c17398f76df99">get_a_hnp_support</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd)
<a name="l01982"></a>01982 {
<a name="l01983"></a>01983         <span class="keywordflow">return</span> pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#e8008719644bdc23040f1a1545b7117f">a_hnp_support</a>;
<a name="l01984"></a>01984 }
<a name="l01985"></a>01985 
<a name="l01986"></a><a class="code" href="dwc__otg__pcd__if_8h.html#842709a4980bc78d49726fa880922dda">01986</a> uint32_t <a class="code" href="dwc__otg__pcd_8c.html#842709a4980bc78d49726fa880922dda">get_a_alt_hnp_support</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd)
<a name="l01987"></a>01987 {
<a name="l01988"></a>01988         <span class="keywordflow">return</span> pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#49f2d2b04a4c07a8d53643f7681b5405">a_alt_hnp_support</a>;
<a name="l01989"></a>01989 }
<a name="l01990"></a>01990 
<a name="l01991"></a><a class="code" href="dwc__otg__pcd__if_8h.html#0107dd39d549d3e10fd388337e03aeb9">01991</a> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__pcd_8c.html#0107dd39d549d3e10fd388337e03aeb9">dwc_otg_pcd_get_rmwkup_enable</a>(<a class="code" href="structdwc__otg__pcd.html">dwc_otg_pcd_t</a> * pcd)
<a name="l01992"></a>01992 {
<a name="l01993"></a>01993         <span class="keywordflow">return</span> pcd-&gt;<a class="code" href="structdwc__otg__pcd.html#9d8e6d7f0ad10d580d467024e258f6f5">remote_wakeup_enable</a>;
<a name="l01994"></a>01994 }
<a name="l01995"></a>01995 
<a name="l01996"></a>01996 <span class="preprocessor">#endif                          </span><span class="comment">/* DWC_HOST_ONLY */</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Tue May 5 02:22:48 2009 for DesignWare USB 2.0 OTG Controller (DWC_otg) Device Driver by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.7 </small></address>
</body>
</html>
