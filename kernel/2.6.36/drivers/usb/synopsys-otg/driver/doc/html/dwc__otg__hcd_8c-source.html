<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>DesignWare USB 2.0 OTG Controller (DWC_otg) Device Driver: dwc_otg_hcd.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.7 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>Globals</span></a></li>
  </ul></div>
<h1>dwc_otg_hcd.c</h1><a href="dwc__otg__hcd_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/* ==========================================================================</span>
<a name="l00002"></a>00002 <span class="comment"> * $File: //dwh/usb_iip/dev/software/otg/linux/drivers/dwc_otg_hcd.c $</span>
<a name="l00003"></a>00003 <span class="comment"> * $Revision: #87 $</span>
<a name="l00004"></a>00004 <span class="comment"> * $Date: 2009/04/23 $</span>
<a name="l00005"></a>00005 <span class="comment"> * $Change: 1239143 $</span>
<a name="l00006"></a>00006 <span class="comment"> *</span>
<a name="l00007"></a>00007 <span class="comment"> * Synopsys HS OTG Linux Software Driver and documentation (hereinafter,</span>
<a name="l00008"></a>00008 <span class="comment"> * "Software") is an Unsupported proprietary work of Synopsys, Inc. unless</span>
<a name="l00009"></a>00009 <span class="comment"> * otherwise expressly agreed to in writing between Synopsys and you.</span>
<a name="l00010"></a>00010 <span class="comment"> *</span>
<a name="l00011"></a>00011 <span class="comment"> * The Software IS NOT an item of Licensed Software or Licensed Product under</span>
<a name="l00012"></a>00012 <span class="comment"> * any End User Software License Agreement or Agreement for Licensed Product</span>
<a name="l00013"></a>00013 <span class="comment"> * with Synopsys or any supplement thereto. You are permitted to use and</span>
<a name="l00014"></a>00014 <span class="comment"> * redistribute this Software in source and binary forms, with or without</span>
<a name="l00015"></a>00015 <span class="comment"> * modification, provided that redistributions of source code must retain this</span>
<a name="l00016"></a>00016 <span class="comment"> * notice. You may not view, use, disclose, copy or distribute this file or</span>
<a name="l00017"></a>00017 <span class="comment"> * any information contained herein except pursuant to this license grant from</span>
<a name="l00018"></a>00018 <span class="comment"> * Synopsys. If you do not agree with this notice, including the disclaimer</span>
<a name="l00019"></a>00019 <span class="comment"> * below, then you are not authorized to use the Software.</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * THIS SOFTWARE IS BEING DISTRIBUTED BY SYNOPSYS SOLELY ON AN "AS IS" BASIS</span>
<a name="l00022"></a>00022 <span class="comment"> * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
<a name="l00023"></a>00023 <span class="comment"> * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
<a name="l00024"></a>00024 <span class="comment"> * ARE HEREBY DISCLAIMED. IN NO EVENT SHALL SYNOPSYS BE LIABLE FOR ANY DIRECT,</span>
<a name="l00025"></a>00025 <span class="comment"> * INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES</span>
<a name="l00026"></a>00026 <span class="comment"> * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR</span>
<a name="l00027"></a>00027 <span class="comment"> * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER</span>
<a name="l00028"></a>00028 <span class="comment"> * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</span>
<a name="l00029"></a>00029 <span class="comment"> * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY</span>
<a name="l00030"></a>00030 <span class="comment"> * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH</span>
<a name="l00031"></a>00031 <span class="comment"> * DAMAGE.</span>
<a name="l00032"></a>00032 <span class="comment"> * ========================================================================== */</span>
<a name="l00033"></a>00033 <span class="preprocessor">#ifndef DWC_DEVICE_ONLY</span>
<a name="l00034"></a>00034 <span class="preprocessor"></span>
<a name="l00042"></a>00042 <span class="preprocessor">#include "<a class="code" href="dwc__otg__hcd_8h.html">dwc_otg_hcd.h</a>"</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include "<a class="code" href="dwc__otg__regs_8h.html">dwc_otg_regs.h</a>"</span>
<a name="l00044"></a>00044                 
<a name="l00045"></a><a class="code" href="dwc__otg__hcd__if_8h.html#5595437c199432efbd3609dc87ef5afa">00045</a> <a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> *<a class="code" href="dwc__otg__hcd_8c.html#5595437c199432efbd3609dc87ef5afa">dwc_otg_hcd_alloc_hcd</a>(<span class="keywordtype">void</span>)
<a name="l00046"></a>00046 {
<a name="l00047"></a>00047         <span class="keywordflow">return</span> dwc_alloc(<span class="keyword">sizeof</span>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a>));
<a name="l00048"></a>00048 }
<a name="l00049"></a>00049 
<a name="l00054"></a><a class="code" href="dwc__otg__hcd_8c.html#4f6f55c20aa8eb215d692195f9f0280d">00054</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__hcd_8c.html#4f6f55c20aa8eb215d692195f9f0280d">dwc_otg_hcd_connect_timeout</a>(<span class="keywordtype">void</span> *ptr)
<a name="l00055"></a>00055 {
<a name="l00056"></a>00056         <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#39931d908ba215b3d5d590e42d8408b5">DBG_HCDV</a>, <span class="stringliteral">"%s(%p)\n"</span>, __func__, ptr);
<a name="l00057"></a>00057         DWC_PRINTF(<span class="stringliteral">"Connect Timeout\n"</span>);
<a name="l00058"></a>00058         __DWC_ERROR(<span class="stringliteral">"Device Not Connected/Responding\n"</span>);
<a name="l00059"></a>00059 }
<a name="l00060"></a>00060 
<a name="l00061"></a>00061 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l00062"></a>00062 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">void</span> dump_channel_info(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd, <a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a> * qh)
<a name="l00063"></a>00063 {
<a name="l00064"></a>00064         <span class="keywordflow">if</span> (qh-&gt;<a class="code" href="structdwc__otg__qh.html#bbdb7d30b60b6c326301f33b35088bb4">channel</a> != NULL) {
<a name="l00065"></a>00065                 <a class="code" href="structdwc__hc.html">dwc_hc_t</a> *hc = qh-&gt;<a class="code" href="structdwc__otg__qh.html#bbdb7d30b60b6c326301f33b35088bb4">channel</a>;
<a name="l00066"></a>00066                 dwc_list_link_t *item;
<a name="l00067"></a>00067                 <a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a> *qh_item;
<a name="l00068"></a>00068                 <span class="keywordtype">int</span> num_channels = hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#63ffc9b8e36340bd59bf1fab9ca490ad">core_params</a>-&gt;<a class="code" href="structdwc__otg__core__params.html#c1b433c6965aa7d48f6ca6818c592039">host_channels</a>;
<a name="l00069"></a>00069                 <span class="keywordtype">int</span> i;
<a name="l00070"></a>00070 
<a name="l00071"></a>00071                 <a class="code" href="structdwc__otg__hc__regs.html">dwc_otg_hc_regs_t</a> *hc_regs;
<a name="l00072"></a>00072                 <a class="code" href="unionhcchar__data.html">hcchar_data_t</a> hcchar;
<a name="l00073"></a>00073                 <a class="code" href="unionhcsplt__data.html">hcsplt_data_t</a> hcsplt;
<a name="l00074"></a>00074                 <a class="code" href="unionhctsiz__data.html">hctsiz_data_t</a> hctsiz;
<a name="l00075"></a>00075                 uint32_t hcdma;
<a name="l00076"></a>00076 
<a name="l00077"></a>00077                 hc_regs = hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#51bac71891b5f6f435d7fc4582b974c1">host_if</a>-&gt;<a class="code" href="structdwc__otg__host__if.html#7f7c107d4720641eb4141cd817211ac0">hc_regs</a>[hc-&gt;<a class="code" href="structdwc__hc.html#df0c2b93e5c84cfaba6f06eaeaece5a1">hc_num</a>];
<a name="l00078"></a>00078                 hcchar.<a class="code" href="unionhcchar__data.html#03d352fb421ab5c11bf9afaae4933ba4">d32</a> = dwc_read_reg32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#3d8bdf7979ea6dd5ba01858aca7a1c02">hcchar</a>);
<a name="l00079"></a>00079                 hcsplt.<a class="code" href="unionhcsplt__data.html#0cd235b445ff681b846f5dccf24fd644">d32</a> = dwc_read_reg32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#149053001a9ee21b692afde531a814de">hcsplt</a>);
<a name="l00080"></a>00080                 hctsiz.<a class="code" href="unionhctsiz__data.html#fb41950555c60c6015294bdefe9cd39d">d32</a> = dwc_read_reg32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#c6173f823ba754d9f9549422b6380ca2">hctsiz</a>);
<a name="l00081"></a>00081                 hcdma = dwc_read_reg32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#ab2148d4b5f1bf3a2ad438e497a8b4a3">hcdma</a>);
<a name="l00082"></a>00082 
<a name="l00083"></a>00083                 DWC_PRINTF(<span class="stringliteral">"  Assigned to channel %p:\n"</span>, hc);
<a name="l00084"></a>00084                 DWC_PRINTF(<span class="stringliteral">"    hcchar 0x%08x, hcsplt 0x%08x\n"</span>, hcchar.<a class="code" href="unionhcchar__data.html#03d352fb421ab5c11bf9afaae4933ba4">d32</a>,
<a name="l00085"></a>00085                            hcsplt.<a class="code" href="unionhcsplt__data.html#0cd235b445ff681b846f5dccf24fd644">d32</a>);
<a name="l00086"></a>00086                 DWC_PRINTF(<span class="stringliteral">"    hctsiz 0x%08x, hcdma 0x%08x\n"</span>, hctsiz.<a class="code" href="unionhctsiz__data.html#fb41950555c60c6015294bdefe9cd39d">d32</a>,
<a name="l00087"></a>00087                            hcdma);
<a name="l00088"></a>00088                 DWC_PRINTF(<span class="stringliteral">"    dev_addr: %d, ep_num: %d, ep_is_in: %d\n"</span>,
<a name="l00089"></a>00089                            hc-&gt;<a class="code" href="structdwc__hc.html#b2c7e8baff70104375f4916e9b76cef7">dev_addr</a>, hc-&gt;<a class="code" href="structdwc__hc.html#70b755f76a00b81679aeb1e0db8b2e60">ep_num</a>, hc-&gt;<a class="code" href="structdwc__hc.html#c5088d431f5efc382121f201f5d571aa">ep_is_in</a>);
<a name="l00090"></a>00090                 DWC_PRINTF(<span class="stringliteral">"    ep_type: %d\n"</span>, hc-&gt;<a class="code" href="structdwc__hc.html#e6169fbc92e4d79686097742ad646f5c">ep_type</a>);
<a name="l00091"></a>00091                 DWC_PRINTF(<span class="stringliteral">"    max_packet: %d\n"</span>, hc-&gt;<a class="code" href="structdwc__hc.html#bd88f02eb286ba01d8d1b049e8975ccb">max_packet</a>);
<a name="l00092"></a>00092                 DWC_PRINTF(<span class="stringliteral">"    data_pid_start: %d\n"</span>, hc-&gt;<a class="code" href="structdwc__hc.html#513427c5e8c4603ba344d4e7f9191064">data_pid_start</a>);
<a name="l00093"></a>00093                 DWC_PRINTF(<span class="stringliteral">"    xfer_started: %d\n"</span>, hc-&gt;<a class="code" href="structdwc__hc.html#78a1cf134604b24bfdedb4f4df9f2c1f">xfer_started</a>);
<a name="l00094"></a>00094                 DWC_PRINTF(<span class="stringliteral">"    halt_status: %d\n"</span>, hc-&gt;<a class="code" href="structdwc__hc.html#07eca0fa02105ddaa1719387f5558b23">halt_status</a>);
<a name="l00095"></a>00095                 DWC_PRINTF(<span class="stringliteral">"    xfer_buff: %p\n"</span>, hc-&gt;<a class="code" href="structdwc__hc.html#9dc781cb9e4bc639765beee37ce76673">xfer_buff</a>);
<a name="l00096"></a>00096                 DWC_PRINTF(<span class="stringliteral">"    xfer_len: %d\n"</span>, hc-&gt;<a class="code" href="structdwc__hc.html#ce32fe93214f1686896e924fbf61cac7">xfer_len</a>);
<a name="l00097"></a>00097                 DWC_PRINTF(<span class="stringliteral">"    qh: %p\n"</span>, hc-&gt;<a class="code" href="structdwc__hc.html#d338f8db131745d9921f51c30f26cd3c">qh</a>);
<a name="l00098"></a>00098                 DWC_PRINTF(<span class="stringliteral">"  NP inactive sched:\n"</span>);
<a name="l00099"></a>00099                 DWC_LIST_FOREACH(item, &amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#64c96c47a36d71bad6e4360cec9d07ad">non_periodic_sched_inactive</a>) {
<a name="l00100"></a>00100                         qh_item =
<a name="l00101"></a>00101                             DWC_LIST_ENTRY(item, <a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a>, qh_list_entry);
<a name="l00102"></a>00102                         DWC_PRINTF(<span class="stringliteral">"    %p\n"</span>, qh_item);
<a name="l00103"></a>00103                 }
<a name="l00104"></a>00104                 DWC_PRINTF(<span class="stringliteral">"  NP active sched:\n"</span>);
<a name="l00105"></a>00105                 DWC_LIST_FOREACH(item, &amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#ffa3041ad517da9519aa2159cdec3f61">non_periodic_sched_active</a>) {
<a name="l00106"></a>00106                         qh_item =
<a name="l00107"></a>00107                             DWC_LIST_ENTRY(item, <a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a>, qh_list_entry);
<a name="l00108"></a>00108                         DWC_PRINTF(<span class="stringliteral">"    %p\n"</span>, qh_item);
<a name="l00109"></a>00109                 }
<a name="l00110"></a>00110                 DWC_PRINTF(<span class="stringliteral">"  Channels: \n"</span>);
<a name="l00111"></a>00111                 <span class="keywordflow">for</span> (i = 0; i &lt; num_channels; i++) {
<a name="l00112"></a>00112                         <a class="code" href="structdwc__hc.html">dwc_hc_t</a> *hc = hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#cb393f6a676fb106e0e3d35396fb97f9">hc_ptr_array</a>[i];
<a name="l00113"></a>00113                         DWC_PRINTF(<span class="stringliteral">"    %2d: %p\n"</span>, i, hc);
<a name="l00114"></a>00114                 }
<a name="l00115"></a>00115         }
<a name="l00116"></a>00116 }
<a name="l00117"></a>00117 <span class="preprocessor">#endif                          </span><span class="comment">/* DEBUG */</span>
<a name="l00118"></a>00118 
<a name="l00123"></a><a class="code" href="dwc__otg__hcd_8c.html#5a7a5af3b84b4af188fa3b60058a039c">00123</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__hcd_8c.html#5a7a5af3b84b4af188fa3b60058a039c">hcd_start_func</a>(<span class="keywordtype">void</span> *_vp)
<a name="l00124"></a>00124 {
<a name="l00125"></a>00125         <a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> *hcd = (<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> *) _vp;
<a name="l00126"></a>00126 
<a name="l00127"></a>00127         <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#39931d908ba215b3d5d590e42d8408b5">DBG_HCDV</a>, <span class="stringliteral">"%s() %p\n"</span>, __func__, hcd);
<a name="l00128"></a>00128         <span class="keywordflow">if</span> (hcd) {
<a name="l00129"></a>00129                 hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#ffefbd33a59a14b8b46406f5aaeaa2f4">fops</a>-&gt;<a class="code" href="structdwc__otg__hcd__function__ops.html#d74a65269fe5712ac307bfd3230a29b4">start</a>(hcd);
<a name="l00130"></a>00130         }
<a name="l00131"></a>00131 }
<a name="l00132"></a>00132 
<a name="l00133"></a><a class="code" href="dwc__otg__hcd_8c.html#17f7272e6a2fe4515b3160ad4694ea55">00133</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__hcd_8c.html#17f7272e6a2fe4515b3160ad4694ea55">del_xfer_timers</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd)
<a name="l00134"></a>00134 {
<a name="l00135"></a>00135 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l00136"></a>00136 <span class="preprocessor"></span>        <span class="keywordtype">int</span> i;
<a name="l00137"></a>00137         <span class="keywordtype">int</span> num_channels = hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#63ffc9b8e36340bd59bf1fab9ca490ad">core_params</a>-&gt;<a class="code" href="structdwc__otg__core__params.html#c1b433c6965aa7d48f6ca6818c592039">host_channels</a>;
<a name="l00138"></a>00138         <span class="keywordflow">for</span> (i = 0; i &lt; num_channels; i++) {
<a name="l00139"></a>00139                 DWC_TIMER_CANCEL(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;hc_xfer_timer[i]);
<a name="l00140"></a>00140         }
<a name="l00141"></a>00141 <span class="preprocessor">#endif</span>
<a name="l00142"></a>00142 <span class="preprocessor"></span>}
<a name="l00143"></a>00143 
<a name="l00144"></a><a class="code" href="dwc__otg__hcd_8c.html#939a9c8afc75cbe47625e392a7c66a1a">00144</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__hcd_8c.html#939a9c8afc75cbe47625e392a7c66a1a">del_timers</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd)
<a name="l00145"></a>00145 {
<a name="l00146"></a>00146         <a class="code" href="dwc__otg__hcd_8c.html#17f7272e6a2fe4515b3160ad4694ea55">del_xfer_timers</a>(hcd);
<a name="l00147"></a>00147         DWC_TIMER_CANCEL(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#de7796a41bb7d1e45ed9dbc20c995342">conn_timer</a>);
<a name="l00148"></a>00148 }
<a name="l00149"></a>00149 
<a name="l00154"></a><a class="code" href="dwc__otg__hcd_8c.html#8fd9263ed86449c5440edd834cb4d766">00154</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__hcd_8c.html#8fd9263ed86449c5440edd834cb4d766">kill_urbs_in_qh_list</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd, dwc_list_link_t * qh_list)
<a name="l00155"></a>00155 {
<a name="l00156"></a>00156         dwc_list_link_t *qh_item;
<a name="l00157"></a>00157         <a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a> *qh;
<a name="l00158"></a>00158         <a class="code" href="structdwc__otg__qtd.html">dwc_otg_qtd_t</a> *qtd, *qtd_tmp;
<a name="l00159"></a>00159 
<a name="l00160"></a>00160         DWC_LIST_FOREACH(qh_item, qh_list) {
<a name="l00161"></a>00161                 qh = DWC_LIST_ENTRY(qh_item, <a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a>, qh_list_entry);
<a name="l00162"></a>00162                 DWC_CIRCLEQ_FOREACH_SAFE(qtd, qtd_tmp,
<a name="l00163"></a>00163                                          &amp;qh-&gt;<a class="code" href="structdwc__otg__qh.html#9567d266da8e796d3467fb16ae867f8e">qtd_list</a>, qtd_list_entry) {
<a name="l00164"></a>00164                         qtd = DWC_CIRCLEQ_FIRST(&amp;qh-&gt;<a class="code" href="structdwc__otg__qh.html#9567d266da8e796d3467fb16ae867f8e">qtd_list</a>);
<a name="l00165"></a>00165                         <span class="keywordflow">if</span> (qtd-&gt;<a class="code" href="structdwc__otg__qtd.html#7e7767808e8eb9d71de0db00f57553f9">urb</a> != NULL) {
<a name="l00166"></a>00166                                 hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#ffefbd33a59a14b8b46406f5aaeaa2f4">fops</a>-&gt;<a class="code" href="structdwc__otg__hcd__function__ops.html#09a989481103de7468cd46ef61ace0ce">complete</a>(hcd, qtd-&gt;<a class="code" href="structdwc__otg__qtd.html#7e7767808e8eb9d71de0db00f57553f9">urb</a>-&gt;<a class="code" href="structdwc__otg__hcd__urb.html#5ba0e393ef9768275db85c00e68be477">priv</a>,
<a name="l00167"></a>00167                                                     qtd-&gt;<a class="code" href="structdwc__otg__qtd.html#7e7767808e8eb9d71de0db00f57553f9">urb</a>,
<a name="l00168"></a>00168                                                     -DWC_E_TIMEOUT);
<a name="l00169"></a>00169                                 <a class="code" href="dwc__otg__hcd_8h.html#19adb6641f95448a956015b2d69ba96a">dwc_otg_hcd_qtd_remove_and_free</a>(hcd, qtd, qh);
<a name="l00170"></a>00170                         }
<a name="l00171"></a>00171 
<a name="l00172"></a>00172                 }
<a name="l00173"></a>00173         }
<a name="l00174"></a>00174 }
<a name="l00175"></a>00175 
<a name="l00182"></a><a class="code" href="dwc__otg__hcd_8c.html#63f169b583c3818268def3614ac2fe0a">00182</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__hcd_8c.html#63f169b583c3818268def3614ac2fe0a">kill_all_urbs</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd)
<a name="l00183"></a>00183 {
<a name="l00184"></a>00184         <a class="code" href="dwc__otg__hcd_8c.html#8fd9263ed86449c5440edd834cb4d766">kill_urbs_in_qh_list</a>(hcd, &amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#64c96c47a36d71bad6e4360cec9d07ad">non_periodic_sched_inactive</a>);
<a name="l00185"></a>00185         <a class="code" href="dwc__otg__hcd_8c.html#8fd9263ed86449c5440edd834cb4d766">kill_urbs_in_qh_list</a>(hcd, &amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#ffa3041ad517da9519aa2159cdec3f61">non_periodic_sched_active</a>);
<a name="l00186"></a>00186         <a class="code" href="dwc__otg__hcd_8c.html#8fd9263ed86449c5440edd834cb4d766">kill_urbs_in_qh_list</a>(hcd, &amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#2a747cacd6bdbacbef86d4157c34a312">periodic_sched_inactive</a>);
<a name="l00187"></a>00187         <a class="code" href="dwc__otg__hcd_8c.html#8fd9263ed86449c5440edd834cb4d766">kill_urbs_in_qh_list</a>(hcd, &amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#74b089e094911a558f7b5f24681d3242">periodic_sched_ready</a>);
<a name="l00188"></a>00188         <a class="code" href="dwc__otg__hcd_8c.html#8fd9263ed86449c5440edd834cb4d766">kill_urbs_in_qh_list</a>(hcd, &amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#4b8deae798f771135c4a99693b26873f">periodic_sched_assigned</a>);
<a name="l00189"></a>00189         <a class="code" href="dwc__otg__hcd_8c.html#8fd9263ed86449c5440edd834cb4d766">kill_urbs_in_qh_list</a>(hcd, &amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e127912880eb487b3a2f38778c0de238">periodic_sched_queued</a>);
<a name="l00190"></a>00190 }
<a name="l00191"></a>00191 
<a name="l00198"></a><a class="code" href="dwc__otg__hcd_8c.html#65c0cd2720ab3e728fffd0073b4a1aba">00198</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__hcd_8c.html#65c0cd2720ab3e728fffd0073b4a1aba">dwc_otg_hcd_start_connect_timer</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd)
<a name="l00199"></a>00199 {
<a name="l00200"></a>00200         DWC_TIMER_SCHEDULE(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#de7796a41bb7d1e45ed9dbc20c995342">conn_timer</a>, 10000 <span class="comment">/* 10 secs */</span> );
<a name="l00201"></a>00201 }
<a name="l00202"></a>00202 
<a name="l00208"></a><a class="code" href="dwc__otg__hcd_8c.html#a0deab93f6ca3bcfcab0085b2bf86113">00208</a> <span class="keyword">static</span> int32_t <a class="code" href="dwc__otg__hcd_8c.html#a0deab93f6ca3bcfcab0085b2bf86113">dwc_otg_hcd_session_start_cb</a>(<span class="keywordtype">void</span> *p)
<a name="l00209"></a>00209 {
<a name="l00210"></a>00210         <a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> *<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd</a>;
<a name="l00211"></a>00211         <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#39931d908ba215b3d5d590e42d8408b5">DBG_HCDV</a>, <span class="stringliteral">"%s(%p)\n"</span>, __func__, p);
<a name="l00212"></a>00212         dwc_otg_hcd = p;
<a name="l00213"></a>00213         <a class="code" href="dwc__otg__hcd_8c.html#65c0cd2720ab3e728fffd0073b4a1aba">dwc_otg_hcd_start_connect_timer</a>(dwc_otg_hcd);
<a name="l00214"></a>00214         <span class="keywordflow">return</span> 1;
<a name="l00215"></a>00215 }
<a name="l00216"></a>00216 
<a name="l00223"></a><a class="code" href="dwc__otg__hcd_8c.html#1aaeb9f41b201877f86a17d617b828d2">00223</a> <span class="keyword">static</span> int32_t <a class="code" href="dwc__otg__hcd_8c.html#1aaeb9f41b201877f86a17d617b828d2">dwc_otg_hcd_start_cb</a>(<span class="keywordtype">void</span> *p)
<a name="l00224"></a>00224 {
<a name="l00225"></a>00225         <a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> *<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd</a> = p;
<a name="l00226"></a>00226         <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>;
<a name="l00227"></a>00227         <a class="code" href="unionhprt0__data.html">hprt0_data_t</a> hprt0;
<a name="l00228"></a>00228 
<a name="l00229"></a>00229         <a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a> = dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>;
<a name="l00230"></a>00230 
<a name="l00231"></a>00231         <span class="keywordflow">if</span> (<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#5a5c5c1cf8d870101cc1fffac56d88c0">op_state</a> == <a class="code" href="dwc__otg__cil_8h.html#02d6d4d9a0fdcc4fc8c5cf8e6c8577aa">B_HOST</a>) {
<a name="l00232"></a>00232                 <span class="comment">/*</span>
<a name="l00233"></a>00233 <span class="comment">                 * Reset the port.  During a HNP mode switch the reset</span>
<a name="l00234"></a>00234 <span class="comment">                 * needs to occur within 1ms and have a duration of at</span>
<a name="l00235"></a>00235 <span class="comment">                 * least 50ms.</span>
<a name="l00236"></a>00236 <span class="comment">                 */</span>
<a name="l00237"></a>00237                 hprt0.<a class="code" href="unionhprt0__data.html#88e9271f697d2ec209fc6a6da67fe216">d32</a> = <a class="code" href="dwc__otg__cil_8h.html#ce67da6af4023cffd25333d20992438e">dwc_otg_read_hprt0</a>(<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>);
<a name="l00238"></a>00238                 hprt0.<a class="code" href="unionhprt0__data.html#08cd86ce6da6462fc53601db7e2b73f3">b</a>.<a class="code" href="unionhprt0__data.html#714a31048710164370292124795a9a9b">prtrst</a> = 1;
<a name="l00239"></a>00239                 dwc_write_reg32(<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#51bac71891b5f6f435d7fc4582b974c1">host_if</a>-&gt;<a class="code" href="structdwc__otg__host__if.html#dc8fe33e0bb3829cafa884d5fc603c4d">hprt0</a>, hprt0.<a class="code" href="unionhprt0__data.html#88e9271f697d2ec209fc6a6da67fe216">d32</a>);
<a name="l00240"></a>00240         }
<a name="l00241"></a>00241         DWC_WORKQ_SCHEDULE_DELAYED(<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#7e3716f6d6bc6f956a45efbe6e308386">wq_otg</a>,
<a name="l00242"></a>00242                                    <a class="code" href="dwc__otg__hcd_8c.html#5a7a5af3b84b4af188fa3b60058a039c">hcd_start_func</a>, dwc_otg_hcd, 50,
<a name="l00243"></a>00243                                    <span class="stringliteral">"start hcd"</span>);
<a name="l00244"></a>00244 
<a name="l00245"></a>00245         <span class="keywordflow">return</span> 1;
<a name="l00246"></a>00246 }
<a name="l00247"></a>00247 
<a name="l00253"></a><a class="code" href="dwc__otg__hcd_8c.html#2af30c3c78408325b26e3431b2442055">00253</a> <span class="keyword">static</span> int32_t <a class="code" href="dwc__otg__hcd_8c.html#2af30c3c78408325b26e3431b2442055">dwc_otg_hcd_disconnect_cb</a>(<span class="keywordtype">void</span> *p)
<a name="l00254"></a>00254 {
<a name="l00255"></a>00255         <a class="code" href="uniongintsts__data.html">gintsts_data_t</a> intr;
<a name="l00256"></a>00256         <a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> *<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd</a> = p;
<a name="l00257"></a>00257 
<a name="l00258"></a>00258         <span class="comment">/*</span>
<a name="l00259"></a>00259 <span class="comment">         * Set status flags for the hub driver.</span>
<a name="l00260"></a>00260 <span class="comment">         */</span>
<a name="l00261"></a>00261         dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#9aaf2a112f5794f92dedd826342bd637">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#76f573861d9316238ded198c58c228c7">b</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#cd31ac4b9658265e90773448f354f0e1">port_connect_status_change</a> = 1;
<a name="l00262"></a>00262         dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#9aaf2a112f5794f92dedd826342bd637">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#76f573861d9316238ded198c58c228c7">b</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#9314ac02ed140807687793b512f78c63">port_connect_status</a> = 0;
<a name="l00263"></a>00263 
<a name="l00264"></a>00264         <span class="comment">/*</span>
<a name="l00265"></a>00265 <span class="comment">         * Shutdown any transfers in process by clearing the Tx FIFO Empty</span>
<a name="l00266"></a>00266 <span class="comment">         * interrupt mask and status bits and disabling subsequent host</span>
<a name="l00267"></a>00267 <span class="comment">         * channel interrupts.</span>
<a name="l00268"></a>00268 <span class="comment">         */</span>
<a name="l00269"></a>00269         intr.<a class="code" href="uniongintsts__data.html#379f34f5a95628b735e3a965f9cea12d">d32</a> = 0;
<a name="l00270"></a>00270         intr.<a class="code" href="uniongintsts__data.html#781da5558468e5dbdc93ae95e4cb872e">b</a>.<a class="code" href="uniongintsts__data.html#adebf5ff5bdf69a2bcf0bd4b2ba55ef4">nptxfempty</a> = 1;
<a name="l00271"></a>00271         intr.<a class="code" href="uniongintsts__data.html#781da5558468e5dbdc93ae95e4cb872e">b</a>.<a class="code" href="uniongintsts__data.html#54ed752629e9b8916507beca28d76162">ptxfempty</a> = 1;
<a name="l00272"></a>00272         intr.<a class="code" href="uniongintsts__data.html#781da5558468e5dbdc93ae95e4cb872e">b</a>.<a class="code" href="uniongintsts__data.html#e02f1a50b20ed1c4248fd76e155147e8">hcintr</a> = 1;
<a name="l00273"></a>00273         dwc_modify_reg32(&amp;dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#909eae7e3b9432ca1e278b99f7811f52">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#48827c76da2c6b18f369e2f2483cc4b6">gintmsk</a>,
<a name="l00274"></a>00274                          intr.<a class="code" href="uniongintsts__data.html#379f34f5a95628b735e3a965f9cea12d">d32</a>, 0);
<a name="l00275"></a>00275         dwc_modify_reg32(&amp;dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#909eae7e3b9432ca1e278b99f7811f52">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#aa1d909e3b0a60a56bf612968ff09019">gintsts</a>,
<a name="l00276"></a>00276                          intr.<a class="code" href="uniongintsts__data.html#379f34f5a95628b735e3a965f9cea12d">d32</a>, 0);
<a name="l00277"></a>00277 
<a name="l00278"></a>00278         <a class="code" href="dwc__otg__hcd_8c.html#939a9c8afc75cbe47625e392a7c66a1a">del_timers</a>(dwc_otg_hcd);
<a name="l00279"></a>00279 
<a name="l00280"></a>00280         <span class="comment">/*</span>
<a name="l00281"></a>00281 <span class="comment">         * Turn off the vbus power only if the core has transitioned to device</span>
<a name="l00282"></a>00282 <span class="comment">         * mode. If still in host mode, need to keep power on to detect a</span>
<a name="l00283"></a>00283 <span class="comment">         * reconnection.</span>
<a name="l00284"></a>00284 <span class="comment">         */</span>
<a name="l00285"></a>00285         <span class="keywordflow">if</span> (<a class="code" href="dwc__otg__cil_8c.html#e83fb22890bc54c6b06cedb751430e77">dwc_otg_is_device_mode</a>(dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>)) {
<a name="l00286"></a>00286                 <span class="keywordflow">if</span> (dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#5a5c5c1cf8d870101cc1fffac56d88c0">op_state</a> != <a class="code" href="dwc__otg__cil_8h.html#da9f5eb506da71435e8976ceb38bc14d">A_SUSPEND</a>) {
<a name="l00287"></a>00287                         <a class="code" href="unionhprt0__data.html">hprt0_data_t</a> hprt0 = {.d32 = 0 };
<a name="l00288"></a>00288                         DWC_PRINTF(<span class="stringliteral">"Disconnect: PortPower off\n"</span>);
<a name="l00289"></a>00289                         hprt0.<a class="code" href="unionhprt0__data.html#08cd86ce6da6462fc53601db7e2b73f3">b</a>.<a class="code" href="unionhprt0__data.html#010bd8fb208ef4eeaa288b28f8f8c3a4">prtpwr</a> = 0;
<a name="l00290"></a>00290                         dwc_write_reg32(dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#51bac71891b5f6f435d7fc4582b974c1">host_if</a>-&gt;<a class="code" href="structdwc__otg__host__if.html#dc8fe33e0bb3829cafa884d5fc603c4d">hprt0</a>,
<a name="l00291"></a>00291                                         hprt0.<a class="code" href="unionhprt0__data.html#88e9271f697d2ec209fc6a6da67fe216">d32</a>);
<a name="l00292"></a>00292                 }
<a name="l00293"></a>00293 
<a name="l00294"></a>00294                 <a class="code" href="dwc__otg__cil_8c.html#4dd4a30dd75a819e9da38d6410cbb0a4">dwc_otg_disable_host_interrupts</a>(dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>);
<a name="l00295"></a>00295         }
<a name="l00296"></a>00296 
<a name="l00297"></a>00297         <span class="comment">/* Respond with an error status to all URBs in the schedule. */</span>
<a name="l00298"></a>00298         <a class="code" href="dwc__otg__hcd_8c.html#63f169b583c3818268def3614ac2fe0a">kill_all_urbs</a>(dwc_otg_hcd);
<a name="l00299"></a>00299 
<a name="l00300"></a>00300         <span class="keywordflow">if</span> (<a class="code" href="dwc__otg__cil_8c.html#f0bfe5f933e21a94ea06c96ffc086e72">dwc_otg_is_host_mode</a>(dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>)) {
<a name="l00301"></a>00301                 <span class="comment">/* Clean up any host channels that were in use. */</span>
<a name="l00302"></a>00302                 <span class="keywordtype">int</span> num_channels;
<a name="l00303"></a>00303                 <span class="keywordtype">int</span> i;
<a name="l00304"></a>00304                 <a class="code" href="structdwc__hc.html">dwc_hc_t</a> *channel;
<a name="l00305"></a>00305                 <a class="code" href="structdwc__otg__hc__regs.html">dwc_otg_hc_regs_t</a> *hc_regs;
<a name="l00306"></a>00306                 <a class="code" href="unionhcchar__data.html">hcchar_data_t</a> hcchar;
<a name="l00307"></a>00307 
<a name="l00308"></a>00308                 num_channels = dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#63ffc9b8e36340bd59bf1fab9ca490ad">core_params</a>-&gt;<a class="code" href="structdwc__otg__core__params.html#c1b433c6965aa7d48f6ca6818c592039">host_channels</a>;
<a name="l00309"></a>00309 
<a name="l00310"></a>00310                 <span class="keywordflow">if</span> (!dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#5ade18c62c5101c603247691d3047a19">dma_enable</a>) {
<a name="l00311"></a>00311                         <span class="comment">/* Flush out any channel requests in slave mode. */</span>
<a name="l00312"></a>00312                         <span class="keywordflow">for</span> (i = 0; i &lt; num_channels; i++) {
<a name="l00313"></a>00313                                 channel = dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#cb393f6a676fb106e0e3d35396fb97f9">hc_ptr_array</a>[i];
<a name="l00314"></a>00314                                 if (DWC_CIRCLEQ_EMPTY_ENTRY
<a name="l00315"></a>00315                                     (channel, hc_list_entry)) {
<a name="l00316"></a>00316                                         hc_regs =
<a name="l00317"></a>00317                                             dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#51bac71891b5f6f435d7fc4582b974c1">host_if</a>-&gt;
<a name="l00318"></a>00318                                             hc_regs[i];
<a name="l00319"></a>00319                                         hcchar.<a class="code" href="unionhcchar__data.html#03d352fb421ab5c11bf9afaae4933ba4">d32</a> =
<a name="l00320"></a>00320                                             dwc_read_reg32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#3d8bdf7979ea6dd5ba01858aca7a1c02">hcchar</a>);
<a name="l00321"></a>00321                                         if (hcchar.<a class="code" href="unionhcchar__data.html#231c3638b02200c477e402d977c31e51">b</a>.<a class="code" href="unionhcchar__data.html#994a5305780edb0c4fe159b6cc7b14ae">chen</a>) {
<a name="l00322"></a>00322                                                 hcchar.<a class="code" href="unionhcchar__data.html#231c3638b02200c477e402d977c31e51">b</a>.<a class="code" href="unionhcchar__data.html#994a5305780edb0c4fe159b6cc7b14ae">chen</a> = 0;
<a name="l00323"></a>00323                                                 hcchar.<a class="code" href="unionhcchar__data.html#231c3638b02200c477e402d977c31e51">b</a>.<a class="code" href="unionhcchar__data.html#73c9f7f3cc4036c72ef341d1d1d9c388">chdis</a> = 1;
<a name="l00324"></a>00324                                                 hcchar.<a class="code" href="unionhcchar__data.html#231c3638b02200c477e402d977c31e51">b</a>.<a class="code" href="unionhcchar__data.html#11f1b16e50f90806f90953bb979d4e77">epdir</a> = 0;
<a name="l00325"></a>00325                                                 dwc_write_reg32(&amp;hc_regs-&gt;
<a name="l00326"></a>00326                                                                 hcchar,
<a name="l00327"></a>00327                                                                 hcchar.<a class="code" href="unionhcchar__data.html#03d352fb421ab5c11bf9afaae4933ba4">d32</a>);
<a name="l00328"></a>00328                                         }
<a name="l00329"></a>00329                                 }
<a name="l00330"></a>00330                         }
<a name="l00331"></a>00331                 }
<a name="l00332"></a>00332 
<a name="l00333"></a>00333                 <span class="keywordflow">for</span> (i = 0; i &lt; num_channels; i++) {
<a name="l00334"></a>00334                         channel = dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#cb393f6a676fb106e0e3d35396fb97f9">hc_ptr_array</a>[i];
<a name="l00335"></a>00335                         if (DWC_CIRCLEQ_EMPTY_ENTRY(channel, hc_list_entry)) {
<a name="l00336"></a>00336                                 hc_regs =
<a name="l00337"></a>00337                                     dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#51bac71891b5f6f435d7fc4582b974c1">host_if</a>-&gt;<a class="code" href="structdwc__otg__host__if.html#7f7c107d4720641eb4141cd817211ac0">hc_regs</a>[i];
<a name="l00338"></a>00338                                 hcchar.<a class="code" href="unionhcchar__data.html#03d352fb421ab5c11bf9afaae4933ba4">d32</a> = dwc_read_reg32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#3d8bdf7979ea6dd5ba01858aca7a1c02">hcchar</a>);
<a name="l00339"></a>00339                                 if (hcchar.<a class="code" href="unionhcchar__data.html#231c3638b02200c477e402d977c31e51">b</a>.<a class="code" href="unionhcchar__data.html#994a5305780edb0c4fe159b6cc7b14ae">chen</a>) {
<a name="l00340"></a>00340                                         <span class="comment">/* Halt the channel. */</span>
<a name="l00341"></a>00341                                         hcchar.<a class="code" href="unionhcchar__data.html#231c3638b02200c477e402d977c31e51">b</a>.<a class="code" href="unionhcchar__data.html#73c9f7f3cc4036c72ef341d1d1d9c388">chdis</a> = 1;
<a name="l00342"></a>00342                                         dwc_write_reg32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#3d8bdf7979ea6dd5ba01858aca7a1c02">hcchar</a>,
<a name="l00343"></a>00343                                                         hcchar.<a class="code" href="unionhcchar__data.html#03d352fb421ab5c11bf9afaae4933ba4">d32</a>);
<a name="l00344"></a>00344                                 }
<a name="l00345"></a>00345 
<a name="l00346"></a>00346                                 <a class="code" href="dwc__otg__cil_8c.html#f05341f811fba7f6183db66faf50a867">dwc_otg_hc_cleanup</a>(dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>,
<a name="l00347"></a>00347                                                    channel);
<a name="l00348"></a>00348                                 DWC_CIRCLEQ_INSERT_TAIL(&amp;dwc_otg_hcd-&gt;
<a name="l00349"></a>00349                                                         <a class="code" href="structdwc__otg__hcd.html#1761f2e6b8f6ba82c0e0c4e561813f0f">free_hc_list</a>, channel,
<a name="l00350"></a>00350                                                         hc_list_entry);
<a name="l00351"></a>00351                                 <span class="comment">/* </span>
<a name="l00352"></a>00352 <span class="comment">                                 * Added for Descriptor DMA to prevent channel double cleanup </span>
<a name="l00353"></a>00353 <span class="comment">                                 * in release_channel_ddma(). Which called from ep_disable</span>
<a name="l00354"></a>00354 <span class="comment">                                 * when device disconnect.</span>
<a name="l00355"></a>00355 <span class="comment">                                 */</span>                     
<a name="l00356"></a>00356                                 channel-&gt;qh = NULL;                     
<a name="l00357"></a>00357                         }
<a name="l00358"></a>00358                 }
<a name="l00359"></a>00359         }
<a name="l00360"></a>00360 
<a name="l00361"></a>00361         <span class="keywordflow">if</span> (<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd</a>-&gt;fops-&gt;disconnect) {
<a name="l00362"></a>00362                 <a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd</a>-&gt;fops-&gt;disconnect(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd</a>);
<a name="l00363"></a>00363         }
<a name="l00364"></a>00364 
<a name="l00365"></a>00365         <span class="keywordflow">return</span> 1;
<a name="l00366"></a>00366 }
<a name="l00367"></a>00367 
<a name="l00373"></a><a class="code" href="dwc__otg__hcd_8c.html#44e479b1c67b62a1887f93afd2106e4a">00373</a> <span class="keyword">static</span> int32_t <a class="code" href="dwc__otg__hcd_8c.html#44e479b1c67b62a1887f93afd2106e4a">dwc_otg_hcd_stop_cb</a>(<span class="keywordtype">void</span> *p)
<a name="l00374"></a>00374 {
<a name="l00375"></a>00375         <a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> *<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd</a> = p;
<a name="l00376"></a>00376 
<a name="l00377"></a>00377         <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#39931d908ba215b3d5d590e42d8408b5">DBG_HCDV</a>, <span class="stringliteral">"%s(%p)\n"</span>, __func__, p);
<a name="l00378"></a>00378         <a class="code" href="dwc__otg__hcd_8c.html#70c58e8a45eb7ad8ee2f2c74ba3a77f0">dwc_otg_hcd_stop</a>(dwc_otg_hcd);
<a name="l00379"></a>00379         <span class="keywordflow">return</span> 1;
<a name="l00380"></a>00380 }
<a name="l00381"></a>00381 
<a name="l00382"></a>00382 <span class="preprocessor">#ifdef CONFIG_USB_DWC_OTG_LPM</span>
<a name="l00383"></a>00383 <span class="preprocessor"></span>
<a name="l00388"></a>00388 <span class="keyword">static</span> <span class="keywordtype">int</span> dwc_otg_hcd_sleep_cb(<span class="keywordtype">void</span> *p)
<a name="l00389"></a>00389 {
<a name="l00390"></a>00390         <a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> *hcd = p;
<a name="l00391"></a>00391 
<a name="l00392"></a>00392         dwc_otg_hcd_free_hc_from_lpm(hcd);
<a name="l00393"></a>00393 
<a name="l00394"></a>00394         <span class="keywordflow">return</span> 0;
<a name="l00395"></a>00395 }
<a name="l00396"></a>00396 <span class="preprocessor">#endif</span>
<a name="l00397"></a>00397 <span class="preprocessor"></span>
<a name="l00403"></a><a class="code" href="dwc__otg__hcd_8c.html#fb35aff10c8837095302575957145f13">00403</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__hcd_8c.html#fb35aff10c8837095302575957145f13">dwc_otg_hcd_rem_wakeup_cb</a>(<span class="keywordtype">void</span> *p)
<a name="l00404"></a>00404 {
<a name="l00405"></a>00405         <a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> *hcd = p;
<a name="l00406"></a>00406 
<a name="l00407"></a>00407         <span class="keywordflow">if</span> (hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#2b0701d814069ec69897e08374366c7b">lx_state</a> == <a class="code" href="dwc__otg__cil_8h.html#8442e49b7c783099ac17bda4f8b3bc3cd1fadb6fa31de73e8176316a0e0ba905">DWC_OTG_L2</a>) {
<a name="l00408"></a>00408                 hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#9aaf2a112f5794f92dedd826342bd637">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#76f573861d9316238ded198c58c228c7">b</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#2a6e323cb4c01153aff1adc6269c74c7">port_suspend_change</a> = 1;
<a name="l00409"></a>00409         }
<a name="l00410"></a>00410 <span class="preprocessor">#ifdef CONFIG_USB_DWC_OTG_LPM</span>
<a name="l00411"></a>00411 <span class="preprocessor"></span>        <span class="keywordflow">else</span> {
<a name="l00412"></a>00412                 hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#9aaf2a112f5794f92dedd826342bd637">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#76f573861d9316238ded198c58c228c7">b</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#1900375ccea165f0efc40725f507a0bf">port_l1_change</a> = 1;
<a name="l00413"></a>00413         }
<a name="l00414"></a>00414 <span class="preprocessor">#endif</span>
<a name="l00415"></a>00415 <span class="preprocessor"></span>        <span class="keywordflow">return</span> 0;
<a name="l00416"></a>00416 }
<a name="l00417"></a>00417 
<a name="l00422"></a><a class="code" href="dwc__otg__hcd__if_8h.html#70c58e8a45eb7ad8ee2f2c74ba3a77f0">00422</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__hcd_8c.html#70c58e8a45eb7ad8ee2f2c74ba3a77f0">dwc_otg_hcd_stop</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd)
<a name="l00423"></a>00423 {
<a name="l00424"></a>00424         <a class="code" href="unionhprt0__data.html">hprt0_data_t</a> hprt0 = {.d32 = 0 };
<a name="l00425"></a>00425 
<a name="l00426"></a>00426         <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#e4a050e176c1c4f556da2b276a8c2b37">DBG_HCD</a>, <span class="stringliteral">"DWC OTG HCD STOP\n"</span>);
<a name="l00427"></a>00427 
<a name="l00428"></a>00428         <span class="comment">/*</span>
<a name="l00429"></a>00429 <span class="comment">         * The root hub should be disconnected before this function is called.</span>
<a name="l00430"></a>00430 <span class="comment">         * The disconnect will clear the QTD lists (via ..._hcd_urb_dequeue)</span>
<a name="l00431"></a>00431 <span class="comment">         * and the QH lists (via ..._hcd_endpoint_disable).</span>
<a name="l00432"></a>00432 <span class="comment">         */</span>
<a name="l00433"></a>00433 
<a name="l00434"></a>00434         <span class="comment">/* Turn off all host-specific interrupts. */</span>
<a name="l00435"></a>00435         <a class="code" href="dwc__otg__cil_8c.html#4dd4a30dd75a819e9da38d6410cbb0a4">dwc_otg_disable_host_interrupts</a>(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>);
<a name="l00436"></a>00436 
<a name="l00437"></a>00437         <span class="comment">/* Turn off the vbus power */</span>
<a name="l00438"></a>00438         DWC_PRINTF(<span class="stringliteral">"PortPower off\n"</span>);
<a name="l00439"></a>00439         hprt0.<a class="code" href="unionhprt0__data.html#08cd86ce6da6462fc53601db7e2b73f3">b</a>.<a class="code" href="unionhprt0__data.html#010bd8fb208ef4eeaa288b28f8f8c3a4">prtpwr</a> = 0;
<a name="l00440"></a>00440         dwc_write_reg32(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#51bac71891b5f6f435d7fc4582b974c1">host_if</a>-&gt;<a class="code" href="structdwc__otg__host__if.html#dc8fe33e0bb3829cafa884d5fc603c4d">hprt0</a>, hprt0.<a class="code" href="unionhprt0__data.html#88e9271f697d2ec209fc6a6da67fe216">d32</a>);
<a name="l00441"></a>00441         dwc_mdelay(1);
<a name="l00442"></a>00442 }
<a name="l00443"></a>00443 
<a name="l00444"></a><a class="code" href="dwc__otg__hcd__if_8h.html#e8db09c826a847ffbaf7a5e7a60b697c">00444</a> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__hcd_8c.html#e8129fbc0a4073f0a5f64fa3b0f5127b">dwc_otg_hcd_urb_enqueue</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd,
<a name="l00445"></a>00445                             <a class="code" href="structdwc__otg__hcd__urb.html">dwc_otg_hcd_urb_t</a> * dwc_otg_urb, <span class="keywordtype">void</span> **ep_handle)
<a name="l00446"></a>00446 {
<a name="l00447"></a>00447         uint64_t <a class="code" href="structdwc__otg__hcd.html#9aaf2a112f5794f92dedd826342bd637">flags</a>;
<a name="l00448"></a>00448         <span class="keywordtype">int</span> retval = 0;
<a name="l00449"></a>00449         <a class="code" href="structdwc__otg__qtd.html">dwc_otg_qtd_t</a> *qtd;
<a name="l00450"></a>00450 
<a name="l00451"></a>00451         <span class="keywordflow">if</span> (!hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#9aaf2a112f5794f92dedd826342bd637">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#76f573861d9316238ded198c58c228c7">b</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#9314ac02ed140807687793b512f78c63">port_connect_status</a>) {
<a name="l00452"></a>00452                 <span class="comment">/* No longer connected. */</span>
<a name="l00453"></a>00453                 <span class="keywordflow">return</span> -DWC_E_NO_DEVICE;
<a name="l00454"></a>00454         }
<a name="l00455"></a>00455 
<a name="l00456"></a>00456         qtd = <a class="code" href="dwc__otg__hcd_8h.html#5c4da8822ae027f70eda33cb783644fc">dwc_otg_hcd_qtd_create</a>(dwc_otg_urb);
<a name="l00457"></a>00457         <span class="keywordflow">if</span> (qtd == NULL) {
<a name="l00458"></a>00458                 DWC_ERROR(<span class="stringliteral">"DWC OTG HCD URB Enqueue failed creating QTD\n"</span>);
<a name="l00459"></a>00459                 <span class="keywordflow">return</span> -DWC_E_NO_MEMORY;
<a name="l00460"></a>00460         }
<a name="l00461"></a>00461 
<a name="l00462"></a>00462         retval =
<a name="l00463"></a>00463             <a class="code" href="dwc__otg__hcd_8h.html#748ba77769387bfe4295cb10265053f0">dwc_otg_hcd_qtd_add</a>(qtd, hcd, (<a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a> **) ep_handle);
<a name="l00464"></a>00464         <span class="keywordflow">if</span> (retval &lt; 0) {
<a name="l00465"></a>00465                 DWC_ERROR(<span class="stringliteral">"DWC OTG HCD URB Enqueue failed adding QTD. "</span>
<a name="l00466"></a>00466                           <span class="stringliteral">"Error status %d\n"</span>, retval);
<a name="l00467"></a>00467                 <a class="code" href="dwc__otg__hcd_8h.html#34434d836361462c04fb45ba9ab89fb9">dwc_otg_hcd_qtd_free</a>(qtd);
<a name="l00468"></a>00468         } <span class="keywordflow">else</span> {
<a name="l00469"></a>00469                 qtd-&gt;<a class="code" href="structdwc__otg__qtd.html#f80ddcfb6edbe83a3991dd67c93a47e4">qh</a> = *ep_handle;
<a name="l00470"></a>00470         }
<a name="l00471"></a>00471         
<a name="l00472"></a>00472         <span class="keywordflow">if</span> (hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#7e3b96c6167eceeeb1090798f8297f1f">dma_desc_enable</a> &amp;&amp; retval == 0) {
<a name="l00473"></a>00473                 <a class="code" href="dwc__otg__hcd_8h.html#92c49783eebc5bcffa8b8a51c2127be9">dwc_otg_transaction_type_e</a> tr_type;     
<a name="l00474"></a>00474                 <span class="keywordflow">if</span> ((qtd-&gt;<a class="code" href="structdwc__otg__qtd.html#f80ddcfb6edbe83a3991dd67c93a47e4">qh</a>-&gt;<a class="code" href="structdwc__otg__qh.html#98b78ffd8dbc01be44b302e873e73a82">ep_type</a> == UE_BULK) &amp;&amp; !(qtd-&gt;<a class="code" href="structdwc__otg__qtd.html#7e7767808e8eb9d71de0db00f57553f9">urb</a>-&gt;<a class="code" href="structdwc__otg__hcd__urb.html#2f1d90765496d78d297b3e57ef4d781c">flags</a> &amp; <a class="code" href="dwc__otg__hcd__if_8h.html#973a9deb7ee08e99abf7cb7adf6a5c72">URB_GIVEBACK_ASAP</a>)) {
<a name="l00475"></a>00475                         <span class="comment">/* Do not schedule SG transcations until qtd has URB_GIVEBACK_ASAP set */</span>
<a name="l00476"></a>00476                         <span class="keywordflow">return</span> 0;
<a name="l00477"></a>00477                 }
<a name="l00478"></a>00478                 DWC_SPINLOCK_IRQSAVE(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#34f29e9c035009476495f7701c1813fd">lock</a>, &amp;flags);
<a name="l00479"></a>00479                 tr_type = <a class="code" href="dwc__otg__hcd_8c.html#96cc299f4f0478187ed7ba49b975ffc3">dwc_otg_hcd_select_transactions</a>(hcd);
<a name="l00480"></a>00480                 <span class="keywordflow">if</span> (tr_type != DWC_OTG_TRANSACTION_NONE) {
<a name="l00481"></a>00481                         <a class="code" href="dwc__otg__hcd_8c.html#2f57bf2fc3013d63101f112702b913a0">dwc_otg_hcd_queue_transactions</a>(hcd, tr_type);
<a name="l00482"></a>00482                 }
<a name="l00483"></a>00483                 DWC_SPINUNLOCK_IRQRESTORE(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#34f29e9c035009476495f7701c1813fd">lock</a>, flags);
<a name="l00484"></a>00484         }
<a name="l00485"></a>00485 
<a name="l00486"></a>00486         <span class="keywordflow">return</span> retval;
<a name="l00487"></a>00487 }
<a name="l00488"></a>00488 
<a name="l00489"></a><a class="code" href="dwc__otg__hcd__if_8h.html#e7377ee6d5cdb17a4213cc96bf534a23">00489</a> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__hcd_8c.html#8844d0e14480b7f0dcf5c8120cc20a4f">dwc_otg_hcd_urb_dequeue</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd,
<a name="l00490"></a>00490                             <a class="code" href="structdwc__otg__hcd__urb.html">dwc_otg_hcd_urb_t</a> * dwc_otg_urb)
<a name="l00491"></a>00491 {
<a name="l00492"></a>00492         uint64_t <a class="code" href="structdwc__otg__hcd.html#9aaf2a112f5794f92dedd826342bd637">flags</a>;
<a name="l00493"></a>00493 
<a name="l00494"></a>00494         <a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a> *qh;
<a name="l00495"></a>00495         <a class="code" href="structdwc__otg__qtd.html">dwc_otg_qtd_t</a> *urb_qtd;
<a name="l00496"></a>00496 
<a name="l00497"></a>00497         DWC_SPINLOCK_IRQSAVE(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#34f29e9c035009476495f7701c1813fd">lock</a>, &amp;flags);
<a name="l00498"></a>00498         
<a name="l00499"></a>00499         urb_qtd = dwc_otg_urb-&gt;<a class="code" href="structdwc__otg__hcd__urb.html#68dc4d459bb70aed6083553653aadaad">qtd</a>;
<a name="l00500"></a>00500         qh = urb_qtd-&gt;<a class="code" href="structdwc__otg__qtd.html#f80ddcfb6edbe83a3991dd67c93a47e4">qh</a>;
<a name="l00501"></a>00501 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l00502"></a>00502 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="dwc__otg__dbg_8h.html#7a96217c88a4d786f6cb3d4df09dee04">CHK_DEBUG_LEVEL</a>(<a class="code" href="dwc__otg__dbg_8h.html#39931d908ba215b3d5d590e42d8408b5">DBG_HCDV</a> | <a class="code" href="dwc__otg__dbg_8h.html#737e22e02729647d12db8e3059ad06c9">DBG_HCD_URB</a>)) {
<a name="l00503"></a>00503                 <span class="keywordflow">if</span> (urb_qtd-&gt;<a class="code" href="structdwc__otg__qtd.html#c1d73f1d48eeabbdc198ad28c0882bc1">in_process</a>) {
<a name="l00504"></a>00504                         dump_channel_info(hcd, qh);
<a name="l00505"></a>00505                 }
<a name="l00506"></a>00506         }
<a name="l00507"></a>00507 <span class="preprocessor">#endif</span>
<a name="l00508"></a>00508 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (urb_qtd-&gt;<a class="code" href="structdwc__otg__qtd.html#c1d73f1d48eeabbdc198ad28c0882bc1">in_process</a> &amp;&amp; qh-&gt;<a class="code" href="structdwc__otg__qh.html#bbdb7d30b60b6c326301f33b35088bb4">channel</a>) {
<a name="l00509"></a>00509                 <span class="comment">/* The QTD is in process (it has been assigned to a channel). */</span>
<a name="l00510"></a>00510                 <span class="keywordflow">if</span> (hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#9aaf2a112f5794f92dedd826342bd637">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#76f573861d9316238ded198c58c228c7">b</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#9314ac02ed140807687793b512f78c63">port_connect_status</a>) {
<a name="l00511"></a>00511                         <span class="comment">/*</span>
<a name="l00512"></a>00512 <span class="comment">                         * If still connected (i.e. in host mode), halt the</span>
<a name="l00513"></a>00513 <span class="comment">                         * channel so it can be used for other transfers. If</span>
<a name="l00514"></a>00514 <span class="comment">                         * no longer connected, the host registers can't be</span>
<a name="l00515"></a>00515 <span class="comment">                         * written to halt the channel since the core is in</span>
<a name="l00516"></a>00516 <span class="comment">                         * device mode.</span>
<a name="l00517"></a>00517 <span class="comment">                         */</span>
<a name="l00518"></a>00518                         <a class="code" href="dwc__otg__cil_8c.html#de044bf6b96c1bac92259a447ae85c0f">dwc_otg_hc_halt</a>(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>, qh-&gt;<a class="code" href="structdwc__otg__qh.html#bbdb7d30b60b6c326301f33b35088bb4">channel</a>,
<a name="l00519"></a>00519                                         DWC_OTG_HC_XFER_URB_DEQUEUE);
<a name="l00520"></a>00520                 }
<a name="l00521"></a>00521         }
<a name="l00522"></a>00522 
<a name="l00523"></a>00523         <span class="comment">/*</span>
<a name="l00524"></a>00524 <span class="comment">         * Free the QTD and clean up the associated QH. Leave the QH in the</span>
<a name="l00525"></a>00525 <span class="comment">         * schedule if it has any remaining QTDs.</span>
<a name="l00526"></a>00526 <span class="comment">         */</span>
<a name="l00527"></a>00527          
<a name="l00528"></a>00528         <span class="keywordflow">if</span> (!hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#7e3b96c6167eceeeb1090798f8297f1f">dma_desc_enable</a>) {
<a name="l00529"></a>00529                 uint8_t b = urb_qtd-&gt;<a class="code" href="structdwc__otg__qtd.html#c1d73f1d48eeabbdc198ad28c0882bc1">in_process</a>;        
<a name="l00530"></a>00530                 <a class="code" href="dwc__otg__hcd_8h.html#19adb6641f95448a956015b2d69ba96a">dwc_otg_hcd_qtd_remove_and_free</a>(hcd, urb_qtd, qh);
<a name="l00531"></a>00531                 <span class="keywordflow">if</span> (b) {
<a name="l00532"></a>00532                         <a class="code" href="dwc__otg__hcd_8h.html#f88bc5b6beb674c909d1c09a819ba9d9">dwc_otg_hcd_qh_deactivate</a>(hcd, qh, 0);
<a name="l00533"></a>00533                         qh-&gt;<a class="code" href="structdwc__otg__qh.html#bbdb7d30b60b6c326301f33b35088bb4">channel</a> = NULL;
<a name="l00534"></a>00534                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (DWC_CIRCLEQ_EMPTY(&amp;qh-&gt;<a class="code" href="structdwc__otg__qh.html#9567d266da8e796d3467fb16ae867f8e">qtd_list</a>)) {
<a name="l00535"></a>00535                         <a class="code" href="dwc__otg__hcd_8h.html#506b89b01ee7692885daff1c17c894f8">dwc_otg_hcd_qh_remove</a>(hcd, qh);
<a name="l00536"></a>00536                 }
<a name="l00537"></a>00537         }
<a name="l00538"></a>00538         <span class="keywordflow">else</span> {
<a name="l00539"></a>00539                 <a class="code" href="dwc__otg__hcd_8h.html#19adb6641f95448a956015b2d69ba96a">dwc_otg_hcd_qtd_remove_and_free</a>(hcd, urb_qtd, qh);
<a name="l00540"></a>00540         }
<a name="l00541"></a>00541         
<a name="l00542"></a>00542         DWC_SPINUNLOCK_IRQRESTORE(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#34f29e9c035009476495f7701c1813fd">lock</a>, flags);
<a name="l00543"></a>00543 
<a name="l00544"></a>00544         <span class="keywordflow">return</span> 0;
<a name="l00545"></a>00545 }
<a name="l00546"></a>00546 
<a name="l00547"></a><a class="code" href="dwc__otg__hcd__if_8h.html#f80e9550161e354c865e3c411d661dbe">00547</a> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__hcd_8c.html#f80e9550161e354c865e3c411d661dbe">dwc_otg_hcd_endpoint_disable</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd, <span class="keywordtype">void</span> *ep_handle,
<a name="l00548"></a>00548                                  <span class="keywordtype">int</span> retry)
<a name="l00549"></a>00549 {
<a name="l00550"></a>00550         <a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a> *qh = (<a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a> *) ep_handle;
<a name="l00551"></a>00551         <span class="keywordtype">int</span> retval = 0;
<a name="l00552"></a>00552         uint64_t <a class="code" href="structdwc__otg__hcd.html#9aaf2a112f5794f92dedd826342bd637">flags</a>;
<a name="l00553"></a>00553 
<a name="l00554"></a>00554         <span class="keywordflow">if</span> (retry &lt; 0) {
<a name="l00555"></a>00555                 retval = -DWC_E_INVALID;
<a name="l00556"></a>00556                 <span class="keywordflow">goto</span> done;
<a name="l00557"></a>00557         }
<a name="l00558"></a>00558 
<a name="l00559"></a>00559         <span class="keywordflow">if</span> (!qh) {
<a name="l00560"></a>00560                 <span class="keywordflow">goto</span> done;
<a name="l00561"></a>00561         }
<a name="l00562"></a>00562 
<a name="l00563"></a>00563         DWC_SPINLOCK_IRQSAVE(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#34f29e9c035009476495f7701c1813fd">lock</a>, &amp;flags);
<a name="l00564"></a>00564         
<a name="l00565"></a>00565         <span class="keywordflow">while</span> (!DWC_CIRCLEQ_EMPTY(&amp;qh-&gt;<a class="code" href="structdwc__otg__qh.html#9567d266da8e796d3467fb16ae867f8e">qtd_list</a>) &amp;&amp; retry) {
<a name="l00566"></a>00566                 DWC_SPINUNLOCK_IRQRESTORE(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#34f29e9c035009476495f7701c1813fd">lock</a>, flags);
<a name="l00567"></a>00567                 retry--;
<a name="l00568"></a>00568                 dwc_msleep(5);
<a name="l00569"></a>00569                 DWC_SPINLOCK_IRQSAVE(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#34f29e9c035009476495f7701c1813fd">lock</a>, &amp;flags);
<a name="l00570"></a>00570         }
<a name="l00571"></a>00571 
<a name="l00572"></a>00572         <a class="code" href="dwc__otg__hcd_8h.html#506b89b01ee7692885daff1c17c894f8">dwc_otg_hcd_qh_remove</a>(hcd, qh);
<a name="l00573"></a>00573         
<a name="l00574"></a>00574         DWC_SPINUNLOCK_IRQRESTORE(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#34f29e9c035009476495f7701c1813fd">lock</a>, flags);
<a name="l00575"></a>00575         <span class="comment">/* </span>
<a name="l00576"></a>00576 <span class="comment">         * Split dwc_otg_hcd_qh_remove_and_free() into qh_remove </span>
<a name="l00577"></a>00577 <span class="comment">         * and qh_free to prevent stack dump on dwc_dma_free() with </span>
<a name="l00578"></a>00578 <span class="comment">         * irq_disabled (spinlock_irqsave) in dwc_otg_hcd_desc_list_free() </span>
<a name="l00579"></a>00579 <span class="comment">         * and dwc_otg_hcd_frame_list_alloc().</span>
<a name="l00580"></a>00580 <span class="comment">         */</span>
<a name="l00581"></a>00581         <a class="code" href="dwc__otg__hcd_8h.html#1ac731c0691ac3851edddc558fae79e0">dwc_otg_hcd_qh_free</a>(hcd, qh);
<a name="l00582"></a>00582 
<a name="l00583"></a>00583       done:
<a name="l00584"></a>00584         <span class="keywordflow">return</span> retval;
<a name="l00585"></a>00585 }
<a name="l00586"></a>00586 
<a name="l00590"></a><a class="code" href="dwc__otg__hcd_8c.html#106ff6cbb1499325ea75f2d97abb8e6a">00590</a> <span class="keyword">static</span> <a class="code" href="structdwc__otg__cil__callbacks.html">dwc_otg_cil_callbacks_t</a> <a class="code" href="dwc__otg__hcd_8c.html#106ff6cbb1499325ea75f2d97abb8e6a">hcd_cil_callbacks</a> = {
<a name="l00591"></a>00591         .<a class="code" href="structdwc__otg__cil__callbacks.html#ebb662b2e0b4d187648b7f91b9d00713">start</a> = <a class="code" href="dwc__otg__hcd_8c.html#1aaeb9f41b201877f86a17d617b828d2">dwc_otg_hcd_start_cb</a>,
<a name="l00592"></a>00592         .stop = <a class="code" href="dwc__otg__hcd_8c.html#44e479b1c67b62a1887f93afd2106e4a">dwc_otg_hcd_stop_cb</a>,
<a name="l00593"></a>00593         .disconnect = <a class="code" href="dwc__otg__hcd_8c.html#2af30c3c78408325b26e3431b2442055">dwc_otg_hcd_disconnect_cb</a>,
<a name="l00594"></a>00594         .session_start = <a class="code" href="dwc__otg__hcd_8c.html#a0deab93f6ca3bcfcab0085b2bf86113">dwc_otg_hcd_session_start_cb</a>,
<a name="l00595"></a>00595         .resume_wakeup = <a class="code" href="dwc__otg__hcd_8c.html#fb35aff10c8837095302575957145f13">dwc_otg_hcd_rem_wakeup_cb</a>,
<a name="l00596"></a>00596 <span class="preprocessor">#ifdef CONFIG_USB_DWC_OTG_LPM</span>
<a name="l00597"></a>00597 <span class="preprocessor"></span>        .sleep = dwc_otg_hcd_sleep_cb,
<a name="l00598"></a>00598 <span class="preprocessor">#endif</span>
<a name="l00599"></a>00599 <span class="preprocessor"></span>        .p = 0,
<a name="l00600"></a>00600 };
<a name="l00601"></a>00601 
<a name="l00605"></a><a class="code" href="dwc__otg__hcd_8c.html#ed4640393d701e9bbfd966d4006a60b8">00605</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__hcd_8c.html#ed4640393d701e9bbfd966d4006a60b8">reset_tasklet_func</a>(<span class="keywordtype">void</span> *data)
<a name="l00606"></a>00606 {
<a name="l00607"></a>00607         <a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> *<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd</a> = (<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> *) data;
<a name="l00608"></a>00608         <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a> = dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>;
<a name="l00609"></a>00609         <a class="code" href="unionhprt0__data.html">hprt0_data_t</a> hprt0;
<a name="l00610"></a>00610 
<a name="l00611"></a>00611         <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#39931d908ba215b3d5d590e42d8408b5">DBG_HCDV</a>, <span class="stringliteral">"USB RESET tasklet called\n"</span>);
<a name="l00612"></a>00612 
<a name="l00613"></a>00613         hprt0.<a class="code" href="unionhprt0__data.html#88e9271f697d2ec209fc6a6da67fe216">d32</a> = <a class="code" href="dwc__otg__cil_8h.html#ce67da6af4023cffd25333d20992438e">dwc_otg_read_hprt0</a>(<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>);
<a name="l00614"></a>00614         hprt0.<a class="code" href="unionhprt0__data.html#08cd86ce6da6462fc53601db7e2b73f3">b</a>.<a class="code" href="unionhprt0__data.html#714a31048710164370292124795a9a9b">prtrst</a> = 1;
<a name="l00615"></a>00615         dwc_write_reg32(<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#51bac71891b5f6f435d7fc4582b974c1">host_if</a>-&gt;<a class="code" href="structdwc__otg__host__if.html#dc8fe33e0bb3829cafa884d5fc603c4d">hprt0</a>, hprt0.<a class="code" href="unionhprt0__data.html#88e9271f697d2ec209fc6a6da67fe216">d32</a>);
<a name="l00616"></a>00616         dwc_mdelay(60);
<a name="l00617"></a>00617 
<a name="l00618"></a>00618         hprt0.<a class="code" href="unionhprt0__data.html#08cd86ce6da6462fc53601db7e2b73f3">b</a>.<a class="code" href="unionhprt0__data.html#714a31048710164370292124795a9a9b">prtrst</a> = 0;
<a name="l00619"></a>00619         dwc_write_reg32(<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#51bac71891b5f6f435d7fc4582b974c1">host_if</a>-&gt;<a class="code" href="structdwc__otg__host__if.html#dc8fe33e0bb3829cafa884d5fc603c4d">hprt0</a>, hprt0.<a class="code" href="unionhprt0__data.html#88e9271f697d2ec209fc6a6da67fe216">d32</a>);
<a name="l00620"></a>00620         dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#9aaf2a112f5794f92dedd826342bd637">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#76f573861d9316238ded198c58c228c7">b</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#d0d63f32ed35315e8a02549521fb386e">port_reset_change</a> = 1;
<a name="l00621"></a>00621 }
<a name="l00622"></a>00622 
<a name="l00623"></a><a class="code" href="dwc__otg__hcd_8c.html#d76881c1efea1a13be74ecfde85b4881">00623</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__hcd_8c.html#d76881c1efea1a13be74ecfde85b4881">qh_list_free</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd, dwc_list_link_t * qh_list)
<a name="l00624"></a>00624 {
<a name="l00625"></a>00625         dwc_list_link_t *item;
<a name="l00626"></a>00626         <a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a> *qh;
<a name="l00627"></a>00627 
<a name="l00628"></a>00628         <span class="keywordflow">if</span> (!qh_list-&gt;next) {
<a name="l00629"></a>00629                 <span class="comment">/* The list hasn't been initialized yet. */</span>
<a name="l00630"></a>00630                 <span class="keywordflow">return</span>;
<a name="l00631"></a>00631         }
<a name="l00632"></a>00632 
<a name="l00633"></a>00633         <span class="comment">/* Ensure there are no QTDs or URBs left. */</span>
<a name="l00634"></a>00634         <a class="code" href="dwc__otg__hcd_8c.html#8fd9263ed86449c5440edd834cb4d766">kill_urbs_in_qh_list</a>(hcd, qh_list);
<a name="l00635"></a>00635 
<a name="l00636"></a>00636         DWC_LIST_FOREACH(item, qh_list) {
<a name="l00637"></a>00637                 qh = DWC_LIST_ENTRY(item, <a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a>, qh_list_entry);
<a name="l00638"></a>00638                 <a class="code" href="dwc__otg__hcd_8h.html#64eb3490186ebd94fd8204d74c089a51">dwc_otg_hcd_qh_remove_and_free</a>(hcd, qh);
<a name="l00639"></a>00639         }
<a name="l00640"></a>00640 }
<a name="l00641"></a>00641 
<a name="l00646"></a><a class="code" href="dwc__otg__hcd_8c.html#7ee877a9be0c15bacbb92a7babb116d0">00646</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__hcd_8c.html#7ee877a9be0c15bacbb92a7babb116d0">dwc_otg_hcd_free</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * <a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd</a>)
<a name="l00647"></a>00647 {
<a name="l00648"></a>00648         <span class="keywordtype">int</span> i;
<a name="l00649"></a>00649 
<a name="l00650"></a>00650         <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#e4a050e176c1c4f556da2b276a8c2b37">DBG_HCD</a>, <span class="stringliteral">"DWC OTG HCD FREE\n"</span>);
<a name="l00651"></a>00651 
<a name="l00652"></a>00652         <a class="code" href="dwc__otg__hcd_8c.html#939a9c8afc75cbe47625e392a7c66a1a">del_timers</a>(dwc_otg_hcd);
<a name="l00653"></a>00653 
<a name="l00654"></a>00654         <span class="comment">/* Free memory for QH/QTD lists */</span>
<a name="l00655"></a>00655         <a class="code" href="dwc__otg__hcd_8c.html#d76881c1efea1a13be74ecfde85b4881">qh_list_free</a>(dwc_otg_hcd, &amp;dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#64c96c47a36d71bad6e4360cec9d07ad">non_periodic_sched_inactive</a>);
<a name="l00656"></a>00656         <a class="code" href="dwc__otg__hcd_8c.html#d76881c1efea1a13be74ecfde85b4881">qh_list_free</a>(dwc_otg_hcd, &amp;dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#ffa3041ad517da9519aa2159cdec3f61">non_periodic_sched_active</a>);
<a name="l00657"></a>00657         <a class="code" href="dwc__otg__hcd_8c.html#d76881c1efea1a13be74ecfde85b4881">qh_list_free</a>(dwc_otg_hcd, &amp;dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#2a747cacd6bdbacbef86d4157c34a312">periodic_sched_inactive</a>);
<a name="l00658"></a>00658         <a class="code" href="dwc__otg__hcd_8c.html#d76881c1efea1a13be74ecfde85b4881">qh_list_free</a>(dwc_otg_hcd, &amp;dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#74b089e094911a558f7b5f24681d3242">periodic_sched_ready</a>);
<a name="l00659"></a>00659         <a class="code" href="dwc__otg__hcd_8c.html#d76881c1efea1a13be74ecfde85b4881">qh_list_free</a>(dwc_otg_hcd, &amp;dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#4b8deae798f771135c4a99693b26873f">periodic_sched_assigned</a>);
<a name="l00660"></a>00660         <a class="code" href="dwc__otg__hcd_8c.html#d76881c1efea1a13be74ecfde85b4881">qh_list_free</a>(dwc_otg_hcd, &amp;dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e127912880eb487b3a2f38778c0de238">periodic_sched_queued</a>);
<a name="l00661"></a>00661 
<a name="l00662"></a>00662         <span class="comment">/* Free memory for the host channels. */</span>
<a name="l00663"></a>00663         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="dwc__otg__core__if_8h.html#bfb88b45545f7685f668ac2f545674ec">MAX_EPS_CHANNELS</a>; i++) {
<a name="l00664"></a>00664                 <a class="code" href="structdwc__hc.html">dwc_hc_t</a> *hc = dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#cb393f6a676fb106e0e3d35396fb97f9">hc_ptr_array</a>[i];
<a name="l00665"></a>00665 
<a name="l00666"></a>00666 #ifdef DEBUG
<a name="l00667"></a>00667                 if (dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;hc_xfer_timer[i]) {
<a name="l00668"></a>00668                         DWC_TIMER_FREE(dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;hc_xfer_timer[i]);
<a name="l00669"></a>00669                 }
<a name="l00670"></a>00670 <span class="preprocessor">#endif</span>
<a name="l00671"></a>00671 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (hc != NULL) {
<a name="l00672"></a>00672                         <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#39931d908ba215b3d5d590e42d8408b5">DBG_HCDV</a>, <span class="stringliteral">"HCD Free channel #%i, hc=%p\n"</span>,
<a name="l00673"></a>00673                                     i, hc);
<a name="l00674"></a>00674                         dwc_free(hc);
<a name="l00675"></a>00675                 }
<a name="l00676"></a>00676         }
<a name="l00677"></a>00677 
<a name="l00678"></a>00678         <span class="keywordflow">if</span> (<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd</a>-&gt;core_if-&gt;dma_enable) {
<a name="l00679"></a>00679                 <span class="keywordflow">if</span> (<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd</a>-&gt;status_buf_dma) {
<a name="l00680"></a>00680                         dwc_dma_free(<a class="code" href="dwc__otg__hcd_8h.html#d8ae8e24a91bb0b076390e96a8abee18">DWC_OTG_HCD_STATUS_BUF_SIZE</a>,
<a name="l00681"></a>00681                                      <a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd</a>-&gt;status_buf,
<a name="l00682"></a>00682                                      <a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd</a>-&gt;status_buf_dma);
<a name="l00683"></a>00683                 }
<a name="l00684"></a>00684         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd</a>-&gt;status_buf != NULL) {
<a name="l00685"></a>00685                 dwc_free(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd</a>-&gt;status_buf);
<a name="l00686"></a>00686         }
<a name="l00687"></a>00687         DWC_SPINLOCK_FREE(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd</a>-&gt;lock);
<a name="l00688"></a>00688         DWC_TIMER_FREE(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd</a>-&gt;conn_timer);
<a name="l00689"></a>00689         DWC_TASK_FREE(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd</a>-&gt;reset_tasklet);
<a name="l00690"></a>00690         dwc_free(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd</a>);
<a name="l00691"></a>00691 }
<a name="l00692"></a>00692 
<a name="l00693"></a><a class="code" href="dwc__otg__hcd__if_8h.html#2d38590dadee51fd767d63e0dc675f23">00693</a> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__hcd_8c.html#2d38590dadee51fd767d63e0dc675f23">dwc_otg_hcd_init</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd, <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> * <a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>)
<a name="l00694"></a>00694 {
<a name="l00695"></a>00695         <span class="keywordtype">int</span> retval = 0;
<a name="l00696"></a>00696         <span class="keywordtype">int</span> num_channels;
<a name="l00697"></a>00697         <span class="keywordtype">int</span> i;
<a name="l00698"></a>00698         <a class="code" href="structdwc__hc.html">dwc_hc_t</a> *channel;
<a name="l00699"></a>00699 
<a name="l00700"></a>00700         hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#34f29e9c035009476495f7701c1813fd">lock</a> = DWC_SPINLOCK_ALLOC();
<a name="l00701"></a>00701 
<a name="l00702"></a>00702         hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a> = <a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>;
<a name="l00703"></a>00703         <span class="comment">/* Register the HCD CIL Callbacks */</span>
<a name="l00704"></a>00704         <a class="code" href="dwc__otg__cil_8c.html#97c9b9d68211477e486848203def0d0f">dwc_otg_cil_register_hcd_callbacks</a>(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>,
<a name="l00705"></a>00705                                            &amp;<a class="code" href="dwc__otg__hcd_8c.html#106ff6cbb1499325ea75f2d97abb8e6a">hcd_cil_callbacks</a>, hcd);
<a name="l00706"></a>00706 
<a name="l00707"></a>00707         <span class="comment">/* Initialize the non-periodic schedule. */</span>
<a name="l00708"></a>00708         DWC_LIST_INIT(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#64c96c47a36d71bad6e4360cec9d07ad">non_periodic_sched_inactive</a>);
<a name="l00709"></a>00709         DWC_LIST_INIT(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#ffa3041ad517da9519aa2159cdec3f61">non_periodic_sched_active</a>);
<a name="l00710"></a>00710 
<a name="l00711"></a>00711         <span class="comment">/* Initialize the periodic schedule. */</span>
<a name="l00712"></a>00712         DWC_LIST_INIT(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#2a747cacd6bdbacbef86d4157c34a312">periodic_sched_inactive</a>);
<a name="l00713"></a>00713         DWC_LIST_INIT(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#74b089e094911a558f7b5f24681d3242">periodic_sched_ready</a>);
<a name="l00714"></a>00714         DWC_LIST_INIT(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#4b8deae798f771135c4a99693b26873f">periodic_sched_assigned</a>);
<a name="l00715"></a>00715         DWC_LIST_INIT(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e127912880eb487b3a2f38778c0de238">periodic_sched_queued</a>);
<a name="l00716"></a>00716 
<a name="l00717"></a>00717         <span class="comment">/*</span>
<a name="l00718"></a>00718 <span class="comment">         * Create a host channel descriptor for each host channel implemented</span>
<a name="l00719"></a>00719 <span class="comment">         * in the controller. Initialize the channel descriptor array.</span>
<a name="l00720"></a>00720 <span class="comment">         */</span>
<a name="l00721"></a>00721         DWC_CIRCLEQ_INIT(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#1761f2e6b8f6ba82c0e0c4e561813f0f">free_hc_list</a>);
<a name="l00722"></a>00722         num_channels = hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#63ffc9b8e36340bd59bf1fab9ca490ad">core_params</a>-&gt;<a class="code" href="structdwc__otg__core__params.html#c1b433c6965aa7d48f6ca6818c592039">host_channels</a>;
<a name="l00723"></a>00723         DWC_MEMSET(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#cb393f6a676fb106e0e3d35396fb97f9">hc_ptr_array</a>, 0, <span class="keyword">sizeof</span>(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#cb393f6a676fb106e0e3d35396fb97f9">hc_ptr_array</a>));
<a name="l00724"></a>00724         <span class="keywordflow">for</span> (i = 0; i &lt; num_channels; i++) {
<a name="l00725"></a>00725                 channel = dwc_alloc(<span class="keyword">sizeof</span>(<a class="code" href="structdwc__hc.html">dwc_hc_t</a>));
<a name="l00726"></a>00726                 <span class="keywordflow">if</span> (channel == NULL) {
<a name="l00727"></a>00727                         retval = -DWC_E_NO_MEMORY;
<a name="l00728"></a>00728                         DWC_ERROR(<span class="stringliteral">"%s: host channel allocation failed\n"</span>,
<a name="l00729"></a>00729                                   __func__);
<a name="l00730"></a>00730                         <a class="code" href="dwc__otg__hcd_8c.html#7ee877a9be0c15bacbb92a7babb116d0">dwc_otg_hcd_free</a>(hcd);
<a name="l00731"></a>00731                         <span class="keywordflow">goto</span> out;
<a name="l00732"></a>00732                 }
<a name="l00733"></a>00733                 channel-&gt;<a class="code" href="structdwc__hc.html#df0c2b93e5c84cfaba6f06eaeaece5a1">hc_num</a> = i;
<a name="l00734"></a>00734                 hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#cb393f6a676fb106e0e3d35396fb97f9">hc_ptr_array</a>[i] = channel;
<a name="l00735"></a>00735 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l00736"></a>00736 <span class="preprocessor"></span>                hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;hc_xfer_timer[i] =
<a name="l00737"></a>00737                     DWC_TIMER_ALLOC(<span class="stringliteral">"hc timer"</span>, hc_xfer_timeout,
<a name="l00738"></a>00738                                     &amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;hc_xfer_info[i]);
<a name="l00739"></a>00739 <span class="preprocessor">#endif</span>
<a name="l00740"></a>00740 <span class="preprocessor"></span>                <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#39931d908ba215b3d5d590e42d8408b5">DBG_HCDV</a>, <span class="stringliteral">"HCD Added channel #%d, hc=%p\n"</span>, i,
<a name="l00741"></a>00741                             channel);
<a name="l00742"></a>00742         }
<a name="l00743"></a>00743 
<a name="l00744"></a>00744         <span class="comment">/* Initialize the Connection timeout timer. */</span>
<a name="l00745"></a>00745         hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#de7796a41bb7d1e45ed9dbc20c995342">conn_timer</a> = DWC_TIMER_ALLOC(<span class="stringliteral">"Connection timer"</span>,
<a name="l00746"></a>00746                                           <a class="code" href="dwc__otg__hcd_8c.html#4f6f55c20aa8eb215d692195f9f0280d">dwc_otg_hcd_connect_timeout</a>, 0);
<a name="l00747"></a>00747 
<a name="l00748"></a>00748         <span class="comment">/* Initialize reset tasklet. */</span>
<a name="l00749"></a>00749         hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#4f2b2c551e4ac9f49afcbdbde1ddf55d">reset_tasklet</a> = DWC_TASK_ALLOC(<a class="code" href="dwc__otg__hcd_8c.html#ed4640393d701e9bbfd966d4006a60b8">reset_tasklet_func</a>, hcd);
<a name="l00750"></a>00750 
<a name="l00751"></a>00751         <span class="comment">/*</span>
<a name="l00752"></a>00752 <span class="comment">         * Allocate space for storing data on status transactions. Normally no</span>
<a name="l00753"></a>00753 <span class="comment">         * data is sent, but this space acts as a bit bucket. This must be</span>
<a name="l00754"></a>00754 <span class="comment">         * done after usb_add_hcd since that function allocates the DMA buffer</span>
<a name="l00755"></a>00755 <span class="comment">         * pool.</span>
<a name="l00756"></a>00756 <span class="comment">         */</span>
<a name="l00757"></a>00757         <span class="keywordflow">if</span> (hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#5ade18c62c5101c603247691d3047a19">dma_enable</a>) {
<a name="l00758"></a>00758                 hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#68627912f0d3672096e6a98be38f66ab">status_buf</a> =
<a name="l00759"></a>00759                     dwc_dma_alloc(<a class="code" href="dwc__otg__hcd_8h.html#d8ae8e24a91bb0b076390e96a8abee18">DWC_OTG_HCD_STATUS_BUF_SIZE</a>,
<a name="l00760"></a>00760                                   &amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#3e752b2c5d632d848f3b1fadf543e7a4">status_buf_dma</a>);
<a name="l00761"></a>00761         } <span class="keywordflow">else</span> {
<a name="l00762"></a>00762                 hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#68627912f0d3672096e6a98be38f66ab">status_buf</a> = dwc_alloc(<a class="code" href="dwc__otg__hcd_8h.html#d8ae8e24a91bb0b076390e96a8abee18">DWC_OTG_HCD_STATUS_BUF_SIZE</a>);
<a name="l00763"></a>00763         }
<a name="l00764"></a>00764         <span class="keywordflow">if</span> (!hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#68627912f0d3672096e6a98be38f66ab">status_buf</a>) {
<a name="l00765"></a>00765                 retval = -DWC_E_NO_MEMORY;
<a name="l00766"></a>00766                 DWC_ERROR(<span class="stringliteral">"%s: status_buf allocation failed\n"</span>, __func__);
<a name="l00767"></a>00767                 <a class="code" href="dwc__otg__hcd_8c.html#7ee877a9be0c15bacbb92a7babb116d0">dwc_otg_hcd_free</a>(hcd);
<a name="l00768"></a>00768                 <span class="keywordflow">goto</span> out;
<a name="l00769"></a>00769         }
<a name="l00770"></a>00770 
<a name="l00771"></a>00771         hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#9231b4c3dce89a1506a5e501ec5c7a39">otg_port</a> = 1;
<a name="l00772"></a>00772         hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#77f16d5530f50556ed01fe7f69a135fd">frame_list</a> = NULL;
<a name="l00773"></a>00773         hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#3421063dcac9d4e200b5d9bbb0508f3d">frame_list_dma</a> = 0;
<a name="l00774"></a>00774 out:
<a name="l00775"></a>00775         <span class="keywordflow">return</span> retval;
<a name="l00776"></a>00776 }
<a name="l00777"></a>00777 
<a name="l00778"></a><a class="code" href="dwc__otg__hcd__if_8h.html#f347bcb363a622ced29161878d38830b">00778</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__hcd_8c.html#f347bcb363a622ced29161878d38830b">dwc_otg_hcd_remove</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd)
<a name="l00779"></a>00779 {
<a name="l00780"></a>00780         <span class="comment">/* Turn off all host-specific interrupts. */</span>
<a name="l00781"></a>00781         <a class="code" href="dwc__otg__cil_8c.html#4dd4a30dd75a819e9da38d6410cbb0a4">dwc_otg_disable_host_interrupts</a>(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>);
<a name="l00782"></a>00782 
<a name="l00783"></a>00783         <a class="code" href="dwc__otg__hcd_8c.html#7ee877a9be0c15bacbb92a7babb116d0">dwc_otg_hcd_free</a>(hcd);
<a name="l00784"></a>00784 }
<a name="l00785"></a>00785 
<a name="l00789"></a><a class="code" href="dwc__otg__hcd_8c.html#a9b6729ba2077bed1b6d149970d5525e">00789</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__hcd_8c.html#a9b6729ba2077bed1b6d149970d5525e">dwc_otg_hcd_reinit</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd)
<a name="l00790"></a>00790 {
<a name="l00791"></a>00791         <span class="keywordtype">int</span> num_channels;
<a name="l00792"></a>00792         <span class="keywordtype">int</span> i;
<a name="l00793"></a>00793         <a class="code" href="structdwc__hc.html">dwc_hc_t</a> *channel;
<a name="l00794"></a>00794         <a class="code" href="structdwc__hc.html">dwc_hc_t</a> *channel_tmp;
<a name="l00795"></a>00795 
<a name="l00796"></a>00796         hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#9aaf2a112f5794f92dedd826342bd637">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#95ad2033c30d79c28ffcfa6df44af1d5">d32</a> = 0;
<a name="l00797"></a>00797 
<a name="l00798"></a>00798         hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#01ab5791d6269b6b5d506f2113b94231">non_periodic_qh_ptr</a> = &amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#ffa3041ad517da9519aa2159cdec3f61">non_periodic_sched_active</a>;
<a name="l00799"></a>00799         hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e7fff26b5cce7c6c520c89f9e3c75617">non_periodic_channels</a> = 0;
<a name="l00800"></a>00800         hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#5754b87bd4644fbb7b90cf843c638f1c">periodic_channels</a> = 0;
<a name="l00801"></a>00801 
<a name="l00802"></a>00802         <span class="comment">/*</span>
<a name="l00803"></a>00803 <span class="comment">         * Put all channels in the free channel list and clean up channel</span>
<a name="l00804"></a>00804 <span class="comment">         * states.</span>
<a name="l00805"></a>00805 <span class="comment">         */</span>
<a name="l00806"></a>00806         DWC_CIRCLEQ_FOREACH_SAFE(channel, channel_tmp,
<a name="l00807"></a>00807                                  &amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#1761f2e6b8f6ba82c0e0c4e561813f0f">free_hc_list</a>, hc_list_entry) {
<a name="l00808"></a>00808                 DWC_CIRCLEQ_REMOVE(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#1761f2e6b8f6ba82c0e0c4e561813f0f">free_hc_list</a>, channel, hc_list_entry);
<a name="l00809"></a>00809         }
<a name="l00810"></a>00810 
<a name="l00811"></a>00811         num_channels = hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#63ffc9b8e36340bd59bf1fab9ca490ad">core_params</a>-&gt;<a class="code" href="structdwc__otg__core__params.html#c1b433c6965aa7d48f6ca6818c592039">host_channels</a>;
<a name="l00812"></a>00812         <span class="keywordflow">for</span> (i = 0; i &lt; num_channels; i++) {
<a name="l00813"></a>00813                 channel = hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#cb393f6a676fb106e0e3d35396fb97f9">hc_ptr_array</a>[i];
<a name="l00814"></a>00814                 DWC_CIRCLEQ_INSERT_TAIL(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#1761f2e6b8f6ba82c0e0c4e561813f0f">free_hc_list</a>, channel,
<a name="l00815"></a>00815                                         hc_list_entry);
<a name="l00816"></a>00816                 <a class="code" href="dwc__otg__cil_8c.html#f05341f811fba7f6183db66faf50a867">dwc_otg_hc_cleanup</a>(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>, channel);
<a name="l00817"></a>00817         }
<a name="l00818"></a>00818 
<a name="l00819"></a>00819         <span class="comment">/* Initialize the DWC core for host mode operation. */</span>
<a name="l00820"></a>00820         <a class="code" href="dwc__otg__cil_8c.html#04ad276f20faad71333f6293c952744e">dwc_otg_core_host_init</a>(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>);
<a name="l00821"></a>00821 }
<a name="l00822"></a>00822 
<a name="l00832"></a><a class="code" href="dwc__otg__hcd_8c.html#08cefee3729196462fe6a7608046652c">00832</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__hcd_8c.html#08cefee3729196462fe6a7608046652c">assign_and_init_hc</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd, <a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a> * qh)
<a name="l00833"></a>00833 {
<a name="l00834"></a>00834         <a class="code" href="structdwc__hc.html">dwc_hc_t</a> *hc;
<a name="l00835"></a>00835         <a class="code" href="structdwc__otg__qtd.html">dwc_otg_qtd_t</a> *qtd;
<a name="l00836"></a>00836         <a class="code" href="structdwc__otg__hcd__urb.html">dwc_otg_hcd_urb_t</a> *urb;
<a name="l00837"></a>00837         <span class="keywordtype">void</span>* ptr = NULL;
<a name="l00838"></a>00838 
<a name="l00839"></a>00839         <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#39931d908ba215b3d5d590e42d8408b5">DBG_HCDV</a>, <span class="stringliteral">"%s(%p,%p)\n"</span>, __func__, hcd, qh);
<a name="l00840"></a>00840 
<a name="l00841"></a>00841         hc = DWC_CIRCLEQ_FIRST(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#1761f2e6b8f6ba82c0e0c4e561813f0f">free_hc_list</a>);
<a name="l00842"></a>00842 
<a name="l00843"></a>00843         <span class="comment">/* Remove the host channel from the free list. */</span>
<a name="l00844"></a>00844         DWC_CIRCLEQ_REMOVE_INIT(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#1761f2e6b8f6ba82c0e0c4e561813f0f">free_hc_list</a>, hc, hc_list_entry);
<a name="l00845"></a>00845 
<a name="l00846"></a>00846         qtd = DWC_CIRCLEQ_FIRST(&amp;qh-&gt;<a class="code" href="structdwc__otg__qh.html#9567d266da8e796d3467fb16ae867f8e">qtd_list</a>);
<a name="l00847"></a>00847         
<a name="l00848"></a>00848         urb = qtd-&gt;<a class="code" href="structdwc__otg__qtd.html#7e7767808e8eb9d71de0db00f57553f9">urb</a>;
<a name="l00849"></a>00849         qh-&gt;<a class="code" href="structdwc__otg__qh.html#bbdb7d30b60b6c326301f33b35088bb4">channel</a> = hc;
<a name="l00850"></a>00850         
<a name="l00851"></a>00851         qtd-&gt;<a class="code" href="structdwc__otg__qtd.html#c1d73f1d48eeabbdc198ad28c0882bc1">in_process</a> = 1;
<a name="l00852"></a>00852 
<a name="l00853"></a>00853         <span class="comment">/*</span>
<a name="l00854"></a>00854 <span class="comment">         * Use usb_pipedevice to determine device address. This address is</span>
<a name="l00855"></a>00855 <span class="comment">         * 0 before the SET_ADDRESS command and the correct address afterward.</span>
<a name="l00856"></a>00856 <span class="comment">         */</span>
<a name="l00857"></a>00857         hc-&gt;<a class="code" href="structdwc__hc.html#b2c7e8baff70104375f4916e9b76cef7">dev_addr</a> = <a class="code" href="dwc__otg__hcd_8h.html#0de365358ba4472d56c1ac8074ba926b">dwc_otg_hcd_get_dev_addr</a>(&amp;urb-&gt;<a class="code" href="structdwc__otg__hcd__urb.html#34ee3ac5931687b41dd726f00c558369">pipe_info</a>);
<a name="l00858"></a>00858         hc-&gt;<a class="code" href="structdwc__hc.html#70b755f76a00b81679aeb1e0db8b2e60">ep_num</a> = <a class="code" href="dwc__otg__hcd_8h.html#367b79057f321cfa65023f4026d6c2c9">dwc_otg_hcd_get_ep_num</a>(&amp;urb-&gt;<a class="code" href="structdwc__otg__hcd__urb.html#34ee3ac5931687b41dd726f00c558369">pipe_info</a>);
<a name="l00859"></a>00859         hc-&gt;<a class="code" href="structdwc__hc.html#570b78178975193edb921af1ef36d37b">speed</a> = qh-&gt;<a class="code" href="structdwc__otg__qh.html#42459dd91e199807783000b6dc358a7d">dev_speed</a>;
<a name="l00860"></a>00860         hc-&gt;<a class="code" href="structdwc__hc.html#bd88f02eb286ba01d8d1b049e8975ccb">max_packet</a> = <a class="code" href="dwc__otg__hcd_8h.html#bd2189f881088fe7f4ca9112ee24549b">dwc_max_packet</a>(qh-&gt;<a class="code" href="structdwc__otg__qh.html#5975c2bede1ca0c6cfe9a66fe0a52567">maxp</a>);
<a name="l00861"></a>00861 
<a name="l00862"></a>00862         hc-&gt;<a class="code" href="structdwc__hc.html#78a1cf134604b24bfdedb4f4df9f2c1f">xfer_started</a> = 0;
<a name="l00863"></a>00863         hc-&gt;<a class="code" href="structdwc__hc.html#07eca0fa02105ddaa1719387f5558b23">halt_status</a> = DWC_OTG_HC_XFER_NO_HALT_STATUS;
<a name="l00864"></a>00864         hc-&gt;<a class="code" href="structdwc__hc.html#ab0855754930fdc74978fa71772982ed">error_state</a> = (qtd-&gt;<a class="code" href="structdwc__otg__qtd.html#18eeb9c647049aec468bf9a7861c873f">error_count</a> &gt; 0);
<a name="l00865"></a>00865         hc-&gt;<a class="code" href="structdwc__hc.html#c3b27b33fae73aff43a9834a1ed585da">halt_on_queue</a> = 0;
<a name="l00866"></a>00866         hc-&gt;<a class="code" href="structdwc__hc.html#2177dcde6dbb17b6bc7d0fb34e8ec95a">halt_pending</a> = 0;
<a name="l00867"></a>00867         hc-&gt;<a class="code" href="structdwc__hc.html#961e8eae7a18c503e370c4bc513d3e55">requests</a> = 0;
<a name="l00868"></a>00868 
<a name="l00869"></a>00869         <span class="comment">/*</span>
<a name="l00870"></a>00870 <span class="comment">         * The following values may be modified in the transfer type section</span>
<a name="l00871"></a>00871 <span class="comment">         * below. The xfer_len value may be reduced when the transfer is</span>
<a name="l00872"></a>00872 <span class="comment">         * started to accommodate the max widths of the XferSize and PktCnt</span>
<a name="l00873"></a>00873 <span class="comment">         * fields in the HCTSIZn register.</span>
<a name="l00874"></a>00874 <span class="comment">         */</span>
<a name="l00875"></a>00875         hc-&gt;<a class="code" href="structdwc__hc.html#ae7184275dbb23b3a5d2af20ed224920">do_ping</a> = qh-&gt;<a class="code" href="structdwc__otg__qh.html#2c115474978a808c797c8975d72e419d">ping_state</a>;
<a name="l00876"></a>00876         hc-&gt;<a class="code" href="structdwc__hc.html#c5088d431f5efc382121f201f5d571aa">ep_is_in</a> = (<a class="code" href="dwc__otg__hcd_8h.html#68de5629a8b45d9bec58f680fa4c820c">dwc_otg_hcd_is_pipe_in</a>(&amp;urb-&gt;<a class="code" href="structdwc__otg__hcd__urb.html#34ee3ac5931687b41dd726f00c558369">pipe_info</a>) != 0);
<a name="l00877"></a>00877         hc-&gt;<a class="code" href="structdwc__hc.html#513427c5e8c4603ba344d4e7f9191064">data_pid_start</a> = qh-&gt;<a class="code" href="structdwc__otg__qh.html#b0e001bfd76f5781926795ac47ef2c25">data_toggle</a>;
<a name="l00878"></a>00878         hc-&gt;<a class="code" href="structdwc__hc.html#9a01b904f7ccc7178cdb80c20e8a9b0c">multi_count</a> = 1;
<a name="l00879"></a>00879 
<a name="l00880"></a>00880         <span class="keywordflow">if</span> (hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#5ade18c62c5101c603247691d3047a19">dma_enable</a>) {
<a name="l00881"></a>00881                 hc-&gt;<a class="code" href="structdwc__hc.html#9dc781cb9e4bc639765beee37ce76673">xfer_buff</a> = (uint8_t *) urb-&gt;<a class="code" href="structdwc__otg__hcd__urb.html#4e177a55239e95ae2f6c8b6b913f67fc">dma</a> + urb-&gt;<a class="code" href="structdwc__otg__hcd__urb.html#742c8a97d3867ab89148eae34e0c73a6">actual_length</a>;
<a name="l00882"></a>00882         
<a name="l00883"></a>00883                 <span class="comment">/* For non-dword aligned case */</span>
<a name="l00884"></a>00884                 if (((uint32_t)hc-&gt;<a class="code" href="structdwc__hc.html#9dc781cb9e4bc639765beee37ce76673">xfer_buff</a> &amp; 0x3) &amp;&amp; !hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#7e3b96c6167eceeeb1090798f8297f1f">dma_desc_enable</a>) {
<a name="l00885"></a>00885                         ptr = (uint8_t *) urb-&gt;<a class="code" href="structdwc__otg__hcd__urb.html#99ae35ffcd6147ddb93b361ab3bcfe95">buf</a> + urb-&gt;<a class="code" href="structdwc__otg__hcd__urb.html#742c8a97d3867ab89148eae34e0c73a6">actual_length</a>;
<a name="l00886"></a>00886                 }
<a name="l00887"></a>00887         } <span class="keywordflow">else</span> {
<a name="l00888"></a>00888                 hc-&gt;<a class="code" href="structdwc__hc.html#9dc781cb9e4bc639765beee37ce76673">xfer_buff</a> = (uint8_t *) urb-&gt;<a class="code" href="structdwc__otg__hcd__urb.html#99ae35ffcd6147ddb93b361ab3bcfe95">buf</a> + urb-&gt;<a class="code" href="structdwc__otg__hcd__urb.html#742c8a97d3867ab89148eae34e0c73a6">actual_length</a>;
<a name="l00889"></a>00889         }
<a name="l00890"></a>00890         hc-&gt;<a class="code" href="structdwc__hc.html#ce32fe93214f1686896e924fbf61cac7">xfer_len</a> = urb-&gt;<a class="code" href="structdwc__otg__hcd__urb.html#dca57de4fdecd894241ce24167206a45">length</a> - urb-&gt;<a class="code" href="structdwc__otg__hcd__urb.html#742c8a97d3867ab89148eae34e0c73a6">actual_length</a>;
<a name="l00891"></a>00891         hc-&gt;<a class="code" href="structdwc__hc.html#6199aaeab2d64954311c410b30270293">xfer_count</a> = 0;
<a name="l00892"></a>00892 
<a name="l00893"></a>00893         <span class="comment">/*</span>
<a name="l00894"></a>00894 <span class="comment">         * Set the split attributes</span>
<a name="l00895"></a>00895 <span class="comment">         */</span>
<a name="l00896"></a>00896         hc-&gt;<a class="code" href="structdwc__hc.html#4365ef67d517a621a626ac5392545c6d">do_split</a> = 0;
<a name="l00897"></a>00897         <span class="keywordflow">if</span> (qh-&gt;<a class="code" href="structdwc__otg__qh.html#8708dd009988ce20b8a8d52a4a96c5a3">do_split</a>) {
<a name="l00898"></a>00898                 uint32_t hub_addr, port_addr;
<a name="l00899"></a>00899                 hc-&gt;<a class="code" href="structdwc__hc.html#4365ef67d517a621a626ac5392545c6d">do_split</a> = 1;
<a name="l00900"></a>00900                 hc-&gt;<a class="code" href="structdwc__hc.html#3cde49a724756e16eb11a027360b2d4b">xact_pos</a> = qtd-&gt;<a class="code" href="structdwc__otg__qtd.html#ab224d64d72f2ef4f10e722ebcfa29a6">isoc_split_pos</a>;
<a name="l00901"></a>00901                 hc-&gt;<a class="code" href="structdwc__hc.html#21e00df6fb9a555975879526118d599e">complete_split</a> = qtd-&gt;<a class="code" href="structdwc__otg__qtd.html#6355e968a4d36edce3e22c89ac7b5001">complete_split</a>;
<a name="l00902"></a>00902                 hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#ffefbd33a59a14b8b46406f5aaeaa2f4">fops</a>-&gt;<a class="code" href="structdwc__otg__hcd__function__ops.html#71bff93886173700d26a8950e7ea82e1">hub_info</a>(hcd, urb-&gt;<a class="code" href="structdwc__otg__hcd__urb.html#5ba0e393ef9768275db85c00e68be477">priv</a>, &amp;hub_addr, &amp;port_addr);
<a name="l00903"></a>00903                 hc-&gt;<a class="code" href="structdwc__hc.html#19d0302b6e3769eada2466b8e5e0dd91">hub_addr</a> = (uint8_t) hub_addr;
<a name="l00904"></a>00904                 hc-&gt;<a class="code" href="structdwc__hc.html#9f597e05c37d7292f4c0d965c67ee3dd">port_addr</a> = (uint8_t) port_addr;
<a name="l00905"></a>00905         }
<a name="l00906"></a>00906 
<a name="l00907"></a>00907         <span class="keywordflow">switch</span> (<a class="code" href="dwc__otg__hcd_8h.html#b97cea598797e69d011ffef89989a739">dwc_otg_hcd_get_pipe_type</a>(&amp;urb-&gt;<a class="code" href="structdwc__otg__hcd__urb.html#34ee3ac5931687b41dd726f00c558369">pipe_info</a>)) {
<a name="l00908"></a>00908         <span class="keywordflow">case</span> UE_CONTROL:
<a name="l00909"></a>00909                 hc-&gt;<a class="code" href="structdwc__hc.html#e6169fbc92e4d79686097742ad646f5c">ep_type</a> = <a class="code" href="dwc__otg__cil_8h.html#64e5cd756330f5adab79b25cc8067bdc">DWC_OTG_EP_TYPE_CONTROL</a>;
<a name="l00910"></a>00910                 <span class="keywordflow">switch</span> (qtd-&gt;<a class="code" href="structdwc__otg__qtd.html#5189ec9c992974d20477481eaf96d0bb">control_phase</a>) {
<a name="l00911"></a>00911                 <span class="keywordflow">case</span> DWC_OTG_CONTROL_SETUP:
<a name="l00912"></a>00912                         <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#39931d908ba215b3d5d590e42d8408b5">DBG_HCDV</a>, <span class="stringliteral">"  Control setup transaction\n"</span>);
<a name="l00913"></a>00913                         hc-&gt;<a class="code" href="structdwc__hc.html#ae7184275dbb23b3a5d2af20ed224920">do_ping</a> = 0;
<a name="l00914"></a>00914                         hc-&gt;<a class="code" href="structdwc__hc.html#c5088d431f5efc382121f201f5d571aa">ep_is_in</a> = 0;
<a name="l00915"></a>00915                         hc-&gt;<a class="code" href="structdwc__hc.html#513427c5e8c4603ba344d4e7f9191064">data_pid_start</a> = <a class="code" href="dwc__otg__cil_8h.html#8d329f92a5ff6f9a72fc755b6b1a4e17">DWC_OTG_HC_PID_SETUP</a>;
<a name="l00916"></a>00916                         <span class="keywordflow">if</span> (hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#5ade18c62c5101c603247691d3047a19">dma_enable</a>) {
<a name="l00917"></a>00917                                 hc-&gt;<a class="code" href="structdwc__hc.html#9dc781cb9e4bc639765beee37ce76673">xfer_buff</a> = (uint8_t *) urb-&gt;<a class="code" href="structdwc__otg__hcd__urb.html#497f61f9b3f6f77f6b844e31c047264d">setup_dma</a>;
<a name="l00918"></a>00918                         } <span class="keywordflow">else</span> {
<a name="l00919"></a>00919                                 hc-&gt;<a class="code" href="structdwc__hc.html#9dc781cb9e4bc639765beee37ce76673">xfer_buff</a> = (uint8_t *) urb-&gt;<a class="code" href="structdwc__otg__hcd__urb.html#254afd954f3e24bb92841384183a317c">setup_packet</a>;
<a name="l00920"></a>00920                         }
<a name="l00921"></a>00921                         hc-&gt;<a class="code" href="structdwc__hc.html#ce32fe93214f1686896e924fbf61cac7">xfer_len</a> = 8;
<a name="l00922"></a>00922                         ptr = NULL;
<a name="l00923"></a>00923                         <span class="keywordflow">break</span>;
<a name="l00924"></a>00924                 <span class="keywordflow">case</span> DWC_OTG_CONTROL_DATA:
<a name="l00925"></a>00925                         <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#39931d908ba215b3d5d590e42d8408b5">DBG_HCDV</a>, <span class="stringliteral">"  Control data transaction\n"</span>);
<a name="l00926"></a>00926                         hc-&gt;<a class="code" href="structdwc__hc.html#513427c5e8c4603ba344d4e7f9191064">data_pid_start</a> = qtd-&gt;<a class="code" href="structdwc__otg__qtd.html#e912f256e01165b573c26262247a5eff">data_toggle</a>;
<a name="l00927"></a>00927                         <span class="keywordflow">break</span>;
<a name="l00928"></a>00928                 <span class="keywordflow">case</span> DWC_OTG_CONTROL_STATUS:
<a name="l00929"></a>00929                         <span class="comment">/*</span>
<a name="l00930"></a>00930 <span class="comment">                         * Direction is opposite of data direction or IN if no</span>
<a name="l00931"></a>00931 <span class="comment">                         * data.</span>
<a name="l00932"></a>00932 <span class="comment">                         */</span>
<a name="l00933"></a>00933                         <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#39931d908ba215b3d5d590e42d8408b5">DBG_HCDV</a>, <span class="stringliteral">"  Control status transaction\n"</span>);
<a name="l00934"></a>00934                         <span class="keywordflow">if</span> (urb-&gt;<a class="code" href="structdwc__otg__hcd__urb.html#dca57de4fdecd894241ce24167206a45">length</a> == 0) {
<a name="l00935"></a>00935                                 hc-&gt;<a class="code" href="structdwc__hc.html#c5088d431f5efc382121f201f5d571aa">ep_is_in</a> = 1;
<a name="l00936"></a>00936                         } <span class="keywordflow">else</span> {
<a name="l00937"></a>00937                                 hc-&gt;<a class="code" href="structdwc__hc.html#c5088d431f5efc382121f201f5d571aa">ep_is_in</a> =
<a name="l00938"></a>00938                                     <a class="code" href="dwc__otg__hcd_8h.html#cf3e5e59a22ef6bd497e05710e39cad0">dwc_otg_hcd_is_pipe_out</a>(&amp;urb-&gt;<a class="code" href="structdwc__otg__hcd__urb.html#34ee3ac5931687b41dd726f00c558369">pipe_info</a>);
<a name="l00939"></a>00939                         }
<a name="l00940"></a>00940                         <span class="keywordflow">if</span> (hc-&gt;<a class="code" href="structdwc__hc.html#c5088d431f5efc382121f201f5d571aa">ep_is_in</a>) {
<a name="l00941"></a>00941                                 hc-&gt;<a class="code" href="structdwc__hc.html#ae7184275dbb23b3a5d2af20ed224920">do_ping</a> = 0;
<a name="l00942"></a>00942                         }
<a name="l00943"></a>00943                         
<a name="l00944"></a>00944                         hc-&gt;<a class="code" href="structdwc__hc.html#513427c5e8c4603ba344d4e7f9191064">data_pid_start</a> = <a class="code" href="dwc__otg__cil_8h.html#e623eb446c55928b324e9636111315e1">DWC_OTG_HC_PID_DATA1</a>;
<a name="l00945"></a>00945 
<a name="l00946"></a>00946                         hc-&gt;<a class="code" href="structdwc__hc.html#ce32fe93214f1686896e924fbf61cac7">xfer_len</a> = 0;
<a name="l00947"></a>00947                         <span class="keywordflow">if</span> (hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#5ade18c62c5101c603247691d3047a19">dma_enable</a>) {
<a name="l00948"></a>00948                                 hc-&gt;<a class="code" href="structdwc__hc.html#9dc781cb9e4bc639765beee37ce76673">xfer_buff</a> = (uint8_t *) hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#3e752b2c5d632d848f3b1fadf543e7a4">status_buf_dma</a>;
<a name="l00949"></a>00949                         } <span class="keywordflow">else</span> {
<a name="l00950"></a>00950                                 hc-&gt;<a class="code" href="structdwc__hc.html#9dc781cb9e4bc639765beee37ce76673">xfer_buff</a> = (uint8_t *) hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#68627912f0d3672096e6a98be38f66ab">status_buf</a>;
<a name="l00951"></a>00951                         }
<a name="l00952"></a>00952                         ptr = NULL;
<a name="l00953"></a>00953                         <span class="keywordflow">break</span>;
<a name="l00954"></a>00954                 }
<a name="l00955"></a>00955                 <span class="keywordflow">break</span>;
<a name="l00956"></a>00956         <span class="keywordflow">case</span> UE_BULK:
<a name="l00957"></a>00957                 hc-&gt;<a class="code" href="structdwc__hc.html#e6169fbc92e4d79686097742ad646f5c">ep_type</a> = <a class="code" href="dwc__otg__cil_8h.html#9b079858cda0b917316ad9161b3881e0">DWC_OTG_EP_TYPE_BULK</a>;
<a name="l00958"></a>00958                 <span class="keywordflow">break</span>;
<a name="l00959"></a>00959         <span class="keywordflow">case</span> UE_INTERRUPT:
<a name="l00960"></a>00960                 hc-&gt;<a class="code" href="structdwc__hc.html#e6169fbc92e4d79686097742ad646f5c">ep_type</a> = <a class="code" href="dwc__otg__cil_8h.html#1401d1264f88530232cf51ab31cc5347">DWC_OTG_EP_TYPE_INTR</a>;
<a name="l00961"></a>00961                 <span class="keywordflow">break</span>;
<a name="l00962"></a>00962         <span class="keywordflow">case</span> UE_ISOCHRONOUS:
<a name="l00963"></a>00963                 {
<a name="l00964"></a>00964                         <span class="keyword">struct </span><a class="code" href="structdwc__otg__hcd__iso__packet__desc.html">dwc_otg_hcd_iso_packet_desc</a> *frame_desc;
<a name="l00965"></a>00965                         
<a name="l00966"></a>00966                         hc-&gt;<a class="code" href="structdwc__hc.html#e6169fbc92e4d79686097742ad646f5c">ep_type</a> = <a class="code" href="dwc__otg__cil_8h.html#152a3a5e1433bd2197672f0b5105e7a4">DWC_OTG_EP_TYPE_ISOC</a>;
<a name="l00967"></a>00967                         
<a name="l00968"></a>00968                         <span class="keywordflow">if</span> (hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#7e3b96c6167eceeeb1090798f8297f1f">dma_desc_enable</a>)
<a name="l00969"></a>00969                                 <span class="keywordflow">break</span>;
<a name="l00970"></a>00970                                 
<a name="l00971"></a>00971                         frame_desc = &amp;urb-&gt;<a class="code" href="structdwc__otg__hcd__urb.html#ed542f6a2d99dba2f6b71b0d8012ec8a">iso_descs</a>[qtd-&gt;<a class="code" href="structdwc__otg__qtd.html#c67d5f885976d0698f20d113d32b4b30">isoc_frame_index</a>];
<a name="l00972"></a>00972                         
<a name="l00973"></a>00973                         frame_desc-&gt;<a class="code" href="structdwc__otg__hcd__iso__packet__desc.html#d070772c24621c47b49ad21c6acadb94">status</a> = 0;
<a name="l00974"></a>00974                         
<a name="l00975"></a>00975                         <span class="keywordflow">if</span> (hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#5ade18c62c5101c603247691d3047a19">dma_enable</a>) {
<a name="l00976"></a>00976                                 hc-&gt;<a class="code" href="structdwc__hc.html#9dc781cb9e4bc639765beee37ce76673">xfer_buff</a> = (uint8_t *) urb-&gt;<a class="code" href="structdwc__otg__hcd__urb.html#4e177a55239e95ae2f6c8b6b913f67fc">dma</a>;
<a name="l00977"></a>00977                         } <span class="keywordflow">else</span> {
<a name="l00978"></a>00978                                 hc-&gt;<a class="code" href="structdwc__hc.html#9dc781cb9e4bc639765beee37ce76673">xfer_buff</a> = (uint8_t *) urb-&gt;<a class="code" href="structdwc__otg__hcd__urb.html#99ae35ffcd6147ddb93b361ab3bcfe95">buf</a>;
<a name="l00979"></a>00979                         }
<a name="l00980"></a>00980                         hc-&gt;<a class="code" href="structdwc__hc.html#9dc781cb9e4bc639765beee37ce76673">xfer_buff</a> +=
<a name="l00981"></a>00981                             frame_desc-&gt;<a class="code" href="structdwc__otg__hcd__iso__packet__desc.html#246f3d147a22cd295c534253593dca4a">offset</a> + qtd-&gt;<a class="code" href="structdwc__otg__qtd.html#839371940a7e34365e2272f3214b7e34">isoc_split_offset</a>;
<a name="l00982"></a>00982                         hc-&gt;<a class="code" href="structdwc__hc.html#ce32fe93214f1686896e924fbf61cac7">xfer_len</a> =
<a name="l00983"></a>00983                             frame_desc-&gt;<a class="code" href="structdwc__otg__hcd__iso__packet__desc.html#8392d21b820df0181f4e6dca91234543">length</a> - qtd-&gt;<a class="code" href="structdwc__otg__qtd.html#839371940a7e34365e2272f3214b7e34">isoc_split_offset</a>;
<a name="l00984"></a>00984 
<a name="l00985"></a>00985                         <span class="comment">/* For non-dword aligned buffers */</span>
<a name="l00986"></a>00986                         <span class="keywordflow">if</span> (((uint32_t)hc-&gt;<a class="code" href="structdwc__hc.html#9dc781cb9e4bc639765beee37ce76673">xfer_buff</a> &amp; 0x3) &amp;&amp; hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#5ade18c62c5101c603247691d3047a19">dma_enable</a>) {
<a name="l00987"></a>00987                                 ptr = (uint8_t *) urb-&gt;<a class="code" href="structdwc__otg__hcd__urb.html#99ae35ffcd6147ddb93b361ab3bcfe95">buf</a> + frame_desc-&gt;<a class="code" href="structdwc__otg__hcd__iso__packet__desc.html#246f3d147a22cd295c534253593dca4a">offset</a> + qtd-&gt;<a class="code" href="structdwc__otg__qtd.html#839371940a7e34365e2272f3214b7e34">isoc_split_offset</a>;
<a name="l00988"></a>00988                         }       
<a name="l00989"></a>00989                         <span class="keywordflow">else</span>
<a name="l00990"></a>00990                             ptr = NULL;
<a name="l00991"></a>00991                         
<a name="l00992"></a>00992                         <span class="keywordflow">if</span> (hc-&gt;<a class="code" href="structdwc__hc.html#3cde49a724756e16eb11a027360b2d4b">xact_pos</a> == <a class="code" href="dwc__otg__regs_8h.html#b8a8f35d8fd73c955cc0403e87cea0c6">DWC_HCSPLIT_XACTPOS_ALL</a>) {
<a name="l00993"></a>00993                                 <span class="keywordflow">if</span> (hc-&gt;<a class="code" href="structdwc__hc.html#ce32fe93214f1686896e924fbf61cac7">xfer_len</a> &lt;= 188) {
<a name="l00994"></a>00994                                         hc-&gt;<a class="code" href="structdwc__hc.html#3cde49a724756e16eb11a027360b2d4b">xact_pos</a> = <a class="code" href="dwc__otg__regs_8h.html#b8a8f35d8fd73c955cc0403e87cea0c6">DWC_HCSPLIT_XACTPOS_ALL</a>;
<a name="l00995"></a>00995                                 } <span class="keywordflow">else</span> {
<a name="l00996"></a>00996                                         hc-&gt;<a class="code" href="structdwc__hc.html#3cde49a724756e16eb11a027360b2d4b">xact_pos</a> =
<a name="l00997"></a>00997                                             <a class="code" href="dwc__otg__regs_8h.html#c0b856e1a71e0373153d986a3cb5b135">DWC_HCSPLIT_XACTPOS_BEGIN</a>;
<a name="l00998"></a>00998                                 }
<a name="l00999"></a>00999                         }
<a name="l01000"></a>01000                 }
<a name="l01001"></a>01001                 <span class="keywordflow">break</span>;
<a name="l01002"></a>01002         }
<a name="l01003"></a>01003         <span class="comment">/* non DWORD-aligned buffer case */</span>     
<a name="l01004"></a>01004         <span class="keywordflow">if</span> (ptr) {
<a name="l01005"></a>01005                 uint32_t buf_size;
<a name="l01006"></a>01006                 <span class="keywordflow">if</span> (hc-&gt;<a class="code" href="structdwc__hc.html#e6169fbc92e4d79686097742ad646f5c">ep_type</a> != <a class="code" href="dwc__otg__cil_8h.html#152a3a5e1433bd2197672f0b5105e7a4">DWC_OTG_EP_TYPE_ISOC</a>) {
<a name="l01007"></a>01007                         buf_size = hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#63ffc9b8e36340bd59bf1fab9ca490ad">core_params</a>-&gt;<a class="code" href="structdwc__otg__core__params.html#e614d1d2ee740cd972ca76ed0dffec74">max_transfer_size</a>;
<a name="l01008"></a>01008                 } <span class="keywordflow">else</span> {                                
<a name="l01009"></a>01009                         buf_size = 4096;
<a name="l01010"></a>01010                 }
<a name="l01011"></a>01011                 <span class="keywordflow">if</span> (!qh-&gt;<a class="code" href="structdwc__otg__qh.html#aac9f90a6afd9056dce79d013dd2168b">dw_align_buf</a>) {
<a name="l01012"></a>01012                         qh-&gt;<a class="code" href="structdwc__otg__qh.html#aac9f90a6afd9056dce79d013dd2168b">dw_align_buf</a> = dwc_dma_alloc(buf_size,
<a name="l01013"></a>01013                                                          &amp;qh-&gt;<a class="code" href="structdwc__otg__qh.html#b0b008f9d25f5e3b6e285d2830cfdca1">dw_align_buf_dma</a>);
<a name="l01014"></a>01014                         <span class="keywordflow">if</span> (!qh-&gt;<a class="code" href="structdwc__otg__qh.html#aac9f90a6afd9056dce79d013dd2168b">dw_align_buf</a>) {
<a name="l01015"></a>01015                                 DWC_ERROR(<span class="stringliteral">"%s: Failed to allocate memory to handle "</span>
<a name="l01016"></a>01016                                           <span class="stringliteral">"non-dword aligned buffer case\n"</span>, __func__);
<a name="l01017"></a>01017                                 <span class="keywordflow">return</span>;
<a name="l01018"></a>01018                         }
<a name="l01019"></a>01019                 }
<a name="l01020"></a>01020                 <span class="keywordflow">if</span> (!hc-&gt;<a class="code" href="structdwc__hc.html#c5088d431f5efc382121f201f5d571aa">ep_is_in</a>) {
<a name="l01021"></a>01021                         dwc_memcpy(qh-&gt;<a class="code" href="structdwc__otg__qh.html#aac9f90a6afd9056dce79d013dd2168b">dw_align_buf</a>, ptr, hc-&gt;<a class="code" href="structdwc__hc.html#ce32fe93214f1686896e924fbf61cac7">xfer_len</a>);
<a name="l01022"></a>01022                 }
<a name="l01023"></a>01023                 hc-&gt;<a class="code" href="structdwc__hc.html#e0c3ba51a04b36656baa4e70fc63cf77">align_buff</a> = qh-&gt;<a class="code" href="structdwc__otg__qh.html#b0b008f9d25f5e3b6e285d2830cfdca1">dw_align_buf_dma</a>;
<a name="l01024"></a>01024         }
<a name="l01025"></a>01025         <span class="keywordflow">else</span> {
<a name="l01026"></a>01026                 hc-&gt;<a class="code" href="structdwc__hc.html#e0c3ba51a04b36656baa4e70fc63cf77">align_buff</a> = 0;
<a name="l01027"></a>01027         }
<a name="l01028"></a>01028 
<a name="l01029"></a>01029         <span class="keywordflow">if</span> (hc-&gt;<a class="code" href="structdwc__hc.html#e6169fbc92e4d79686097742ad646f5c">ep_type</a> == <a class="code" href="dwc__otg__cil_8h.html#1401d1264f88530232cf51ab31cc5347">DWC_OTG_EP_TYPE_INTR</a> ||
<a name="l01030"></a>01030             hc-&gt;<a class="code" href="structdwc__hc.html#e6169fbc92e4d79686097742ad646f5c">ep_type</a> == <a class="code" href="dwc__otg__cil_8h.html#152a3a5e1433bd2197672f0b5105e7a4">DWC_OTG_EP_TYPE_ISOC</a>) {
<a name="l01031"></a>01031                 <span class="comment">/*</span>
<a name="l01032"></a>01032 <span class="comment">                 * This value may be modified when the transfer is started to</span>
<a name="l01033"></a>01033 <span class="comment">                 * reflect the actual transfer length.</span>
<a name="l01034"></a>01034 <span class="comment">                 */</span>
<a name="l01035"></a>01035                 hc-&gt;<a class="code" href="structdwc__hc.html#9a01b904f7ccc7178cdb80c20e8a9b0c">multi_count</a> = <a class="code" href="dwc__otg__hcd_8h.html#a371dfcb8a66214c8fe226190fc1a323">dwc_hb_mult</a>(qh-&gt;<a class="code" href="structdwc__otg__qh.html#5975c2bede1ca0c6cfe9a66fe0a52567">maxp</a>);
<a name="l01036"></a>01036         }
<a name="l01037"></a>01037         
<a name="l01038"></a>01038         <span class="keywordflow">if</span> (hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#7e3b96c6167eceeeb1090798f8297f1f">dma_desc_enable</a>)
<a name="l01039"></a>01039                 hc-&gt;<a class="code" href="structdwc__hc.html#f3001addf65df4d3c6a5c685d7637efd">desc_list_addr</a> = qh-&gt;<a class="code" href="structdwc__otg__qh.html#c31412bb35362e77c697352fd4c3eeaf">desc_list_dma</a>;
<a name="l01040"></a>01040         
<a name="l01041"></a>01041         <a class="code" href="dwc__otg__cil_8c.html#7b04d5b3b31c79c73d577cfbb231998c">dwc_otg_hc_init</a>(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>, hc);
<a name="l01042"></a>01042         hc-&gt;<a class="code" href="structdwc__hc.html#d338f8db131745d9921f51c30f26cd3c">qh</a> = qh;
<a name="l01043"></a>01043 }
<a name="l01044"></a>01044 
<a name="l01045"></a>01045 
<a name="l01055"></a><a class="code" href="dwc__otg__hcd_8h.html#96cc299f4f0478187ed7ba49b975ffc3">01055</a> <a class="code" href="dwc__otg__hcd_8h.html#92c49783eebc5bcffa8b8a51c2127be9">dwc_otg_transaction_type_e</a> <a class="code" href="dwc__otg__hcd_8c.html#96cc299f4f0478187ed7ba49b975ffc3">dwc_otg_hcd_select_transactions</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd)
<a name="l01056"></a>01056 {
<a name="l01057"></a>01057         dwc_list_link_t *qh_ptr;
<a name="l01058"></a>01058         <a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a> *qh;
<a name="l01059"></a>01059         <span class="keywordtype">int</span> num_channels;
<a name="l01060"></a>01060         <a class="code" href="dwc__otg__hcd_8h.html#92c49783eebc5bcffa8b8a51c2127be9">dwc_otg_transaction_type_e</a> ret_val = DWC_OTG_TRANSACTION_NONE;
<a name="l01061"></a>01061 
<a name="l01062"></a>01062 <span class="preprocessor">#ifdef DEBUG_SOF</span>
<a name="l01063"></a>01063 <span class="preprocessor"></span>        <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#e4a050e176c1c4f556da2b276a8c2b37">DBG_HCD</a>, <span class="stringliteral">"  Select Transactions\n"</span>);
<a name="l01064"></a>01064 <span class="preprocessor">#endif</span>
<a name="l01065"></a>01065 <span class="preprocessor"></span>
<a name="l01066"></a>01066         <span class="comment">/* Process entries in the periodic ready list. */</span>
<a name="l01067"></a>01067         qh_ptr = DWC_LIST_FIRST(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#74b089e094911a558f7b5f24681d3242">periodic_sched_ready</a>);
<a name="l01068"></a>01068 
<a name="l01069"></a>01069         <span class="keywordflow">while</span> (qh_ptr != &amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#74b089e094911a558f7b5f24681d3242">periodic_sched_ready</a> &amp;&amp;
<a name="l01070"></a>01070                !DWC_CIRCLEQ_EMPTY(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#1761f2e6b8f6ba82c0e0c4e561813f0f">free_hc_list</a>)) {
<a name="l01071"></a>01071 
<a name="l01072"></a>01072                 qh = DWC_LIST_ENTRY(qh_ptr, <a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a>, qh_list_entry);
<a name="l01073"></a>01073                 <a class="code" href="dwc__otg__hcd_8c.html#08cefee3729196462fe6a7608046652c">assign_and_init_hc</a>(hcd, qh);
<a name="l01074"></a>01074 
<a name="l01075"></a>01075                 <span class="comment">/*</span>
<a name="l01076"></a>01076 <span class="comment">                 * Move the QH from the periodic ready schedule to the</span>
<a name="l01077"></a>01077 <span class="comment">                 * periodic assigned schedule.</span>
<a name="l01078"></a>01078 <span class="comment">                 */</span>
<a name="l01079"></a>01079                 qh_ptr = DWC_LIST_NEXT(qh_ptr);
<a name="l01080"></a>01080                 DWC_LIST_MOVE_HEAD(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#4b8deae798f771135c4a99693b26873f">periodic_sched_assigned</a>,
<a name="l01081"></a>01081                                    &amp;qh-&gt;<a class="code" href="structdwc__otg__qh.html#3e1cb9863dc72139e1832c04244c25ff">qh_list_entry</a>);
<a name="l01082"></a>01082 
<a name="l01083"></a>01083                 ret_val = DWC_OTG_TRANSACTION_PERIODIC;
<a name="l01084"></a>01084         }
<a name="l01085"></a>01085 
<a name="l01086"></a>01086         <span class="comment">/*</span>
<a name="l01087"></a>01087 <span class="comment">         * Process entries in the inactive portion of the non-periodic</span>
<a name="l01088"></a>01088 <span class="comment">         * schedule. Some free host channels may not be used if they are</span>
<a name="l01089"></a>01089 <span class="comment">         * reserved for periodic transfers.</span>
<a name="l01090"></a>01090 <span class="comment">         */</span>
<a name="l01091"></a>01091         qh_ptr = hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#64c96c47a36d71bad6e4360cec9d07ad">non_periodic_sched_inactive</a>.next;
<a name="l01092"></a>01092         num_channels = hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#63ffc9b8e36340bd59bf1fab9ca490ad">core_params</a>-&gt;<a class="code" href="structdwc__otg__core__params.html#c1b433c6965aa7d48f6ca6818c592039">host_channels</a>;
<a name="l01093"></a>01093         <span class="keywordflow">while</span> (qh_ptr != &amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#64c96c47a36d71bad6e4360cec9d07ad">non_periodic_sched_inactive</a> &amp;&amp;
<a name="l01094"></a>01094                (hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e7fff26b5cce7c6c520c89f9e3c75617">non_periodic_channels</a> &lt;
<a name="l01095"></a>01095                 num_channels - hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#5754b87bd4644fbb7b90cf843c638f1c">periodic_channels</a>) &amp;&amp;
<a name="l01096"></a>01096                !DWC_CIRCLEQ_EMPTY(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#1761f2e6b8f6ba82c0e0c4e561813f0f">free_hc_list</a>)) {
<a name="l01097"></a>01097 
<a name="l01098"></a>01098                 qh = DWC_LIST_ENTRY(qh_ptr, <a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a>, qh_list_entry);
<a name="l01099"></a>01099 
<a name="l01100"></a>01100                 <a class="code" href="dwc__otg__hcd_8c.html#08cefee3729196462fe6a7608046652c">assign_and_init_hc</a>(hcd, qh);
<a name="l01101"></a>01101 
<a name="l01102"></a>01102                 <span class="comment">/*</span>
<a name="l01103"></a>01103 <span class="comment">                 * Move the QH from the non-periodic inactive schedule to the</span>
<a name="l01104"></a>01104 <span class="comment">                 * non-periodic active schedule.</span>
<a name="l01105"></a>01105 <span class="comment">                 */</span>
<a name="l01106"></a>01106                 qh_ptr = DWC_LIST_NEXT(qh_ptr);
<a name="l01107"></a>01107                 DWC_LIST_MOVE_HEAD(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#ffa3041ad517da9519aa2159cdec3f61">non_periodic_sched_active</a>,
<a name="l01108"></a>01108                                    &amp;qh-&gt;<a class="code" href="structdwc__otg__qh.html#3e1cb9863dc72139e1832c04244c25ff">qh_list_entry</a>);
<a name="l01109"></a>01109 
<a name="l01110"></a>01110                 <span class="keywordflow">if</span> (ret_val == DWC_OTG_TRANSACTION_NONE) {
<a name="l01111"></a>01111                         ret_val = DWC_OTG_TRANSACTION_NON_PERIODIC;
<a name="l01112"></a>01112                 } <span class="keywordflow">else</span> {
<a name="l01113"></a>01113                         ret_val = DWC_OTG_TRANSACTION_ALL;
<a name="l01114"></a>01114                 }
<a name="l01115"></a>01115 
<a name="l01116"></a>01116                 hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e7fff26b5cce7c6c520c89f9e3c75617">non_periodic_channels</a>++;
<a name="l01117"></a>01117         }
<a name="l01118"></a>01118 
<a name="l01119"></a>01119         <span class="keywordflow">return</span> ret_val;
<a name="l01120"></a>01120 }
<a name="l01139"></a><a class="code" href="dwc__otg__hcd_8c.html#8c7cd2f81cf41dbf3158f49b1d82a4f8">01139</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__hcd_8c.html#8c7cd2f81cf41dbf3158f49b1d82a4f8">queue_transaction</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd,
<a name="l01140"></a>01140                              <a class="code" href="structdwc__hc.html">dwc_hc_t</a> * hc, uint16_t fifo_dwords_avail)
<a name="l01141"></a>01141 {
<a name="l01142"></a>01142         <span class="keywordtype">int</span> retval;
<a name="l01143"></a>01143 
<a name="l01144"></a>01144         <span class="keywordflow">if</span> (hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#5ade18c62c5101c603247691d3047a19">dma_enable</a>) {
<a name="l01145"></a>01145                 <span class="keywordflow">if</span> (hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#7e3b96c6167eceeeb1090798f8297f1f">dma_desc_enable</a>) {
<a name="l01146"></a>01146                         <span class="keywordflow">if</span> (!hc-&gt;<a class="code" href="structdwc__hc.html#78a1cf134604b24bfdedb4f4df9f2c1f">xfer_started</a> || (hc-&gt;<a class="code" href="structdwc__hc.html#e6169fbc92e4d79686097742ad646f5c">ep_type</a> == <a class="code" href="dwc__otg__cil_8h.html#152a3a5e1433bd2197672f0b5105e7a4">DWC_OTG_EP_TYPE_ISOC</a>)) {       
<a name="l01147"></a>01147                                 <a class="code" href="dwc__otg__hcd_8h.html#9b051bad5e81a6b6d74b817c741bfaf3">dwc_otg_hcd_start_xfer_ddma</a>(hcd, hc-&gt;<a class="code" href="structdwc__hc.html#d338f8db131745d9921f51c30f26cd3c">qh</a>);
<a name="l01148"></a>01148                                 hc-&gt;<a class="code" href="structdwc__hc.html#d338f8db131745d9921f51c30f26cd3c">qh</a>-&gt;<a class="code" href="structdwc__otg__qh.html#2c115474978a808c797c8975d72e419d">ping_state</a> = 0;
<a name="l01149"></a>01149                         }
<a name="l01150"></a>01150                 }
<a name="l01151"></a>01151                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!hc-&gt;<a class="code" href="structdwc__hc.html#78a1cf134604b24bfdedb4f4df9f2c1f">xfer_started</a>) {
<a name="l01152"></a>01152                         <a class="code" href="dwc__otg__cil_8c.html#025af79d6a2255dba4578588be510444">dwc_otg_hc_start_transfer</a>(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>, hc);
<a name="l01153"></a>01153                         hc-&gt;<a class="code" href="structdwc__hc.html#d338f8db131745d9921f51c30f26cd3c">qh</a>-&gt;<a class="code" href="structdwc__otg__qh.html#2c115474978a808c797c8975d72e419d">ping_state</a> = 0;
<a name="l01154"></a>01154                 }
<a name="l01155"></a>01155                 retval = 0;
<a name="l01156"></a>01156         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (hc-&gt;<a class="code" href="structdwc__hc.html#2177dcde6dbb17b6bc7d0fb34e8ec95a">halt_pending</a>) {
<a name="l01157"></a>01157                 <span class="comment">/* Don't queue a request if the channel has been halted. */</span>
<a name="l01158"></a>01158                 retval = 0;
<a name="l01159"></a>01159         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (hc-&gt;<a class="code" href="structdwc__hc.html#c3b27b33fae73aff43a9834a1ed585da">halt_on_queue</a>) {
<a name="l01160"></a>01160                 <a class="code" href="dwc__otg__cil_8c.html#de044bf6b96c1bac92259a447ae85c0f">dwc_otg_hc_halt</a>(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>, hc, hc-&gt;<a class="code" href="structdwc__hc.html#07eca0fa02105ddaa1719387f5558b23">halt_status</a>);
<a name="l01161"></a>01161                 retval = 0;
<a name="l01162"></a>01162         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (hc-&gt;<a class="code" href="structdwc__hc.html#ae7184275dbb23b3a5d2af20ed224920">do_ping</a>) {
<a name="l01163"></a>01163                 <span class="keywordflow">if</span> (!hc-&gt;<a class="code" href="structdwc__hc.html#78a1cf134604b24bfdedb4f4df9f2c1f">xfer_started</a>) {
<a name="l01164"></a>01164                         <a class="code" href="dwc__otg__cil_8c.html#025af79d6a2255dba4578588be510444">dwc_otg_hc_start_transfer</a>(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>, hc);
<a name="l01165"></a>01165                 }
<a name="l01166"></a>01166                 retval = 0;
<a name="l01167"></a>01167         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!hc-&gt;<a class="code" href="structdwc__hc.html#c5088d431f5efc382121f201f5d571aa">ep_is_in</a> || hc-&gt;<a class="code" href="structdwc__hc.html#513427c5e8c4603ba344d4e7f9191064">data_pid_start</a> == <a class="code" href="dwc__otg__cil_8h.html#8d329f92a5ff6f9a72fc755b6b1a4e17">DWC_OTG_HC_PID_SETUP</a>) {
<a name="l01168"></a>01168                 <span class="keywordflow">if</span> ((fifo_dwords_avail * 4) &gt;= hc-&gt;<a class="code" href="structdwc__hc.html#bd88f02eb286ba01d8d1b049e8975ccb">max_packet</a>) {
<a name="l01169"></a>01169                         <span class="keywordflow">if</span> (!hc-&gt;<a class="code" href="structdwc__hc.html#78a1cf134604b24bfdedb4f4df9f2c1f">xfer_started</a>) {
<a name="l01170"></a>01170                                 <a class="code" href="dwc__otg__cil_8c.html#025af79d6a2255dba4578588be510444">dwc_otg_hc_start_transfer</a>(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>, hc);
<a name="l01171"></a>01171                                 retval = 1;
<a name="l01172"></a>01172                         } <span class="keywordflow">else</span> {
<a name="l01173"></a>01173                                 retval =
<a name="l01174"></a>01174                                     <a class="code" href="dwc__otg__cil_8c.html#d848c41cdd739edd9271e1e207af9c9c">dwc_otg_hc_continue_transfer</a>(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>,
<a name="l01175"></a>01175                                                                  hc);
<a name="l01176"></a>01176                         }
<a name="l01177"></a>01177                 } <span class="keywordflow">else</span> {
<a name="l01178"></a>01178                         retval = -1;
<a name="l01179"></a>01179                 }
<a name="l01180"></a>01180         } <span class="keywordflow">else</span> {
<a name="l01181"></a>01181                 <span class="keywordflow">if</span> (!hc-&gt;<a class="code" href="structdwc__hc.html#78a1cf134604b24bfdedb4f4df9f2c1f">xfer_started</a>) {
<a name="l01182"></a>01182                         <a class="code" href="dwc__otg__cil_8c.html#025af79d6a2255dba4578588be510444">dwc_otg_hc_start_transfer</a>(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>, hc);
<a name="l01183"></a>01183                         retval = 1;
<a name="l01184"></a>01184                 } <span class="keywordflow">else</span> {
<a name="l01185"></a>01185                         retval = <a class="code" href="dwc__otg__cil_8c.html#d848c41cdd739edd9271e1e207af9c9c">dwc_otg_hc_continue_transfer</a>(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>, hc);
<a name="l01186"></a>01186                 }
<a name="l01187"></a>01187         }
<a name="l01188"></a>01188 
<a name="l01189"></a>01189         <span class="keywordflow">return</span> retval;
<a name="l01190"></a>01190 }
<a name="l01191"></a>01191 
<a name="l01199"></a><a class="code" href="dwc__otg__hcd_8c.html#00876268eb53e5ce91dbedcb026181ec">01199</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__hcd_8c.html#00876268eb53e5ce91dbedcb026181ec">process_periodic_channels</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd)
<a name="l01200"></a>01200 {
<a name="l01201"></a>01201         <a class="code" href="unionhptxsts__data.html">hptxsts_data_t</a> tx_status;
<a name="l01202"></a>01202         dwc_list_link_t *qh_ptr;
<a name="l01203"></a>01203         <a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a> *qh;
<a name="l01204"></a>01204         <span class="keywordtype">int</span> <a class="code" href="structdwc__otg__hcd__iso__packet__desc.html#d070772c24621c47b49ad21c6acadb94">status</a>;
<a name="l01205"></a>01205         <span class="keywordtype">int</span> no_queue_space = 0;
<a name="l01206"></a>01206         <span class="keywordtype">int</span> no_fifo_space = 0;
<a name="l01207"></a>01207 
<a name="l01208"></a>01208         <a class="code" href="structdwc__otg__host__global__regs.html">dwc_otg_host_global_regs_t</a> *host_regs;
<a name="l01209"></a>01209         host_regs = hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#51bac71891b5f6f435d7fc4582b974c1">host_if</a>-&gt;<a class="code" href="structdwc__otg__host__if.html#ff9692c2e10ca2bc7e24f981f25179c2">host_global_regs</a>;
<a name="l01210"></a>01210 
<a name="l01211"></a>01211         <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#39931d908ba215b3d5d590e42d8408b5">DBG_HCDV</a>, <span class="stringliteral">"Queue periodic transactions\n"</span>);
<a name="l01212"></a>01212 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l01213"></a>01213 <span class="preprocessor"></span>        tx_status.<a class="code" href="unionhptxsts__data.html#b48d41d449d8f71c0b184b38029c26bc">d32</a> = dwc_read_reg32(&amp;host_regs-&gt;<a class="code" href="structdwc__otg__host__global__regs.html#bf1a1528a2e479d86318d49ecd52ee40">hptxsts</a>);
<a name="l01214"></a>01214         <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#39931d908ba215b3d5d590e42d8408b5">DBG_HCDV</a>,
<a name="l01215"></a>01215                     <span class="stringliteral">"  P Tx Req Queue Space Avail (before queue): %d\n"</span>,
<a name="l01216"></a>01216                     tx_status.<a class="code" href="unionhptxsts__data.html#a6839185cc4aeabf771f04f1b2a97ec3">b</a>.<a class="code" href="unionhptxsts__data.html#8139e6eafb7b0bbb3cbafa125d5cd28f">ptxqspcavail</a>);
<a name="l01217"></a>01217         <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#39931d908ba215b3d5d590e42d8408b5">DBG_HCDV</a>, <span class="stringliteral">"  P Tx FIFO Space Avail (before queue): %d\n"</span>,
<a name="l01218"></a>01218                     tx_status.<a class="code" href="unionhptxsts__data.html#a6839185cc4aeabf771f04f1b2a97ec3">b</a>.<a class="code" href="unionhptxsts__data.html#0df6fb1f76396da626715d6ffc06dfa8">ptxfspcavail</a>);
<a name="l01219"></a>01219 <span class="preprocessor">#endif</span>
<a name="l01220"></a>01220 <span class="preprocessor"></span>
<a name="l01221"></a>01221         qh_ptr = hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#4b8deae798f771135c4a99693b26873f">periodic_sched_assigned</a>.next;
<a name="l01222"></a>01222         <span class="keywordflow">while</span> (qh_ptr != &amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#4b8deae798f771135c4a99693b26873f">periodic_sched_assigned</a>) {
<a name="l01223"></a>01223                 tx_status.<a class="code" href="unionhptxsts__data.html#b48d41d449d8f71c0b184b38029c26bc">d32</a> = dwc_read_reg32(&amp;host_regs-&gt;<a class="code" href="structdwc__otg__host__global__regs.html#bf1a1528a2e479d86318d49ecd52ee40">hptxsts</a>);
<a name="l01224"></a>01224                 <span class="keywordflow">if</span> (tx_status.<a class="code" href="unionhptxsts__data.html#a6839185cc4aeabf771f04f1b2a97ec3">b</a>.<a class="code" href="unionhptxsts__data.html#8139e6eafb7b0bbb3cbafa125d5cd28f">ptxqspcavail</a> == 0) {
<a name="l01225"></a>01225                         no_queue_space = 1;
<a name="l01226"></a>01226                         <span class="keywordflow">break</span>;
<a name="l01227"></a>01227                 }
<a name="l01228"></a>01228 
<a name="l01229"></a>01229                 qh = DWC_LIST_ENTRY(qh_ptr, <a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a>, qh_list_entry);
<a name="l01230"></a>01230 
<a name="l01231"></a>01231                 <span class="comment">/*</span>
<a name="l01232"></a>01232 <span class="comment">                 * Set a flag if we're queuing high-bandwidth in slave mode.</span>
<a name="l01233"></a>01233 <span class="comment">                 * The flag prevents any halts to get into the request queue in</span>
<a name="l01234"></a>01234 <span class="comment">                 * the middle of multiple high-bandwidth packets getting queued.</span>
<a name="l01235"></a>01235 <span class="comment">                 */</span>
<a name="l01236"></a>01236                 <span class="keywordflow">if</span> (!hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#5ade18c62c5101c603247691d3047a19">dma_enable</a> &amp;&amp; qh-&gt;<a class="code" href="structdwc__otg__qh.html#bbdb7d30b60b6c326301f33b35088bb4">channel</a>-&gt;<a class="code" href="structdwc__hc.html#9a01b904f7ccc7178cdb80c20e8a9b0c">multi_count</a> &gt; 1) {
<a name="l01237"></a>01237                         hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#5a6a90b40bc80e71d40f107b68f1e84c">queuing_high_bandwidth</a> = 1;
<a name="l01238"></a>01238                 }
<a name="l01239"></a>01239                 status =
<a name="l01240"></a>01240                     <a class="code" href="dwc__otg__hcd_8c.html#8c7cd2f81cf41dbf3158f49b1d82a4f8">queue_transaction</a>(hcd, qh-&gt;<a class="code" href="structdwc__otg__qh.html#bbdb7d30b60b6c326301f33b35088bb4">channel</a>,
<a name="l01241"></a>01241                                       tx_status.<a class="code" href="unionhptxsts__data.html#a6839185cc4aeabf771f04f1b2a97ec3">b</a>.<a class="code" href="unionhptxsts__data.html#0df6fb1f76396da626715d6ffc06dfa8">ptxfspcavail</a>);
<a name="l01242"></a>01242                 <span class="keywordflow">if</span> (status &lt; 0) {
<a name="l01243"></a>01243                         no_fifo_space = 1;
<a name="l01244"></a>01244                         <span class="keywordflow">break</span>;
<a name="l01245"></a>01245                 }
<a name="l01246"></a>01246 
<a name="l01247"></a>01247                 <span class="comment">/*</span>
<a name="l01248"></a>01248 <span class="comment">                 * In Slave mode, stay on the current transfer until there is</span>
<a name="l01249"></a>01249 <span class="comment">                 * nothing more to do or the high-bandwidth request count is</span>
<a name="l01250"></a>01250 <span class="comment">                 * reached. In DMA mode, only need to queue one request. The</span>
<a name="l01251"></a>01251 <span class="comment">                 * controller automatically handles multiple packets for</span>
<a name="l01252"></a>01252 <span class="comment">                 * high-bandwidth transfers.</span>
<a name="l01253"></a>01253 <span class="comment">                 */</span>
<a name="l01254"></a>01254                 <span class="keywordflow">if</span> (hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#5ade18c62c5101c603247691d3047a19">dma_enable</a> || status == 0 ||
<a name="l01255"></a>01255                     qh-&gt;<a class="code" href="structdwc__otg__qh.html#bbdb7d30b60b6c326301f33b35088bb4">channel</a>-&gt;<a class="code" href="structdwc__hc.html#961e8eae7a18c503e370c4bc513d3e55">requests</a> == qh-&gt;<a class="code" href="structdwc__otg__qh.html#bbdb7d30b60b6c326301f33b35088bb4">channel</a>-&gt;<a class="code" href="structdwc__hc.html#9a01b904f7ccc7178cdb80c20e8a9b0c">multi_count</a>) {
<a name="l01256"></a>01256                         qh_ptr = qh_ptr-&gt;next;
<a name="l01257"></a>01257                         <span class="comment">/*</span>
<a name="l01258"></a>01258 <span class="comment">                         * Move the QH from the periodic assigned schedule to</span>
<a name="l01259"></a>01259 <span class="comment">                         * the periodic queued schedule.</span>
<a name="l01260"></a>01260 <span class="comment">                         */</span>
<a name="l01261"></a>01261                         DWC_LIST_MOVE_HEAD(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e127912880eb487b3a2f38778c0de238">periodic_sched_queued</a>,
<a name="l01262"></a>01262                                            &amp;qh-&gt;<a class="code" href="structdwc__otg__qh.html#3e1cb9863dc72139e1832c04244c25ff">qh_list_entry</a>);
<a name="l01263"></a>01263 
<a name="l01264"></a>01264                         <span class="comment">/* done queuing high bandwidth */</span>
<a name="l01265"></a>01265                         hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#5a6a90b40bc80e71d40f107b68f1e84c">queuing_high_bandwidth</a> = 0;
<a name="l01266"></a>01266                 }
<a name="l01267"></a>01267         }
<a name="l01268"></a>01268 
<a name="l01269"></a>01269         <span class="keywordflow">if</span> (!hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#5ade18c62c5101c603247691d3047a19">dma_enable</a>) {
<a name="l01270"></a>01270                 <a class="code" href="structdwc__otg__core__global__regs.html">dwc_otg_core_global_regs_t</a> *global_regs;
<a name="l01271"></a>01271                 <a class="code" href="uniongintmsk__data.html">gintmsk_data_t</a> intr_mask = {.d32 = 0 };
<a name="l01272"></a>01272 
<a name="l01273"></a>01273                 global_regs = hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#909eae7e3b9432ca1e278b99f7811f52">core_global_regs</a>;
<a name="l01274"></a>01274                 intr_mask.<a class="code" href="uniongintmsk__data.html#6f9ac3edb378165675a3203f555aa8d6">b</a>.<a class="code" href="uniongintmsk__data.html#3b52444894e041c660c146af2178272f">ptxfempty</a> = 1;
<a name="l01275"></a>01275 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l01276"></a>01276 <span class="preprocessor"></span>                tx_status.<a class="code" href="unionhptxsts__data.html#b48d41d449d8f71c0b184b38029c26bc">d32</a> = dwc_read_reg32(&amp;host_regs-&gt;<a class="code" href="structdwc__otg__host__global__regs.html#bf1a1528a2e479d86318d49ecd52ee40">hptxsts</a>);
<a name="l01277"></a>01277                 <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#39931d908ba215b3d5d590e42d8408b5">DBG_HCDV</a>,
<a name="l01278"></a>01278                             <span class="stringliteral">"  P Tx Req Queue Space Avail (after queue): %d\n"</span>,
<a name="l01279"></a>01279                             tx_status.<a class="code" href="unionhptxsts__data.html#a6839185cc4aeabf771f04f1b2a97ec3">b</a>.<a class="code" href="unionhptxsts__data.html#8139e6eafb7b0bbb3cbafa125d5cd28f">ptxqspcavail</a>);
<a name="l01280"></a>01280                 <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#39931d908ba215b3d5d590e42d8408b5">DBG_HCDV</a>,
<a name="l01281"></a>01281                             <span class="stringliteral">"  P Tx FIFO Space Avail (after queue): %d\n"</span>,
<a name="l01282"></a>01282                             tx_status.<a class="code" href="unionhptxsts__data.html#a6839185cc4aeabf771f04f1b2a97ec3">b</a>.<a class="code" href="unionhptxsts__data.html#0df6fb1f76396da626715d6ffc06dfa8">ptxfspcavail</a>);
<a name="l01283"></a>01283 <span class="preprocessor">#endif</span>
<a name="l01284"></a>01284 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (!DWC_LIST_EMPTY(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#4b8deae798f771135c4a99693b26873f">periodic_sched_assigned</a>) ||
<a name="l01285"></a>01285                     no_queue_space || no_fifo_space) {
<a name="l01286"></a>01286                         <span class="comment">/*</span>
<a name="l01287"></a>01287 <span class="comment">                         * May need to queue more transactions as the request</span>
<a name="l01288"></a>01288 <span class="comment">                         * queue or Tx FIFO empties. Enable the periodic Tx</span>
<a name="l01289"></a>01289 <span class="comment">                         * FIFO empty interrupt. (Always use the half-empty</span>
<a name="l01290"></a>01290 <span class="comment">                         * level to ensure that new requests are loaded as</span>
<a name="l01291"></a>01291 <span class="comment">                         * soon as possible.)</span>
<a name="l01292"></a>01292 <span class="comment">                         */</span>
<a name="l01293"></a>01293                         dwc_modify_reg32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#48827c76da2c6b18f369e2f2483cc4b6">gintmsk</a>, 0,
<a name="l01294"></a>01294                                          intr_mask.<a class="code" href="uniongintmsk__data.html#9c007bd53320f30b3cb06eb56b96673d">d32</a>);
<a name="l01295"></a>01295                 } <span class="keywordflow">else</span> {
<a name="l01296"></a>01296                         <span class="comment">/*</span>
<a name="l01297"></a>01297 <span class="comment">                         * Disable the Tx FIFO empty interrupt since there are</span>
<a name="l01298"></a>01298 <span class="comment">                         * no more transactions that need to be queued right</span>
<a name="l01299"></a>01299 <span class="comment">                         * now. This function is called from interrupt</span>
<a name="l01300"></a>01300 <span class="comment">                         * handlers to queue more transactions as transfer</span>
<a name="l01301"></a>01301 <span class="comment">                         * states change.</span>
<a name="l01302"></a>01302 <span class="comment">                         */</span>
<a name="l01303"></a>01303                         dwc_modify_reg32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#48827c76da2c6b18f369e2f2483cc4b6">gintmsk</a>, intr_mask.<a class="code" href="uniongintmsk__data.html#9c007bd53320f30b3cb06eb56b96673d">d32</a>,
<a name="l01304"></a>01304                                          0);
<a name="l01305"></a>01305                 }
<a name="l01306"></a>01306         }
<a name="l01307"></a>01307 }
<a name="l01308"></a>01308 
<a name="l01316"></a><a class="code" href="dwc__otg__hcd_8c.html#a3f28e8605fd652c5177962e5dc8b95a">01316</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__hcd_8c.html#a3f28e8605fd652c5177962e5dc8b95a">process_non_periodic_channels</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd)
<a name="l01317"></a>01317 {
<a name="l01318"></a>01318         <a class="code" href="uniongnptxsts__data.html">gnptxsts_data_t</a> tx_status;
<a name="l01319"></a>01319         dwc_list_link_t *orig_qh_ptr;
<a name="l01320"></a>01320         <a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a> *qh;
<a name="l01321"></a>01321         <span class="keywordtype">int</span> <a class="code" href="structdwc__otg__hcd__iso__packet__desc.html#d070772c24621c47b49ad21c6acadb94">status</a>;
<a name="l01322"></a>01322         <span class="keywordtype">int</span> no_queue_space = 0;
<a name="l01323"></a>01323         <span class="keywordtype">int</span> no_fifo_space = 0;
<a name="l01324"></a>01324         <span class="keywordtype">int</span> more_to_do = 0;
<a name="l01325"></a>01325 
<a name="l01326"></a>01326         <a class="code" href="structdwc__otg__core__global__regs.html">dwc_otg_core_global_regs_t</a> *global_regs =
<a name="l01327"></a>01327             hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#909eae7e3b9432ca1e278b99f7811f52">core_global_regs</a>;
<a name="l01328"></a>01328 
<a name="l01329"></a>01329         <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#39931d908ba215b3d5d590e42d8408b5">DBG_HCDV</a>, <span class="stringliteral">"Queue non-periodic transactions\n"</span>);
<a name="l01330"></a>01330 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l01331"></a>01331 <span class="preprocessor"></span>        tx_status.<a class="code" href="uniongnptxsts__data.html#a58b5adbe6bd0344c4f585ef6aba4672">d32</a> = dwc_read_reg32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#57dabea6f6e0bf9e1ee8e94f55b9e465">gnptxsts</a>);
<a name="l01332"></a>01332         <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#39931d908ba215b3d5d590e42d8408b5">DBG_HCDV</a>,
<a name="l01333"></a>01333                     <span class="stringliteral">"  NP Tx Req Queue Space Avail (before queue): %d\n"</span>,
<a name="l01334"></a>01334                     tx_status.<a class="code" href="uniongnptxsts__data.html#be1d1adf7b827616ebbbf6bf564c0738">b</a>.<a class="code" href="uniongnptxsts__data.html#634ffd5e84bc422ddef043574d8f0957">nptxqspcavail</a>);
<a name="l01335"></a>01335         <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#39931d908ba215b3d5d590e42d8408b5">DBG_HCDV</a>, <span class="stringliteral">"  NP Tx FIFO Space Avail (before queue): %d\n"</span>,
<a name="l01336"></a>01336                     tx_status.<a class="code" href="uniongnptxsts__data.html#be1d1adf7b827616ebbbf6bf564c0738">b</a>.<a class="code" href="uniongnptxsts__data.html#6c149be246bcf5ca5395f67e67648207">nptxfspcavail</a>);
<a name="l01337"></a>01337 <span class="preprocessor">#endif</span>
<a name="l01338"></a>01338 <span class="preprocessor"></span>        <span class="comment">/*</span>
<a name="l01339"></a>01339 <span class="comment">         * Keep track of the starting point. Skip over the start-of-list</span>
<a name="l01340"></a>01340 <span class="comment">         * entry.</span>
<a name="l01341"></a>01341 <span class="comment">         */</span>
<a name="l01342"></a>01342         <span class="keywordflow">if</span> (hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#01ab5791d6269b6b5d506f2113b94231">non_periodic_qh_ptr</a> == &amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#ffa3041ad517da9519aa2159cdec3f61">non_periodic_sched_active</a>) {
<a name="l01343"></a>01343                 hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#01ab5791d6269b6b5d506f2113b94231">non_periodic_qh_ptr</a> = hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#01ab5791d6269b6b5d506f2113b94231">non_periodic_qh_ptr</a>-&gt;next;
<a name="l01344"></a>01344         }
<a name="l01345"></a>01345         orig_qh_ptr = hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#01ab5791d6269b6b5d506f2113b94231">non_periodic_qh_ptr</a>;
<a name="l01346"></a>01346 
<a name="l01347"></a>01347         <span class="comment">/*</span>
<a name="l01348"></a>01348 <span class="comment">         * Process once through the active list or until no more space is</span>
<a name="l01349"></a>01349 <span class="comment">         * available in the request queue or the Tx FIFO.</span>
<a name="l01350"></a>01350 <span class="comment">         */</span>
<a name="l01351"></a>01351         <span class="keywordflow">do</span> {
<a name="l01352"></a>01352                 tx_status.<a class="code" href="uniongnptxsts__data.html#a58b5adbe6bd0344c4f585ef6aba4672">d32</a> = dwc_read_reg32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#57dabea6f6e0bf9e1ee8e94f55b9e465">gnptxsts</a>);
<a name="l01353"></a>01353                 <span class="keywordflow">if</span> (!hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#5ade18c62c5101c603247691d3047a19">dma_enable</a> &amp;&amp; tx_status.<a class="code" href="uniongnptxsts__data.html#be1d1adf7b827616ebbbf6bf564c0738">b</a>.<a class="code" href="uniongnptxsts__data.html#634ffd5e84bc422ddef043574d8f0957">nptxqspcavail</a> == 0) {
<a name="l01354"></a>01354                         no_queue_space = 1;
<a name="l01355"></a>01355                         <span class="keywordflow">break</span>;
<a name="l01356"></a>01356                 }
<a name="l01357"></a>01357 
<a name="l01358"></a>01358                 qh = DWC_LIST_ENTRY(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#01ab5791d6269b6b5d506f2113b94231">non_periodic_qh_ptr</a>, <a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a>,
<a name="l01359"></a>01359                                     qh_list_entry);
<a name="l01360"></a>01360                 status =
<a name="l01361"></a>01361                     <a class="code" href="dwc__otg__hcd_8c.html#8c7cd2f81cf41dbf3158f49b1d82a4f8">queue_transaction</a>(hcd, qh-&gt;<a class="code" href="structdwc__otg__qh.html#bbdb7d30b60b6c326301f33b35088bb4">channel</a>,
<a name="l01362"></a>01362                                       tx_status.<a class="code" href="uniongnptxsts__data.html#be1d1adf7b827616ebbbf6bf564c0738">b</a>.<a class="code" href="uniongnptxsts__data.html#6c149be246bcf5ca5395f67e67648207">nptxfspcavail</a>);
<a name="l01363"></a>01363 
<a name="l01364"></a>01364                 <span class="keywordflow">if</span> (status &gt; 0) {
<a name="l01365"></a>01365                         more_to_do = 1;
<a name="l01366"></a>01366                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (status &lt; 0) {
<a name="l01367"></a>01367                         no_fifo_space = 1;
<a name="l01368"></a>01368                         <span class="keywordflow">break</span>;
<a name="l01369"></a>01369                 }
<a name="l01370"></a>01370 
<a name="l01371"></a>01371                 <span class="comment">/* Advance to next QH, skipping start-of-list entry. */</span>
<a name="l01372"></a>01372                 hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#01ab5791d6269b6b5d506f2113b94231">non_periodic_qh_ptr</a> = hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#01ab5791d6269b6b5d506f2113b94231">non_periodic_qh_ptr</a>-&gt;next;
<a name="l01373"></a>01373                 <span class="keywordflow">if</span> (hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#01ab5791d6269b6b5d506f2113b94231">non_periodic_qh_ptr</a> == &amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#ffa3041ad517da9519aa2159cdec3f61">non_periodic_sched_active</a>) {
<a name="l01374"></a>01374                         hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#01ab5791d6269b6b5d506f2113b94231">non_periodic_qh_ptr</a> =
<a name="l01375"></a>01375                             hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#01ab5791d6269b6b5d506f2113b94231">non_periodic_qh_ptr</a>-&gt;next;
<a name="l01376"></a>01376                 }
<a name="l01377"></a>01377 
<a name="l01378"></a>01378         } <span class="keywordflow">while</span> (hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#01ab5791d6269b6b5d506f2113b94231">non_periodic_qh_ptr</a> != orig_qh_ptr);
<a name="l01379"></a>01379 
<a name="l01380"></a>01380         <span class="keywordflow">if</span> (!hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#5ade18c62c5101c603247691d3047a19">dma_enable</a>) {
<a name="l01381"></a>01381                 <a class="code" href="uniongintmsk__data.html">gintmsk_data_t</a> intr_mask = {.d32 = 0 };
<a name="l01382"></a>01382                 intr_mask.<a class="code" href="uniongintmsk__data.html#6f9ac3edb378165675a3203f555aa8d6">b</a>.<a class="code" href="uniongintmsk__data.html#2c395e7bef31a4d9b2d1a3257c601be4">nptxfempty</a> = 1;
<a name="l01383"></a>01383 
<a name="l01384"></a>01384 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l01385"></a>01385 <span class="preprocessor"></span>                tx_status.<a class="code" href="uniongnptxsts__data.html#a58b5adbe6bd0344c4f585ef6aba4672">d32</a> = dwc_read_reg32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#57dabea6f6e0bf9e1ee8e94f55b9e465">gnptxsts</a>);
<a name="l01386"></a>01386                 <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#39931d908ba215b3d5d590e42d8408b5">DBG_HCDV</a>,
<a name="l01387"></a>01387                             <span class="stringliteral">"  NP Tx Req Queue Space Avail (after queue): %d\n"</span>,
<a name="l01388"></a>01388                             tx_status.<a class="code" href="uniongnptxsts__data.html#be1d1adf7b827616ebbbf6bf564c0738">b</a>.<a class="code" href="uniongnptxsts__data.html#634ffd5e84bc422ddef043574d8f0957">nptxqspcavail</a>);
<a name="l01389"></a>01389                 <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#39931d908ba215b3d5d590e42d8408b5">DBG_HCDV</a>,
<a name="l01390"></a>01390                             <span class="stringliteral">"  NP Tx FIFO Space Avail (after queue): %d\n"</span>,
<a name="l01391"></a>01391                             tx_status.<a class="code" href="uniongnptxsts__data.html#be1d1adf7b827616ebbbf6bf564c0738">b</a>.<a class="code" href="uniongnptxsts__data.html#6c149be246bcf5ca5395f67e67648207">nptxfspcavail</a>);
<a name="l01392"></a>01392 <span class="preprocessor">#endif</span>
<a name="l01393"></a>01393 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (more_to_do || no_queue_space || no_fifo_space) {
<a name="l01394"></a>01394                         <span class="comment">/*</span>
<a name="l01395"></a>01395 <span class="comment">                         * May need to queue more transactions as the request</span>
<a name="l01396"></a>01396 <span class="comment">                         * queue or Tx FIFO empties. Enable the non-periodic</span>
<a name="l01397"></a>01397 <span class="comment">                         * Tx FIFO empty interrupt. (Always use the half-empty</span>
<a name="l01398"></a>01398 <span class="comment">                         * level to ensure that new requests are loaded as</span>
<a name="l01399"></a>01399 <span class="comment">                         * soon as possible.)</span>
<a name="l01400"></a>01400 <span class="comment">                         */</span>
<a name="l01401"></a>01401                         dwc_modify_reg32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#48827c76da2c6b18f369e2f2483cc4b6">gintmsk</a>, 0,
<a name="l01402"></a>01402                                          intr_mask.<a class="code" href="uniongintmsk__data.html#9c007bd53320f30b3cb06eb56b96673d">d32</a>);
<a name="l01403"></a>01403                 } <span class="keywordflow">else</span> {
<a name="l01404"></a>01404                         <span class="comment">/*</span>
<a name="l01405"></a>01405 <span class="comment">                         * Disable the Tx FIFO empty interrupt since there are</span>
<a name="l01406"></a>01406 <span class="comment">                         * no more transactions that need to be queued right</span>
<a name="l01407"></a>01407 <span class="comment">                         * now. This function is called from interrupt</span>
<a name="l01408"></a>01408 <span class="comment">                         * handlers to queue more transactions as transfer</span>
<a name="l01409"></a>01409 <span class="comment">                         * states change.</span>
<a name="l01410"></a>01410 <span class="comment">                         */</span>
<a name="l01411"></a>01411                         dwc_modify_reg32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#48827c76da2c6b18f369e2f2483cc4b6">gintmsk</a>, intr_mask.<a class="code" href="uniongintmsk__data.html#9c007bd53320f30b3cb06eb56b96673d">d32</a>,
<a name="l01412"></a>01412                                          0);
<a name="l01413"></a>01413                 }
<a name="l01414"></a>01414         }
<a name="l01415"></a>01415 }
<a name="l01416"></a>01416 
<a name="l01426"></a><a class="code" href="dwc__otg__hcd_8h.html#2f57bf2fc3013d63101f112702b913a0">01426</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__hcd_8c.html#2f57bf2fc3013d63101f112702b913a0">dwc_otg_hcd_queue_transactions</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd,
<a name="l01427"></a>01427                                            <a class="code" href="dwc__otg__hcd_8h.html#92c49783eebc5bcffa8b8a51c2127be9">dwc_otg_transaction_type_e</a> tr_type)
<a name="l01428"></a>01428 {
<a name="l01429"></a>01429 <span class="preprocessor">#ifdef DEBUG_SOF</span>
<a name="l01430"></a>01430 <span class="preprocessor"></span>        <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#e4a050e176c1c4f556da2b276a8c2b37">DBG_HCD</a>, <span class="stringliteral">"Queue Transactions\n"</span>);
<a name="l01431"></a>01431 <span class="preprocessor">#endif</span>
<a name="l01432"></a>01432 <span class="preprocessor"></span>        <span class="comment">/* Process host channels associated with periodic transfers. */</span>
<a name="l01433"></a>01433         <span class="keywordflow">if</span> ((tr_type == DWC_OTG_TRANSACTION_PERIODIC ||
<a name="l01434"></a>01434              tr_type == DWC_OTG_TRANSACTION_ALL) &amp;&amp;
<a name="l01435"></a>01435             !DWC_LIST_EMPTY(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#4b8deae798f771135c4a99693b26873f">periodic_sched_assigned</a>)) {
<a name="l01436"></a>01436 
<a name="l01437"></a>01437                 <a class="code" href="dwc__otg__hcd_8c.html#00876268eb53e5ce91dbedcb026181ec">process_periodic_channels</a>(hcd);
<a name="l01438"></a>01438         }
<a name="l01439"></a>01439 
<a name="l01440"></a>01440         <span class="comment">/* Process host channels associated with non-periodic transfers. */</span>
<a name="l01441"></a>01441         <span class="keywordflow">if</span> (tr_type == DWC_OTG_TRANSACTION_NON_PERIODIC ||
<a name="l01442"></a>01442             tr_type == DWC_OTG_TRANSACTION_ALL) {
<a name="l01443"></a>01443                 <span class="keywordflow">if</span> (!DWC_LIST_EMPTY(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#ffa3041ad517da9519aa2159cdec3f61">non_periodic_sched_active</a>)) {
<a name="l01444"></a>01444                         <a class="code" href="dwc__otg__hcd_8c.html#a3f28e8605fd652c5177962e5dc8b95a">process_non_periodic_channels</a>(hcd);
<a name="l01445"></a>01445                 } <span class="keywordflow">else</span> {
<a name="l01446"></a>01446                         <span class="comment">/*</span>
<a name="l01447"></a>01447 <span class="comment">                         * Ensure NP Tx FIFO empty interrupt is disabled when</span>
<a name="l01448"></a>01448 <span class="comment">                         * there are no non-periodic transfers to process.</span>
<a name="l01449"></a>01449 <span class="comment">                         */</span>
<a name="l01450"></a>01450                         <a class="code" href="uniongintmsk__data.html">gintmsk_data_t</a> gintmsk = {.d32 = 0 };
<a name="l01451"></a>01451                         gintmsk.<a class="code" href="uniongintmsk__data.html#6f9ac3edb378165675a3203f555aa8d6">b</a>.<a class="code" href="uniongintmsk__data.html#2c395e7bef31a4d9b2d1a3257c601be4">nptxfempty</a> = 1;
<a name="l01452"></a>01452                         dwc_modify_reg32(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#909eae7e3b9432ca1e278b99f7811f52">core_global_regs</a>-&gt;
<a name="l01453"></a>01453                                          gintmsk, gintmsk.<a class="code" href="uniongintmsk__data.html#9c007bd53320f30b3cb06eb56b96673d">d32</a>, 0);
<a name="l01454"></a>01454                 }
<a name="l01455"></a>01455         }
<a name="l01456"></a>01456 }
<a name="l01457"></a>01457  
<a name="l01458"></a>01458 <span class="preprocessor">#ifdef DWC_HS_ELECT_TST</span>
<a name="l01459"></a>01459 <span class="preprocessor"></span><span class="comment">/*</span>
<a name="l01460"></a>01460 <span class="comment"> * Quick and dirty hack to implement the HS Electrical Test</span>
<a name="l01461"></a>01461 <span class="comment"> * SINGLE_STEP_GET_DEVICE_DESCRIPTOR feature.</span>
<a name="l01462"></a>01462 <span class="comment"> *</span>
<a name="l01463"></a>01463 <span class="comment"> * This code was copied from our userspace app "hset". It sends a</span>
<a name="l01464"></a>01464 <span class="comment"> * Get Device Descriptor control sequence in two parts, first the</span>
<a name="l01465"></a>01465 <span class="comment"> * Setup packet by itself, followed some time later by the In and</span>
<a name="l01466"></a>01466 <span class="comment"> * Ack packets. Rather than trying to figure out how to add this</span>
<a name="l01467"></a>01467 <span class="comment"> * functionality to the normal driver code, we just hijack the</span>
<a name="l01468"></a>01468 <span class="comment"> * hardware, using these two function to drive the hardware</span>
<a name="l01469"></a>01469 <span class="comment"> * directly.</span>
<a name="l01470"></a>01470 <span class="comment"> */</span>
<a name="l01471"></a>01471 
<a name="l01472"></a>01472 <span class="keyword">static</span> <a class="code" href="structdwc__otg__core__global__regs.html">dwc_otg_core_global_regs_t</a> *global_regs;
<a name="l01473"></a>01473 <span class="keyword">static</span> <a class="code" href="structdwc__otg__host__global__regs.html">dwc_otg_host_global_regs_t</a> *hc_global_regs;
<a name="l01474"></a>01474 <span class="keyword">static</span> <a class="code" href="structdwc__otg__hc__regs.html">dwc_otg_hc_regs_t</a> *hc_regs;
<a name="l01475"></a>01475 <span class="keyword">static</span> uint32_t *data_fifo;
<a name="l01476"></a>01476 
<a name="l01477"></a>01477 <span class="keyword">static</span> <span class="keywordtype">void</span> do_setup(<span class="keywordtype">void</span>)
<a name="l01478"></a>01478 {
<a name="l01479"></a>01479         <a class="code" href="uniongintsts__data.html">gintsts_data_t</a> gintsts;
<a name="l01480"></a>01480         <a class="code" href="unionhctsiz__data.html">hctsiz_data_t</a> hctsiz;
<a name="l01481"></a>01481         <a class="code" href="unionhcchar__data.html">hcchar_data_t</a> hcchar;
<a name="l01482"></a>01482         <a class="code" href="unionhaint__data.html">haint_data_t</a> haint;
<a name="l01483"></a>01483         <a class="code" href="unionhcint__data.html">hcint_data_t</a> hcint;
<a name="l01484"></a>01484 
<a name="l01485"></a>01485         <span class="comment">/* Enable HAINTs */</span>
<a name="l01486"></a>01486         dwc_write_reg32(&amp;hc_global_regs-&gt;<a class="code" href="structdwc__otg__host__global__regs.html#317f5059d4c2dc91da041f5c0a4819fc">haintmsk</a>, 0x0001);
<a name="l01487"></a>01487 
<a name="l01488"></a>01488         <span class="comment">/* Enable HCINTs */</span>
<a name="l01489"></a>01489         dwc_write_reg32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#830aa61c1d4326823662168ea7359205">hcintmsk</a>, 0x04a3);
<a name="l01490"></a>01490 
<a name="l01491"></a>01491         <span class="comment">/* Read GINTSTS */</span>
<a name="l01492"></a>01492         gintsts.<a class="code" href="uniongintsts__data.html#379f34f5a95628b735e3a965f9cea12d">d32</a> = dwc_read_reg32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#aa1d909e3b0a60a56bf612968ff09019">gintsts</a>);
<a name="l01493"></a>01493 
<a name="l01494"></a>01494         <span class="comment">/* Read HAINT */</span>
<a name="l01495"></a>01495         haint.<a class="code" href="unionhaint__data.html#c83834650d2981b44274a89dda63a0f5">d32</a> = dwc_read_reg32(&amp;hc_global_regs-&gt;<a class="code" href="structdwc__otg__host__global__regs.html#7c41808b0a69ed7d2125eb3afbbf6c14">haint</a>);
<a name="l01496"></a>01496 
<a name="l01497"></a>01497         <span class="comment">/* Read HCINT */</span>
<a name="l01498"></a>01498         hcint.<a class="code" href="unionhcint__data.html#05a82fa7693f875622db744716d7f73e">d32</a> = dwc_read_reg32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#0dfd5bae537d58e13788508dc719480d">hcint</a>);
<a name="l01499"></a>01499 
<a name="l01500"></a>01500         <span class="comment">/* Read HCCHAR */</span>
<a name="l01501"></a>01501         hcchar.<a class="code" href="unionhcchar__data.html#03d352fb421ab5c11bf9afaae4933ba4">d32</a> = dwc_read_reg32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#3d8bdf7979ea6dd5ba01858aca7a1c02">hcchar</a>);
<a name="l01502"></a>01502 
<a name="l01503"></a>01503         <span class="comment">/* Clear HCINT */</span>
<a name="l01504"></a>01504         dwc_write_reg32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#0dfd5bae537d58e13788508dc719480d">hcint</a>, hcint.<a class="code" href="unionhcint__data.html#05a82fa7693f875622db744716d7f73e">d32</a>);
<a name="l01505"></a>01505 
<a name="l01506"></a>01506         <span class="comment">/* Clear HAINT */</span>
<a name="l01507"></a>01507         dwc_write_reg32(&amp;hc_global_regs-&gt;<a class="code" href="structdwc__otg__host__global__regs.html#7c41808b0a69ed7d2125eb3afbbf6c14">haint</a>, haint.<a class="code" href="unionhaint__data.html#c83834650d2981b44274a89dda63a0f5">d32</a>);
<a name="l01508"></a>01508 
<a name="l01509"></a>01509         <span class="comment">/* Clear GINTSTS */</span>
<a name="l01510"></a>01510         dwc_write_reg32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#aa1d909e3b0a60a56bf612968ff09019">gintsts</a>, gintsts.<a class="code" href="uniongintsts__data.html#379f34f5a95628b735e3a965f9cea12d">d32</a>);
<a name="l01511"></a>01511 
<a name="l01512"></a>01512         <span class="comment">/* Read GINTSTS */</span>
<a name="l01513"></a>01513         gintsts.<a class="code" href="uniongintsts__data.html#379f34f5a95628b735e3a965f9cea12d">d32</a> = dwc_read_reg32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#aa1d909e3b0a60a56bf612968ff09019">gintsts</a>);
<a name="l01514"></a>01514 
<a name="l01515"></a>01515         <span class="comment">/*</span>
<a name="l01516"></a>01516 <span class="comment">         * Send Setup packet (Get Device Descriptor)</span>
<a name="l01517"></a>01517 <span class="comment">         */</span>
<a name="l01518"></a>01518 
<a name="l01519"></a>01519         <span class="comment">/* Make sure channel is disabled */</span>
<a name="l01520"></a>01520         hcchar.<a class="code" href="unionhcchar__data.html#03d352fb421ab5c11bf9afaae4933ba4">d32</a> = dwc_read_reg32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#3d8bdf7979ea6dd5ba01858aca7a1c02">hcchar</a>);
<a name="l01521"></a>01521         <span class="keywordflow">if</span> (hcchar.<a class="code" href="unionhcchar__data.html#231c3638b02200c477e402d977c31e51">b</a>.<a class="code" href="unionhcchar__data.html#994a5305780edb0c4fe159b6cc7b14ae">chen</a>) {
<a name="l01522"></a>01522                 hcchar.<a class="code" href="unionhcchar__data.html#231c3638b02200c477e402d977c31e51">b</a>.<a class="code" href="unionhcchar__data.html#73c9f7f3cc4036c72ef341d1d1d9c388">chdis</a> = 1;
<a name="l01523"></a>01523 <span class="comment">//              hcchar.b.chen = 1;</span>
<a name="l01524"></a>01524                 dwc_write_reg32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#3d8bdf7979ea6dd5ba01858aca7a1c02">hcchar</a>, hcchar.<a class="code" href="unionhcchar__data.html#03d352fb421ab5c11bf9afaae4933ba4">d32</a>);
<a name="l01525"></a>01525                 <span class="comment">//sleep(1);</span>
<a name="l01526"></a>01526                 dwc_mdelay(1000);
<a name="l01527"></a>01527 
<a name="l01528"></a>01528                 <span class="comment">/* Read GINTSTS */</span>
<a name="l01529"></a>01529                 gintsts.<a class="code" href="uniongintsts__data.html#379f34f5a95628b735e3a965f9cea12d">d32</a> = dwc_read_reg32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#aa1d909e3b0a60a56bf612968ff09019">gintsts</a>);
<a name="l01530"></a>01530 
<a name="l01531"></a>01531                 <span class="comment">/* Read HAINT */</span>
<a name="l01532"></a>01532                 haint.<a class="code" href="unionhaint__data.html#c83834650d2981b44274a89dda63a0f5">d32</a> = dwc_read_reg32(&amp;hc_global_regs-&gt;<a class="code" href="structdwc__otg__host__global__regs.html#7c41808b0a69ed7d2125eb3afbbf6c14">haint</a>);
<a name="l01533"></a>01533 
<a name="l01534"></a>01534                 <span class="comment">/* Read HCINT */</span>
<a name="l01535"></a>01535                 hcint.<a class="code" href="unionhcint__data.html#05a82fa7693f875622db744716d7f73e">d32</a> = dwc_read_reg32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#0dfd5bae537d58e13788508dc719480d">hcint</a>);
<a name="l01536"></a>01536 
<a name="l01537"></a>01537                 <span class="comment">/* Read HCCHAR */</span>
<a name="l01538"></a>01538                 hcchar.<a class="code" href="unionhcchar__data.html#03d352fb421ab5c11bf9afaae4933ba4">d32</a> = dwc_read_reg32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#3d8bdf7979ea6dd5ba01858aca7a1c02">hcchar</a>);
<a name="l01539"></a>01539 
<a name="l01540"></a>01540                 <span class="comment">/* Clear HCINT */</span>
<a name="l01541"></a>01541                 dwc_write_reg32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#0dfd5bae537d58e13788508dc719480d">hcint</a>, hcint.<a class="code" href="unionhcint__data.html#05a82fa7693f875622db744716d7f73e">d32</a>);
<a name="l01542"></a>01542 
<a name="l01543"></a>01543                 <span class="comment">/* Clear HAINT */</span>
<a name="l01544"></a>01544                 dwc_write_reg32(&amp;hc_global_regs-&gt;<a class="code" href="structdwc__otg__host__global__regs.html#7c41808b0a69ed7d2125eb3afbbf6c14">haint</a>, haint.<a class="code" href="unionhaint__data.html#c83834650d2981b44274a89dda63a0f5">d32</a>);
<a name="l01545"></a>01545 
<a name="l01546"></a>01546                 <span class="comment">/* Clear GINTSTS */</span>
<a name="l01547"></a>01547                 dwc_write_reg32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#aa1d909e3b0a60a56bf612968ff09019">gintsts</a>, gintsts.<a class="code" href="uniongintsts__data.html#379f34f5a95628b735e3a965f9cea12d">d32</a>);
<a name="l01548"></a>01548 
<a name="l01549"></a>01549                 hcchar.<a class="code" href="unionhcchar__data.html#03d352fb421ab5c11bf9afaae4933ba4">d32</a> = dwc_read_reg32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#3d8bdf7979ea6dd5ba01858aca7a1c02">hcchar</a>);
<a name="l01550"></a>01550         }
<a name="l01551"></a>01551 
<a name="l01552"></a>01552         <span class="comment">/* Set HCTSIZ */</span>
<a name="l01553"></a>01553         hctsiz.<a class="code" href="unionhctsiz__data.html#fb41950555c60c6015294bdefe9cd39d">d32</a> = 0;
<a name="l01554"></a>01554         hctsiz.<a class="code" href="unionhctsiz__data.html#8967fa90c651bce44a3cbe90c44cf638">b</a>.<a class="code" href="unionhctsiz__data.html#6ad01d874d77aa4382f71fa68eaec12d">xfersize</a> = 8;
<a name="l01555"></a>01555         hctsiz.<a class="code" href="unionhctsiz__data.html#8967fa90c651bce44a3cbe90c44cf638">b</a>.<a class="code" href="unionhctsiz__data.html#3ea18df5a98d33a6f8fa786252a0205b">pktcnt</a> = 1;
<a name="l01556"></a>01556         hctsiz.<a class="code" href="unionhctsiz__data.html#8967fa90c651bce44a3cbe90c44cf638">b</a>.<a class="code" href="unionhctsiz__data.html#d8b17af02c244e47ca0c38f933a6b3f0">pid</a> = <a class="code" href="dwc__otg__cil_8h.html#8d329f92a5ff6f9a72fc755b6b1a4e17">DWC_OTG_HC_PID_SETUP</a>;
<a name="l01557"></a>01557         dwc_write_reg32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#c6173f823ba754d9f9549422b6380ca2">hctsiz</a>, hctsiz.<a class="code" href="unionhctsiz__data.html#fb41950555c60c6015294bdefe9cd39d">d32</a>);
<a name="l01558"></a>01558 
<a name="l01559"></a>01559         <span class="comment">/* Set HCCHAR */</span>
<a name="l01560"></a>01560         hcchar.<a class="code" href="unionhcchar__data.html#03d352fb421ab5c11bf9afaae4933ba4">d32</a> = dwc_read_reg32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#3d8bdf7979ea6dd5ba01858aca7a1c02">hcchar</a>);
<a name="l01561"></a>01561         hcchar.<a class="code" href="unionhcchar__data.html#231c3638b02200c477e402d977c31e51">b</a>.<a class="code" href="unionhcchar__data.html#df4deee52d932ab29e5d077cde77cbfc">eptype</a> = <a class="code" href="dwc__otg__cil_8h.html#64e5cd756330f5adab79b25cc8067bdc">DWC_OTG_EP_TYPE_CONTROL</a>;
<a name="l01562"></a>01562         hcchar.<a class="code" href="unionhcchar__data.html#231c3638b02200c477e402d977c31e51">b</a>.<a class="code" href="unionhcchar__data.html#11f1b16e50f90806f90953bb979d4e77">epdir</a> = 0;
<a name="l01563"></a>01563         hcchar.<a class="code" href="unionhcchar__data.html#231c3638b02200c477e402d977c31e51">b</a>.<a class="code" href="unionhcchar__data.html#1597f36b85006e643aaf6f4d503bebc9">epnum</a> = 0;
<a name="l01564"></a>01564         hcchar.<a class="code" href="unionhcchar__data.html#231c3638b02200c477e402d977c31e51">b</a>.<a class="code" href="unionhcchar__data.html#47d11a5e62f69534d8ac0606aa7ffe7d">mps</a> = 8;
<a name="l01565"></a>01565         hcchar.<a class="code" href="unionhcchar__data.html#231c3638b02200c477e402d977c31e51">b</a>.<a class="code" href="unionhcchar__data.html#994a5305780edb0c4fe159b6cc7b14ae">chen</a> = 1;
<a name="l01566"></a>01566         dwc_write_reg32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#3d8bdf7979ea6dd5ba01858aca7a1c02">hcchar</a>, hcchar.<a class="code" href="unionhcchar__data.html#03d352fb421ab5c11bf9afaae4933ba4">d32</a>);
<a name="l01567"></a>01567 
<a name="l01568"></a>01568         <span class="comment">/* Fill FIFO with Setup data for Get Device Descriptor */</span>
<a name="l01569"></a>01569         data_fifo = (uint32_t *) ((<span class="keywordtype">char</span> *)global_regs + 0x1000);
<a name="l01570"></a>01570         dwc_write_reg32(data_fifo++, 0x01000680);
<a name="l01571"></a>01571         dwc_write_reg32(data_fifo++, 0x00080000);
<a name="l01572"></a>01572 
<a name="l01573"></a>01573         gintsts.<a class="code" href="uniongintsts__data.html#379f34f5a95628b735e3a965f9cea12d">d32</a> = dwc_read_reg32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#aa1d909e3b0a60a56bf612968ff09019">gintsts</a>);
<a name="l01574"></a>01574 
<a name="l01575"></a>01575         <span class="comment">/* Wait for host channel interrupt */</span>
<a name="l01576"></a>01576         <span class="keywordflow">do</span> {
<a name="l01577"></a>01577                 gintsts.<a class="code" href="uniongintsts__data.html#379f34f5a95628b735e3a965f9cea12d">d32</a> = dwc_read_reg32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#aa1d909e3b0a60a56bf612968ff09019">gintsts</a>);
<a name="l01578"></a>01578         } <span class="keywordflow">while</span> (gintsts.<a class="code" href="uniongintsts__data.html#781da5558468e5dbdc93ae95e4cb872e">b</a>.<a class="code" href="uniongintsts__data.html#e02f1a50b20ed1c4248fd76e155147e8">hcintr</a> == 0);
<a name="l01579"></a>01579 
<a name="l01580"></a>01580 
<a name="l01581"></a>01581         <span class="comment">/* Disable HCINTs */</span>
<a name="l01582"></a>01582         dwc_write_reg32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#830aa61c1d4326823662168ea7359205">hcintmsk</a>, 0x0000);
<a name="l01583"></a>01583 
<a name="l01584"></a>01584         <span class="comment">/* Disable HAINTs */</span>
<a name="l01585"></a>01585         dwc_write_reg32(&amp;hc_global_regs-&gt;<a class="code" href="structdwc__otg__host__global__regs.html#317f5059d4c2dc91da041f5c0a4819fc">haintmsk</a>, 0x0000);
<a name="l01586"></a>01586 
<a name="l01587"></a>01587         <span class="comment">/* Read HAINT */</span>
<a name="l01588"></a>01588         haint.<a class="code" href="unionhaint__data.html#c83834650d2981b44274a89dda63a0f5">d32</a> = dwc_read_reg32(&amp;hc_global_regs-&gt;<a class="code" href="structdwc__otg__host__global__regs.html#7c41808b0a69ed7d2125eb3afbbf6c14">haint</a>);
<a name="l01589"></a>01589 
<a name="l01590"></a>01590         <span class="comment">/* Read HCINT */</span>
<a name="l01591"></a>01591         hcint.<a class="code" href="unionhcint__data.html#05a82fa7693f875622db744716d7f73e">d32</a> = dwc_read_reg32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#0dfd5bae537d58e13788508dc719480d">hcint</a>);
<a name="l01592"></a>01592 
<a name="l01593"></a>01593         <span class="comment">/* Read HCCHAR */</span>
<a name="l01594"></a>01594         hcchar.<a class="code" href="unionhcchar__data.html#03d352fb421ab5c11bf9afaae4933ba4">d32</a> = dwc_read_reg32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#3d8bdf7979ea6dd5ba01858aca7a1c02">hcchar</a>);
<a name="l01595"></a>01595 
<a name="l01596"></a>01596         <span class="comment">/* Clear HCINT */</span>
<a name="l01597"></a>01597         dwc_write_reg32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#0dfd5bae537d58e13788508dc719480d">hcint</a>, hcint.<a class="code" href="unionhcint__data.html#05a82fa7693f875622db744716d7f73e">d32</a>);
<a name="l01598"></a>01598 
<a name="l01599"></a>01599         <span class="comment">/* Clear HAINT */</span>
<a name="l01600"></a>01600         dwc_write_reg32(&amp;hc_global_regs-&gt;<a class="code" href="structdwc__otg__host__global__regs.html#7c41808b0a69ed7d2125eb3afbbf6c14">haint</a>, haint.<a class="code" href="unionhaint__data.html#c83834650d2981b44274a89dda63a0f5">d32</a>);
<a name="l01601"></a>01601 
<a name="l01602"></a>01602         <span class="comment">/* Clear GINTSTS */</span>
<a name="l01603"></a>01603         dwc_write_reg32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#aa1d909e3b0a60a56bf612968ff09019">gintsts</a>, gintsts.<a class="code" href="uniongintsts__data.html#379f34f5a95628b735e3a965f9cea12d">d32</a>);
<a name="l01604"></a>01604 
<a name="l01605"></a>01605         <span class="comment">/* Read GINTSTS */</span>
<a name="l01606"></a>01606         gintsts.<a class="code" href="uniongintsts__data.html#379f34f5a95628b735e3a965f9cea12d">d32</a> = dwc_read_reg32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#aa1d909e3b0a60a56bf612968ff09019">gintsts</a>);
<a name="l01607"></a>01607 }
<a name="l01608"></a>01608 
<a name="l01609"></a>01609 <span class="keyword">static</span> <span class="keywordtype">void</span> do_in_ack(<span class="keywordtype">void</span>)
<a name="l01610"></a>01610 {
<a name="l01611"></a>01611         <a class="code" href="uniongintsts__data.html">gintsts_data_t</a> gintsts;
<a name="l01612"></a>01612         <a class="code" href="unionhctsiz__data.html">hctsiz_data_t</a> hctsiz;
<a name="l01613"></a>01613         <a class="code" href="unionhcchar__data.html">hcchar_data_t</a> hcchar;
<a name="l01614"></a>01614         <a class="code" href="unionhaint__data.html">haint_data_t</a> haint;
<a name="l01615"></a>01615         <a class="code" href="unionhcint__data.html">hcint_data_t</a> hcint;
<a name="l01616"></a>01616         <a class="code" href="unionhost__grxsts__data.html">host_grxsts_data_t</a> grxsts;
<a name="l01617"></a>01617 
<a name="l01618"></a>01618         <span class="comment">/* Enable HAINTs */</span>
<a name="l01619"></a>01619         dwc_write_reg32(&amp;hc_global_regs-&gt;<a class="code" href="structdwc__otg__host__global__regs.html#317f5059d4c2dc91da041f5c0a4819fc">haintmsk</a>, 0x0001);
<a name="l01620"></a>01620 
<a name="l01621"></a>01621         <span class="comment">/* Enable HCINTs */</span>
<a name="l01622"></a>01622         dwc_write_reg32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#830aa61c1d4326823662168ea7359205">hcintmsk</a>, 0x04a3);
<a name="l01623"></a>01623 
<a name="l01624"></a>01624         <span class="comment">/* Read GINTSTS */</span>
<a name="l01625"></a>01625         gintsts.<a class="code" href="uniongintsts__data.html#379f34f5a95628b735e3a965f9cea12d">d32</a> = dwc_read_reg32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#aa1d909e3b0a60a56bf612968ff09019">gintsts</a>);
<a name="l01626"></a>01626 
<a name="l01627"></a>01627         <span class="comment">/* Read HAINT */</span>
<a name="l01628"></a>01628         haint.<a class="code" href="unionhaint__data.html#c83834650d2981b44274a89dda63a0f5">d32</a> = dwc_read_reg32(&amp;hc_global_regs-&gt;<a class="code" href="structdwc__otg__host__global__regs.html#7c41808b0a69ed7d2125eb3afbbf6c14">haint</a>);
<a name="l01629"></a>01629 
<a name="l01630"></a>01630         <span class="comment">/* Read HCINT */</span>
<a name="l01631"></a>01631         hcint.<a class="code" href="unionhcint__data.html#05a82fa7693f875622db744716d7f73e">d32</a> = dwc_read_reg32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#0dfd5bae537d58e13788508dc719480d">hcint</a>);
<a name="l01632"></a>01632 
<a name="l01633"></a>01633         <span class="comment">/* Read HCCHAR */</span>
<a name="l01634"></a>01634         hcchar.<a class="code" href="unionhcchar__data.html#03d352fb421ab5c11bf9afaae4933ba4">d32</a> = dwc_read_reg32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#3d8bdf7979ea6dd5ba01858aca7a1c02">hcchar</a>);
<a name="l01635"></a>01635 
<a name="l01636"></a>01636         <span class="comment">/* Clear HCINT */</span>
<a name="l01637"></a>01637         dwc_write_reg32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#0dfd5bae537d58e13788508dc719480d">hcint</a>, hcint.<a class="code" href="unionhcint__data.html#05a82fa7693f875622db744716d7f73e">d32</a>);
<a name="l01638"></a>01638 
<a name="l01639"></a>01639         <span class="comment">/* Clear HAINT */</span>
<a name="l01640"></a>01640         dwc_write_reg32(&amp;hc_global_regs-&gt;<a class="code" href="structdwc__otg__host__global__regs.html#7c41808b0a69ed7d2125eb3afbbf6c14">haint</a>, haint.<a class="code" href="unionhaint__data.html#c83834650d2981b44274a89dda63a0f5">d32</a>);
<a name="l01641"></a>01641 
<a name="l01642"></a>01642         <span class="comment">/* Clear GINTSTS */</span>
<a name="l01643"></a>01643         dwc_write_reg32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#aa1d909e3b0a60a56bf612968ff09019">gintsts</a>, gintsts.<a class="code" href="uniongintsts__data.html#379f34f5a95628b735e3a965f9cea12d">d32</a>);
<a name="l01644"></a>01644 
<a name="l01645"></a>01645         <span class="comment">/* Read GINTSTS */</span>
<a name="l01646"></a>01646         gintsts.<a class="code" href="uniongintsts__data.html#379f34f5a95628b735e3a965f9cea12d">d32</a> = dwc_read_reg32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#aa1d909e3b0a60a56bf612968ff09019">gintsts</a>);
<a name="l01647"></a>01647 
<a name="l01648"></a>01648         <span class="comment">/*</span>
<a name="l01649"></a>01649 <span class="comment">         * Receive Control In packet</span>
<a name="l01650"></a>01650 <span class="comment">         */</span>
<a name="l01651"></a>01651 
<a name="l01652"></a>01652         <span class="comment">/* Make sure channel is disabled */</span>
<a name="l01653"></a>01653         hcchar.<a class="code" href="unionhcchar__data.html#03d352fb421ab5c11bf9afaae4933ba4">d32</a> = dwc_read_reg32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#3d8bdf7979ea6dd5ba01858aca7a1c02">hcchar</a>);
<a name="l01654"></a>01654         <span class="keywordflow">if</span> (hcchar.<a class="code" href="unionhcchar__data.html#231c3638b02200c477e402d977c31e51">b</a>.<a class="code" href="unionhcchar__data.html#994a5305780edb0c4fe159b6cc7b14ae">chen</a>) {
<a name="l01655"></a>01655                 hcchar.<a class="code" href="unionhcchar__data.html#231c3638b02200c477e402d977c31e51">b</a>.<a class="code" href="unionhcchar__data.html#73c9f7f3cc4036c72ef341d1d1d9c388">chdis</a> = 1;
<a name="l01656"></a>01656                 hcchar.<a class="code" href="unionhcchar__data.html#231c3638b02200c477e402d977c31e51">b</a>.<a class="code" href="unionhcchar__data.html#994a5305780edb0c4fe159b6cc7b14ae">chen</a> = 1;
<a name="l01657"></a>01657                 dwc_write_reg32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#3d8bdf7979ea6dd5ba01858aca7a1c02">hcchar</a>, hcchar.<a class="code" href="unionhcchar__data.html#03d352fb421ab5c11bf9afaae4933ba4">d32</a>);
<a name="l01658"></a>01658                 <span class="comment">//sleep(1);</span>
<a name="l01659"></a>01659                 dwc_mdelay(1000);
<a name="l01660"></a>01660 
<a name="l01661"></a>01661                 <span class="comment">/* Read GINTSTS */</span>
<a name="l01662"></a>01662                 gintsts.<a class="code" href="uniongintsts__data.html#379f34f5a95628b735e3a965f9cea12d">d32</a> = dwc_read_reg32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#aa1d909e3b0a60a56bf612968ff09019">gintsts</a>);
<a name="l01663"></a>01663 
<a name="l01664"></a>01664                 <span class="comment">/* Read HAINT */</span>
<a name="l01665"></a>01665                 haint.<a class="code" href="unionhaint__data.html#c83834650d2981b44274a89dda63a0f5">d32</a> = dwc_read_reg32(&amp;hc_global_regs-&gt;<a class="code" href="structdwc__otg__host__global__regs.html#7c41808b0a69ed7d2125eb3afbbf6c14">haint</a>);
<a name="l01666"></a>01666 
<a name="l01667"></a>01667                 <span class="comment">/* Read HCINT */</span>
<a name="l01668"></a>01668                 hcint.<a class="code" href="unionhcint__data.html#05a82fa7693f875622db744716d7f73e">d32</a> = dwc_read_reg32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#0dfd5bae537d58e13788508dc719480d">hcint</a>);
<a name="l01669"></a>01669 
<a name="l01670"></a>01670                 <span class="comment">/* Read HCCHAR */</span>
<a name="l01671"></a>01671                 hcchar.<a class="code" href="unionhcchar__data.html#03d352fb421ab5c11bf9afaae4933ba4">d32</a> = dwc_read_reg32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#3d8bdf7979ea6dd5ba01858aca7a1c02">hcchar</a>);
<a name="l01672"></a>01672 
<a name="l01673"></a>01673                 <span class="comment">/* Clear HCINT */</span>
<a name="l01674"></a>01674                 dwc_write_reg32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#0dfd5bae537d58e13788508dc719480d">hcint</a>, hcint.<a class="code" href="unionhcint__data.html#05a82fa7693f875622db744716d7f73e">d32</a>);
<a name="l01675"></a>01675 
<a name="l01676"></a>01676                 <span class="comment">/* Clear HAINT */</span>
<a name="l01677"></a>01677                 dwc_write_reg32(&amp;hc_global_regs-&gt;<a class="code" href="structdwc__otg__host__global__regs.html#7c41808b0a69ed7d2125eb3afbbf6c14">haint</a>, haint.<a class="code" href="unionhaint__data.html#c83834650d2981b44274a89dda63a0f5">d32</a>);
<a name="l01678"></a>01678 
<a name="l01679"></a>01679                 <span class="comment">/* Clear GINTSTS */</span>
<a name="l01680"></a>01680                 dwc_write_reg32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#aa1d909e3b0a60a56bf612968ff09019">gintsts</a>, gintsts.<a class="code" href="uniongintsts__data.html#379f34f5a95628b735e3a965f9cea12d">d32</a>);
<a name="l01681"></a>01681 
<a name="l01682"></a>01682                 hcchar.<a class="code" href="unionhcchar__data.html#03d352fb421ab5c11bf9afaae4933ba4">d32</a> = dwc_read_reg32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#3d8bdf7979ea6dd5ba01858aca7a1c02">hcchar</a>);
<a name="l01683"></a>01683         }
<a name="l01684"></a>01684 
<a name="l01685"></a>01685         <span class="comment">/* Set HCTSIZ */</span>
<a name="l01686"></a>01686         hctsiz.<a class="code" href="unionhctsiz__data.html#fb41950555c60c6015294bdefe9cd39d">d32</a> = 0;
<a name="l01687"></a>01687         hctsiz.<a class="code" href="unionhctsiz__data.html#8967fa90c651bce44a3cbe90c44cf638">b</a>.<a class="code" href="unionhctsiz__data.html#6ad01d874d77aa4382f71fa68eaec12d">xfersize</a> = 8;
<a name="l01688"></a>01688         hctsiz.<a class="code" href="unionhctsiz__data.html#8967fa90c651bce44a3cbe90c44cf638">b</a>.<a class="code" href="unionhctsiz__data.html#3ea18df5a98d33a6f8fa786252a0205b">pktcnt</a> = 1;
<a name="l01689"></a>01689         hctsiz.<a class="code" href="unionhctsiz__data.html#8967fa90c651bce44a3cbe90c44cf638">b</a>.<a class="code" href="unionhctsiz__data.html#d8b17af02c244e47ca0c38f933a6b3f0">pid</a> = <a class="code" href="dwc__otg__cil_8h.html#e623eb446c55928b324e9636111315e1">DWC_OTG_HC_PID_DATA1</a>;
<a name="l01690"></a>01690         dwc_write_reg32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#c6173f823ba754d9f9549422b6380ca2">hctsiz</a>, hctsiz.<a class="code" href="unionhctsiz__data.html#fb41950555c60c6015294bdefe9cd39d">d32</a>);
<a name="l01691"></a>01691 
<a name="l01692"></a>01692         <span class="comment">/* Set HCCHAR */</span>
<a name="l01693"></a>01693         hcchar.<a class="code" href="unionhcchar__data.html#03d352fb421ab5c11bf9afaae4933ba4">d32</a> = dwc_read_reg32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#3d8bdf7979ea6dd5ba01858aca7a1c02">hcchar</a>);
<a name="l01694"></a>01694         hcchar.<a class="code" href="unionhcchar__data.html#231c3638b02200c477e402d977c31e51">b</a>.<a class="code" href="unionhcchar__data.html#df4deee52d932ab29e5d077cde77cbfc">eptype</a> = <a class="code" href="dwc__otg__cil_8h.html#64e5cd756330f5adab79b25cc8067bdc">DWC_OTG_EP_TYPE_CONTROL</a>;
<a name="l01695"></a>01695         hcchar.<a class="code" href="unionhcchar__data.html#231c3638b02200c477e402d977c31e51">b</a>.<a class="code" href="unionhcchar__data.html#11f1b16e50f90806f90953bb979d4e77">epdir</a> = 1;
<a name="l01696"></a>01696         hcchar.<a class="code" href="unionhcchar__data.html#231c3638b02200c477e402d977c31e51">b</a>.<a class="code" href="unionhcchar__data.html#1597f36b85006e643aaf6f4d503bebc9">epnum</a> = 0;
<a name="l01697"></a>01697         hcchar.<a class="code" href="unionhcchar__data.html#231c3638b02200c477e402d977c31e51">b</a>.<a class="code" href="unionhcchar__data.html#47d11a5e62f69534d8ac0606aa7ffe7d">mps</a> = 8;
<a name="l01698"></a>01698         hcchar.<a class="code" href="unionhcchar__data.html#231c3638b02200c477e402d977c31e51">b</a>.<a class="code" href="unionhcchar__data.html#994a5305780edb0c4fe159b6cc7b14ae">chen</a> = 1;
<a name="l01699"></a>01699         dwc_write_reg32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#3d8bdf7979ea6dd5ba01858aca7a1c02">hcchar</a>, hcchar.<a class="code" href="unionhcchar__data.html#03d352fb421ab5c11bf9afaae4933ba4">d32</a>);
<a name="l01700"></a>01700 
<a name="l01701"></a>01701         gintsts.<a class="code" href="uniongintsts__data.html#379f34f5a95628b735e3a965f9cea12d">d32</a> = dwc_read_reg32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#aa1d909e3b0a60a56bf612968ff09019">gintsts</a>);
<a name="l01702"></a>01702 
<a name="l01703"></a>01703         <span class="comment">/* Wait for receive status queue interrupt */</span>
<a name="l01704"></a>01704         <span class="keywordflow">do</span> {
<a name="l01705"></a>01705                 gintsts.<a class="code" href="uniongintsts__data.html#379f34f5a95628b735e3a965f9cea12d">d32</a> = dwc_read_reg32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#aa1d909e3b0a60a56bf612968ff09019">gintsts</a>);
<a name="l01706"></a>01706         } <span class="keywordflow">while</span> (gintsts.<a class="code" href="uniongintsts__data.html#781da5558468e5dbdc93ae95e4cb872e">b</a>.<a class="code" href="uniongintsts__data.html#7595576956c3a0ced9ea387880943012">rxstsqlvl</a> == 0);
<a name="l01707"></a>01707 
<a name="l01708"></a>01708 
<a name="l01709"></a>01709         <span class="comment">/* Read RXSTS */</span>
<a name="l01710"></a>01710         grxsts.<a class="code" href="unionhost__grxsts__data.html#993969735da9c3615652391aae76359a">d32</a> = dwc_read_reg32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#763b05035799e1c16d34957fb62a2d17">grxstsp</a>);
<a name="l01711"></a>01711 
<a name="l01712"></a>01712         <span class="comment">/* Clear RXSTSQLVL in GINTSTS */</span>
<a name="l01713"></a>01713         gintsts.<a class="code" href="uniongintsts__data.html#379f34f5a95628b735e3a965f9cea12d">d32</a> = 0;
<a name="l01714"></a>01714         gintsts.<a class="code" href="uniongintsts__data.html#781da5558468e5dbdc93ae95e4cb872e">b</a>.<a class="code" href="uniongintsts__data.html#7595576956c3a0ced9ea387880943012">rxstsqlvl</a> = 1;
<a name="l01715"></a>01715         dwc_write_reg32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#aa1d909e3b0a60a56bf612968ff09019">gintsts</a>, gintsts.<a class="code" href="uniongintsts__data.html#379f34f5a95628b735e3a965f9cea12d">d32</a>);
<a name="l01716"></a>01716 
<a name="l01717"></a>01717         <span class="keywordflow">switch</span> (grxsts.<a class="code" href="unionhost__grxsts__data.html#9d67ba193008dd6afa7fe613c665238d">b</a>.<a class="code" href="unionhost__grxsts__data.html#6dc2553475a56a445c6e6f319feffac8">pktsts</a>) {
<a name="l01718"></a>01718         <span class="keywordflow">case</span> <a class="code" href="dwc__otg__regs_8h.html#d81c89ef7c3e40cfffe9ed08b7136e90">DWC_GRXSTS_PKTSTS_IN</a>:
<a name="l01719"></a>01719                 <span class="comment">/* Read the data into the host buffer */</span>
<a name="l01720"></a>01720                 <span class="keywordflow">if</span> (grxsts.<a class="code" href="unionhost__grxsts__data.html#9d67ba193008dd6afa7fe613c665238d">b</a>.<a class="code" href="unionhost__grxsts__data.html#026fd4d8ab68825fab038c083b8e9c60">bcnt</a> &gt; 0) {
<a name="l01721"></a>01721                         <span class="keywordtype">int</span> i;
<a name="l01722"></a>01722                         <span class="keywordtype">int</span> word_count = (grxsts.<a class="code" href="unionhost__grxsts__data.html#9d67ba193008dd6afa7fe613c665238d">b</a>.<a class="code" href="unionhost__grxsts__data.html#026fd4d8ab68825fab038c083b8e9c60">bcnt</a> + 3) / 4;
<a name="l01723"></a>01723 
<a name="l01724"></a>01724                         data_fifo = (uint32_t *) ((<span class="keywordtype">char</span> *)global_regs + 0x1000);
<a name="l01725"></a>01725 
<a name="l01726"></a>01726                         <span class="keywordflow">for</span> (i = 0; i &lt; word_count; i++) {
<a name="l01727"></a>01727                                 (<span class="keywordtype">void</span>)dwc_read_reg32(data_fifo++);
<a name="l01728"></a>01728                         }
<a name="l01729"></a>01729                 }
<a name="l01730"></a>01730                 <span class="keywordflow">break</span>;
<a name="l01731"></a>01731 
<a name="l01732"></a>01732         <span class="keywordflow">default</span>:
<a name="l01733"></a>01733                 <span class="keywordflow">break</span>;
<a name="l01734"></a>01734         }
<a name="l01735"></a>01735 
<a name="l01736"></a>01736         gintsts.<a class="code" href="uniongintsts__data.html#379f34f5a95628b735e3a965f9cea12d">d32</a> = dwc_read_reg32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#aa1d909e3b0a60a56bf612968ff09019">gintsts</a>);
<a name="l01737"></a>01737 
<a name="l01738"></a>01738         <span class="comment">/* Wait for receive status queue interrupt */</span>
<a name="l01739"></a>01739         <span class="keywordflow">do</span> {
<a name="l01740"></a>01740                 gintsts.<a class="code" href="uniongintsts__data.html#379f34f5a95628b735e3a965f9cea12d">d32</a> = dwc_read_reg32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#aa1d909e3b0a60a56bf612968ff09019">gintsts</a>);
<a name="l01741"></a>01741         } <span class="keywordflow">while</span> (gintsts.<a class="code" href="uniongintsts__data.html#781da5558468e5dbdc93ae95e4cb872e">b</a>.<a class="code" href="uniongintsts__data.html#7595576956c3a0ced9ea387880943012">rxstsqlvl</a> == 0);
<a name="l01742"></a>01742 
<a name="l01743"></a>01743 
<a name="l01744"></a>01744         <span class="comment">/* Read RXSTS */</span>
<a name="l01745"></a>01745         grxsts.<a class="code" href="unionhost__grxsts__data.html#993969735da9c3615652391aae76359a">d32</a> = dwc_read_reg32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#763b05035799e1c16d34957fb62a2d17">grxstsp</a>);
<a name="l01746"></a>01746 
<a name="l01747"></a>01747         <span class="comment">/* Clear RXSTSQLVL in GINTSTS */</span>
<a name="l01748"></a>01748         gintsts.<a class="code" href="uniongintsts__data.html#379f34f5a95628b735e3a965f9cea12d">d32</a> = 0;
<a name="l01749"></a>01749         gintsts.<a class="code" href="uniongintsts__data.html#781da5558468e5dbdc93ae95e4cb872e">b</a>.<a class="code" href="uniongintsts__data.html#7595576956c3a0ced9ea387880943012">rxstsqlvl</a> = 1;
<a name="l01750"></a>01750         dwc_write_reg32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#aa1d909e3b0a60a56bf612968ff09019">gintsts</a>, gintsts.<a class="code" href="uniongintsts__data.html#379f34f5a95628b735e3a965f9cea12d">d32</a>);
<a name="l01751"></a>01751 
<a name="l01752"></a>01752         <span class="keywordflow">switch</span> (grxsts.<a class="code" href="unionhost__grxsts__data.html#9d67ba193008dd6afa7fe613c665238d">b</a>.<a class="code" href="unionhost__grxsts__data.html#6dc2553475a56a445c6e6f319feffac8">pktsts</a>) {
<a name="l01753"></a>01753         <span class="keywordflow">case</span> <a class="code" href="dwc__otg__regs_8h.html#c5c019a36ea5cb66d3cb436292d8c3de">DWC_GRXSTS_PKTSTS_IN_XFER_COMP</a>:
<a name="l01754"></a>01754                 <span class="keywordflow">break</span>;
<a name="l01755"></a>01755 
<a name="l01756"></a>01756         <span class="keywordflow">default</span>:
<a name="l01757"></a>01757                 <span class="keywordflow">break</span>;
<a name="l01758"></a>01758         }
<a name="l01759"></a>01759 
<a name="l01760"></a>01760         gintsts.<a class="code" href="uniongintsts__data.html#379f34f5a95628b735e3a965f9cea12d">d32</a> = dwc_read_reg32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#aa1d909e3b0a60a56bf612968ff09019">gintsts</a>);
<a name="l01761"></a>01761 
<a name="l01762"></a>01762         <span class="comment">/* Wait for host channel interrupt */</span>
<a name="l01763"></a>01763         <span class="keywordflow">do</span> {
<a name="l01764"></a>01764                 gintsts.<a class="code" href="uniongintsts__data.html#379f34f5a95628b735e3a965f9cea12d">d32</a> = dwc_read_reg32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#aa1d909e3b0a60a56bf612968ff09019">gintsts</a>);
<a name="l01765"></a>01765         } <span class="keywordflow">while</span> (gintsts.<a class="code" href="uniongintsts__data.html#781da5558468e5dbdc93ae95e4cb872e">b</a>.<a class="code" href="uniongintsts__data.html#e02f1a50b20ed1c4248fd76e155147e8">hcintr</a> == 0);
<a name="l01766"></a>01766 
<a name="l01767"></a>01767 
<a name="l01768"></a>01768         <span class="comment">/* Read HAINT */</span>
<a name="l01769"></a>01769         haint.<a class="code" href="unionhaint__data.html#c83834650d2981b44274a89dda63a0f5">d32</a> = dwc_read_reg32(&amp;hc_global_regs-&gt;<a class="code" href="structdwc__otg__host__global__regs.html#7c41808b0a69ed7d2125eb3afbbf6c14">haint</a>);
<a name="l01770"></a>01770 
<a name="l01771"></a>01771         <span class="comment">/* Read HCINT */</span>
<a name="l01772"></a>01772         hcint.<a class="code" href="unionhcint__data.html#05a82fa7693f875622db744716d7f73e">d32</a> = dwc_read_reg32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#0dfd5bae537d58e13788508dc719480d">hcint</a>);
<a name="l01773"></a>01773 
<a name="l01774"></a>01774         <span class="comment">/* Read HCCHAR */</span>
<a name="l01775"></a>01775         hcchar.<a class="code" href="unionhcchar__data.html#03d352fb421ab5c11bf9afaae4933ba4">d32</a> = dwc_read_reg32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#3d8bdf7979ea6dd5ba01858aca7a1c02">hcchar</a>);
<a name="l01776"></a>01776 
<a name="l01777"></a>01777         <span class="comment">/* Clear HCINT */</span>
<a name="l01778"></a>01778         dwc_write_reg32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#0dfd5bae537d58e13788508dc719480d">hcint</a>, hcint.<a class="code" href="unionhcint__data.html#05a82fa7693f875622db744716d7f73e">d32</a>);
<a name="l01779"></a>01779 
<a name="l01780"></a>01780         <span class="comment">/* Clear HAINT */</span>
<a name="l01781"></a>01781         dwc_write_reg32(&amp;hc_global_regs-&gt;<a class="code" href="structdwc__otg__host__global__regs.html#7c41808b0a69ed7d2125eb3afbbf6c14">haint</a>, haint.<a class="code" href="unionhaint__data.html#c83834650d2981b44274a89dda63a0f5">d32</a>);
<a name="l01782"></a>01782 
<a name="l01783"></a>01783         <span class="comment">/* Clear GINTSTS */</span>
<a name="l01784"></a>01784         dwc_write_reg32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#aa1d909e3b0a60a56bf612968ff09019">gintsts</a>, gintsts.<a class="code" href="uniongintsts__data.html#379f34f5a95628b735e3a965f9cea12d">d32</a>);
<a name="l01785"></a>01785 
<a name="l01786"></a>01786         <span class="comment">/* Read GINTSTS */</span>
<a name="l01787"></a>01787         gintsts.<a class="code" href="uniongintsts__data.html#379f34f5a95628b735e3a965f9cea12d">d32</a> = dwc_read_reg32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#aa1d909e3b0a60a56bf612968ff09019">gintsts</a>);
<a name="l01788"></a>01788 
<a name="l01789"></a>01789 <span class="comment">//      usleep(100000);</span>
<a name="l01790"></a>01790 <span class="comment">//      mdelay(100);</span>
<a name="l01791"></a>01791         dwc_mdelay(1);
<a name="l01792"></a>01792 
<a name="l01793"></a>01793         <span class="comment">/*</span>
<a name="l01794"></a>01794 <span class="comment">         * Send handshake packet</span>
<a name="l01795"></a>01795 <span class="comment">         */</span>
<a name="l01796"></a>01796 
<a name="l01797"></a>01797         <span class="comment">/* Read HAINT */</span>
<a name="l01798"></a>01798         haint.<a class="code" href="unionhaint__data.html#c83834650d2981b44274a89dda63a0f5">d32</a> = dwc_read_reg32(&amp;hc_global_regs-&gt;<a class="code" href="structdwc__otg__host__global__regs.html#7c41808b0a69ed7d2125eb3afbbf6c14">haint</a>);
<a name="l01799"></a>01799 
<a name="l01800"></a>01800         <span class="comment">/* Read HCINT */</span>
<a name="l01801"></a>01801         hcint.<a class="code" href="unionhcint__data.html#05a82fa7693f875622db744716d7f73e">d32</a> = dwc_read_reg32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#0dfd5bae537d58e13788508dc719480d">hcint</a>);
<a name="l01802"></a>01802 
<a name="l01803"></a>01803         <span class="comment">/* Read HCCHAR */</span>
<a name="l01804"></a>01804         hcchar.<a class="code" href="unionhcchar__data.html#03d352fb421ab5c11bf9afaae4933ba4">d32</a> = dwc_read_reg32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#3d8bdf7979ea6dd5ba01858aca7a1c02">hcchar</a>);
<a name="l01805"></a>01805 
<a name="l01806"></a>01806         <span class="comment">/* Clear HCINT */</span>
<a name="l01807"></a>01807         dwc_write_reg32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#0dfd5bae537d58e13788508dc719480d">hcint</a>, hcint.<a class="code" href="unionhcint__data.html#05a82fa7693f875622db744716d7f73e">d32</a>);
<a name="l01808"></a>01808 
<a name="l01809"></a>01809         <span class="comment">/* Clear HAINT */</span>
<a name="l01810"></a>01810         dwc_write_reg32(&amp;hc_global_regs-&gt;<a class="code" href="structdwc__otg__host__global__regs.html#7c41808b0a69ed7d2125eb3afbbf6c14">haint</a>, haint.<a class="code" href="unionhaint__data.html#c83834650d2981b44274a89dda63a0f5">d32</a>);
<a name="l01811"></a>01811 
<a name="l01812"></a>01812         <span class="comment">/* Clear GINTSTS */</span>
<a name="l01813"></a>01813         dwc_write_reg32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#aa1d909e3b0a60a56bf612968ff09019">gintsts</a>, gintsts.<a class="code" href="uniongintsts__data.html#379f34f5a95628b735e3a965f9cea12d">d32</a>);
<a name="l01814"></a>01814 
<a name="l01815"></a>01815         <span class="comment">/* Read GINTSTS */</span>
<a name="l01816"></a>01816         gintsts.<a class="code" href="uniongintsts__data.html#379f34f5a95628b735e3a965f9cea12d">d32</a> = dwc_read_reg32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#aa1d909e3b0a60a56bf612968ff09019">gintsts</a>);
<a name="l01817"></a>01817 
<a name="l01818"></a>01818         <span class="comment">/* Make sure channel is disabled */</span>
<a name="l01819"></a>01819         hcchar.<a class="code" href="unionhcchar__data.html#03d352fb421ab5c11bf9afaae4933ba4">d32</a> = dwc_read_reg32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#3d8bdf7979ea6dd5ba01858aca7a1c02">hcchar</a>);
<a name="l01820"></a>01820         <span class="keywordflow">if</span> (hcchar.<a class="code" href="unionhcchar__data.html#231c3638b02200c477e402d977c31e51">b</a>.<a class="code" href="unionhcchar__data.html#994a5305780edb0c4fe159b6cc7b14ae">chen</a>) {
<a name="l01821"></a>01821                 hcchar.<a class="code" href="unionhcchar__data.html#231c3638b02200c477e402d977c31e51">b</a>.<a class="code" href="unionhcchar__data.html#73c9f7f3cc4036c72ef341d1d1d9c388">chdis</a> = 1;
<a name="l01822"></a>01822                 hcchar.<a class="code" href="unionhcchar__data.html#231c3638b02200c477e402d977c31e51">b</a>.<a class="code" href="unionhcchar__data.html#994a5305780edb0c4fe159b6cc7b14ae">chen</a> = 1;
<a name="l01823"></a>01823                 dwc_write_reg32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#3d8bdf7979ea6dd5ba01858aca7a1c02">hcchar</a>, hcchar.<a class="code" href="unionhcchar__data.html#03d352fb421ab5c11bf9afaae4933ba4">d32</a>);
<a name="l01824"></a>01824                 <span class="comment">//sleep(1);</span>
<a name="l01825"></a>01825                 dwc_mdelay(1000);
<a name="l01826"></a>01826 
<a name="l01827"></a>01827                 <span class="comment">/* Read GINTSTS */</span>
<a name="l01828"></a>01828                 gintsts.<a class="code" href="uniongintsts__data.html#379f34f5a95628b735e3a965f9cea12d">d32</a> = dwc_read_reg32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#aa1d909e3b0a60a56bf612968ff09019">gintsts</a>);
<a name="l01829"></a>01829 
<a name="l01830"></a>01830                 <span class="comment">/* Read HAINT */</span>
<a name="l01831"></a>01831                 haint.<a class="code" href="unionhaint__data.html#c83834650d2981b44274a89dda63a0f5">d32</a> = dwc_read_reg32(&amp;hc_global_regs-&gt;<a class="code" href="structdwc__otg__host__global__regs.html#7c41808b0a69ed7d2125eb3afbbf6c14">haint</a>);
<a name="l01832"></a>01832 
<a name="l01833"></a>01833                 <span class="comment">/* Read HCINT */</span>
<a name="l01834"></a>01834                 hcint.<a class="code" href="unionhcint__data.html#05a82fa7693f875622db744716d7f73e">d32</a> = dwc_read_reg32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#0dfd5bae537d58e13788508dc719480d">hcint</a>);
<a name="l01835"></a>01835 
<a name="l01836"></a>01836                 <span class="comment">/* Read HCCHAR */</span>
<a name="l01837"></a>01837                 hcchar.<a class="code" href="unionhcchar__data.html#03d352fb421ab5c11bf9afaae4933ba4">d32</a> = dwc_read_reg32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#3d8bdf7979ea6dd5ba01858aca7a1c02">hcchar</a>);
<a name="l01838"></a>01838 
<a name="l01839"></a>01839                 <span class="comment">/* Clear HCINT */</span>
<a name="l01840"></a>01840                 dwc_write_reg32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#0dfd5bae537d58e13788508dc719480d">hcint</a>, hcint.<a class="code" href="unionhcint__data.html#05a82fa7693f875622db744716d7f73e">d32</a>);
<a name="l01841"></a>01841 
<a name="l01842"></a>01842                 <span class="comment">/* Clear HAINT */</span>
<a name="l01843"></a>01843                 dwc_write_reg32(&amp;hc_global_regs-&gt;<a class="code" href="structdwc__otg__host__global__regs.html#7c41808b0a69ed7d2125eb3afbbf6c14">haint</a>, haint.<a class="code" href="unionhaint__data.html#c83834650d2981b44274a89dda63a0f5">d32</a>);
<a name="l01844"></a>01844 
<a name="l01845"></a>01845                 <span class="comment">/* Clear GINTSTS */</span>
<a name="l01846"></a>01846                 dwc_write_reg32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#aa1d909e3b0a60a56bf612968ff09019">gintsts</a>, gintsts.<a class="code" href="uniongintsts__data.html#379f34f5a95628b735e3a965f9cea12d">d32</a>);
<a name="l01847"></a>01847 
<a name="l01848"></a>01848                 hcchar.<a class="code" href="unionhcchar__data.html#03d352fb421ab5c11bf9afaae4933ba4">d32</a> = dwc_read_reg32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#3d8bdf7979ea6dd5ba01858aca7a1c02">hcchar</a>);
<a name="l01849"></a>01849         }
<a name="l01850"></a>01850 
<a name="l01851"></a>01851         <span class="comment">/* Set HCTSIZ */</span>
<a name="l01852"></a>01852         hctsiz.<a class="code" href="unionhctsiz__data.html#fb41950555c60c6015294bdefe9cd39d">d32</a> = 0;
<a name="l01853"></a>01853         hctsiz.<a class="code" href="unionhctsiz__data.html#8967fa90c651bce44a3cbe90c44cf638">b</a>.<a class="code" href="unionhctsiz__data.html#6ad01d874d77aa4382f71fa68eaec12d">xfersize</a> = 0;
<a name="l01854"></a>01854         hctsiz.<a class="code" href="unionhctsiz__data.html#8967fa90c651bce44a3cbe90c44cf638">b</a>.<a class="code" href="unionhctsiz__data.html#3ea18df5a98d33a6f8fa786252a0205b">pktcnt</a> = 1;
<a name="l01855"></a>01855         hctsiz.<a class="code" href="unionhctsiz__data.html#8967fa90c651bce44a3cbe90c44cf638">b</a>.<a class="code" href="unionhctsiz__data.html#d8b17af02c244e47ca0c38f933a6b3f0">pid</a> = <a class="code" href="dwc__otg__cil_8h.html#e623eb446c55928b324e9636111315e1">DWC_OTG_HC_PID_DATA1</a>;
<a name="l01856"></a>01856         dwc_write_reg32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#c6173f823ba754d9f9549422b6380ca2">hctsiz</a>, hctsiz.<a class="code" href="unionhctsiz__data.html#fb41950555c60c6015294bdefe9cd39d">d32</a>);
<a name="l01857"></a>01857 
<a name="l01858"></a>01858         <span class="comment">/* Set HCCHAR */</span>
<a name="l01859"></a>01859         hcchar.<a class="code" href="unionhcchar__data.html#03d352fb421ab5c11bf9afaae4933ba4">d32</a> = dwc_read_reg32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#3d8bdf7979ea6dd5ba01858aca7a1c02">hcchar</a>);
<a name="l01860"></a>01860         hcchar.<a class="code" href="unionhcchar__data.html#231c3638b02200c477e402d977c31e51">b</a>.<a class="code" href="unionhcchar__data.html#df4deee52d932ab29e5d077cde77cbfc">eptype</a> = <a class="code" href="dwc__otg__cil_8h.html#64e5cd756330f5adab79b25cc8067bdc">DWC_OTG_EP_TYPE_CONTROL</a>;
<a name="l01861"></a>01861         hcchar.<a class="code" href="unionhcchar__data.html#231c3638b02200c477e402d977c31e51">b</a>.<a class="code" href="unionhcchar__data.html#11f1b16e50f90806f90953bb979d4e77">epdir</a> = 0;
<a name="l01862"></a>01862         hcchar.<a class="code" href="unionhcchar__data.html#231c3638b02200c477e402d977c31e51">b</a>.<a class="code" href="unionhcchar__data.html#1597f36b85006e643aaf6f4d503bebc9">epnum</a> = 0;
<a name="l01863"></a>01863         hcchar.<a class="code" href="unionhcchar__data.html#231c3638b02200c477e402d977c31e51">b</a>.<a class="code" href="unionhcchar__data.html#47d11a5e62f69534d8ac0606aa7ffe7d">mps</a> = 8;
<a name="l01864"></a>01864         hcchar.<a class="code" href="unionhcchar__data.html#231c3638b02200c477e402d977c31e51">b</a>.<a class="code" href="unionhcchar__data.html#994a5305780edb0c4fe159b6cc7b14ae">chen</a> = 1;
<a name="l01865"></a>01865         dwc_write_reg32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#3d8bdf7979ea6dd5ba01858aca7a1c02">hcchar</a>, hcchar.<a class="code" href="unionhcchar__data.html#03d352fb421ab5c11bf9afaae4933ba4">d32</a>);
<a name="l01866"></a>01866 
<a name="l01867"></a>01867         gintsts.<a class="code" href="uniongintsts__data.html#379f34f5a95628b735e3a965f9cea12d">d32</a> = dwc_read_reg32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#aa1d909e3b0a60a56bf612968ff09019">gintsts</a>);
<a name="l01868"></a>01868 
<a name="l01869"></a>01869         <span class="comment">/* Wait for host channel interrupt */</span>
<a name="l01870"></a>01870         <span class="keywordflow">do</span> {
<a name="l01871"></a>01871                 gintsts.<a class="code" href="uniongintsts__data.html#379f34f5a95628b735e3a965f9cea12d">d32</a> = dwc_read_reg32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#aa1d909e3b0a60a56bf612968ff09019">gintsts</a>);
<a name="l01872"></a>01872         } <span class="keywordflow">while</span> (gintsts.<a class="code" href="uniongintsts__data.html#781da5558468e5dbdc93ae95e4cb872e">b</a>.<a class="code" href="uniongintsts__data.html#e02f1a50b20ed1c4248fd76e155147e8">hcintr</a> == 0);
<a name="l01873"></a>01873 
<a name="l01874"></a>01874 
<a name="l01875"></a>01875         <span class="comment">/* Disable HCINTs */</span>
<a name="l01876"></a>01876         dwc_write_reg32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#830aa61c1d4326823662168ea7359205">hcintmsk</a>, 0x0000);
<a name="l01877"></a>01877 
<a name="l01878"></a>01878         <span class="comment">/* Disable HAINTs */</span>
<a name="l01879"></a>01879         dwc_write_reg32(&amp;hc_global_regs-&gt;<a class="code" href="structdwc__otg__host__global__regs.html#317f5059d4c2dc91da041f5c0a4819fc">haintmsk</a>, 0x0000);
<a name="l01880"></a>01880 
<a name="l01881"></a>01881         <span class="comment">/* Read HAINT */</span>
<a name="l01882"></a>01882         haint.<a class="code" href="unionhaint__data.html#c83834650d2981b44274a89dda63a0f5">d32</a> = dwc_read_reg32(&amp;hc_global_regs-&gt;<a class="code" href="structdwc__otg__host__global__regs.html#7c41808b0a69ed7d2125eb3afbbf6c14">haint</a>);
<a name="l01883"></a>01883 
<a name="l01884"></a>01884         <span class="comment">/* Read HCINT */</span>
<a name="l01885"></a>01885         hcint.<a class="code" href="unionhcint__data.html#05a82fa7693f875622db744716d7f73e">d32</a> = dwc_read_reg32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#0dfd5bae537d58e13788508dc719480d">hcint</a>);
<a name="l01886"></a>01886 
<a name="l01887"></a>01887         <span class="comment">/* Read HCCHAR */</span>
<a name="l01888"></a>01888         hcchar.<a class="code" href="unionhcchar__data.html#03d352fb421ab5c11bf9afaae4933ba4">d32</a> = dwc_read_reg32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#3d8bdf7979ea6dd5ba01858aca7a1c02">hcchar</a>);
<a name="l01889"></a>01889 
<a name="l01890"></a>01890         <span class="comment">/* Clear HCINT */</span>
<a name="l01891"></a>01891         dwc_write_reg32(&amp;hc_regs-&gt;<a class="code" href="structdwc__otg__hc__regs.html#0dfd5bae537d58e13788508dc719480d">hcint</a>, hcint.<a class="code" href="unionhcint__data.html#05a82fa7693f875622db744716d7f73e">d32</a>);
<a name="l01892"></a>01892 
<a name="l01893"></a>01893         <span class="comment">/* Clear HAINT */</span>
<a name="l01894"></a>01894         dwc_write_reg32(&amp;hc_global_regs-&gt;<a class="code" href="structdwc__otg__host__global__regs.html#7c41808b0a69ed7d2125eb3afbbf6c14">haint</a>, haint.<a class="code" href="unionhaint__data.html#c83834650d2981b44274a89dda63a0f5">d32</a>);
<a name="l01895"></a>01895 
<a name="l01896"></a>01896         <span class="comment">/* Clear GINTSTS */</span>
<a name="l01897"></a>01897         dwc_write_reg32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#aa1d909e3b0a60a56bf612968ff09019">gintsts</a>, gintsts.<a class="code" href="uniongintsts__data.html#379f34f5a95628b735e3a965f9cea12d">d32</a>);
<a name="l01898"></a>01898 
<a name="l01899"></a>01899         <span class="comment">/* Read GINTSTS */</span>
<a name="l01900"></a>01900         gintsts.<a class="code" href="uniongintsts__data.html#379f34f5a95628b735e3a965f9cea12d">d32</a> = dwc_read_reg32(&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#aa1d909e3b0a60a56bf612968ff09019">gintsts</a>);
<a name="l01901"></a>01901 }
<a name="l01902"></a>01902 <span class="preprocessor">#endif</span>
<a name="l01903"></a>01903 <span class="preprocessor"></span>
<a name="l01905"></a><a class="code" href="dwc__otg__hcd__if_8h.html#e3bd4e9d1f641cdd29df6633bfb1ebd2">01905</a> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__hcd_8c.html#e3bd4e9d1f641cdd29df6633bfb1ebd2">dwc_otg_hcd_hub_control</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * <a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd</a>,
<a name="l01906"></a>01906                             uint16_t typeReq,
<a name="l01907"></a>01907                             uint16_t wValue,
<a name="l01908"></a>01908                             uint16_t wIndex, uint8_t * buf, uint16_t wLength)
<a name="l01909"></a>01909 {
<a name="l01910"></a>01910         <span class="keywordtype">int</span> retval = 0;
<a name="l01911"></a>01911 
<a name="l01912"></a>01912         <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *core_if = dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>;
<a name="l01913"></a>01913         usb_hub_descriptor_t *hub_desc;
<a name="l01914"></a>01914         <a class="code" href="unionhprt0__data.html">hprt0_data_t</a> hprt0 = {.d32 = 0 };
<a name="l01915"></a>01915 
<a name="l01916"></a>01916         uint32_t port_status;
<a name="l01917"></a>01917 
<a name="l01918"></a>01918         <span class="keywordflow">switch</span> (typeReq) {
<a name="l01919"></a>01919         <span class="keywordflow">case</span> UCR_CLEAR_HUB_FEATURE:
<a name="l01920"></a>01920                 <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#e4a050e176c1c4f556da2b276a8c2b37">DBG_HCD</a>, <span class="stringliteral">"DWC OTG HCD HUB CONTROL - "</span>
<a name="l01921"></a>01921                             <span class="stringliteral">"ClearHubFeature 0x%x\n"</span>, wValue);
<a name="l01922"></a>01922                 <span class="keywordflow">switch</span> (wValue) {
<a name="l01923"></a>01923                 <span class="keywordflow">case</span> UHF_C_HUB_LOCAL_POWER:
<a name="l01924"></a>01924                 <span class="keywordflow">case</span> UHF_C_HUB_OVER_CURRENT:
<a name="l01925"></a>01925                         <span class="comment">/* Nothing required here */</span>
<a name="l01926"></a>01926                         <span class="keywordflow">break</span>;
<a name="l01927"></a>01927                 <span class="keywordflow">default</span>:
<a name="l01928"></a>01928                         retval = -DWC_E_INVALID;
<a name="l01929"></a>01929                         DWC_ERROR(<span class="stringliteral">"DWC OTG HCD - "</span>
<a name="l01930"></a>01930                                   <span class="stringliteral">"ClearHubFeature request %xh unknown\n"</span>,
<a name="l01931"></a>01931                                   wValue);
<a name="l01932"></a>01932                 }
<a name="l01933"></a>01933                 <span class="keywordflow">break</span>;
<a name="l01934"></a>01934         <span class="keywordflow">case</span> UCR_CLEAR_PORT_FEATURE:
<a name="l01935"></a>01935 <span class="preprocessor">#ifdef CONFIG_USB_DWC_OTG_LPM</span>
<a name="l01936"></a>01936 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (wValue != UHF_PORT_L1)
<a name="l01937"></a>01937 <span class="preprocessor">#endif</span>
<a name="l01938"></a>01938 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> (!wIndex || wIndex &gt; 1)
<a name="l01939"></a>01939                                 <span class="keywordflow">goto</span> error;
<a name="l01940"></a>01940 
<a name="l01941"></a>01941                 <span class="keywordflow">switch</span> (wValue) {
<a name="l01942"></a>01942                 <span class="keywordflow">case</span> UHF_PORT_ENABLE:
<a name="l01943"></a>01943                         <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#2bf62a567355d1ea38814714bd7b57ec">DBG_ANY</a>, <span class="stringliteral">"DWC OTG HCD HUB CONTROL - "</span>
<a name="l01944"></a>01944                                     <span class="stringliteral">"ClearPortFeature USB_PORT_FEAT_ENABLE\n"</span>);
<a name="l01945"></a>01945                         hprt0.<a class="code" href="unionhprt0__data.html#88e9271f697d2ec209fc6a6da67fe216">d32</a> = <a class="code" href="dwc__otg__cil_8h.html#ce67da6af4023cffd25333d20992438e">dwc_otg_read_hprt0</a>(core_if);
<a name="l01946"></a>01946                         hprt0.<a class="code" href="unionhprt0__data.html#08cd86ce6da6462fc53601db7e2b73f3">b</a>.<a class="code" href="unionhprt0__data.html#a964274b5d22e89ca4490f66dff3c763">prtena</a> = 1;
<a name="l01947"></a>01947                         dwc_write_reg32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#51bac71891b5f6f435d7fc4582b974c1">host_if</a>-&gt;<a class="code" href="structdwc__otg__host__if.html#dc8fe33e0bb3829cafa884d5fc603c4d">hprt0</a>, hprt0.<a class="code" href="unionhprt0__data.html#88e9271f697d2ec209fc6a6da67fe216">d32</a>);
<a name="l01948"></a>01948                         <span class="keywordflow">break</span>;
<a name="l01949"></a>01949                 <span class="keywordflow">case</span> UHF_PORT_SUSPEND:
<a name="l01950"></a>01950                         <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(DBG_HCD, <span class="stringliteral">"DWC OTG HCD HUB CONTROL - "</span>
<a name="l01951"></a>01951                                     <span class="stringliteral">"ClearPortFeature USB_PORT_FEAT_SUSPEND\n"</span>);
<a name="l01952"></a>01952 
<a name="l01953"></a>01953                         dwc_write_reg32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#348ed2c9aeae6fc608f1bb813978b3f9">pcgcctl</a>, 0);
<a name="l01954"></a>01954                         dwc_mdelay(5);
<a name="l01955"></a>01955 
<a name="l01956"></a>01956                         hprt0.<a class="code" href="unionhprt0__data.html#88e9271f697d2ec209fc6a6da67fe216">d32</a> = <a class="code" href="dwc__otg__cil_8h.html#ce67da6af4023cffd25333d20992438e">dwc_otg_read_hprt0</a>(core_if);
<a name="l01957"></a>01957                         hprt0.<a class="code" href="unionhprt0__data.html#08cd86ce6da6462fc53601db7e2b73f3">b</a>.<a class="code" href="unionhprt0__data.html#3f5961529636a3891a4ca9421dd535fa">prtres</a> = 1;
<a name="l01958"></a>01958                         dwc_write_reg32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#51bac71891b5f6f435d7fc4582b974c1">host_if</a>-&gt;<a class="code" href="structdwc__otg__host__if.html#dc8fe33e0bb3829cafa884d5fc603c4d">hprt0</a>, hprt0.<a class="code" href="unionhprt0__data.html#88e9271f697d2ec209fc6a6da67fe216">d32</a>);
<a name="l01959"></a>01959                         hprt0.<a class="code" href="unionhprt0__data.html#08cd86ce6da6462fc53601db7e2b73f3">b</a>.<a class="code" href="unionhprt0__data.html#e7fe71d6c465ae002211c24a6ba359d2">prtsusp</a> = 0;
<a name="l01960"></a>01960                         <span class="comment">/* Clear Resume bit */</span>
<a name="l01961"></a>01961                         dwc_mdelay(100);
<a name="l01962"></a>01962                         hprt0.<a class="code" href="unionhprt0__data.html#08cd86ce6da6462fc53601db7e2b73f3">b</a>.<a class="code" href="unionhprt0__data.html#3f5961529636a3891a4ca9421dd535fa">prtres</a> = 0;
<a name="l01963"></a>01963                         dwc_write_reg32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#51bac71891b5f6f435d7fc4582b974c1">host_if</a>-&gt;<a class="code" href="structdwc__otg__host__if.html#dc8fe33e0bb3829cafa884d5fc603c4d">hprt0</a>, hprt0.<a class="code" href="unionhprt0__data.html#88e9271f697d2ec209fc6a6da67fe216">d32</a>);
<a name="l01964"></a>01964                         <span class="keywordflow">break</span>;
<a name="l01965"></a>01965 <span class="preprocessor">#ifdef CONFIG_USB_DWC_OTG_LPM</span>
<a name="l01966"></a>01966 <span class="preprocessor"></span>                <span class="keywordflow">case</span> UHF_PORT_L1:
<a name="l01967"></a>01967                         {
<a name="l01968"></a>01968                                 <a class="code" href="unionpcgcctl__data.html">pcgcctl_data_t</a> pcgcctl = {.d32 = 0 };
<a name="l01969"></a>01969                                 <a class="code" href="unionglpmctl__data.html">glpmcfg_data_t</a> lpmcfg = {.d32 = 0 };
<a name="l01970"></a>01970 
<a name="l01971"></a>01971                                 lpmcfg.<a class="code" href="unionglpmctl__data.html#cd41461734ff898209bfb64057ef2eb8">d32</a> =
<a name="l01972"></a>01972                                     dwc_read_reg32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#909eae7e3b9432ca1e278b99f7811f52">core_global_regs</a>-&gt;
<a name="l01973"></a>01973                                                    glpmcfg);
<a name="l01974"></a>01974                                 lpmcfg.<a class="code" href="unionglpmctl__data.html#bd3cc34c338226ff1cd89448f7590ff1">b</a>.<a class="code" href="unionglpmctl__data.html#63e912a05b8d29872b92263ca616fec8">en_utmi_sleep</a> = 0;
<a name="l01975"></a>01975                                 lpmcfg.<a class="code" href="unionglpmctl__data.html#bd3cc34c338226ff1cd89448f7590ff1">b</a>.<a class="code" href="unionglpmctl__data.html#e2ceea4bfe468c7b3c800235d7ffd5d2">hird_thres</a> &amp;= (~(1 &lt;&lt; 4));
<a name="l01976"></a>01976                                 lpmcfg.<a class="code" href="unionglpmctl__data.html#bd3cc34c338226ff1cd89448f7590ff1">b</a>.<a class="code" href="unionglpmctl__data.html#241ff25a215f16ac29b3bb6d9f4943ed">prt_sleep_sts</a> = 1;
<a name="l01977"></a>01977                                 dwc_write_reg32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#909eae7e3b9432ca1e278b99f7811f52">core_global_regs</a>-&gt;
<a name="l01978"></a>01978                                                 glpmcfg, lpmcfg.<a class="code" href="unionglpmctl__data.html#cd41461734ff898209bfb64057ef2eb8">d32</a>);
<a name="l01979"></a>01979 
<a name="l01980"></a>01980                                 <span class="comment">/* Clear Enbl_L1Gating bit. */</span>
<a name="l01981"></a>01981                                 pcgcctl.<a class="code" href="unionpcgcctl__data.html#f2bb76709d0ab9d08280eafb78a36279">b</a>.<a class="code" href="unionpcgcctl__data.html#6c18ad3b71ad92e548d0c6d64cc88734">enbl_sleep_gating</a> = 1;
<a name="l01982"></a>01982                                 dwc_modify_reg32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#348ed2c9aeae6fc608f1bb813978b3f9">pcgcctl</a>, pcgcctl.<a class="code" href="unionpcgcctl__data.html#abe048ee884143501929b27d94c52db7">d32</a>,
<a name="l01983"></a>01983                                                  0);
<a name="l01984"></a>01984 
<a name="l01985"></a>01985                                 dwc_mdelay(5);
<a name="l01986"></a>01986 
<a name="l01987"></a>01987                                 hprt0.<a class="code" href="unionhprt0__data.html#88e9271f697d2ec209fc6a6da67fe216">d32</a> = <a class="code" href="dwc__otg__cil_8h.html#ce67da6af4023cffd25333d20992438e">dwc_otg_read_hprt0</a>(core_if);
<a name="l01988"></a>01988                                 hprt0.<a class="code" href="unionhprt0__data.html#08cd86ce6da6462fc53601db7e2b73f3">b</a>.<a class="code" href="unionhprt0__data.html#3f5961529636a3891a4ca9421dd535fa">prtres</a> = 1;
<a name="l01989"></a>01989                                 dwc_write_reg32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#51bac71891b5f6f435d7fc4582b974c1">host_if</a>-&gt;<a class="code" href="structdwc__otg__host__if.html#dc8fe33e0bb3829cafa884d5fc603c4d">hprt0</a>,
<a name="l01990"></a>01990                                                 hprt0.<a class="code" href="unionhprt0__data.html#88e9271f697d2ec209fc6a6da67fe216">d32</a>);
<a name="l01991"></a>01991                                 <span class="comment">/* This bit will be cleared in wakeup interrupt handle */</span>
<a name="l01992"></a>01992                                 <span class="keywordflow">break</span>;
<a name="l01993"></a>01993                         }
<a name="l01994"></a>01994 <span class="preprocessor">#endif</span>
<a name="l01995"></a>01995 <span class="preprocessor"></span>                <span class="keywordflow">case</span> UHF_PORT_POWER:
<a name="l01996"></a>01996                         <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(DBG_HCD, <span class="stringliteral">"DWC OTG HCD HUB CONTROL - "</span>
<a name="l01997"></a>01997                                     <span class="stringliteral">"ClearPortFeature USB_PORT_FEAT_POWER\n"</span>);
<a name="l01998"></a>01998                         hprt0.<a class="code" href="unionhprt0__data.html#88e9271f697d2ec209fc6a6da67fe216">d32</a> = <a class="code" href="dwc__otg__cil_8h.html#ce67da6af4023cffd25333d20992438e">dwc_otg_read_hprt0</a>(core_if);
<a name="l01999"></a>01999                         hprt0.<a class="code" href="unionhprt0__data.html#08cd86ce6da6462fc53601db7e2b73f3">b</a>.<a class="code" href="unionhprt0__data.html#010bd8fb208ef4eeaa288b28f8f8c3a4">prtpwr</a> = 0;
<a name="l02000"></a>02000                         dwc_write_reg32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#51bac71891b5f6f435d7fc4582b974c1">host_if</a>-&gt;<a class="code" href="structdwc__otg__host__if.html#dc8fe33e0bb3829cafa884d5fc603c4d">hprt0</a>, hprt0.<a class="code" href="unionhprt0__data.html#88e9271f697d2ec209fc6a6da67fe216">d32</a>);
<a name="l02001"></a>02001                         <span class="keywordflow">break</span>;
<a name="l02002"></a>02002                 <span class="keywordflow">case</span> UHF_PORT_INDICATOR:
<a name="l02003"></a>02003                         <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(DBG_HCD, <span class="stringliteral">"DWC OTG HCD HUB CONTROL - "</span>
<a name="l02004"></a>02004                                     <span class="stringliteral">"ClearPortFeature USB_PORT_FEAT_INDICATOR\n"</span>);
<a name="l02005"></a>02005                         <span class="comment">/* Port inidicator not supported */</span>
<a name="l02006"></a>02006                         <span class="keywordflow">break</span>;
<a name="l02007"></a>02007                 <span class="keywordflow">case</span> UHF_C_PORT_CONNECTION:
<a name="l02008"></a>02008                         <span class="comment">/* Clears drivers internal connect status change</span>
<a name="l02009"></a>02009 <span class="comment">                         * flag */</span>
<a name="l02010"></a>02010                         <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(DBG_HCD, <span class="stringliteral">"DWC OTG HCD HUB CONTROL - "</span>
<a name="l02011"></a>02011                                     <span class="stringliteral">"ClearPortFeature USB_PORT_FEAT_C_CONNECTION\n"</span>);
<a name="l02012"></a>02012                         dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#9aaf2a112f5794f92dedd826342bd637">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#76f573861d9316238ded198c58c228c7">b</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#cd31ac4b9658265e90773448f354f0e1">port_connect_status_change</a> = 0;
<a name="l02013"></a>02013                         <span class="keywordflow">break</span>;
<a name="l02014"></a>02014                 <span class="keywordflow">case</span> UHF_C_PORT_RESET:
<a name="l02015"></a>02015                         <span class="comment">/* Clears the driver's internal Port Reset Change</span>
<a name="l02016"></a>02016 <span class="comment">                         * flag */</span>
<a name="l02017"></a>02017                         <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(DBG_HCD, <span class="stringliteral">"DWC OTG HCD HUB CONTROL - "</span>
<a name="l02018"></a>02018                                     <span class="stringliteral">"ClearPortFeature USB_PORT_FEAT_C_RESET\n"</span>);
<a name="l02019"></a>02019                         dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#9aaf2a112f5794f92dedd826342bd637">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#76f573861d9316238ded198c58c228c7">b</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#d0d63f32ed35315e8a02549521fb386e">port_reset_change</a> = 0;
<a name="l02020"></a>02020                         <span class="keywordflow">break</span>;
<a name="l02021"></a>02021                 <span class="keywordflow">case</span> UHF_C_PORT_ENABLE:
<a name="l02022"></a>02022                         <span class="comment">/* Clears the driver's internal Port</span>
<a name="l02023"></a>02023 <span class="comment">                         * Enable/Disable Change flag */</span>
<a name="l02024"></a>02024                         <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(DBG_HCD, <span class="stringliteral">"DWC OTG HCD HUB CONTROL - "</span>
<a name="l02025"></a>02025                                     <span class="stringliteral">"ClearPortFeature USB_PORT_FEAT_C_ENABLE\n"</span>);
<a name="l02026"></a>02026                         dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#9aaf2a112f5794f92dedd826342bd637">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#76f573861d9316238ded198c58c228c7">b</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#d222ae08372109a312f6649f77b650e8">port_enable_change</a> = 0;
<a name="l02027"></a>02027                         <span class="keywordflow">break</span>;
<a name="l02028"></a>02028                 <span class="keywordflow">case</span> UHF_C_PORT_SUSPEND:
<a name="l02029"></a>02029                         <span class="comment">/* Clears the driver's internal Port Suspend</span>
<a name="l02030"></a>02030 <span class="comment">                         * Change flag, which is set when resume signaling on</span>
<a name="l02031"></a>02031 <span class="comment">                         * the host port is complete */</span>
<a name="l02032"></a>02032                         <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(DBG_HCD, <span class="stringliteral">"DWC OTG HCD HUB CONTROL - "</span>
<a name="l02033"></a>02033                                     <span class="stringliteral">"ClearPortFeature USB_PORT_FEAT_C_SUSPEND\n"</span>);
<a name="l02034"></a>02034                         dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#9aaf2a112f5794f92dedd826342bd637">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#76f573861d9316238ded198c58c228c7">b</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#2a6e323cb4c01153aff1adc6269c74c7">port_suspend_change</a> = 0;
<a name="l02035"></a>02035                         <span class="keywordflow">break</span>;
<a name="l02036"></a>02036 <span class="preprocessor">#ifdef CONFIG_USB_DWC_OTG_LPM</span>
<a name="l02037"></a>02037 <span class="preprocessor"></span>                <span class="keywordflow">case</span> UHF_C_PORT_L1:
<a name="l02038"></a>02038                         dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#9aaf2a112f5794f92dedd826342bd637">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#76f573861d9316238ded198c58c228c7">b</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#1900375ccea165f0efc40725f507a0bf">port_l1_change</a> = 0;
<a name="l02039"></a>02039                         <span class="keywordflow">break</span>;
<a name="l02040"></a>02040 <span class="preprocessor">#endif</span>
<a name="l02041"></a>02041 <span class="preprocessor"></span>                <span class="keywordflow">case</span> UHF_C_PORT_OVER_CURRENT:
<a name="l02042"></a>02042                         <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(DBG_HCD, <span class="stringliteral">"DWC OTG HCD HUB CONTROL - "</span>
<a name="l02043"></a>02043                                     <span class="stringliteral">"ClearPortFeature USB_PORT_FEAT_C_OVER_CURRENT\n"</span>);
<a name="l02044"></a>02044                         dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#9aaf2a112f5794f92dedd826342bd637">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#76f573861d9316238ded198c58c228c7">b</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#bc96cf12e2bc5b61ce05f15ae3297bd6">port_over_current_change</a> = 0;
<a name="l02045"></a>02045                         <span class="keywordflow">break</span>;
<a name="l02046"></a>02046                 <span class="keywordflow">default</span>:
<a name="l02047"></a>02047                         retval = -DWC_E_INVALID;
<a name="l02048"></a>02048                         DWC_ERROR(<span class="stringliteral">"DWC OTG HCD - "</span>
<a name="l02049"></a>02049                                   <span class="stringliteral">"ClearPortFeature request %xh "</span>
<a name="l02050"></a>02050                                   <span class="stringliteral">"unknown or unsupported\n"</span>, wValue);
<a name="l02051"></a>02051                 }
<a name="l02052"></a>02052                 <span class="keywordflow">break</span>;
<a name="l02053"></a>02053         <span class="keywordflow">case</span> UCR_GET_HUB_DESCRIPTOR:
<a name="l02054"></a>02054                 <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(DBG_HCD, <span class="stringliteral">"DWC OTG HCD HUB CONTROL - "</span>
<a name="l02055"></a>02055                             <span class="stringliteral">"GetHubDescriptor\n"</span>);
<a name="l02056"></a>02056                 hub_desc = (usb_hub_descriptor_t *) buf;
<a name="l02057"></a>02057                 hub_desc-&gt;bDescLength = 9;
<a name="l02058"></a>02058                 hub_desc-&gt;bDescriptorType = 0x29;
<a name="l02059"></a>02059                 hub_desc-&gt;bNbrPorts = 1;
<a name="l02060"></a>02060                 USETW(hub_desc-&gt;wHubCharacteristics, 0x08);
<a name="l02061"></a>02061                 hub_desc-&gt;bPwrOn2PwrGood = 1;
<a name="l02062"></a>02062                 hub_desc-&gt;bHubContrCurrent = 0;
<a name="l02063"></a>02063                 hub_desc-&gt;DeviceRemovable[0] = 0;
<a name="l02064"></a>02064                 hub_desc-&gt;DeviceRemovable[1] = 0xff;
<a name="l02065"></a>02065                 <span class="keywordflow">break</span>;
<a name="l02066"></a>02066         <span class="keywordflow">case</span> UCR_GET_HUB_STATUS:
<a name="l02067"></a>02067                 <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(DBG_HCD, <span class="stringliteral">"DWC OTG HCD HUB CONTROL - "</span>
<a name="l02068"></a>02068                             <span class="stringliteral">"GetHubStatus\n"</span>);
<a name="l02069"></a>02069                 DWC_MEMSET(buf, 0, 4);
<a name="l02070"></a>02070                 <span class="keywordflow">break</span>;
<a name="l02071"></a>02071         <span class="keywordflow">case</span> UCR_GET_PORT_STATUS:
<a name="l02072"></a>02072                 <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(DBG_HCD, <span class="stringliteral">"DWC OTG HCD HUB CONTROL - "</span>
<a name="l02073"></a>02073                             <span class="stringliteral">"GetPortStatus\n"</span>);
<a name="l02074"></a>02074                 <span class="keywordflow">if</span> (!wIndex || wIndex &gt; 1)
<a name="l02075"></a>02075                         <span class="keywordflow">goto</span> error;
<a name="l02076"></a>02076 
<a name="l02077"></a>02077                 port_status = 0;
<a name="l02078"></a>02078 
<a name="l02079"></a>02079                 <span class="keywordflow">if</span> (dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#9aaf2a112f5794f92dedd826342bd637">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#76f573861d9316238ded198c58c228c7">b</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#cd31ac4b9658265e90773448f354f0e1">port_connect_status_change</a>)
<a name="l02080"></a>02080                         port_status |= (1 &lt;&lt; UHF_C_PORT_CONNECTION);
<a name="l02081"></a>02081 
<a name="l02082"></a>02082                 <span class="keywordflow">if</span> (dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#9aaf2a112f5794f92dedd826342bd637">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#76f573861d9316238ded198c58c228c7">b</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#d222ae08372109a312f6649f77b650e8">port_enable_change</a>)
<a name="l02083"></a>02083                         port_status |= (1 &lt;&lt; UHF_C_PORT_ENABLE);
<a name="l02084"></a>02084 
<a name="l02085"></a>02085                 <span class="keywordflow">if</span> (dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#9aaf2a112f5794f92dedd826342bd637">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#76f573861d9316238ded198c58c228c7">b</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#2a6e323cb4c01153aff1adc6269c74c7">port_suspend_change</a>)
<a name="l02086"></a>02086                         port_status |= (1 &lt;&lt; UHF_C_PORT_SUSPEND);
<a name="l02087"></a>02087 
<a name="l02088"></a>02088                 <span class="keywordflow">if</span> (dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#9aaf2a112f5794f92dedd826342bd637">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#76f573861d9316238ded198c58c228c7">b</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#1900375ccea165f0efc40725f507a0bf">port_l1_change</a>)
<a name="l02089"></a>02089                         port_status |= (1 &lt;&lt; UHF_C_PORT_L1);
<a name="l02090"></a>02090 
<a name="l02091"></a>02091                 <span class="keywordflow">if</span> (dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#9aaf2a112f5794f92dedd826342bd637">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#76f573861d9316238ded198c58c228c7">b</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#d0d63f32ed35315e8a02549521fb386e">port_reset_change</a>) {
<a name="l02092"></a>02092                         port_status |= (1 &lt;&lt; UHF_C_PORT_RESET);
<a name="l02093"></a>02093                 }
<a name="l02094"></a>02094 
<a name="l02095"></a>02095                 <span class="keywordflow">if</span> (dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#9aaf2a112f5794f92dedd826342bd637">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#76f573861d9316238ded198c58c228c7">b</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#bc96cf12e2bc5b61ce05f15ae3297bd6">port_over_current_change</a>) {
<a name="l02096"></a>02096                         DWC_ERROR(<span class="stringliteral">"Device Not Supported\n"</span>);
<a name="l02097"></a>02097                         port_status |= (1 &lt;&lt; UHF_C_PORT_OVER_CURRENT);
<a name="l02098"></a>02098                 }
<a name="l02099"></a>02099 
<a name="l02100"></a>02100                 <span class="keywordflow">if</span> (!dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#9aaf2a112f5794f92dedd826342bd637">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#76f573861d9316238ded198c58c228c7">b</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#9314ac02ed140807687793b512f78c63">port_connect_status</a>) {
<a name="l02101"></a>02101                         <span class="comment">/*</span>
<a name="l02102"></a>02102 <span class="comment">                         * The port is disconnected, which means the core is</span>
<a name="l02103"></a>02103 <span class="comment">                         * either in device mode or it soon will be. Just</span>
<a name="l02104"></a>02104 <span class="comment">                         * return 0's for the remainder of the port status</span>
<a name="l02105"></a>02105 <span class="comment">                         * since the port register can't be read if the core</span>
<a name="l02106"></a>02106 <span class="comment">                         * is in device mode.</span>
<a name="l02107"></a>02107 <span class="comment">                         */</span>
<a name="l02108"></a>02108                         *((__le32 *) buf) = dwc_cpu_to_le32(&amp;port_status);
<a name="l02109"></a>02109                         <span class="keywordflow">break</span>;
<a name="l02110"></a>02110                 }
<a name="l02111"></a>02111 
<a name="l02112"></a>02112                 hprt0.<a class="code" href="unionhprt0__data.html#88e9271f697d2ec209fc6a6da67fe216">d32</a> = dwc_read_reg32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#51bac71891b5f6f435d7fc4582b974c1">host_if</a>-&gt;<a class="code" href="structdwc__otg__host__if.html#dc8fe33e0bb3829cafa884d5fc603c4d">hprt0</a>);
<a name="l02113"></a>02113                 <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#39931d908ba215b3d5d590e42d8408b5">DBG_HCDV</a>, <span class="stringliteral">"  HPRT0: 0x%08x\n"</span>, hprt0.<a class="code" href="unionhprt0__data.html#88e9271f697d2ec209fc6a6da67fe216">d32</a>);
<a name="l02114"></a>02114 
<a name="l02115"></a>02115                 <span class="keywordflow">if</span> (hprt0.<a class="code" href="unionhprt0__data.html#08cd86ce6da6462fc53601db7e2b73f3">b</a>.<a class="code" href="unionhprt0__data.html#39b2dee944be8ec96857a3b43d203390">prtconnsts</a>)
<a name="l02116"></a>02116                         port_status |= (1 &lt;&lt; UHF_PORT_CONNECTION);
<a name="l02117"></a>02117 
<a name="l02118"></a>02118                 <span class="keywordflow">if</span> (hprt0.<a class="code" href="unionhprt0__data.html#08cd86ce6da6462fc53601db7e2b73f3">b</a>.<a class="code" href="unionhprt0__data.html#a964274b5d22e89ca4490f66dff3c763">prtena</a>)
<a name="l02119"></a>02119                         port_status |= (1 &lt;&lt; UHF_PORT_ENABLE);
<a name="l02120"></a>02120 
<a name="l02121"></a>02121                 <span class="keywordflow">if</span> (hprt0.<a class="code" href="unionhprt0__data.html#08cd86ce6da6462fc53601db7e2b73f3">b</a>.<a class="code" href="unionhprt0__data.html#e7fe71d6c465ae002211c24a6ba359d2">prtsusp</a>)
<a name="l02122"></a>02122                         port_status |= (1 &lt;&lt; UHF_PORT_SUSPEND);
<a name="l02123"></a>02123 
<a name="l02124"></a>02124                 <span class="keywordflow">if</span> (hprt0.<a class="code" href="unionhprt0__data.html#08cd86ce6da6462fc53601db7e2b73f3">b</a>.<a class="code" href="unionhprt0__data.html#4d8f8b654c26760791614ccbc43f180c">prtovrcurract</a>)
<a name="l02125"></a>02125                         port_status |= (1 &lt;&lt; UHF_PORT_OVER_CURRENT);
<a name="l02126"></a>02126 
<a name="l02127"></a>02127                 <span class="keywordflow">if</span> (hprt0.<a class="code" href="unionhprt0__data.html#08cd86ce6da6462fc53601db7e2b73f3">b</a>.<a class="code" href="unionhprt0__data.html#714a31048710164370292124795a9a9b">prtrst</a>)
<a name="l02128"></a>02128                         port_status |= (1 &lt;&lt; UHF_PORT_RESET);
<a name="l02129"></a>02129 
<a name="l02130"></a>02130                 <span class="keywordflow">if</span> (hprt0.<a class="code" href="unionhprt0__data.html#08cd86ce6da6462fc53601db7e2b73f3">b</a>.<a class="code" href="unionhprt0__data.html#010bd8fb208ef4eeaa288b28f8f8c3a4">prtpwr</a>)
<a name="l02131"></a>02131                         port_status |= (1 &lt;&lt; UHF_PORT_POWER);
<a name="l02132"></a>02132 
<a name="l02133"></a>02133                 <span class="keywordflow">if</span> (hprt0.<a class="code" href="unionhprt0__data.html#08cd86ce6da6462fc53601db7e2b73f3">b</a>.<a class="code" href="unionhprt0__data.html#59f1c27b8c912de0237d2d2974fc2a22">prtspd</a> == <a class="code" href="dwc__otg__regs_8h.html#4556f79078df2164a8162fa8144142a0">DWC_HPRT0_PRTSPD_HIGH_SPEED</a>)
<a name="l02134"></a>02134                         port_status |= (1 &lt;&lt; UHF_PORT_HIGH_SPEED);
<a name="l02135"></a>02135                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (hprt0.<a class="code" href="unionhprt0__data.html#08cd86ce6da6462fc53601db7e2b73f3">b</a>.<a class="code" href="unionhprt0__data.html#59f1c27b8c912de0237d2d2974fc2a22">prtspd</a> == <a class="code" href="dwc__otg__regs_8h.html#db9e36d1ab76c334f6e004ee270bd36f">DWC_HPRT0_PRTSPD_LOW_SPEED</a>)
<a name="l02136"></a>02136                         port_status |= (1 &lt;&lt; UHF_PORT_LOW_SPEED);
<a name="l02137"></a>02137 
<a name="l02138"></a>02138                 <span class="keywordflow">if</span> (hprt0.<a class="code" href="unionhprt0__data.html#08cd86ce6da6462fc53601db7e2b73f3">b</a>.<a class="code" href="unionhprt0__data.html#c61d714ff8f0bc62767342523347ba66">prttstctl</a>)
<a name="l02139"></a>02139                         port_status |= (1 &lt;&lt; UHF_PORT_TEST);
<a name="l02140"></a>02140                 <span class="keywordflow">if</span> (<a class="code" href="dwc__otg__cil_8c.html#87d643973839554bac437d283a462e00">dwc_otg_get_lpm_portsleepstatus</a>(dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>)) {
<a name="l02141"></a>02141                         port_status |= (1 &lt;&lt; UHF_PORT_L1);
<a name="l02142"></a>02142                 }
<a name="l02143"></a>02143 
<a name="l02144"></a>02144                 <span class="comment">/* USB_PORT_FEAT_INDICATOR unsupported always 0 */</span>
<a name="l02145"></a>02145 
<a name="l02146"></a>02146                 *((__le32 *) buf) = dwc_cpu_to_le32(&amp;port_status);
<a name="l02147"></a>02147 
<a name="l02148"></a>02148                 <span class="keywordflow">break</span>;
<a name="l02149"></a>02149         <span class="keywordflow">case</span> UCR_SET_HUB_FEATURE:
<a name="l02150"></a>02150                 <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(DBG_HCD, <span class="stringliteral">"DWC OTG HCD HUB CONTROL - "</span>
<a name="l02151"></a>02151                             <span class="stringliteral">"SetHubFeature\n"</span>);
<a name="l02152"></a>02152                 <span class="comment">/* No HUB features supported */</span>
<a name="l02153"></a>02153                 <span class="keywordflow">break</span>;
<a name="l02154"></a>02154         <span class="keywordflow">case</span> UCR_SET_PORT_FEATURE:
<a name="l02155"></a>02155                 <span class="keywordflow">if</span> (wValue != UHF_PORT_TEST &amp;&amp; (!wIndex || wIndex &gt; 1))
<a name="l02156"></a>02156                         <span class="keywordflow">goto</span> error;
<a name="l02157"></a>02157 
<a name="l02158"></a>02158                 <span class="keywordflow">if</span> (!dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#9aaf2a112f5794f92dedd826342bd637">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#76f573861d9316238ded198c58c228c7">b</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#9314ac02ed140807687793b512f78c63">port_connect_status</a>) {
<a name="l02159"></a>02159                         <span class="comment">/*</span>
<a name="l02160"></a>02160 <span class="comment">                         * The port is disconnected, which means the core is</span>
<a name="l02161"></a>02161 <span class="comment">                         * either in device mode or it soon will be. Just</span>
<a name="l02162"></a>02162 <span class="comment">                         * return without doing anything since the port</span>
<a name="l02163"></a>02163 <span class="comment">                         * register can't be written if the core is in device</span>
<a name="l02164"></a>02164 <span class="comment">                         * mode.</span>
<a name="l02165"></a>02165 <span class="comment">                         */</span>
<a name="l02166"></a>02166                         <span class="keywordflow">break</span>;
<a name="l02167"></a>02167                 }
<a name="l02168"></a>02168 
<a name="l02169"></a>02169                 <span class="keywordflow">switch</span> (wValue) {
<a name="l02170"></a>02170                 <span class="keywordflow">case</span> UHF_PORT_SUSPEND:
<a name="l02171"></a>02171                         <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(DBG_HCD, <span class="stringliteral">"DWC OTG HCD HUB CONTROL - "</span>
<a name="l02172"></a>02172                                     <span class="stringliteral">"SetPortFeature - USB_PORT_FEAT_SUSPEND\n"</span>);
<a name="l02173"></a>02173                         <span class="keywordflow">if</span> (<a class="code" href="dwc__otg__hcd_8c.html#e7d3657931984a1ce1cee5cf47cb08f3">dwc_otg_hcd_otg_port</a>(dwc_otg_hcd) == wIndex &amp;&amp;
<a name="l02174"></a>02174                             dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#ffefbd33a59a14b8b46406f5aaeaa2f4">fops</a>-&gt;<a class="code" href="structdwc__otg__hcd__function__ops.html#24a2ee2bad4dc517fed62417a2a542d3">get_b_hnp_enable</a>(dwc_otg_hcd)) {
<a name="l02175"></a>02175                                 <a class="code" href="uniongotgctl__data.html">gotgctl_data_t</a> gotgctl = {.d32 = 0 };
<a name="l02176"></a>02176                                 gotgctl.b.hstsethnpen = 1;
<a name="l02177"></a>02177                                 dwc_modify_reg32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#909eae7e3b9432ca1e278b99f7811f52">core_global_regs</a>-&gt;
<a name="l02178"></a>02178                                                  gotgctl, 0, gotgctl.d32);
<a name="l02179"></a>02179                                 core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#5a5c5c1cf8d870101cc1fffac56d88c0">op_state</a> = <a class="code" href="dwc__otg__cil_8h.html#da9f5eb506da71435e8976ceb38bc14d">A_SUSPEND</a>;
<a name="l02180"></a>02180                         }
<a name="l02181"></a>02181                         hprt0.<a class="code" href="unionhprt0__data.html#88e9271f697d2ec209fc6a6da67fe216">d32</a> = <a class="code" href="dwc__otg__cil_8h.html#ce67da6af4023cffd25333d20992438e">dwc_otg_read_hprt0</a>(core_if);
<a name="l02182"></a>02182                         hprt0.<a class="code" href="unionhprt0__data.html#08cd86ce6da6462fc53601db7e2b73f3">b</a>.<a class="code" href="unionhprt0__data.html#e7fe71d6c465ae002211c24a6ba359d2">prtsusp</a> = 1;
<a name="l02183"></a>02183                         dwc_write_reg32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#51bac71891b5f6f435d7fc4582b974c1">host_if</a>-&gt;<a class="code" href="structdwc__otg__host__if.html#dc8fe33e0bb3829cafa884d5fc603c4d">hprt0</a>, hprt0.<a class="code" href="unionhprt0__data.html#88e9271f697d2ec209fc6a6da67fe216">d32</a>);
<a name="l02184"></a>02184                         {
<a name="l02185"></a>02185                                 uint64_t flags;
<a name="l02186"></a>02186                                 <span class="comment">/* Update lx_state */</span>
<a name="l02187"></a>02187                                 DWC_SPINLOCK_IRQSAVE(dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#34f29e9c035009476495f7701c1813fd">lock</a>, &amp;flags);
<a name="l02188"></a>02188                                 core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#2b0701d814069ec69897e08374366c7b">lx_state</a> = <a class="code" href="dwc__otg__cil_8h.html#8442e49b7c783099ac17bda4f8b3bc3cd1fadb6fa31de73e8176316a0e0ba905">DWC_OTG_L2</a>;
<a name="l02189"></a>02189                                 DWC_SPINUNLOCK_IRQRESTORE(dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#34f29e9c035009476495f7701c1813fd">lock</a>, flags);
<a name="l02190"></a>02190                         }
<a name="l02191"></a>02191                         <span class="comment">/* Suspend the Phy Clock */</span>
<a name="l02192"></a>02192                         {
<a name="l02193"></a>02193                                 <a class="code" href="unionpcgcctl__data.html">pcgcctl_data_t</a> pcgcctl = {.d32 = 0 };
<a name="l02194"></a>02194                                 pcgcctl.<a class="code" href="unionpcgcctl__data.html#f2bb76709d0ab9d08280eafb78a36279">b</a>.<a class="code" href="unionpcgcctl__data.html#bf40184845ef70be8e59b2672cb0bedf">stoppclk</a> = 1;
<a name="l02195"></a>02195                                 dwc_modify_reg32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#348ed2c9aeae6fc608f1bb813978b3f9">pcgcctl</a>, 0,
<a name="l02196"></a>02196                                                  pcgcctl.<a class="code" href="unionpcgcctl__data.html#abe048ee884143501929b27d94c52db7">d32</a>);
<a name="l02197"></a>02197                         }
<a name="l02198"></a>02198 
<a name="l02199"></a>02199                         <span class="comment">/* For HNP the bus must be suspended for at least 200ms. */</span>
<a name="l02200"></a>02200                         <span class="keywordflow">if</span> (dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#ffefbd33a59a14b8b46406f5aaeaa2f4">fops</a>-&gt;<a class="code" href="structdwc__otg__hcd__function__ops.html#24a2ee2bad4dc517fed62417a2a542d3">get_b_hnp_enable</a>(dwc_otg_hcd)) {
<a name="l02201"></a>02201                                 dwc_mdelay(200);
<a name="l02202"></a>02202                         }
<a name="l02203"></a>02203                         <span class="keywordflow">break</span>;
<a name="l02204"></a>02204                 <span class="keywordflow">case</span> UHF_PORT_POWER:
<a name="l02205"></a>02205                         <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(DBG_HCD, <span class="stringliteral">"DWC OTG HCD HUB CONTROL - "</span>
<a name="l02206"></a>02206                                     <span class="stringliteral">"SetPortFeature - USB_PORT_FEAT_POWER\n"</span>);
<a name="l02207"></a>02207                         hprt0.<a class="code" href="unionhprt0__data.html#88e9271f697d2ec209fc6a6da67fe216">d32</a> = <a class="code" href="dwc__otg__cil_8h.html#ce67da6af4023cffd25333d20992438e">dwc_otg_read_hprt0</a>(core_if);
<a name="l02208"></a>02208                         hprt0.<a class="code" href="unionhprt0__data.html#08cd86ce6da6462fc53601db7e2b73f3">b</a>.<a class="code" href="unionhprt0__data.html#010bd8fb208ef4eeaa288b28f8f8c3a4">prtpwr</a> = 1;
<a name="l02209"></a>02209                         dwc_write_reg32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#51bac71891b5f6f435d7fc4582b974c1">host_if</a>-&gt;<a class="code" href="structdwc__otg__host__if.html#dc8fe33e0bb3829cafa884d5fc603c4d">hprt0</a>, hprt0.<a class="code" href="unionhprt0__data.html#88e9271f697d2ec209fc6a6da67fe216">d32</a>);
<a name="l02210"></a>02210                         <span class="keywordflow">break</span>;
<a name="l02211"></a>02211                 <span class="keywordflow">case</span> UHF_PORT_RESET:
<a name="l02212"></a>02212                         <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(DBG_HCD, <span class="stringliteral">"DWC OTG HCD HUB CONTROL - "</span>
<a name="l02213"></a>02213                                     <span class="stringliteral">"SetPortFeature - USB_PORT_FEAT_RESET\n"</span>);
<a name="l02214"></a>02214                         {
<a name="l02215"></a>02215                                 <a class="code" href="unionpcgcctl__data.html">pcgcctl_data_t</a> pcgcctl = {.d32 = 0 };
<a name="l02216"></a>02216                                 pcgcctl.<a class="code" href="unionpcgcctl__data.html#f2bb76709d0ab9d08280eafb78a36279">b</a>.<a class="code" href="unionpcgcctl__data.html#6c18ad3b71ad92e548d0c6d64cc88734">enbl_sleep_gating</a> = 1;
<a name="l02217"></a>02217                                 pcgcctl.<a class="code" href="unionpcgcctl__data.html#f2bb76709d0ab9d08280eafb78a36279">b</a>.<a class="code" href="unionpcgcctl__data.html#bf40184845ef70be8e59b2672cb0bedf">stoppclk</a> = 1;
<a name="l02218"></a>02218                                 dwc_modify_reg32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#348ed2c9aeae6fc608f1bb813978b3f9">pcgcctl</a>, pcgcctl.<a class="code" href="unionpcgcctl__data.html#abe048ee884143501929b27d94c52db7">d32</a>,
<a name="l02219"></a>02219                                                  0);
<a name="l02220"></a>02220                                 dwc_write_reg32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#348ed2c9aeae6fc608f1bb813978b3f9">pcgcctl</a>, 0);
<a name="l02221"></a>02221                         }
<a name="l02222"></a>02222 <span class="preprocessor">#ifdef CONFIG_USB_DWC_OTG_LPM</span>
<a name="l02223"></a>02223 <span class="preprocessor"></span>                        {
<a name="l02224"></a>02224                                 <a class="code" href="unionglpmctl__data.html">glpmcfg_data_t</a> lpmcfg;
<a name="l02225"></a>02225                                 lpmcfg.<a class="code" href="unionglpmctl__data.html#cd41461734ff898209bfb64057ef2eb8">d32</a> =
<a name="l02226"></a>02226                                     dwc_read_reg32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#909eae7e3b9432ca1e278b99f7811f52">core_global_regs</a>-&gt;
<a name="l02227"></a>02227                                                    glpmcfg);
<a name="l02228"></a>02228                                 <span class="keywordflow">if</span> (lpmcfg.<a class="code" href="unionglpmctl__data.html#bd3cc34c338226ff1cd89448f7590ff1">b</a>.<a class="code" href="unionglpmctl__data.html#241ff25a215f16ac29b3bb6d9f4943ed">prt_sleep_sts</a>) {
<a name="l02229"></a>02229                                         lpmcfg.<a class="code" href="unionglpmctl__data.html#bd3cc34c338226ff1cd89448f7590ff1">b</a>.<a class="code" href="unionglpmctl__data.html#63e912a05b8d29872b92263ca616fec8">en_utmi_sleep</a> = 0;
<a name="l02230"></a>02230                                         lpmcfg.<a class="code" href="unionglpmctl__data.html#bd3cc34c338226ff1cd89448f7590ff1">b</a>.<a class="code" href="unionglpmctl__data.html#e2ceea4bfe468c7b3c800235d7ffd5d2">hird_thres</a> &amp;= (~(1 &lt;&lt; 4));
<a name="l02231"></a>02231                                         dwc_write_reg32(&amp;core_if-&gt;
<a name="l02232"></a>02232                                                         core_global_regs-&gt;
<a name="l02233"></a>02233                                                         glpmcfg, lpmcfg.<a class="code" href="unionglpmctl__data.html#cd41461734ff898209bfb64057ef2eb8">d32</a>);
<a name="l02234"></a>02234                                         dwc_mdelay(1);
<a name="l02235"></a>02235                                 }
<a name="l02236"></a>02236                         }
<a name="l02237"></a>02237 <span class="preprocessor">#endif</span>
<a name="l02238"></a>02238 <span class="preprocessor"></span>                        hprt0.<a class="code" href="unionhprt0__data.html#88e9271f697d2ec209fc6a6da67fe216">d32</a> = <a class="code" href="dwc__otg__cil_8h.html#ce67da6af4023cffd25333d20992438e">dwc_otg_read_hprt0</a>(core_if);
<a name="l02239"></a>02239                         <span class="comment">/* When B-Host the Port reset bit is set in</span>
<a name="l02240"></a>02240 <span class="comment">                         * the Start HCD Callback function, so that</span>
<a name="l02241"></a>02241 <span class="comment">                         * the reset is started within 1ms of the HNP</span>
<a name="l02242"></a>02242 <span class="comment">                         * success interrupt. */</span>
<a name="l02243"></a>02243                         <span class="keywordflow">if</span> (!<a class="code" href="dwc__otg__hcd_8c.html#ca25b33b440a4ef112ee459c26c14adc">dwc_otg_hcd_is_b_host</a>(dwc_otg_hcd)) {
<a name="l02244"></a>02244                                 hprt0.<a class="code" href="unionhprt0__data.html#08cd86ce6da6462fc53601db7e2b73f3">b</a>.<a class="code" href="unionhprt0__data.html#714a31048710164370292124795a9a9b">prtrst</a> = 1;
<a name="l02245"></a>02245                                 dwc_write_reg32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#51bac71891b5f6f435d7fc4582b974c1">host_if</a>-&gt;<a class="code" href="structdwc__otg__host__if.html#dc8fe33e0bb3829cafa884d5fc603c4d">hprt0</a>,
<a name="l02246"></a>02246                                                 hprt0.<a class="code" href="unionhprt0__data.html#88e9271f697d2ec209fc6a6da67fe216">d32</a>);
<a name="l02247"></a>02247                         }
<a name="l02248"></a>02248                         <span class="comment">/* Clear reset bit in 10ms (FS/LS) or 50ms (HS) */</span>
<a name="l02249"></a>02249                         dwc_mdelay(60);
<a name="l02250"></a>02250                         hprt0.<a class="code" href="unionhprt0__data.html#08cd86ce6da6462fc53601db7e2b73f3">b</a>.<a class="code" href="unionhprt0__data.html#714a31048710164370292124795a9a9b">prtrst</a> = 0;
<a name="l02251"></a>02251                         dwc_write_reg32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#51bac71891b5f6f435d7fc4582b974c1">host_if</a>-&gt;<a class="code" href="structdwc__otg__host__if.html#dc8fe33e0bb3829cafa884d5fc603c4d">hprt0</a>, hprt0.<a class="code" href="unionhprt0__data.html#88e9271f697d2ec209fc6a6da67fe216">d32</a>);
<a name="l02252"></a>02252                         core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#2b0701d814069ec69897e08374366c7b">lx_state</a> = <a class="code" href="dwc__otg__cil_8h.html#8442e49b7c783099ac17bda4f8b3bc3c9743a36d9b0b8c66a11a0714fdd27fb5">DWC_OTG_L0</a>; <span class="comment">/* Now back to the on state */</span>
<a name="l02253"></a>02253                         <span class="keywordflow">break</span>;
<a name="l02254"></a>02254 <span class="preprocessor">#ifdef DWC_HS_ELECT_TST</span>
<a name="l02255"></a>02255 <span class="preprocessor"></span>                <span class="keywordflow">case</span> UHF_PORT_TEST:
<a name="l02256"></a>02256                         {
<a name="l02257"></a>02257                                 uint32_t t;
<a name="l02258"></a>02258                                 <a class="code" href="uniongintmsk__data.html">gintmsk_data_t</a> gintmsk;
<a name="l02259"></a>02259 
<a name="l02260"></a>02260                                 t = (wIndex &gt;&gt; 8);      <span class="comment">/* MSB wIndex USB */</span>
<a name="l02261"></a>02261                                 <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(DBG_HCD,
<a name="l02262"></a>02262                                             <span class="stringliteral">"DWC OTG HCD HUB CONTROL - "</span>
<a name="l02263"></a>02263                                             <span class="stringliteral">"SetPortFeature - USB_PORT_FEAT_TEST %d\n"</span>,
<a name="l02264"></a>02264                                             t);
<a name="l02265"></a>02265                                 DWC_WARN(<span class="stringliteral">"USB_PORT_FEAT_TEST %d\n"</span>, t);
<a name="l02266"></a>02266                                 <span class="keywordflow">if</span> (t &lt; 6) {
<a name="l02267"></a>02267                                         hprt0.<a class="code" href="unionhprt0__data.html#88e9271f697d2ec209fc6a6da67fe216">d32</a> = <a class="code" href="dwc__otg__cil_8h.html#ce67da6af4023cffd25333d20992438e">dwc_otg_read_hprt0</a>(core_if);
<a name="l02268"></a>02268                                         hprt0.<a class="code" href="unionhprt0__data.html#08cd86ce6da6462fc53601db7e2b73f3">b</a>.<a class="code" href="unionhprt0__data.html#c61d714ff8f0bc62767342523347ba66">prttstctl</a> = t;
<a name="l02269"></a>02269                                         dwc_write_reg32(core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#51bac71891b5f6f435d7fc4582b974c1">host_if</a>-&gt;<a class="code" href="structdwc__otg__host__if.html#dc8fe33e0bb3829cafa884d5fc603c4d">hprt0</a>,
<a name="l02270"></a>02270                                                         hprt0.<a class="code" href="unionhprt0__data.html#88e9271f697d2ec209fc6a6da67fe216">d32</a>);
<a name="l02271"></a>02271                                 } <span class="keywordflow">else</span> {
<a name="l02272"></a>02272                                         <span class="comment">/* Setup global vars with reg addresses (quick and</span>
<a name="l02273"></a>02273 <span class="comment">                                         * dirty hack, should be cleaned up)</span>
<a name="l02274"></a>02274 <span class="comment">                                         */</span>
<a name="l02275"></a>02275                                         global_regs = core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#909eae7e3b9432ca1e278b99f7811f52">core_global_regs</a>;
<a name="l02276"></a>02276                                         hc_global_regs =
<a name="l02277"></a>02277                                             core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#51bac71891b5f6f435d7fc4582b974c1">host_if</a>-&gt;<a class="code" href="structdwc__otg__host__if.html#ff9692c2e10ca2bc7e24f981f25179c2">host_global_regs</a>;
<a name="l02278"></a>02278                                         hc_regs =
<a name="l02279"></a>02279                                             (<a class="code" href="structdwc__otg__hc__regs.html">dwc_otg_hc_regs_t</a> *) ((<span class="keywordtype">char</span> *)
<a name="l02280"></a>02280                                                                    global_regs +
<a name="l02281"></a>02281                                                                    0x500);
<a name="l02282"></a>02282                                         data_fifo =
<a name="l02283"></a>02283                                             (uint32_t *) ((<span class="keywordtype">char</span> *)global_regs +
<a name="l02284"></a>02284                                                           0x1000);
<a name="l02285"></a>02285 
<a name="l02286"></a>02286                                         <span class="keywordflow">if</span> (t == 6) {   <span class="comment">/* HS_HOST_PORT_SUSPEND_RESUME */</span>
<a name="l02287"></a>02287                                                 <span class="comment">/* Save current interrupt mask */</span>
<a name="l02288"></a>02288                                                 gintmsk.<a class="code" href="uniongintmsk__data.html#9c007bd53320f30b3cb06eb56b96673d">d32</a> =
<a name="l02289"></a>02289                                                     dwc_read_reg32
<a name="l02290"></a>02290                                                     (&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#48827c76da2c6b18f369e2f2483cc4b6">gintmsk</a>);
<a name="l02291"></a>02291 
<a name="l02292"></a>02292                                                 <span class="comment">/* Disable all interrupts while we muck with</span>
<a name="l02293"></a>02293 <span class="comment">                                                 * the hardware directly</span>
<a name="l02294"></a>02294 <span class="comment">                                                 */</span>
<a name="l02295"></a>02295                                                 dwc_write_reg32(&amp;global_regs-&gt;
<a name="l02296"></a>02296                                                                 gintmsk, 0);
<a name="l02297"></a>02297 
<a name="l02298"></a>02298                                                 <span class="comment">/* 15 second delay per the test spec */</span>
<a name="l02299"></a>02299                                                 dwc_mdelay(15000);
<a name="l02300"></a>02300 
<a name="l02301"></a>02301                                                 <span class="comment">/* Drive suspend on the root port */</span>
<a name="l02302"></a>02302                                                 hprt0.<a class="code" href="unionhprt0__data.html#88e9271f697d2ec209fc6a6da67fe216">d32</a> =
<a name="l02303"></a>02303                                                     <a class="code" href="dwc__otg__cil_8h.html#ce67da6af4023cffd25333d20992438e">dwc_otg_read_hprt0</a>(core_if);
<a name="l02304"></a>02304                                                 hprt0.<a class="code" href="unionhprt0__data.html#08cd86ce6da6462fc53601db7e2b73f3">b</a>.<a class="code" href="unionhprt0__data.html#e7fe71d6c465ae002211c24a6ba359d2">prtsusp</a> = 1;
<a name="l02305"></a>02305                                                 hprt0.<a class="code" href="unionhprt0__data.html#08cd86ce6da6462fc53601db7e2b73f3">b</a>.<a class="code" href="unionhprt0__data.html#3f5961529636a3891a4ca9421dd535fa">prtres</a> = 0;
<a name="l02306"></a>02306                                                 dwc_write_reg32(core_if-&gt;
<a name="l02307"></a>02307                                                                 host_if-&gt;hprt0,
<a name="l02308"></a>02308                                                                 hprt0.<a class="code" href="unionhprt0__data.html#88e9271f697d2ec209fc6a6da67fe216">d32</a>);
<a name="l02309"></a>02309 
<a name="l02310"></a>02310                                                 <span class="comment">/* 15 second delay per the test spec */</span>
<a name="l02311"></a>02311                                                 dwc_mdelay(15000);
<a name="l02312"></a>02312 
<a name="l02313"></a>02313                                                 <span class="comment">/* Drive resume on the root port */</span>
<a name="l02314"></a>02314                                                 hprt0.<a class="code" href="unionhprt0__data.html#88e9271f697d2ec209fc6a6da67fe216">d32</a> =
<a name="l02315"></a>02315                                                     <a class="code" href="dwc__otg__cil_8h.html#ce67da6af4023cffd25333d20992438e">dwc_otg_read_hprt0</a>(core_if);
<a name="l02316"></a>02316                                                 hprt0.<a class="code" href="unionhprt0__data.html#08cd86ce6da6462fc53601db7e2b73f3">b</a>.<a class="code" href="unionhprt0__data.html#e7fe71d6c465ae002211c24a6ba359d2">prtsusp</a> = 0;
<a name="l02317"></a>02317                                                 hprt0.<a class="code" href="unionhprt0__data.html#08cd86ce6da6462fc53601db7e2b73f3">b</a>.<a class="code" href="unionhprt0__data.html#3f5961529636a3891a4ca9421dd535fa">prtres</a> = 1;
<a name="l02318"></a>02318                                                 dwc_write_reg32(core_if-&gt;
<a name="l02319"></a>02319                                                                 host_if-&gt;hprt0,
<a name="l02320"></a>02320                                                                 hprt0.<a class="code" href="unionhprt0__data.html#88e9271f697d2ec209fc6a6da67fe216">d32</a>);
<a name="l02321"></a>02321                                                 dwc_mdelay(100);
<a name="l02322"></a>02322 
<a name="l02323"></a>02323                                                 <span class="comment">/* Clear the resume bit */</span>
<a name="l02324"></a>02324                                                 hprt0.<a class="code" href="unionhprt0__data.html#08cd86ce6da6462fc53601db7e2b73f3">b</a>.<a class="code" href="unionhprt0__data.html#3f5961529636a3891a4ca9421dd535fa">prtres</a> = 0;
<a name="l02325"></a>02325                                                 dwc_write_reg32(core_if-&gt;
<a name="l02326"></a>02326                                                                 host_if-&gt;hprt0,
<a name="l02327"></a>02327                                                                 hprt0.<a class="code" href="unionhprt0__data.html#88e9271f697d2ec209fc6a6da67fe216">d32</a>);
<a name="l02328"></a>02328 
<a name="l02329"></a>02329                                                 <span class="comment">/* Restore interrupts */</span>
<a name="l02330"></a>02330                                                 dwc_write_reg32(&amp;global_regs-&gt;
<a name="l02331"></a>02331                                                                 gintmsk,
<a name="l02332"></a>02332                                                                 gintmsk.<a class="code" href="uniongintmsk__data.html#9c007bd53320f30b3cb06eb56b96673d">d32</a>);
<a name="l02333"></a>02333                                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (t == 7) {    <span class="comment">/* SINGLE_STEP_GET_DEVICE_DESCRIPTOR setup */</span>
<a name="l02334"></a>02334                                                 <span class="comment">/* Save current interrupt mask */</span>
<a name="l02335"></a>02335                                                 gintmsk.<a class="code" href="uniongintmsk__data.html#9c007bd53320f30b3cb06eb56b96673d">d32</a> =
<a name="l02336"></a>02336                                                     dwc_read_reg32
<a name="l02337"></a>02337                                                     (&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#48827c76da2c6b18f369e2f2483cc4b6">gintmsk</a>);
<a name="l02338"></a>02338 
<a name="l02339"></a>02339                                                 <span class="comment">/* Disable all interrupts while we muck with</span>
<a name="l02340"></a>02340 <span class="comment">                                                 * the hardware directly</span>
<a name="l02341"></a>02341 <span class="comment">                                                 */</span>
<a name="l02342"></a>02342                                                 dwc_write_reg32(&amp;global_regs-&gt;
<a name="l02343"></a>02343                                                                 gintmsk, 0);
<a name="l02344"></a>02344 
<a name="l02345"></a>02345                                                 <span class="comment">/* 15 second delay per the test spec */</span>
<a name="l02346"></a>02346                                                 dwc_mdelay(15000);
<a name="l02347"></a>02347 
<a name="l02348"></a>02348                                                 <span class="comment">/* Send the Setup packet */</span>
<a name="l02349"></a>02349                                                 do_setup();
<a name="l02350"></a>02350 
<a name="l02351"></a>02351                                                 <span class="comment">/* 15 second delay so nothing else happens for awhile */</span>
<a name="l02352"></a>02352                                                 dwc_mdelay(15000);
<a name="l02353"></a>02353 
<a name="l02354"></a>02354                                                 <span class="comment">/* Restore interrupts */</span>
<a name="l02355"></a>02355                                                 dwc_write_reg32(&amp;global_regs-&gt;
<a name="l02356"></a>02356                                                                 gintmsk,
<a name="l02357"></a>02357                                                                 gintmsk.<a class="code" href="uniongintmsk__data.html#9c007bd53320f30b3cb06eb56b96673d">d32</a>);
<a name="l02358"></a>02358                                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (t == 8) {    <span class="comment">/* SINGLE_STEP_GET_DEVICE_DESCRIPTOR execute */</span>
<a name="l02359"></a>02359                                                 <span class="comment">/* Save current interrupt mask */</span>
<a name="l02360"></a>02360                                                 gintmsk.<a class="code" href="uniongintmsk__data.html#9c007bd53320f30b3cb06eb56b96673d">d32</a> =
<a name="l02361"></a>02361                                                     dwc_read_reg32
<a name="l02362"></a>02362                                                     (&amp;global_regs-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#48827c76da2c6b18f369e2f2483cc4b6">gintmsk</a>);
<a name="l02363"></a>02363 
<a name="l02364"></a>02364                                                 <span class="comment">/* Disable all interrupts while we muck with</span>
<a name="l02365"></a>02365 <span class="comment">                                                 * the hardware directly</span>
<a name="l02366"></a>02366 <span class="comment">                                                 */</span>
<a name="l02367"></a>02367                                                 dwc_write_reg32(&amp;global_regs-&gt;
<a name="l02368"></a>02368                                                                 gintmsk, 0);
<a name="l02369"></a>02369 
<a name="l02370"></a>02370                                                 <span class="comment">/* Send the Setup packet */</span>
<a name="l02371"></a>02371                                                 do_setup();
<a name="l02372"></a>02372 
<a name="l02373"></a>02373                                                 <span class="comment">/* 15 second delay so nothing else happens for awhile */</span>
<a name="l02374"></a>02374                                                 dwc_mdelay(15000);
<a name="l02375"></a>02375 
<a name="l02376"></a>02376                                                 <span class="comment">/* Send the In and Ack packets */</span>
<a name="l02377"></a>02377                                                 do_in_ack();
<a name="l02378"></a>02378 
<a name="l02379"></a>02379                                                 <span class="comment">/* 15 second delay so nothing else happens for awhile */</span>
<a name="l02380"></a>02380                                                 dwc_mdelay(15000);
<a name="l02381"></a>02381 
<a name="l02382"></a>02382                                                 <span class="comment">/* Restore interrupts */</span>
<a name="l02383"></a>02383                                                 dwc_write_reg32(&amp;global_regs-&gt;
<a name="l02384"></a>02384                                                                 gintmsk,
<a name="l02385"></a>02385                                                                 gintmsk.<a class="code" href="uniongintmsk__data.html#9c007bd53320f30b3cb06eb56b96673d">d32</a>);
<a name="l02386"></a>02386                                         }
<a name="l02387"></a>02387                                 }
<a name="l02388"></a>02388                                 <span class="keywordflow">break</span>;
<a name="l02389"></a>02389                         }
<a name="l02390"></a>02390 <span class="preprocessor">#endif                          </span><span class="comment">/* DWC_HS_ELECT_TST */</span>
<a name="l02391"></a>02391 
<a name="l02392"></a>02392                 <span class="keywordflow">case</span> UHF_PORT_INDICATOR:
<a name="l02393"></a>02393                         <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(DBG_HCD, <span class="stringliteral">"DWC OTG HCD HUB CONTROL - "</span>
<a name="l02394"></a>02394                                     <span class="stringliteral">"SetPortFeature - USB_PORT_FEAT_INDICATOR\n"</span>);
<a name="l02395"></a>02395                         <span class="comment">/* Not supported */</span>
<a name="l02396"></a>02396                         <span class="keywordflow">break</span>;
<a name="l02397"></a>02397                 <span class="keywordflow">default</span>:
<a name="l02398"></a>02398                         retval = -DWC_E_INVALID;
<a name="l02399"></a>02399                         DWC_ERROR(<span class="stringliteral">"DWC OTG HCD - "</span>
<a name="l02400"></a>02400                                   <span class="stringliteral">"SetPortFeature request %xh "</span>
<a name="l02401"></a>02401                                   <span class="stringliteral">"unknown or unsupported\n"</span>, wValue);
<a name="l02402"></a>02402                         <span class="keywordflow">break</span>;
<a name="l02403"></a>02403                 }
<a name="l02404"></a>02404                 <span class="keywordflow">break</span>;
<a name="l02405"></a>02405 <span class="preprocessor">#ifdef CONFIG_USB_DWC_OTG_LPM</span>
<a name="l02406"></a>02406 <span class="preprocessor"></span>        <span class="keywordflow">case</span> UCR_SET_AND_TEST_PORT_FEATURE:
<a name="l02407"></a>02407                 <span class="keywordflow">if</span> (wValue != UHF_PORT_L1) {
<a name="l02408"></a>02408                         <span class="keywordflow">goto</span> error;
<a name="l02409"></a>02409                 }
<a name="l02410"></a>02410                 {
<a name="l02411"></a>02411                         <span class="keywordtype">int</span> portnum, hird, devaddr, remwake;
<a name="l02412"></a>02412                         <a class="code" href="unionglpmctl__data.html">glpmcfg_data_t</a> lpmcfg;
<a name="l02413"></a>02413                         uint32_t time_usecs;
<a name="l02414"></a>02414                         <a class="code" href="uniongintsts__data.html">gintsts_data_t</a> gintsts;
<a name="l02415"></a>02415                         <a class="code" href="uniongintmsk__data.html">gintmsk_data_t</a> gintmsk;
<a name="l02416"></a>02416 
<a name="l02417"></a>02417                         <span class="keywordflow">if</span> (!<a class="code" href="dwc__otg__cil_8c.html#0e0eb29733595730396da3ddf3d0ded5">dwc_otg_get_param_lpm_enable</a>(core_if)) {
<a name="l02418"></a>02418                                 <span class="keywordflow">goto</span> error;
<a name="l02419"></a>02419                         }
<a name="l02420"></a>02420                         <span class="keywordflow">if</span> (wValue != UHF_PORT_L1 || wLength != 1) {
<a name="l02421"></a>02421                                 <span class="keywordflow">goto</span> error;
<a name="l02422"></a>02422                         }
<a name="l02423"></a>02423                         <span class="comment">/* Check if the port currently is in SLEEP state */</span>
<a name="l02424"></a>02424                         lpmcfg.<a class="code" href="unionglpmctl__data.html#cd41461734ff898209bfb64057ef2eb8">d32</a> =
<a name="l02425"></a>02425                             dwc_read_reg32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#909eae7e3b9432ca1e278b99f7811f52">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#843cfb38ba366a9a46ad07ed11eb8396">glpmcfg</a>);
<a name="l02426"></a>02426                         <span class="keywordflow">if</span> (lpmcfg.<a class="code" href="unionglpmctl__data.html#bd3cc34c338226ff1cd89448f7590ff1">b</a>.<a class="code" href="unionglpmctl__data.html#241ff25a215f16ac29b3bb6d9f4943ed">prt_sleep_sts</a>) {
<a name="l02427"></a>02427                                 DWC_INFO(<span class="stringliteral">"Port is already in sleep mode\n"</span>);
<a name="l02428"></a>02428                                 buf[0] = 0;     <span class="comment">/* Return success */</span>
<a name="l02429"></a>02429                                 <span class="keywordflow">break</span>;
<a name="l02430"></a>02430                         }
<a name="l02431"></a>02431 
<a name="l02432"></a>02432                         portnum = wIndex &amp; 0xf;
<a name="l02433"></a>02433                         hird = (wIndex &gt;&gt; 4) &amp; 0xf;
<a name="l02434"></a>02434                         devaddr = (wIndex &gt;&gt; 8) &amp; 0x7f;
<a name="l02435"></a>02435                         remwake = (wIndex &gt;&gt; 15);
<a name="l02436"></a>02436 
<a name="l02437"></a>02437                         <span class="keywordflow">if</span> (portnum != 1) {
<a name="l02438"></a>02438                                 retval = -DWC_E_INVALID;
<a name="l02439"></a>02439                                 DWC_WARN
<a name="l02440"></a>02440                                     (<span class="stringliteral">"Wrong port number(%d) in SetandTestPortFeature request\n"</span>,
<a name="l02441"></a>02441                                      portnum);
<a name="l02442"></a>02442                                 <span class="keywordflow">break</span>;
<a name="l02443"></a>02443                         }
<a name="l02444"></a>02444 
<a name="l02445"></a>02445                         DWC_PRINTF
<a name="l02446"></a>02446                             (<span class="stringliteral">"SetandTestPortFeature request: portnum = %d, hird = %d, devaddr = %d, rewake = %d\n"</span>,
<a name="l02447"></a>02447                              portnum, hird, devaddr, remwake);
<a name="l02448"></a>02448                         <span class="comment">/* Disable LPM interrupt */</span>
<a name="l02449"></a>02449                         gintmsk.<a class="code" href="uniongintmsk__data.html#9c007bd53320f30b3cb06eb56b96673d">d32</a> = 0;
<a name="l02450"></a>02450                         gintmsk.<a class="code" href="uniongintmsk__data.html#6f9ac3edb378165675a3203f555aa8d6">b</a>.<a class="code" href="uniongintmsk__data.html#24f9f89b33866c5dc7b16588bc94e103">lpmtranrcvd</a> = 1;
<a name="l02451"></a>02451                         dwc_modify_reg32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#909eae7e3b9432ca1e278b99f7811f52">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#48827c76da2c6b18f369e2f2483cc4b6">gintmsk</a>,
<a name="l02452"></a>02452                                          gintmsk.<a class="code" href="uniongintmsk__data.html#9c007bd53320f30b3cb06eb56b96673d">d32</a>, 0);
<a name="l02453"></a>02453 
<a name="l02454"></a>02454                         <span class="keywordflow">if</span> (<a class="code" href="dwc__otg__hcd__if_8h.html#b0c95e7f6cda9e15d767ad3ef6a7f1cc">dwc_otg_hcd_send_lpm</a>
<a name="l02455"></a>02455                             (dwc_otg_hcd, devaddr, hird, remwake)) {
<a name="l02456"></a>02456                                 retval = -DWC_E_INVALID;
<a name="l02457"></a>02457                                 <span class="keywordflow">break</span>;
<a name="l02458"></a>02458                         }
<a name="l02459"></a>02459 
<a name="l02460"></a>02460                         time_usecs = 10 * (lpmcfg.<a class="code" href="unionglpmctl__data.html#bd3cc34c338226ff1cd89448f7590ff1">b</a>.<a class="code" href="unionglpmctl__data.html#be75ed525bcfe231cd9bda6a1b8594f6">retry_count</a> + 1);
<a name="l02461"></a>02461                         <span class="comment">/* We will consider timeout if time_usecs microseconds pass,</span>
<a name="l02462"></a>02462 <span class="comment">                         * and we don't receive LPM transaction status.</span>
<a name="l02463"></a>02463 <span class="comment">                         * After receiving non-error responce(ACK/NYET/STALL) from device,</span>
<a name="l02464"></a>02464 <span class="comment">                         *  core will set lpmtranrcvd bit.</span>
<a name="l02465"></a>02465 <span class="comment">                         */</span>
<a name="l02466"></a>02466                         <span class="keywordflow">do</span> {
<a name="l02467"></a>02467                                 gintsts.<a class="code" href="uniongintsts__data.html#379f34f5a95628b735e3a965f9cea12d">d32</a> =
<a name="l02468"></a>02468                                     dwc_read_reg32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#909eae7e3b9432ca1e278b99f7811f52">core_global_regs</a>-&gt;
<a name="l02469"></a>02469                                                    gintsts);
<a name="l02470"></a>02470                                 <span class="keywordflow">if</span> (gintsts.<a class="code" href="uniongintsts__data.html#781da5558468e5dbdc93ae95e4cb872e">b</a>.<a class="code" href="uniongintsts__data.html#50e73e91df681c835de50f8276058829">lpmtranrcvd</a>) {
<a name="l02471"></a>02471                                         <span class="keywordflow">break</span>;
<a name="l02472"></a>02472                                 }
<a name="l02473"></a>02473                                 dwc_udelay(1);
<a name="l02474"></a>02474                         } <span class="keywordflow">while</span> (--time_usecs);
<a name="l02475"></a>02475                         <span class="comment">/* lpm_int bit will be cleared in LPM interrupt handler */</span>
<a name="l02476"></a>02476 
<a name="l02477"></a>02477                         <span class="comment">/* Now fill status</span>
<a name="l02478"></a>02478 <span class="comment">                         * 0x00 - Success</span>
<a name="l02479"></a>02479 <span class="comment">                         * 0x10 - NYET</span>
<a name="l02480"></a>02480 <span class="comment">                         * 0x11 - Timeout</span>
<a name="l02481"></a>02481 <span class="comment">                         */</span>
<a name="l02482"></a>02482                         <span class="keywordflow">if</span> (!gintsts.<a class="code" href="uniongintsts__data.html#781da5558468e5dbdc93ae95e4cb872e">b</a>.<a class="code" href="uniongintsts__data.html#50e73e91df681c835de50f8276058829">lpmtranrcvd</a>) {
<a name="l02483"></a>02483                                 buf[0] = 0x3;   <span class="comment">/* Completion code is Timeout */</span>
<a name="l02484"></a>02484                                 dwc_otg_hcd_free_hc_from_lpm(dwc_otg_hcd);
<a name="l02485"></a>02485                         } <span class="keywordflow">else</span> {
<a name="l02486"></a>02486                                 lpmcfg.<a class="code" href="unionglpmctl__data.html#cd41461734ff898209bfb64057ef2eb8">d32</a> =
<a name="l02487"></a>02487                                     dwc_read_reg32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#909eae7e3b9432ca1e278b99f7811f52">core_global_regs</a>-&gt;
<a name="l02488"></a>02488                                                    glpmcfg);
<a name="l02489"></a>02489                                 <span class="keywordflow">if</span> (lpmcfg.<a class="code" href="unionglpmctl__data.html#bd3cc34c338226ff1cd89448f7590ff1">b</a>.<a class="code" href="unionglpmctl__data.html#752c00118919fce173804931b058c5a8">lpm_resp</a> == 0x3) {
<a name="l02490"></a>02490                                         <span class="comment">/* ACK responce from the device */</span>
<a name="l02491"></a>02491                                         buf[0] = 0x00;  <span class="comment">/* Success */</span>
<a name="l02492"></a>02492                                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lpmcfg.<a class="code" href="unionglpmctl__data.html#bd3cc34c338226ff1cd89448f7590ff1">b</a>.<a class="code" href="unionglpmctl__data.html#752c00118919fce173804931b058c5a8">lpm_resp</a> == 0x2) {
<a name="l02493"></a>02493                                         <span class="comment">/* NYET responce from the device */</span>
<a name="l02494"></a>02494                                         buf[0] = 0x2;
<a name="l02495"></a>02495                                 } <span class="keywordflow">else</span> {
<a name="l02496"></a>02496                                         <span class="comment">/* Otherwise responce with Timeout */</span>
<a name="l02497"></a>02497                                         buf[0] = 0x3;
<a name="l02498"></a>02498                                 }
<a name="l02499"></a>02499                         }
<a name="l02500"></a>02500                         DWC_PRINTF(<span class="stringliteral">"Device responce to LPM trans is %x\n"</span>,
<a name="l02501"></a>02501                                    lpmcfg.<a class="code" href="unionglpmctl__data.html#bd3cc34c338226ff1cd89448f7590ff1">b</a>.<a class="code" href="unionglpmctl__data.html#752c00118919fce173804931b058c5a8">lpm_resp</a>);
<a name="l02502"></a>02502                         dwc_modify_reg32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#909eae7e3b9432ca1e278b99f7811f52">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#48827c76da2c6b18f369e2f2483cc4b6">gintmsk</a>, 0,
<a name="l02503"></a>02503                                          gintmsk.<a class="code" href="uniongintmsk__data.html#9c007bd53320f30b3cb06eb56b96673d">d32</a>);
<a name="l02504"></a>02504 
<a name="l02505"></a>02505                         <span class="keywordflow">break</span>;
<a name="l02506"></a>02506                 }
<a name="l02507"></a>02507 <span class="preprocessor">#endif                          </span><span class="comment">/* CONFIG_USB_DWC_OTG_LPM */</span>
<a name="l02508"></a>02508         <span class="keywordflow">default</span>:
<a name="l02509"></a>02509               error:
<a name="l02510"></a>02510                 retval = -DWC_E_INVALID;
<a name="l02511"></a>02511                 DWC_WARN(<span class="stringliteral">"DWC OTG HCD - "</span>
<a name="l02512"></a>02512                          <span class="stringliteral">"Unknown hub control request type or invalid typeReq: %xh wIndex: %xh wValue: %xh\n"</span>,
<a name="l02513"></a>02513                          typeReq, wIndex, wValue);
<a name="l02514"></a>02514                 <span class="keywordflow">break</span>;
<a name="l02515"></a>02515         }
<a name="l02516"></a>02516 
<a name="l02517"></a>02517         <span class="keywordflow">return</span> retval;
<a name="l02518"></a>02518 }
<a name="l02519"></a>02519 
<a name="l02520"></a>02520 <span class="preprocessor">#ifdef CONFIG_USB_DWC_OTG_LPM</span>
<a name="l02521"></a>02521 <span class="preprocessor"></span>
<a name="l02522"></a>02522 <span class="keywordtype">int</span> dwc_otg_hcd_get_hc_for_lpm_tran(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd, uint8_t devaddr)
<a name="l02523"></a>02523 {
<a name="l02524"></a>02524         <a class="code" href="structdwc__otg__core__if.html">dwc_otg_core_if_t</a> *core_if = hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>;
<a name="l02525"></a>02525         <a class="code" href="structdwc__hc.html">dwc_hc_t</a> *hc;
<a name="l02526"></a>02526         <a class="code" href="unionhcchar__data.html">hcchar_data_t</a> hcchar;
<a name="l02527"></a>02527         <a class="code" href="uniongintmsk__data.html">gintmsk_data_t</a> gintmsk = {.<a class="code" href="unionhcchar__data.html#03d352fb421ab5c11bf9afaae4933ba4">d32</a> = 0 };
<a name="l02528"></a>02528 
<a name="l02529"></a>02529         <span class="keywordflow">if</span> (DWC_CIRCLEQ_EMPTY(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#1761f2e6b8f6ba82c0e0c4e561813f0f">free_hc_list</a>)) {
<a name="l02530"></a>02530                 DWC_PRINTF(<span class="stringliteral">"No free channel to select for LPM transaction\n"</span>);
<a name="l02531"></a>02531                 <span class="keywordflow">return</span> -1;
<a name="l02532"></a>02532         }
<a name="l02533"></a>02533 
<a name="l02534"></a>02534         hc = DWC_CIRCLEQ_FIRST(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#1761f2e6b8f6ba82c0e0c4e561813f0f">free_hc_list</a>);
<a name="l02535"></a>02535 
<a name="l02536"></a>02536         <span class="comment">/* Mask host channel interrupts. */</span>
<a name="l02537"></a>02537         gintmsk.<a class="code" href="uniongintmsk__data.html#6f9ac3edb378165675a3203f555aa8d6">b</a>.<a class="code" href="uniongintmsk__data.html#3a4c193d8ff48291809dcd3ccb7c0585">hcintr</a> = 1;
<a name="l02538"></a>02538         dwc_modify_reg32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#909eae7e3b9432ca1e278b99f7811f52">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#48827c76da2c6b18f369e2f2483cc4b6">gintmsk</a>, gintmsk.<a class="code" href="uniongintmsk__data.html#9c007bd53320f30b3cb06eb56b96673d">d32</a>, 0);
<a name="l02539"></a>02539 
<a name="l02540"></a>02540         <span class="comment">/* Fill fields that core needs for LPM transaction */</span>
<a name="l02541"></a>02541         hcchar.<a class="code" href="unionhcchar__data.html#231c3638b02200c477e402d977c31e51">b</a>.<a class="code" href="unionhcchar__data.html#19326a679cb3507cf294d229834252a1">devaddr</a> = devaddr;
<a name="l02542"></a>02542         hcchar.<a class="code" href="unionhcchar__data.html#231c3638b02200c477e402d977c31e51">b</a>.<a class="code" href="unionhcchar__data.html#1597f36b85006e643aaf6f4d503bebc9">epnum</a> = 0;
<a name="l02543"></a>02543         hcchar.<a class="code" href="unionhcchar__data.html#231c3638b02200c477e402d977c31e51">b</a>.<a class="code" href="unionhcchar__data.html#df4deee52d932ab29e5d077cde77cbfc">eptype</a> = <a class="code" href="dwc__otg__cil_8h.html#64e5cd756330f5adab79b25cc8067bdc">DWC_OTG_EP_TYPE_CONTROL</a>;
<a name="l02544"></a>02544         hcchar.<a class="code" href="unionhcchar__data.html#231c3638b02200c477e402d977c31e51">b</a>.<a class="code" href="unionhcchar__data.html#47d11a5e62f69534d8ac0606aa7ffe7d">mps</a> = 64;
<a name="l02545"></a>02545         hcchar.<a class="code" href="unionhcchar__data.html#231c3638b02200c477e402d977c31e51">b</a>.<a class="code" href="unionhcchar__data.html#ca469c8bda88761c4d9ef74b811d71f4">lspddev</a> = (hc-&gt;<a class="code" href="structdwc__hc.html#570b78178975193edb921af1ef36d37b">speed</a> == <a class="code" href="dwc__otg__cil_8h.html#1a25260b2e1a06850c26f7b7e5128f31">DWC_OTG_EP_SPEED_LOW</a>);
<a name="l02546"></a>02546         hcchar.<a class="code" href="unionhcchar__data.html#231c3638b02200c477e402d977c31e51">b</a>.<a class="code" href="unionhcchar__data.html#11f1b16e50f90806f90953bb979d4e77">epdir</a> = 0;     <span class="comment">/* OUT */</span>
<a name="l02547"></a>02547         dwc_write_reg32(&amp;core_if-&gt;<a class="code" href="structdwc__otg__core__if.html#51bac71891b5f6f435d7fc4582b974c1">host_if</a>-&gt;<a class="code" href="structdwc__otg__host__if.html#7f7c107d4720641eb4141cd817211ac0">hc_regs</a>[hc-&gt;<a class="code" href="structdwc__hc.html#df0c2b93e5c84cfaba6f06eaeaece5a1">hc_num</a>]-&gt;hcchar,
<a name="l02548"></a>02548                         hcchar.<a class="code" href="unionhcchar__data.html#03d352fb421ab5c11bf9afaae4933ba4">d32</a>);
<a name="l02549"></a>02549 
<a name="l02550"></a>02550         <span class="comment">/* Remove the host channel from the free list. */</span>
<a name="l02551"></a>02551         DWC_CIRCLEQ_REMOVE_INIT(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#1761f2e6b8f6ba82c0e0c4e561813f0f">free_hc_list</a>, hc, hc_list_entry);
<a name="l02552"></a>02552 
<a name="l02553"></a>02553         DWC_PRINTF(<span class="stringliteral">"hcnum = %d devaddr = %d\n"</span>, hc-&gt;<a class="code" href="structdwc__hc.html#df0c2b93e5c84cfaba6f06eaeaece5a1">hc_num</a>, devaddr);
<a name="l02554"></a>02554 
<a name="l02555"></a>02555         <span class="keywordflow">return</span> hc-&gt;<a class="code" href="structdwc__hc.html#df0c2b93e5c84cfaba6f06eaeaece5a1">hc_num</a>;
<a name="l02556"></a>02556 }
<a name="l02557"></a>02557 
<a name="l02559"></a>02559 <span class="keywordtype">void</span> dwc_otg_hcd_free_hc_from_lpm(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd)
<a name="l02560"></a>02560 {
<a name="l02561"></a>02561         <a class="code" href="structdwc__hc.html">dwc_hc_t</a> *hc;
<a name="l02562"></a>02562         <a class="code" href="unionglpmctl__data.html">glpmcfg_data_t</a> lpmcfg;
<a name="l02563"></a>02563         uint8_t hc_num;
<a name="l02564"></a>02564 
<a name="l02565"></a>02565         lpmcfg.<a class="code" href="unionglpmctl__data.html#cd41461734ff898209bfb64057ef2eb8">d32</a> = dwc_read_reg32(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#909eae7e3b9432ca1e278b99f7811f52">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#843cfb38ba366a9a46ad07ed11eb8396">glpmcfg</a>);
<a name="l02566"></a>02566         hc_num = lpmcfg.<a class="code" href="unionglpmctl__data.html#bd3cc34c338226ff1cd89448f7590ff1">b</a>.<a class="code" href="unionglpmctl__data.html#7e6bb2a40d4e0bdfed6f868b1f670235">lpm_chan_index</a>;
<a name="l02567"></a>02567 
<a name="l02568"></a>02568         hc = hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#cb393f6a676fb106e0e3d35396fb97f9">hc_ptr_array</a>[hc_num];
<a name="l02569"></a>02569 
<a name="l02570"></a>02570         DWC_PRINTF(<span class="stringliteral">"Freeing channel %d after LPM\n"</span>, hc_num);
<a name="l02571"></a>02571         <span class="comment">/* Return host channel to free list */</span>
<a name="l02572"></a>02572         DWC_CIRCLEQ_INSERT_TAIL(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#1761f2e6b8f6ba82c0e0c4e561813f0f">free_hc_list</a>, hc, hc_list_entry);
<a name="l02573"></a>02573 }
<a name="l02574"></a>02574 
<a name="l02575"></a>02575 <span class="keywordtype">int</span> <a class="code" href="dwc__otg__hcd__if_8h.html#b0c95e7f6cda9e15d767ad3ef6a7f1cc">dwc_otg_hcd_send_lpm</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd, uint8_t devaddr, uint8_t hird,
<a name="l02576"></a>02576                          uint8_t bRemoteWake)
<a name="l02577"></a>02577 {
<a name="l02578"></a>02578         <a class="code" href="unionglpmctl__data.html">glpmcfg_data_t</a> lpmcfg;
<a name="l02579"></a>02579         <a class="code" href="unionpcgcctl__data.html">pcgcctl_data_t</a> pcgcctl = {.d32 = 0 };
<a name="l02580"></a>02580         <span class="keywordtype">int</span> channel;
<a name="l02581"></a>02581 
<a name="l02582"></a>02582         channel = dwc_otg_hcd_get_hc_for_lpm_tran(hcd, devaddr);
<a name="l02583"></a>02583         <span class="keywordflow">if</span> (channel &lt; 0) {
<a name="l02584"></a>02584                 <span class="keywordflow">return</span> channel;
<a name="l02585"></a>02585         }
<a name="l02586"></a>02586 
<a name="l02587"></a>02587         pcgcctl.<a class="code" href="unionpcgcctl__data.html#f2bb76709d0ab9d08280eafb78a36279">b</a>.<a class="code" href="unionpcgcctl__data.html#6c18ad3b71ad92e548d0c6d64cc88734">enbl_sleep_gating</a> = 1;
<a name="l02588"></a>02588         dwc_modify_reg32(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#348ed2c9aeae6fc608f1bb813978b3f9">pcgcctl</a>, 0, pcgcctl.<a class="code" href="unionpcgcctl__data.html#abe048ee884143501929b27d94c52db7">d32</a>);
<a name="l02589"></a>02589 
<a name="l02590"></a>02590         <span class="comment">/* Read LPM config register */</span>
<a name="l02591"></a>02591         lpmcfg.<a class="code" href="unionglpmctl__data.html#cd41461734ff898209bfb64057ef2eb8">d32</a> = dwc_read_reg32(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#909eae7e3b9432ca1e278b99f7811f52">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#843cfb38ba366a9a46ad07ed11eb8396">glpmcfg</a>);
<a name="l02592"></a>02592 
<a name="l02593"></a>02593         <span class="comment">/* Program LPM transaction fields */</span>
<a name="l02594"></a>02594         lpmcfg.<a class="code" href="unionglpmctl__data.html#bd3cc34c338226ff1cd89448f7590ff1">b</a>.<a class="code" href="unionglpmctl__data.html#60a9c2e233e3ee15a80ae80b27d09f8b">rem_wkup_en</a> = bRemoteWake;
<a name="l02595"></a>02595         lpmcfg.<a class="code" href="unionglpmctl__data.html#bd3cc34c338226ff1cd89448f7590ff1">b</a>.<a class="code" href="unionglpmctl__data.html#176b788935d1952606f523f2718b3512">hird</a> = hird;
<a name="l02596"></a>02596         lpmcfg.<a class="code" href="unionglpmctl__data.html#bd3cc34c338226ff1cd89448f7590ff1">b</a>.<a class="code" href="unionglpmctl__data.html#e2ceea4bfe468c7b3c800235d7ffd5d2">hird_thres</a> = 0x1c;
<a name="l02597"></a>02597         lpmcfg.<a class="code" href="unionglpmctl__data.html#bd3cc34c338226ff1cd89448f7590ff1">b</a>.<a class="code" href="unionglpmctl__data.html#7e6bb2a40d4e0bdfed6f868b1f670235">lpm_chan_index</a> = channel;
<a name="l02598"></a>02598         lpmcfg.<a class="code" href="unionglpmctl__data.html#bd3cc34c338226ff1cd89448f7590ff1">b</a>.<a class="code" href="unionglpmctl__data.html#63e912a05b8d29872b92263ca616fec8">en_utmi_sleep</a> = 1;
<a name="l02599"></a>02599         <span class="comment">/* Program LPM config register */</span>
<a name="l02600"></a>02600         dwc_write_reg32(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#909eae7e3b9432ca1e278b99f7811f52">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#843cfb38ba366a9a46ad07ed11eb8396">glpmcfg</a>, lpmcfg.<a class="code" href="unionglpmctl__data.html#cd41461734ff898209bfb64057ef2eb8">d32</a>);
<a name="l02601"></a>02601 
<a name="l02602"></a>02602         <span class="comment">/* Send LPM transaction */</span>
<a name="l02603"></a>02603         lpmcfg.<a class="code" href="unionglpmctl__data.html#bd3cc34c338226ff1cd89448f7590ff1">b</a>.<a class="code" href="unionglpmctl__data.html#0651e486c5502489b2cac633bb00c78e">send_lpm</a> = 1;
<a name="l02604"></a>02604         dwc_write_reg32(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#909eae7e3b9432ca1e278b99f7811f52">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#843cfb38ba366a9a46ad07ed11eb8396">glpmcfg</a>, lpmcfg.<a class="code" href="unionglpmctl__data.html#cd41461734ff898209bfb64057ef2eb8">d32</a>);
<a name="l02605"></a>02605 
<a name="l02606"></a>02606         <span class="keywordflow">return</span> 0;
<a name="l02607"></a>02607 }
<a name="l02608"></a>02608 
<a name="l02609"></a>02609 <span class="preprocessor">#endif                          </span><span class="comment">/* CONFIG_USB_DWC_OTG_LPM */</span>
<a name="l02610"></a>02610 
<a name="l02611"></a><a class="code" href="dwc__otg__hcd__if_8h.html#0d324c8dbb0c7cbadec8cebf943fc84b">02611</a> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__hcd_8c.html#0d324c8dbb0c7cbadec8cebf943fc84b">dwc_otg_hcd_is_status_changed</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd, <span class="keywordtype">int</span> port)
<a name="l02612"></a>02612 {
<a name="l02613"></a>02613         <span class="keywordtype">int</span> retval;
<a name="l02614"></a>02614 
<a name="l02615"></a>02615         <span class="keywordflow">if</span> (port != 1) {
<a name="l02616"></a>02616                 <span class="keywordflow">return</span> -DWC_E_INVALID;
<a name="l02617"></a>02617         }
<a name="l02618"></a>02618 
<a name="l02619"></a>02619         retval = (hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#9aaf2a112f5794f92dedd826342bd637">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#76f573861d9316238ded198c58c228c7">b</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#cd31ac4b9658265e90773448f354f0e1">port_connect_status_change</a> ||
<a name="l02620"></a>02620                   hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#9aaf2a112f5794f92dedd826342bd637">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#76f573861d9316238ded198c58c228c7">b</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#d0d63f32ed35315e8a02549521fb386e">port_reset_change</a> ||
<a name="l02621"></a>02621                   hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#9aaf2a112f5794f92dedd826342bd637">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#76f573861d9316238ded198c58c228c7">b</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#d222ae08372109a312f6649f77b650e8">port_enable_change</a> ||
<a name="l02622"></a>02622                   hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#9aaf2a112f5794f92dedd826342bd637">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#76f573861d9316238ded198c58c228c7">b</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#2a6e323cb4c01153aff1adc6269c74c7">port_suspend_change</a> ||
<a name="l02623"></a>02623                   hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#9aaf2a112f5794f92dedd826342bd637">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#76f573861d9316238ded198c58c228c7">b</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#bc96cf12e2bc5b61ce05f15ae3297bd6">port_over_current_change</a>);
<a name="l02624"></a>02624 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l02625"></a>02625 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (retval) {
<a name="l02626"></a>02626                 <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#e4a050e176c1c4f556da2b276a8c2b37">DBG_HCD</a>, <span class="stringliteral">"DWC OTG HCD HUB STATUS DATA:"</span>
<a name="l02627"></a>02627                             <span class="stringliteral">" Root port status changed\n"</span>);
<a name="l02628"></a>02628                 <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#39931d908ba215b3d5d590e42d8408b5">DBG_HCDV</a>, <span class="stringliteral">"  port_connect_status_change: %d\n"</span>,
<a name="l02629"></a>02629                             hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#9aaf2a112f5794f92dedd826342bd637">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#76f573861d9316238ded198c58c228c7">b</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#cd31ac4b9658265e90773448f354f0e1">port_connect_status_change</a>);
<a name="l02630"></a>02630                 <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#39931d908ba215b3d5d590e42d8408b5">DBG_HCDV</a>, <span class="stringliteral">"  port_reset_change: %d\n"</span>,
<a name="l02631"></a>02631                             hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#9aaf2a112f5794f92dedd826342bd637">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#76f573861d9316238ded198c58c228c7">b</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#d0d63f32ed35315e8a02549521fb386e">port_reset_change</a>);
<a name="l02632"></a>02632                 <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#39931d908ba215b3d5d590e42d8408b5">DBG_HCDV</a>, <span class="stringliteral">"  port_enable_change: %d\n"</span>,
<a name="l02633"></a>02633                             hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#9aaf2a112f5794f92dedd826342bd637">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#76f573861d9316238ded198c58c228c7">b</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#d222ae08372109a312f6649f77b650e8">port_enable_change</a>);
<a name="l02634"></a>02634                 <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#39931d908ba215b3d5d590e42d8408b5">DBG_HCDV</a>, <span class="stringliteral">"  port_suspend_change: %d\n"</span>,
<a name="l02635"></a>02635                             hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#9aaf2a112f5794f92dedd826342bd637">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#76f573861d9316238ded198c58c228c7">b</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#2a6e323cb4c01153aff1adc6269c74c7">port_suspend_change</a>);
<a name="l02636"></a>02636                 <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#39931d908ba215b3d5d590e42d8408b5">DBG_HCDV</a>, <span class="stringliteral">"  port_over_current_change: %d\n"</span>,
<a name="l02637"></a>02637                             hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#9aaf2a112f5794f92dedd826342bd637">flags</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#76f573861d9316238ded198c58c228c7">b</a>.<a class="code" href="uniondwc__otg__hcd_1_1dwc__otg__hcd__internal__flags.html#bc96cf12e2bc5b61ce05f15ae3297bd6">port_over_current_change</a>);
<a name="l02638"></a>02638         }
<a name="l02639"></a>02639 <span class="preprocessor">#endif</span>
<a name="l02640"></a>02640 <span class="preprocessor"></span>        <span class="keywordflow">return</span> retval;
<a name="l02641"></a>02641 }
<a name="l02642"></a>02642 
<a name="l02643"></a><a class="code" href="dwc__otg__hcd__if_8h.html#65b3f4d96d1b34abaa54c3bbb32ec07f">02643</a> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__hcd_8c.html#f06514bd6f8c219cc72d1f467a82c056">dwc_otg_hcd_get_frame_number</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * dwc_otg_hcd)
<a name="l02644"></a>02644 {
<a name="l02645"></a>02645         <a class="code" href="unionhfnum__data.html">hfnum_data_t</a> hfnum;
<a name="l02646"></a>02646         hfnum.<a class="code" href="unionhfnum__data.html#e5ccbed3af86ac88577ded328e6c9932">d32</a> = dwc_read_reg32(&amp;dwc_otg_hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;
<a name="l02647"></a>02647                                    host_if-&gt;host_global_regs-&gt;hfnum);
<a name="l02648"></a>02648 
<a name="l02649"></a>02649 <span class="preprocessor">#ifdef DEBUG_SOF</span>
<a name="l02650"></a>02650 <span class="preprocessor"></span>        <a class="code" href="dwc__otg__dbg_8h.html#ed38f5a57cb756e97a17c0926cc9a10e">DWC_DEBUGPL</a>(<a class="code" href="dwc__otg__dbg_8h.html#39931d908ba215b3d5d590e42d8408b5">DBG_HCDV</a>, <span class="stringliteral">"DWC OTG HCD GET FRAME NUMBER %d\n"</span>,
<a name="l02651"></a>02651                     hfnum.<a class="code" href="unionhfnum__data.html#81df6fbd20a454665803eb5790855c66">b</a>.<a class="code" href="unionhfnum__data.html#a64e8b6c4a1cd262dbc30e158f3cb8bc">frnum</a>);
<a name="l02652"></a>02652 <span class="preprocessor">#endif</span>
<a name="l02653"></a>02653 <span class="preprocessor"></span>        <span class="keywordflow">return</span> hfnum.<a class="code" href="unionhfnum__data.html#81df6fbd20a454665803eb5790855c66">b</a>.<a class="code" href="unionhfnum__data.html#a64e8b6c4a1cd262dbc30e158f3cb8bc">frnum</a>;
<a name="l02654"></a>02654 }
<a name="l02655"></a>02655 
<a name="l02656"></a><a class="code" href="dwc__otg__hcd__if_8h.html#7242be8ebc7f7516292cbe2344ab03be">02656</a> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__hcd_8c.html#7242be8ebc7f7516292cbe2344ab03be">dwc_otg_hcd_start</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd,
<a name="l02657"></a>02657                       <span class="keyword">struct</span> <a class="code" href="structdwc__otg__hcd__function__ops.html">dwc_otg_hcd_function_ops</a> *<a class="code" href="dwc__otg__pcd__linux_8c.html#9ce9b5e49c60906c189bee157dd68acd">fops</a>)
<a name="l02658"></a>02658 {
<a name="l02659"></a>02659         <span class="keywordtype">int</span> retval = 0;
<a name="l02660"></a>02660 
<a name="l02661"></a>02661         hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#ffefbd33a59a14b8b46406f5aaeaa2f4">fops</a> = <a class="code" href="dwc__otg__pcd__linux_8c.html#9ce9b5e49c60906c189bee157dd68acd">fops</a>;
<a name="l02662"></a>02662         <span class="keywordflow">if</span> (!<a class="code" href="dwc__otg__cil_8c.html#e83fb22890bc54c6b06cedb751430e77">dwc_otg_is_device_mode</a>(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>)) {
<a name="l02663"></a>02663                 <a class="code" href="dwc__otg__hcd_8c.html#a9b6729ba2077bed1b6d149970d5525e">dwc_otg_hcd_reinit</a>(hcd);
<a name="l02664"></a>02664         } <span class="keywordflow">else</span> {
<a name="l02665"></a>02665                 retval = -DWC_E_NO_DEVICE;
<a name="l02666"></a>02666         }
<a name="l02667"></a>02667 
<a name="l02668"></a>02668         <span class="keywordflow">return</span> retval;
<a name="l02669"></a>02669 }
<a name="l02670"></a>02670 
<a name="l02671"></a><a class="code" href="dwc__otg__hcd__if_8h.html#7740268b2d0fd8d25aaaeacfa5aef5cf">02671</a> <span class="keywordtype">void</span> *<a class="code" href="dwc__otg__hcd_8c.html#7740268b2d0fd8d25aaaeacfa5aef5cf">dwc_otg_hcd_get_priv_data</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd)
<a name="l02672"></a>02672 {
<a name="l02673"></a>02673         <span class="keywordflow">return</span> hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#c019b908f209d577ccc19d29030926a1">priv</a>;
<a name="l02674"></a>02674 }
<a name="l02675"></a>02675 
<a name="l02676"></a><a class="code" href="dwc__otg__hcd__if_8h.html#c73ca7d4284c8f0de7338a66607e4eb1">02676</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__hcd_8c.html#c73ca7d4284c8f0de7338a66607e4eb1">dwc_otg_hcd_set_priv_data</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd, <span class="keywordtype">void</span> *priv_data)
<a name="l02677"></a>02677 {
<a name="l02678"></a>02678         hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#c019b908f209d577ccc19d29030926a1">priv</a> = priv_data;
<a name="l02679"></a>02679 }
<a name="l02680"></a>02680 
<a name="l02681"></a><a class="code" href="dwc__otg__hcd__if_8h.html#e7d3657931984a1ce1cee5cf47cb08f3">02681</a> uint32_t <a class="code" href="dwc__otg__hcd_8c.html#e7d3657931984a1ce1cee5cf47cb08f3">dwc_otg_hcd_otg_port</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd)
<a name="l02682"></a>02682 {
<a name="l02683"></a>02683         <span class="keywordflow">return</span> hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#9231b4c3dce89a1506a5e501ec5c7a39">otg_port</a>;
<a name="l02684"></a>02684 }
<a name="l02685"></a>02685 
<a name="l02686"></a><a class="code" href="dwc__otg__hcd__if_8h.html#ca25b33b440a4ef112ee459c26c14adc">02686</a> uint32_t <a class="code" href="dwc__otg__hcd_8c.html#ca25b33b440a4ef112ee459c26c14adc">dwc_otg_hcd_is_b_host</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd)
<a name="l02687"></a>02687 {
<a name="l02688"></a>02688         uint32_t is_b_host;
<a name="l02689"></a>02689         <span class="keywordflow">if</span> (hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#5a5c5c1cf8d870101cc1fffac56d88c0">op_state</a> == <a class="code" href="dwc__otg__cil_8h.html#02d6d4d9a0fdcc4fc8c5cf8e6c8577aa">B_HOST</a>) {
<a name="l02690"></a>02690                 is_b_host = 1;
<a name="l02691"></a>02691         } <span class="keywordflow">else</span> {
<a name="l02692"></a>02692                 is_b_host = 0;
<a name="l02693"></a>02693         }
<a name="l02694"></a>02694 
<a name="l02695"></a>02695         <span class="keywordflow">return</span> is_b_host;
<a name="l02696"></a>02696 }
<a name="l02697"></a>02697 
<a name="l02698"></a><a class="code" href="dwc__otg__hcd__if_8h.html#264fc9d293c76e42dded9dee2cf44283">02698</a> <a class="code" href="structdwc__otg__hcd__urb.html">dwc_otg_hcd_urb_t</a> *<a class="code" href="dwc__otg__hcd_8c.html#264fc9d293c76e42dded9dee2cf44283">dwc_otg_hcd_urb_alloc</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd,
<a name="l02699"></a>02699                                          <span class="keywordtype">int</span> iso_desc_count, <span class="keywordtype">int</span> atomic_alloc)
<a name="l02700"></a>02700 {
<a name="l02701"></a>02701         <a class="code" href="structdwc__otg__hcd__urb.html">dwc_otg_hcd_urb_t</a> *dwc_otg_urb;
<a name="l02702"></a>02702         uint32_t size;
<a name="l02703"></a>02703 
<a name="l02704"></a>02704         size =
<a name="l02705"></a>02705             <span class="keyword">sizeof</span>(*dwc_otg_urb) +
<a name="l02706"></a>02706             iso_desc_count * <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structdwc__otg__hcd__iso__packet__desc.html">dwc_otg_hcd_iso_packet_desc</a>);
<a name="l02707"></a>02707         <span class="keywordflow">if</span> (atomic_alloc) {
<a name="l02708"></a>02708                 dwc_otg_urb = dwc_alloc_atomic(size);
<a name="l02709"></a>02709         } <span class="keywordflow">else</span> {
<a name="l02710"></a>02710                 dwc_otg_urb = dwc_alloc(size);
<a name="l02711"></a>02711         }
<a name="l02712"></a>02712         dwc_otg_urb-&gt;<a class="code" href="structdwc__otg__hcd__urb.html#570583697e8c1e4398969630bc2562f8">packet_count</a> = iso_desc_count;
<a name="l02713"></a>02713 
<a name="l02714"></a>02714         <span class="keywordflow">return</span> dwc_otg_urb;
<a name="l02715"></a>02715 }
<a name="l02716"></a>02716 
<a name="l02717"></a><a class="code" href="dwc__otg__hcd__if_8h.html#6c0a7bf2d1091d6e9e1ce767329fc04a">02717</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__hcd_8c.html#4aca8781f512198149388799a8ae9aba">dwc_otg_hcd_urb_set_pipeinfo</a>(<a class="code" href="structdwc__otg__hcd__urb.html">dwc_otg_hcd_urb_t</a> * dwc_otg_urb,
<a name="l02718"></a>02718                                   uint8_t dev_addr, uint8_t ep_num,
<a name="l02719"></a>02719                                   uint8_t ep_type, uint8_t ep_dir, uint16_t mps)
<a name="l02720"></a>02720 {
<a name="l02721"></a>02721         <a class="code" href="dwc__otg__hcd_8h.html#4806306754f0414ad9cee3067cdda8c9">dwc_otg_hcd_fill_pipe</a>(&amp;dwc_otg_urb-&gt;<a class="code" href="structdwc__otg__hcd__urb.html#34ee3ac5931687b41dd726f00c558369">pipe_info</a>, dev_addr, ep_num,
<a name="l02722"></a>02722                               ep_type, ep_dir, mps);
<a name="l02723"></a>02723 <span class="preprocessor">#if 0</span>
<a name="l02724"></a>02724 <span class="preprocessor"></span>        DWC_PRINTF
<a name="l02725"></a>02725             (<span class="stringliteral">"addr = %d, ep_num = %d, ep_dir = 0x%x, ep_type = 0x%x, mps = %d\n"</span>,
<a name="l02726"></a>02726              dev_addr, ep_num, ep_dir, ep_type, mps);
<a name="l02727"></a>02727 <span class="preprocessor">#endif</span>
<a name="l02728"></a>02728 <span class="preprocessor"></span>}
<a name="l02729"></a>02729 
<a name="l02730"></a><a class="code" href="dwc__otg__hcd__if_8h.html#356834d51d095518b6283a343bfab2b0">02730</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__hcd_8c.html#d141b0ed3f2eac3f8aab2d8cefe34345">dwc_otg_hcd_urb_set_params</a>(<a class="code" href="structdwc__otg__hcd__urb.html">dwc_otg_hcd_urb_t</a> * dwc_otg_urb,
<a name="l02731"></a>02731                                 <span class="keywordtype">void</span> *urb_handle, <span class="keywordtype">void</span> *buf, dwc_dma_t dma,
<a name="l02732"></a>02732                                 uint32_t buflen, <span class="keywordtype">void</span> *setup_packet,
<a name="l02733"></a>02733                                 dwc_dma_t setup_dma, uint32_t flags,
<a name="l02734"></a>02734                                 uint16_t interval)
<a name="l02735"></a>02735 {
<a name="l02736"></a>02736         dwc_otg_urb-&gt;<a class="code" href="structdwc__otg__hcd__urb.html#5ba0e393ef9768275db85c00e68be477">priv</a> = urb_handle;
<a name="l02737"></a>02737         dwc_otg_urb-&gt;<a class="code" href="structdwc__otg__hcd__urb.html#99ae35ffcd6147ddb93b361ab3bcfe95">buf</a> = buf;
<a name="l02738"></a>02738         dwc_otg_urb-&gt;<a class="code" href="structdwc__otg__hcd__urb.html#4e177a55239e95ae2f6c8b6b913f67fc">dma</a> = dma;
<a name="l02739"></a>02739         dwc_otg_urb-&gt;<a class="code" href="structdwc__otg__hcd__urb.html#dca57de4fdecd894241ce24167206a45">length</a> = buflen;
<a name="l02740"></a>02740         dwc_otg_urb-&gt;<a class="code" href="structdwc__otg__hcd__urb.html#254afd954f3e24bb92841384183a317c">setup_packet</a> = setup_packet;
<a name="l02741"></a>02741         dwc_otg_urb-&gt;<a class="code" href="structdwc__otg__hcd__urb.html#497f61f9b3f6f77f6b844e31c047264d">setup_dma</a> = setup_dma;
<a name="l02742"></a>02742         dwc_otg_urb-&gt;<a class="code" href="structdwc__otg__hcd__urb.html#2f1d90765496d78d297b3e57ef4d781c">flags</a> = flags;
<a name="l02743"></a>02743         dwc_otg_urb-&gt;<a class="code" href="structdwc__otg__hcd__urb.html#49c5353377e2fb173f1b34ae7be7e257">interval</a> = interval;
<a name="l02744"></a>02744         dwc_otg_urb-&gt;<a class="code" href="structdwc__otg__hcd__urb.html#101e4a6762b9911cdb85768890fa1210">status</a> = -DWC_E_IN_PROGRESS;
<a name="l02745"></a>02745 }
<a name="l02746"></a>02746 
<a name="l02747"></a><a class="code" href="dwc__otg__hcd__if_8h.html#81b7aad80889affb1e63cf1307b88fb6">02747</a> uint32_t <a class="code" href="dwc__otg__hcd_8c.html#81b7aad80889affb1e63cf1307b88fb6">dwc_otg_hcd_urb_get_status</a>(<a class="code" href="structdwc__otg__hcd__urb.html">dwc_otg_hcd_urb_t</a> * dwc_otg_urb)
<a name="l02748"></a>02748 {
<a name="l02749"></a>02749         <span class="keywordflow">return</span> dwc_otg_urb-&gt;<a class="code" href="structdwc__otg__hcd__urb.html#101e4a6762b9911cdb85768890fa1210">status</a>;
<a name="l02750"></a>02750 }
<a name="l02751"></a>02751 
<a name="l02752"></a><a class="code" href="dwc__otg__hcd__if_8h.html#3260f5db4ea20074da16b292eb1a686b">02752</a> uint32_t <a class="code" href="dwc__otg__hcd_8c.html#3260f5db4ea20074da16b292eb1a686b">dwc_otg_hcd_urb_get_actual_length</a>(<a class="code" href="structdwc__otg__hcd__urb.html">dwc_otg_hcd_urb_t</a> * dwc_otg_urb)
<a name="l02753"></a>02753 {
<a name="l02754"></a>02754         <span class="keywordflow">return</span> dwc_otg_urb-&gt;<a class="code" href="structdwc__otg__hcd__urb.html#742c8a97d3867ab89148eae34e0c73a6">actual_length</a>;
<a name="l02755"></a>02755 }
<a name="l02756"></a>02756 
<a name="l02757"></a><a class="code" href="dwc__otg__hcd__if_8h.html#816cc30c3129fc8911a458355d977129">02757</a> uint32_t <a class="code" href="dwc__otg__hcd_8c.html#816cc30c3129fc8911a458355d977129">dwc_otg_hcd_urb_get_error_count</a>(<a class="code" href="structdwc__otg__hcd__urb.html">dwc_otg_hcd_urb_t</a> * dwc_otg_urb)
<a name="l02758"></a>02758 {
<a name="l02759"></a>02759         <span class="keywordflow">return</span> dwc_otg_urb-&gt;<a class="code" href="structdwc__otg__hcd__urb.html#58c7018042c94c436637ea80354e7e28">error_count</a>;
<a name="l02760"></a>02760 }
<a name="l02761"></a>02761 
<a name="l02762"></a><a class="code" href="dwc__otg__hcd__if_8h.html#8617e93eba1bfd6466a9af1e6d2f731b">02762</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__hcd_8c.html#8617e93eba1bfd6466a9af1e6d2f731b">dwc_otg_hcd_urb_set_iso_desc_params</a>(<a class="code" href="structdwc__otg__hcd__urb.html">dwc_otg_hcd_urb_t</a> * dwc_otg_urb,
<a name="l02763"></a>02763                                          <span class="keywordtype">int</span> desc_num, uint32_t <a class="code" href="structdwc__otg__hcd__iso__packet__desc.html#246f3d147a22cd295c534253593dca4a">offset</a>,
<a name="l02764"></a>02764                                          uint32_t <a class="code" href="structdwc__otg__hcd__iso__packet__desc.html#8392d21b820df0181f4e6dca91234543">length</a>)
<a name="l02765"></a>02765 {
<a name="l02766"></a>02766         dwc_otg_urb-&gt;<a class="code" href="structdwc__otg__hcd__urb.html#ed542f6a2d99dba2f6b71b0d8012ec8a">iso_descs</a>[desc_num].<a class="code" href="structdwc__otg__hcd__iso__packet__desc.html#246f3d147a22cd295c534253593dca4a">offset</a> = offset;
<a name="l02767"></a>02767         dwc_otg_urb-&gt;<a class="code" href="structdwc__otg__hcd__urb.html#ed542f6a2d99dba2f6b71b0d8012ec8a">iso_descs</a>[desc_num].<a class="code" href="structdwc__otg__hcd__iso__packet__desc.html#8392d21b820df0181f4e6dca91234543">length</a> = length;
<a name="l02768"></a>02768 }
<a name="l02769"></a>02769 
<a name="l02770"></a><a class="code" href="dwc__otg__hcd__if_8h.html#fde27182e452709e10c1100ea57aa46b">02770</a> uint32_t <a class="code" href="dwc__otg__hcd_8c.html#fde27182e452709e10c1100ea57aa46b">dwc_otg_hcd_urb_get_iso_desc_status</a>(<a class="code" href="structdwc__otg__hcd__urb.html">dwc_otg_hcd_urb_t</a> * dwc_otg_urb,
<a name="l02771"></a>02771                                              <span class="keywordtype">int</span> desc_num)
<a name="l02772"></a>02772 {
<a name="l02773"></a>02773         <span class="keywordflow">return</span> dwc_otg_urb-&gt;<a class="code" href="structdwc__otg__hcd__urb.html#ed542f6a2d99dba2f6b71b0d8012ec8a">iso_descs</a>[desc_num].<a class="code" href="structdwc__otg__hcd__iso__packet__desc.html#d070772c24621c47b49ad21c6acadb94">status</a>;
<a name="l02774"></a>02774 }
<a name="l02775"></a>02775 
<a name="l02776"></a><a class="code" href="dwc__otg__hcd__if_8h.html#c6d28fc3e6aedb29d46a793423c4de0a">02776</a> uint32_t <a class="code" href="dwc__otg__hcd_8c.html#c6d28fc3e6aedb29d46a793423c4de0a">dwc_otg_hcd_urb_get_iso_desc_actual_length</a>(<a class="code" href="structdwc__otg__hcd__urb.html">dwc_otg_hcd_urb_t</a> *
<a name="l02777"></a>02777                                                     dwc_otg_urb, <span class="keywordtype">int</span> desc_num)
<a name="l02778"></a>02778 {
<a name="l02779"></a>02779         <span class="keywordflow">return</span> dwc_otg_urb-&gt;<a class="code" href="structdwc__otg__hcd__urb.html#ed542f6a2d99dba2f6b71b0d8012ec8a">iso_descs</a>[desc_num].<a class="code" href="structdwc__otg__hcd__iso__packet__desc.html#c00b967f4c613820b99efc0abda5178c">actual_length</a>;
<a name="l02780"></a>02780 }
<a name="l02781"></a>02781 
<a name="l02782"></a><a class="code" href="dwc__otg__hcd__if_8h.html#5deb69c332ba937b959c9dccadd87568">02782</a> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__hcd_8c.html#5deb69c332ba937b959c9dccadd87568">dwc_otg_hcd_is_bandwidth_allocated</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd, <span class="keywordtype">void</span> *ep_handle)
<a name="l02783"></a>02783 {
<a name="l02784"></a>02784         <span class="keywordtype">int</span> allocated = 0;
<a name="l02785"></a>02785         <a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a> *qh = (<a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a> *) ep_handle;
<a name="l02786"></a>02786 
<a name="l02787"></a>02787         <span class="keywordflow">if</span> (qh) {
<a name="l02788"></a>02788                 <span class="keywordflow">if</span> (!DWC_LIST_EMPTY(&amp;qh-&gt;qh_list_entry)) {
<a name="l02789"></a>02789                         allocated = 1;
<a name="l02790"></a>02790                 }
<a name="l02791"></a>02791         }
<a name="l02792"></a>02792         <span class="keywordflow">return</span> allocated;
<a name="l02793"></a>02793 }
<a name="l02794"></a>02794 
<a name="l02795"></a><a class="code" href="dwc__otg__hcd__if_8h.html#ad28eed057375c7f31663dc777edefd7">02795</a> <span class="keywordtype">int</span> <a class="code" href="dwc__otg__hcd_8c.html#ad28eed057375c7f31663dc777edefd7">dwc_otg_hcd_is_bandwidth_freed</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd, <span class="keywordtype">void</span> *ep_handle)
<a name="l02796"></a>02796 {
<a name="l02797"></a>02797         <a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a> *qh = (<a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a> *) ep_handle;
<a name="l02798"></a>02798         <span class="keywordtype">int</span> freed = 0;
<a name="l02799"></a>02799         DWC_ASSERT(qh, <span class="stringliteral">"qh is not allocated\n"</span>);
<a name="l02800"></a>02800 
<a name="l02801"></a>02801         <span class="keywordflow">if</span> (DWC_LIST_EMPTY(&amp;qh-&gt;<a class="code" href="structdwc__otg__qh.html#3e1cb9863dc72139e1832c04244c25ff">qh_list_entry</a>)) {
<a name="l02802"></a>02802                 freed = 1;
<a name="l02803"></a>02803         }
<a name="l02804"></a>02804 
<a name="l02805"></a>02805         <span class="keywordflow">return</span> freed;
<a name="l02806"></a>02806 }
<a name="l02807"></a>02807 
<a name="l02808"></a><a class="code" href="dwc__otg__hcd__if_8h.html#bd160be911ccc8f90141dae9c40276eb">02808</a> uint8_t <a class="code" href="dwc__otg__hcd_8c.html#bd160be911ccc8f90141dae9c40276eb">dwc_otg_hcd_get_ep_bandwidth</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd, <span class="keywordtype">void</span> *ep_handle)
<a name="l02809"></a>02809 {
<a name="l02810"></a>02810         <a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a> *qh = (<a class="code" href="structdwc__otg__qh.html">dwc_otg_qh_t</a> *) ep_handle;
<a name="l02811"></a>02811         DWC_ASSERT(qh, <span class="stringliteral">"qh is not allocated\n"</span>);
<a name="l02812"></a>02812         <span class="keywordflow">return</span> qh-&gt;usecs;
<a name="l02813"></a>02813 }
<a name="l02814"></a>02814 
<a name="l02815"></a><a class="code" href="dwc__otg__hcd__if_8h.html#464f920221173fe04c756a9d6657f321">02815</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__hcd_8c.html#464f920221173fe04c756a9d6657f321">dwc_otg_hcd_dump_state</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd)
<a name="l02816"></a>02816 {
<a name="l02817"></a>02817 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l02818"></a>02818 <span class="preprocessor"></span>        <span class="keywordtype">int</span> num_channels;
<a name="l02819"></a>02819         <span class="keywordtype">int</span> i;
<a name="l02820"></a>02820         <a class="code" href="uniongnptxsts__data.html">gnptxsts_data_t</a> np_tx_status;
<a name="l02821"></a>02821         <a class="code" href="unionhptxsts__data.html">hptxsts_data_t</a> p_tx_status;
<a name="l02822"></a>02822 
<a name="l02823"></a>02823         num_channels = hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#63ffc9b8e36340bd59bf1fab9ca490ad">core_params</a>-&gt;<a class="code" href="structdwc__otg__core__params.html#c1b433c6965aa7d48f6ca6818c592039">host_channels</a>;
<a name="l02824"></a>02824         DWC_PRINTF(<span class="stringliteral">"\n"</span>);
<a name="l02825"></a>02825         DWC_PRINTF
<a name="l02826"></a>02826             (<span class="stringliteral">"************************************************************\n"</span>);
<a name="l02827"></a>02827         DWC_PRINTF(<span class="stringliteral">"HCD State:\n"</span>);
<a name="l02828"></a>02828         DWC_PRINTF(<span class="stringliteral">"  Num channels: %d\n"</span>, num_channels);
<a name="l02829"></a>02829         <span class="keywordflow">for</span> (i = 0; i &lt; num_channels; i++) {
<a name="l02830"></a>02830                 <a class="code" href="structdwc__hc.html">dwc_hc_t</a> *hc = hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#cb393f6a676fb106e0e3d35396fb97f9">hc_ptr_array</a>[i];
<a name="l02831"></a>02831                 DWC_PRINTF(<span class="stringliteral">"  Channel %d:\n"</span>, i);
<a name="l02832"></a>02832                 DWC_PRINTF(<span class="stringliteral">"    dev_addr: %d, ep_num: %d, ep_is_in: %d\n"</span>,
<a name="l02833"></a>02833                            hc-&gt;dev_addr, hc-&gt;ep_num, hc-&gt;ep_is_in);
<a name="l02834"></a>02834                 DWC_PRINTF(<span class="stringliteral">"    speed: %d\n"</span>, hc-&gt;speed);
<a name="l02835"></a>02835                 DWC_PRINTF(<span class="stringliteral">"    ep_type: %d\n"</span>, hc-&gt;ep_type);
<a name="l02836"></a>02836                 DWC_PRINTF(<span class="stringliteral">"    max_packet: %d\n"</span>, hc-&gt;max_packet);
<a name="l02837"></a>02837                 DWC_PRINTF(<span class="stringliteral">"    data_pid_start: %d\n"</span>, hc-&gt;data_pid_start);
<a name="l02838"></a>02838                 DWC_PRINTF(<span class="stringliteral">"    multi_count: %d\n"</span>, hc-&gt;multi_count);
<a name="l02839"></a>02839                 DWC_PRINTF(<span class="stringliteral">"    xfer_started: %d\n"</span>, hc-&gt;xfer_started);
<a name="l02840"></a>02840                 DWC_PRINTF(<span class="stringliteral">"    xfer_buff: %p\n"</span>, hc-&gt;xfer_buff);
<a name="l02841"></a>02841                 DWC_PRINTF(<span class="stringliteral">"    xfer_len: %d\n"</span>, hc-&gt;xfer_len);
<a name="l02842"></a>02842                 DWC_PRINTF(<span class="stringliteral">"    xfer_count: %d\n"</span>, hc-&gt;xfer_count);
<a name="l02843"></a>02843                 DWC_PRINTF(<span class="stringliteral">"    halt_on_queue: %d\n"</span>, hc-&gt;halt_on_queue);
<a name="l02844"></a>02844                 DWC_PRINTF(<span class="stringliteral">"    halt_pending: %d\n"</span>, hc-&gt;halt_pending);
<a name="l02845"></a>02845                 DWC_PRINTF(<span class="stringliteral">"    halt_status: %d\n"</span>, hc-&gt;halt_status);
<a name="l02846"></a>02846                 DWC_PRINTF(<span class="stringliteral">"    do_split: %d\n"</span>, hc-&gt;do_split);
<a name="l02847"></a>02847                 DWC_PRINTF(<span class="stringliteral">"    complete_split: %d\n"</span>, hc-&gt;complete_split);
<a name="l02848"></a>02848                 DWC_PRINTF(<span class="stringliteral">"    hub_addr: %d\n"</span>, hc-&gt;hub_addr);
<a name="l02849"></a>02849                 DWC_PRINTF(<span class="stringliteral">"    port_addr: %d\n"</span>, hc-&gt;port_addr);
<a name="l02850"></a>02850                 DWC_PRINTF(<span class="stringliteral">"    xact_pos: %d\n"</span>, hc-&gt;xact_pos);
<a name="l02851"></a>02851                 DWC_PRINTF(<span class="stringliteral">"    requests: %d\n"</span>, hc-&gt;requests);
<a name="l02852"></a>02852                 DWC_PRINTF(<span class="stringliteral">"    qh: %p\n"</span>, hc-&gt;qh);
<a name="l02853"></a>02853                 <span class="keywordflow">if</span> (hc-&gt;xfer_started) {
<a name="l02854"></a>02854                         <a class="code" href="unionhfnum__data.html">hfnum_data_t</a> hfnum;
<a name="l02855"></a>02855                         <a class="code" href="unionhcchar__data.html">hcchar_data_t</a> hcchar;
<a name="l02856"></a>02856                         <a class="code" href="unionhctsiz__data.html">hctsiz_data_t</a> hctsiz;
<a name="l02857"></a>02857                         <a class="code" href="unionhcint__data.html">hcint_data_t</a> hcint;
<a name="l02858"></a>02858                         <a class="code" href="unionhcintmsk__data.html">hcintmsk_data_t</a> hcintmsk;
<a name="l02859"></a>02859                         hfnum.<a class="code" href="unionhfnum__data.html#e5ccbed3af86ac88577ded328e6c9932">d32</a> =
<a name="l02860"></a>02860                             dwc_read_reg32(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#51bac71891b5f6f435d7fc4582b974c1">host_if</a>-&gt;
<a name="l02861"></a>02861                                            host_global_regs-&gt;hfnum);
<a name="l02862"></a>02862                         hcchar.<a class="code" href="unionhcchar__data.html#03d352fb421ab5c11bf9afaae4933ba4">d32</a> =
<a name="l02863"></a>02863                             dwc_read_reg32(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#51bac71891b5f6f435d7fc4582b974c1">host_if</a>-&gt;<a class="code" href="structdwc__otg__host__if.html#7f7c107d4720641eb4141cd817211ac0">hc_regs</a>[i]-&gt;
<a name="l02864"></a>02864                                            hcchar);
<a name="l02865"></a>02865                         hctsiz.<a class="code" href="unionhctsiz__data.html#fb41950555c60c6015294bdefe9cd39d">d32</a> =
<a name="l02866"></a>02866                             dwc_read_reg32(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#51bac71891b5f6f435d7fc4582b974c1">host_if</a>-&gt;<a class="code" href="structdwc__otg__host__if.html#7f7c107d4720641eb4141cd817211ac0">hc_regs</a>[i]-&gt;
<a name="l02867"></a>02867                                            hctsiz);
<a name="l02868"></a>02868                         hcint.<a class="code" href="unionhcint__data.html#05a82fa7693f875622db744716d7f73e">d32</a> =
<a name="l02869"></a>02869                             dwc_read_reg32(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#51bac71891b5f6f435d7fc4582b974c1">host_if</a>-&gt;<a class="code" href="structdwc__otg__host__if.html#7f7c107d4720641eb4141cd817211ac0">hc_regs</a>[i]-&gt;
<a name="l02870"></a>02870                                            hcint);
<a name="l02871"></a>02871                         hcintmsk.<a class="code" href="unionhcintmsk__data.html#8868299fcc762e005b7f0bf67e5fbe30">d32</a> =
<a name="l02872"></a>02872                             dwc_read_reg32(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#51bac71891b5f6f435d7fc4582b974c1">host_if</a>-&gt;<a class="code" href="structdwc__otg__host__if.html#7f7c107d4720641eb4141cd817211ac0">hc_regs</a>[i]-&gt;
<a name="l02873"></a>02873                                            hcintmsk);
<a name="l02874"></a>02874                         DWC_PRINTF(<span class="stringliteral">"    hfnum: 0x%08x\n"</span>, hfnum.<a class="code" href="unionhfnum__data.html#e5ccbed3af86ac88577ded328e6c9932">d32</a>);
<a name="l02875"></a>02875                         DWC_PRINTF(<span class="stringliteral">"    hcchar: 0x%08x\n"</span>, hcchar.d32);
<a name="l02876"></a>02876                         DWC_PRINTF(<span class="stringliteral">"    hctsiz: 0x%08x\n"</span>, hctsiz.d32);
<a name="l02877"></a>02877                         DWC_PRINTF(<span class="stringliteral">"    hcint: 0x%08x\n"</span>, hcint.d32);
<a name="l02878"></a>02878                         DWC_PRINTF(<span class="stringliteral">"    hcintmsk: 0x%08x\n"</span>, hcintmsk.d32);
<a name="l02879"></a>02879                 }
<a name="l02880"></a>02880                 <span class="keywordflow">if</span> (hc-&gt;xfer_started &amp;&amp; hc-&gt;qh) {
<a name="l02881"></a>02881                         <a class="code" href="structdwc__otg__qtd.html">dwc_otg_qtd_t</a> *qtd;
<a name="l02882"></a>02882                         <a class="code" href="structdwc__otg__hcd__urb.html">dwc_otg_hcd_urb_t</a> *urb;
<a name="l02883"></a>02883                         
<a name="l02884"></a>02884                         DWC_CIRCLEQ_FOREACH(qtd, &amp;hc-&gt;<a class="code" href="structdwc__otg__qtd.html#f80ddcfb6edbe83a3991dd67c93a47e4">qh</a>-&gt;<a class="code" href="structdwc__otg__qh.html#9567d266da8e796d3467fb16ae867f8e">qtd_list</a>, qtd_list_entry) {
<a name="l02885"></a>02885                                 <span class="keywordflow">if</span>(!qtd-&gt;<a class="code" href="structdwc__otg__qtd.html#c1d73f1d48eeabbdc198ad28c0882bc1">in_process</a>)
<a name="l02886"></a>02886                                         <span class="keywordflow">break</span>;
<a name="l02887"></a>02887                                 
<a name="l02888"></a>02888                                 urb = qtd-&gt;<a class="code" href="structdwc__otg__qtd.html#7e7767808e8eb9d71de0db00f57553f9">urb</a>;
<a name="l02889"></a>02889                         DWC_PRINTF(<span class="stringliteral">"    URB Info:\n"</span>);
<a name="l02890"></a>02890                         DWC_PRINTF(<span class="stringliteral">"      qtd: %p, urb: %p\n"</span>, qtd, urb);
<a name="l02891"></a>02891                         <span class="keywordflow">if</span> (urb) {
<a name="l02892"></a>02892                                 DWC_PRINTF(<span class="stringliteral">"      Dev: %d, EP: %d %s\n"</span>,
<a name="l02893"></a>02893                                            <a class="code" href="dwc__otg__hcd_8h.html#0de365358ba4472d56c1ac8074ba926b">dwc_otg_hcd_get_dev_addr</a>(&amp;urb-&gt;
<a name="l02894"></a>02894                                                                     pipe_info),
<a name="l02895"></a>02895                                            <a class="code" href="dwc__otg__hcd_8h.html#367b79057f321cfa65023f4026d6c2c9">dwc_otg_hcd_get_ep_num</a>(&amp;urb-&gt;
<a name="l02896"></a>02896                                                                   pipe_info),
<a name="l02897"></a>02897                                            <a class="code" href="dwc__otg__hcd_8h.html#68de5629a8b45d9bec58f680fa4c820c">dwc_otg_hcd_is_pipe_in</a>(&amp;urb-&gt;
<a name="l02898"></a>02898                                                                   pipe_info) ?
<a name="l02899"></a>02899                                            <span class="stringliteral">"IN"</span> : <span class="stringliteral">"OUT"</span>);
<a name="l02900"></a>02900                                 DWC_PRINTF(<span class="stringliteral">"      Max packet size: %d\n"</span>,
<a name="l02901"></a>02901                                            <a class="code" href="dwc__otg__hcd_8h.html#e47df3e0ac1c8ccc916e0c0895568c88">dwc_otg_hcd_get_mps</a>(&amp;urb-&gt;
<a name="l02902"></a>02902                                                                pipe_info));
<a name="l02903"></a>02903                                 DWC_PRINTF(<span class="stringliteral">"      transfer_buffer: %p\n"</span>,
<a name="l02904"></a>02904                                            urb-&gt;<a class="code" href="structdwc__otg__hcd__urb.html#99ae35ffcd6147ddb93b361ab3bcfe95">buf</a>);
<a name="l02905"></a>02905                                 DWC_PRINTF(<span class="stringliteral">"      transfer_dma: %p\n"</span>,
<a name="l02906"></a>02906                                            (<span class="keywordtype">void</span> *)urb-&gt;<a class="code" href="structdwc__otg__hcd__urb.html#4e177a55239e95ae2f6c8b6b913f67fc">dma</a>);
<a name="l02907"></a>02907                                 DWC_PRINTF(<span class="stringliteral">"      transfer_buffer_length: %d\n"</span>,
<a name="l02908"></a>02908                                            urb-&gt;<a class="code" href="structdwc__otg__hcd__urb.html#dca57de4fdecd894241ce24167206a45">length</a>);
<a name="l02909"></a>02909                                 DWC_PRINTF(<span class="stringliteral">"      actual_length: %d\n"</span>,
<a name="l02910"></a>02910                                            urb-&gt;<a class="code" href="structdwc__otg__hcd__urb.html#742c8a97d3867ab89148eae34e0c73a6">actual_length</a>);
<a name="l02911"></a>02911                         }
<a name="l02912"></a>02912                 }
<a name="l02913"></a>02913         }
<a name="l02914"></a>02914         }
<a name="l02915"></a>02915         DWC_PRINTF(<span class="stringliteral">"  non_periodic_channels: %d\n"</span>, hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e7fff26b5cce7c6c520c89f9e3c75617">non_periodic_channels</a>);
<a name="l02916"></a>02916         DWC_PRINTF(<span class="stringliteral">"  periodic_channels: %d\n"</span>, hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#5754b87bd4644fbb7b90cf843c638f1c">periodic_channels</a>);
<a name="l02917"></a>02917         DWC_PRINTF(<span class="stringliteral">"  periodic_usecs: %d\n"</span>, hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#1f2ce690c8ded506eff8d1b567747235">periodic_usecs</a>);
<a name="l02918"></a>02918         np_tx_status.<a class="code" href="uniongnptxsts__data.html#a58b5adbe6bd0344c4f585ef6aba4672">d32</a> =
<a name="l02919"></a>02919             dwc_read_reg32(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#909eae7e3b9432ca1e278b99f7811f52">core_global_regs</a>-&gt;<a class="code" href="structdwc__otg__core__global__regs.html#57dabea6f6e0bf9e1ee8e94f55b9e465">gnptxsts</a>);
<a name="l02920"></a>02920         DWC_PRINTF(<span class="stringliteral">"  NP Tx Req Queue Space Avail: %d\n"</span>,
<a name="l02921"></a>02921                    np_tx_status.<a class="code" href="uniongnptxsts__data.html#be1d1adf7b827616ebbbf6bf564c0738">b</a>.<a class="code" href="uniongnptxsts__data.html#634ffd5e84bc422ddef043574d8f0957">nptxqspcavail</a>);
<a name="l02922"></a>02922         DWC_PRINTF(<span class="stringliteral">"  NP Tx FIFO Space Avail: %d\n"</span>,
<a name="l02923"></a>02923                    np_tx_status.<a class="code" href="uniongnptxsts__data.html#be1d1adf7b827616ebbbf6bf564c0738">b</a>.<a class="code" href="uniongnptxsts__data.html#6c149be246bcf5ca5395f67e67648207">nptxfspcavail</a>);
<a name="l02924"></a>02924         p_tx_status.<a class="code" href="unionhptxsts__data.html#b48d41d449d8f71c0b184b38029c26bc">d32</a> =
<a name="l02925"></a>02925             dwc_read_reg32(&amp;hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;<a class="code" href="structdwc__otg__core__if.html#51bac71891b5f6f435d7fc4582b974c1">host_if</a>-&gt;<a class="code" href="structdwc__otg__host__if.html#ff9692c2e10ca2bc7e24f981f25179c2">host_global_regs</a>-&gt;<a class="code" href="structdwc__otg__host__global__regs.html#bf1a1528a2e479d86318d49ecd52ee40">hptxsts</a>);
<a name="l02926"></a>02926         DWC_PRINTF(<span class="stringliteral">"  P Tx Req Queue Space Avail: %d\n"</span>,
<a name="l02927"></a>02927                    p_tx_status.<a class="code" href="unionhptxsts__data.html#a6839185cc4aeabf771f04f1b2a97ec3">b</a>.<a class="code" href="unionhptxsts__data.html#8139e6eafb7b0bbb3cbafa125d5cd28f">ptxqspcavail</a>);
<a name="l02928"></a>02928         DWC_PRINTF(<span class="stringliteral">"  P Tx FIFO Space Avail: %d\n"</span>, p_tx_status.<a class="code" href="unionhptxsts__data.html#a6839185cc4aeabf771f04f1b2a97ec3">b</a>.<a class="code" href="unionhptxsts__data.html#0df6fb1f76396da626715d6ffc06dfa8">ptxfspcavail</a>);
<a name="l02929"></a>02929         <a class="code" href="dwc__otg__hcd_8c.html#b2c46e92cdc57b1783f445ed60cc3f38">dwc_otg_hcd_dump_frrem</a>(hcd);
<a name="l02930"></a>02930         <a class="code" href="dwc__otg__cil_8c.html#118ecda931e2b745f76fde129ff707c2">dwc_otg_dump_global_registers</a>(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>);
<a name="l02931"></a>02931         <a class="code" href="dwc__otg__cil_8c.html#e85d3d04799b17226fcb00ea2074ca63">dwc_otg_dump_host_registers</a>(hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>);
<a name="l02932"></a>02932         DWC_PRINTF
<a name="l02933"></a>02933             (<span class="stringliteral">"************************************************************\n"</span>);
<a name="l02934"></a>02934         DWC_PRINTF(<span class="stringliteral">"\n"</span>);
<a name="l02935"></a>02935 <span class="preprocessor">#endif</span>
<a name="l02936"></a>02936 <span class="preprocessor"></span>}
<a name="l02937"></a>02937 
<a name="l02938"></a>02938 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l02939"></a>02939 <span class="preprocessor"></span><span class="keywordtype">void</span> dwc_print_setup_data(uint8_t * setup)
<a name="l02940"></a>02940 {
<a name="l02941"></a>02941         <span class="keywordtype">int</span> i;
<a name="l02942"></a>02942         <span class="keywordflow">if</span> (<a class="code" href="dwc__otg__dbg_8h.html#7a96217c88a4d786f6cb3d4df09dee04">CHK_DEBUG_LEVEL</a>(<a class="code" href="dwc__otg__dbg_8h.html#e4a050e176c1c4f556da2b276a8c2b37">DBG_HCD</a>)) {
<a name="l02943"></a>02943                 DWC_PRINTF(<span class="stringliteral">"Setup Data = MSB "</span>);
<a name="l02944"></a>02944                 <span class="keywordflow">for</span> (i = 7; i &gt;= 0; i--)
<a name="l02945"></a>02945                         DWC_PRINTF(<span class="stringliteral">"%02x "</span>, setup[i]);
<a name="l02946"></a>02946                 DWC_PRINTF(<span class="stringliteral">"\n"</span>);
<a name="l02947"></a>02947                 DWC_PRINTF(<span class="stringliteral">"  bmRequestType Tranfer = %s\n"</span>,
<a name="l02948"></a>02948                            (setup[0] &amp; 0x80) ? <span class="stringliteral">"Device-to-Host"</span> :
<a name="l02949"></a>02949                            <span class="stringliteral">"Host-to-Device"</span>);
<a name="l02950"></a>02950                 DWC_PRINTF(<span class="stringliteral">"  bmRequestType Type = "</span>);
<a name="l02951"></a>02951                 <span class="keywordflow">switch</span> ((setup[0] &amp; 0x60) &gt;&gt; 5) {
<a name="l02952"></a>02952                 <span class="keywordflow">case</span> 0:
<a name="l02953"></a>02953                         DWC_PRINTF(<span class="stringliteral">"Standard\n"</span>);
<a name="l02954"></a>02954                         <span class="keywordflow">break</span>;
<a name="l02955"></a>02955                 <span class="keywordflow">case</span> 1:
<a name="l02956"></a>02956                         DWC_PRINTF(<span class="stringliteral">"Class\n"</span>);
<a name="l02957"></a>02957                         <span class="keywordflow">break</span>;
<a name="l02958"></a>02958                 <span class="keywordflow">case</span> 2:
<a name="l02959"></a>02959                         DWC_PRINTF(<span class="stringliteral">"Vendor\n"</span>);
<a name="l02960"></a>02960                         <span class="keywordflow">break</span>;
<a name="l02961"></a>02961                 <span class="keywordflow">case</span> 3:
<a name="l02962"></a>02962                         DWC_PRINTF(<span class="stringliteral">"Reserved\n"</span>);
<a name="l02963"></a>02963                         <span class="keywordflow">break</span>;
<a name="l02964"></a>02964                 }
<a name="l02965"></a>02965                 DWC_PRINTF(<span class="stringliteral">"  bmRequestType Recipient = "</span>);
<a name="l02966"></a>02966                 <span class="keywordflow">switch</span> (setup[0] &amp; 0x1f) {
<a name="l02967"></a>02967                 <span class="keywordflow">case</span> 0:
<a name="l02968"></a>02968                         DWC_PRINTF(<span class="stringliteral">"Device\n"</span>);
<a name="l02969"></a>02969                         <span class="keywordflow">break</span>;
<a name="l02970"></a>02970                 <span class="keywordflow">case</span> 1:
<a name="l02971"></a>02971                         DWC_PRINTF(<span class="stringliteral">"Interface\n"</span>);
<a name="l02972"></a>02972                         <span class="keywordflow">break</span>;
<a name="l02973"></a>02973                 <span class="keywordflow">case</span> 2:
<a name="l02974"></a>02974                         DWC_PRINTF(<span class="stringliteral">"Endpoint\n"</span>);
<a name="l02975"></a>02975                         <span class="keywordflow">break</span>;
<a name="l02976"></a>02976                 <span class="keywordflow">case</span> 3:
<a name="l02977"></a>02977                         DWC_PRINTF(<span class="stringliteral">"Other\n"</span>);
<a name="l02978"></a>02978                         <span class="keywordflow">break</span>;
<a name="l02979"></a>02979                 <span class="keywordflow">default</span>:
<a name="l02980"></a>02980                         DWC_PRINTF(<span class="stringliteral">"Reserved\n"</span>);
<a name="l02981"></a>02981                         <span class="keywordflow">break</span>;
<a name="l02982"></a>02982                 }
<a name="l02983"></a>02983                 DWC_PRINTF(<span class="stringliteral">"  bRequest = 0x%0x\n"</span>, setup[1]);
<a name="l02984"></a>02984                 DWC_PRINTF(<span class="stringliteral">"  wValue = 0x%0x\n"</span>, *((uint16_t *) &amp; setup[2]));
<a name="l02985"></a>02985                 DWC_PRINTF(<span class="stringliteral">"  wIndex = 0x%0x\n"</span>, *((uint16_t *) &amp; setup[4]));
<a name="l02986"></a>02986                 DWC_PRINTF(<span class="stringliteral">"  wLength = 0x%0x\n\n"</span>, *((uint16_t *) &amp; setup[6]));
<a name="l02987"></a>02987         }
<a name="l02988"></a>02988 }
<a name="l02989"></a>02989 <span class="preprocessor">#endif</span>
<a name="l02990"></a>02990 <span class="preprocessor"></span>
<a name="l02991"></a><a class="code" href="dwc__otg__hcd__if_8h.html#b2c46e92cdc57b1783f445ed60cc3f38">02991</a> <span class="keywordtype">void</span> <a class="code" href="dwc__otg__hcd_8c.html#b2c46e92cdc57b1783f445ed60cc3f38">dwc_otg_hcd_dump_frrem</a>(<a class="code" href="structdwc__otg__hcd.html">dwc_otg_hcd_t</a> * hcd)
<a name="l02992"></a>02992 {
<a name="l02993"></a>02993 <span class="preprocessor">#if 0</span>
<a name="l02994"></a>02994 <span class="preprocessor"></span>        DWC_PRINTF(<span class="stringliteral">"Frame remaining at SOF:\n"</span>);
<a name="l02995"></a>02995         DWC_PRINTF(<span class="stringliteral">"  samples %u, accum %llu, avg %llu\n"</span>,
<a name="l02996"></a>02996                    hcd-&gt;frrem_samples, hcd-&gt;frrem_accum,
<a name="l02997"></a>02997                    (hcd-&gt;frrem_samples &gt; 0) ?
<a name="l02998"></a>02998                    hcd-&gt;frrem_accum / hcd-&gt;frrem_samples : 0);
<a name="l02999"></a>02999 
<a name="l03000"></a>03000         DWC_PRINTF(<span class="stringliteral">"\n"</span>);
<a name="l03001"></a>03001         DWC_PRINTF(<span class="stringliteral">"Frame remaining at start_transfer (uframe 7):\n"</span>);
<a name="l03002"></a>03002         DWC_PRINTF(<span class="stringliteral">"  samples %u, accum %llu, avg %llu\n"</span>,
<a name="l03003"></a>03003                    hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;hfnum_7_samples,
<a name="l03004"></a>03004                    hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;hfnum_7_frrem_accum,
<a name="l03005"></a>03005                    (hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;hfnum_7_samples &gt;
<a name="l03006"></a>03006                     0) ? hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;hfnum_7_frrem_accum /
<a name="l03007"></a>03007                    hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;hfnum_7_samples : 0);
<a name="l03008"></a>03008         DWC_PRINTF(<span class="stringliteral">"Frame remaining at start_transfer (uframe 0):\n"</span>);
<a name="l03009"></a>03009         DWC_PRINTF(<span class="stringliteral">"  samples %u, accum %llu, avg %llu\n"</span>,
<a name="l03010"></a>03010                    hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;hfnum_0_samples,
<a name="l03011"></a>03011                    hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;hfnum_0_frrem_accum,
<a name="l03012"></a>03012                    (hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;hfnum_0_samples &gt;
<a name="l03013"></a>03013                     0) ? hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;hfnum_0_frrem_accum /
<a name="l03014"></a>03014                    hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;hfnum_0_samples : 0);
<a name="l03015"></a>03015         DWC_PRINTF(<span class="stringliteral">"Frame remaining at start_transfer (uframe 1-6):\n"</span>);
<a name="l03016"></a>03016         DWC_PRINTF(<span class="stringliteral">"  samples %u, accum %llu, avg %llu\n"</span>,
<a name="l03017"></a>03017                    hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;hfnum_other_samples,
<a name="l03018"></a>03018                    hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;hfnum_other_frrem_accum,
<a name="l03019"></a>03019                    (hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;hfnum_other_samples &gt;
<a name="l03020"></a>03020                     0) ? hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;hfnum_other_frrem_accum /
<a name="l03021"></a>03021                    hcd-&gt;<a class="code" href="structdwc__otg__hcd.html#e36b9560ce538a7d2ea9bd266d4041f0">core_if</a>-&gt;hfnum_other_samples : 0);
<a name="l03022"></a>03022 
<a name="l03023"></a>03023         DWC_PRINTF(<span class="stringliteral">"\n"</span>);
<a name="l03024"></a>03024         DWC_PRINTF(<span class="stringliteral">"Frame remaining at sample point A (uframe 7):\n"</span>);
<a name="l03025"></a>03025         DWC_PRINTF(<span class="stringliteral">"  samples %u, accum %llu, avg %llu\n"</span>,
<a name="l03026"></a>03026                    hcd-&gt;hfnum_7_samples_a, hcd-&gt;hfnum_7_frrem_accum_a,
<a name="l03027"></a>03027                    (hcd-&gt;hfnum_7_samples_a &gt; 0) ?
<a name="l03028"></a>03028                    hcd-&gt;hfnum_7_frrem_accum_a / hcd-&gt;hfnum_7_samples_a : 0);
<a name="l03029"></a>03029         DWC_PRINTF(<span class="stringliteral">"Frame remaining at sample point A (uframe 0):\n"</span>);
<a name="l03030"></a>03030         DWC_PRINTF(<span class="stringliteral">"  samples %u, accum %llu, avg %llu\n"</span>,
<a name="l03031"></a>03031                    hcd-&gt;hfnum_0_samples_a, hcd-&gt;hfnum_0_frrem_accum_a,
<a name="l03032"></a>03032                    (hcd-&gt;hfnum_0_samples_a &gt; 0) ?
<a name="l03033"></a>03033                    hcd-&gt;hfnum_0_frrem_accum_a / hcd-&gt;hfnum_0_samples_a : 0);
<a name="l03034"></a>03034         DWC_PRINTF(<span class="stringliteral">"Frame remaining at sample point A (uframe 1-6):\n"</span>);
<a name="l03035"></a>03035         DWC_PRINTF(<span class="stringliteral">"  samples %u, accum %llu, avg %llu\n"</span>,
<a name="l03036"></a>03036                    hcd-&gt;hfnum_other_samples_a, hcd-&gt;hfnum_other_frrem_accum_a,
<a name="l03037"></a>03037                    (hcd-&gt;hfnum_other_samples_a &gt; 0) ?
<a name="l03038"></a>03038                    hcd-&gt;hfnum_other_frrem_accum_a /
<a name="l03039"></a>03039                    hcd-&gt;hfnum_other_samples_a : 0);
<a name="l03040"></a>03040 
<a name="l03041"></a>03041         DWC_PRINTF(<span class="stringliteral">"\n"</span>);
<a name="l03042"></a>03042         DWC_PRINTF(<span class="stringliteral">"Frame remaining at sample point B (uframe 7):\n"</span>);
<a name="l03043"></a>03043         DWC_PRINTF(<span class="stringliteral">"  samples %u, accum %llu, avg %llu\n"</span>,
<a name="l03044"></a>03044                    hcd-&gt;hfnum_7_samples_b, hcd-&gt;hfnum_7_frrem_accum_b,
<a name="l03045"></a>03045                    (hcd-&gt;hfnum_7_samples_b &gt; 0) ?
<a name="l03046"></a>03046                    hcd-&gt;hfnum_7_frrem_accum_b / hcd-&gt;hfnum_7_samples_b : 0);
<a name="l03047"></a>03047         DWC_PRINTF(<span class="stringliteral">"Frame remaining at sample point B (uframe 0):\n"</span>);
<a name="l03048"></a>03048         DWC_PRINTF(<span class="stringliteral">"  samples %u, accum %llu, avg %llu\n"</span>,
<a name="l03049"></a>03049                    hcd-&gt;hfnum_0_samples_b, hcd-&gt;hfnum_0_frrem_accum_b,
<a name="l03050"></a>03050                    (hcd-&gt;hfnum_0_samples_b &gt; 0) ?
<a name="l03051"></a>03051                    hcd-&gt;hfnum_0_frrem_accum_b / hcd-&gt;hfnum_0_samples_b : 0);
<a name="l03052"></a>03052         DWC_PRINTF(<span class="stringliteral">"Frame remaining at sample point B (uframe 1-6):\n"</span>);
<a name="l03053"></a>03053         DWC_PRINTF(<span class="stringliteral">"  samples %u, accum %llu, avg %llu\n"</span>,
<a name="l03054"></a>03054                    hcd-&gt;hfnum_other_samples_b, hcd-&gt;hfnum_other_frrem_accum_b,
<a name="l03055"></a>03055                    (hcd-&gt;hfnum_other_samples_b &gt; 0) ?
<a name="l03056"></a>03056                    hcd-&gt;hfnum_other_frrem_accum_b /
<a name="l03057"></a>03057                    hcd-&gt;hfnum_other_samples_b : 0);
<a name="l03058"></a>03058 <span class="preprocessor">#endif</span>
<a name="l03059"></a>03059 <span class="preprocessor"></span>}
<a name="l03060"></a>03060 
<a name="l03061"></a>03061 <span class="preprocessor">#endif                          </span><span class="comment">/* DWC_DEVICE_ONLY */</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Tue May 5 02:22:48 2009 for DesignWare USB 2.0 OTG Controller (DWC_otg) Device Driver by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.7 </small></address>
</body>
</html>
